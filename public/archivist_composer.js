!function t(e,n,i){function o(s,a){if(!n[s]){if(!e[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(r)return r(s,!0);var h=new Error("Cannot find module '"+s+"'");throw h.code="MODULE_NOT_FOUND",h}var u=n[s]={exports:{}};e[s][0].call(u.exports,function(t){var n=e[s][1][t];return o(n?n:t)},u,u.exports,t,e,n,i)}return n[s].exports}for(var r="function"==typeof require&&require,s=0;s<i.length;s++)o(i[s]);return o}({1:[function(t){"use strict";var e=t("substance-composer/env/web"),n=(t("./src/panels/locations"),t("./src/panels/persons"),t("./src/panels/definitions"),t("./src/panels/subjects")),i=(t("./src/panels/metadata"),t("./src/archivist_shell")),o=[new n],r=t("substance-composer").defaultTools,s=(t("./src/tools/location_tool"),t("./src/tools/person_tool"),t("./src/tools/definition_tool"),t("./src/tools/subject_tool"));r.push(new s);var a=t("substance-composer").defaultWorkflows,c=t("./src/workflows/tag_entity"),h=t("./src/workflows/tag_subject");a.tag_entity=new c,a.tag_subject=new h,$(function(){var t=new i,n=new e({shell:t,panels:o,tools:r,workflows:a});window.app=n;var s=$("#container")[0];if(!s)throw new Error("Could not find element with id 'container'.");n.start({el:s})})},{"./src/archivist_shell":272,"./src/panels/definitions":279,"./src/panels/locations":282,"./src/panels/metadata":286,"./src/panels/persons":290,"./src/panels/subjects":294,"./src/tools/definition_tool":298,"./src/tools/location_tool":299,"./src/tools/person_tool":300,"./src/tools/subject_tool":301,"./src/workflows/tag_entity":302,"./src/workflows/tag_subject":303,"substance-composer":33,"substance-composer/env/web":32}],2:[function(t,e){e.exports=[{id:"definition_1",type:"definition",title:"AAA",description:"Lorem ipsum dolor sit amet"},{id:"definition_2",type:"definition",title:"BBB",description:"consectetur adipiscing elit"},{id:"definition_3",type:"definition",title:"CCC",description:"condimentum urna vel libero"}]},{}],3:[function(t,e){e.exports=[{id:"location_komorn",type:"location",location_type:"prison",name:"Komorn",synonyms:["Komarom","Komarno","Комаром","Komárom"],prison_type:["prison","German labor camp","transit camp","filtration camp","stammlager","POW camp"],nearest_locality:"Komarom",comment:"The camp was in the fortress (citadel) Komar; respondent was there as a prisoner of war.",country:"Hungary",latlong:[47.721223,18.1234664]},{id:"location_danzig",type:"location",location_type:"locality",name:"Danzig",synonyms:["Gdańsk","Данциг","Гданьск"],current_name:"Gdansk",comment:"Current name is Gdansk (Poland); in the 1308-1466 and 1793-1945 years was known as Danzig.",country:"Poland",latlong:[54.35202520000001,18.6466384]},{id:"location_linz",type:"location",location_type:"locality",name:"Linz",synonyms:["Lentia","Данциг","Гданьск"],current_name:"Gdansk",comment:"Linz is the capital of Upper Austria",country:"Austria",latlong:[54.35202520000001,18.6466384]},{id:"location_quasi",type:"location",location_type:"locality",name:"Quasi",synonyms:["Lentia","Данциг","Гданьск"],current_name:"Gdansk",comment:"Linz is the capital of Upper Austria",country:"Austria",latlong:[54.35202520000001,18.6466384]}]},{}],4:[function(t,e){e.exports=[{id:"person_1",type:"person",name:"Michael Aufreiter",bio:"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus pretium, tellus vitae facilisis pulvinar, augue tellus consequat nunc, eget porta tortor purus dictum ipsum."},{id:"person_2",type:"person",name:"Oliver Buchtala",bio:"Aliquam eu vulputate sapien. Curabitur nec cursus ex. Morbi ultrices nisi id metus elementum, nec convallis est tempor. Etiam ultricies id tortor id accumsan."},{id:"person_3",type:"person",name:"Daniel Beilinson",bio:"Fusce ac pellentesque nulla. Morbi condimentum urna vel libero interdum, non varius nisi sagittis."}]},{}],5:[function(t,e){e.exports=[{id:"subject_war",type:"subject",name:"War"},{id:"subject_hunger",type:"subject",name:"Hunger"},{id:"subject_peace",type:"subject",name:"Peace"},{id:"subject_war_in_41",type:"subject",name:"In 41",parent:"subject_war"},{id:"subject_war_in_42",type:"subject",name:"In 42",parent:"subject_war"},{id:"subject_hunger_in_41",type:"subject",name:"In 41",parent:"subject_hunger"},{id:"subject_hunger_in_42",type:"subject",name:"In 42",parent:"subject_hunger"}]},{}],6:[function(t,e){"use strict";var n=t("./src/application");n.View=t("./src/view"),n.Controller=t("./src/controller"),"undefined"!=typeof window&&(n.Router=t("./src/router"),n.DefaultRouter=t("./src/default_router"),n.ElementRenderer=t("./src/renderers/element_renderer"),n.$$=n.ElementRenderer.$$),e.exports=n},{"./src/application":7,"./src/controller":8,"./src/default_router":9,"./src/renderers/element_renderer":10,"./src/router":11,"./src/view":12}],7:[function(t,e){"use strict";var n=t("./view"),i=t("substance-util"),o=t("underscore"),r=function(t){n.call(this),this.config=t||{},this.__controller__=null};r.Prototype=function(){this.setRouter=function(t){this.router=t},this.start=function(t){var e=window.$;t=t||{},t.el?(this.el=t.el,this.$el=e(this.el)):(this.$el=e("body"),this.el=this.$el[0]),this.initialize&&this.initialize(),this.render&&this.render(),this.router&&this.router.start()};var t={updateRoute:!0,replace:!1};this.switchState=function(e,n,r){var s=this;n=o.extend({},t,n||{});var a=this.getState();this.controller.__switchState__(e,n,function(t){if(t)return void(r?r(t):(console.error(t.message),i.printStackTrace(t)));if(n.updateRoute&&s.updateRoute(n),s.afterTransition)try{s.afterTransition(e,a)}catch(o){return void(r?r(o):(console.error(o.message),i.printStackTrace(o)))}r&&r(null)})},this.stateFromFragment=function(t){function e(t){for(var e=[],n=0;n<t.length;n++)e.push({id:t[n]});return e}var n,i,o,r=t.split(";"),s=[];for(i=0;i<r.length;i++){o=r[i].split("=");var a=o[0],c=o[1];if(a&&void 0!==c)if("state"===a){var h=c.split(".");n=e(h)}else o=a.split("."),s.push({state:o[0],key:o[1],value:c})}for(i=0;i<s.length;i++){var u=s[i],l=n[u.state];l[u.key]=u.value}return n},this.getState=function(){if(!this.controller.state)return null;for(var t=[],e=this.controller;e;)t.push(e.state),e=e.childController;return t},this.updateRoute=function(t){if(!this.router&&!this.config.headless)throw new Error("Application.updateRoute(): application has no router.");t=t||{};for(var e=this.getState(),n=[],i=[],r=0;r<e.length;r++){var s=e[r];if(s){n.push(s.id);for(var a in s){var c=s[a];"id"!==a&&"__id__"!==a&&"options"!==a&&(o.isString(c)?i.push(r+"."+a+"="+c):console.error("Only String state variables are allowed"))}}}var h="state="+n.join(".")+";"+i.join(";");this.router.navigate(h,{trigger:!1,replace:t.replace})},this.stateChanged=function(t,e,n){n.updateRoute&&this.updateRoute(n)},this.sendError=function(t){throw t}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,Object.defineProperty(r.prototype,"controller",{set:function(t){t.setChangeListener(this),this.__controller__=t},get:function(){return this.__controller__}}),e.exports=r},{"./view":12,"substance-util":264,underscore:269}],8:[function(t,e){"use strict";var n=t("substance-util"),i=t("underscore"),o=function(){this.changeListener=null,this.state={id:"uninitialized"},this.__childController__=null,this.__parentController__=null};o.Prototype=function(){this.intitialize=function(){},this.dispose=function(){this.__childController__&&this.__childController__.dispose(),this.__childController__=null,this.state={id:"uninitialized"}},this.transition=function(t,e){e(null)},this.switchState=function(t,e,o){!o&&i.isFunction(e)&&(o=e);var r=this;1===arguments.length&&i.isFunction(e)&&(o=e,e={}),e=e||{updateRoute:!0,replace:!1},o=o||function(i){if(i)throw console.error("Error during switch state",t,e),n.printStackTrace(i),new Error(i)};var s=this.state;this.__switchState__(t,e,function(t){return t?o(t):(r.changeListener&&r.changeListener.stateChanged(this,s,e),void o(null))})},this.__switchState__=function(t,e,n){var o=this;n=n||function(t){if(t)throw new Error(t)},i.isArray(t)||(t=[t]);var r=t.shift();r.options=e||{};var s,a=function(){if(!s){var t=o.state;o.state=r,o.afterTransition(t),o.state.options={}}n(null)},c=function(){try{o.transition(r,function(e,r){if(e)return n(e);if(i.isBoolean(r)?s=r:r&&(s=r.skip),o.childController)if(t.length>0)o.childController.__switchState__(t,r,function(t){return t?n(t):void a()});else{if(!o.childController.DEFAULT_STATE)throw new Error("Unsufficient state data provided! Child controller needs a transition!");o.childController.__switchState__(o.childController.DEFAULT_STATE,r,function(t){return t?n(t):void a()})}else a()})}catch(e){n(e)}};this.state?c():this.initialize(r,function(t){return t?n(t):(o.state={id:"initialized"},void c())})},this.afterTransition=function(){},this.setChildController=function(t,e){e=e||{},this.__childController__&&this.__childController__.state&&!e.nowarn&&console.error("The child controller has not been disposed. Call 'disposeChildController()' first."),t&&(this.changeListener?t.changeListener=this.changeListener:console.error("This controller does not have a changeListener attached, so the child controller will not trigger corresponding application state changes."),t.__parentController__=this,this.__childController__=t)},this.disposeChildController=function(){this.__childController__&&(this.__childController__.dispose(),this.__childController__=null)},this.setChangeListener=function(t){this.changeListener=t},this.sendError=function(t){this.__parentController__&&this.__parentController__.sendError(t)}},o.Prototype.prototype=n.Events,o.prototype=new o.Prototype,o.State=function(t){if(i.isString(t))this.__id__=t;else{var e=arguments[0];this.__id__=e.id,i.each(e,function(t,e){"id"!==e&&(this[e]=t)},this)}},Object.defineProperty(o.State.prototype,"id",{set:function(){throw new Error("Property 'id' is immutable")},get:function(){return this.__id__}}),Object.defineProperty(o.prototype,"childController",{set:function(t){this.setChildController(t)},get:function(){return this.__childController__}}),e.exports=o},{"substance-util":264,underscore:269}],9:[function(t,e){"use strict";var n=t("underscore"),i=t("./router"),o=function(t){i.call(this),this.app=t,n.each(o.routes,function(t){this[t.command]?this.route(t.route,t.name,n.bind(this[t.command],this)):console.error("Unknown route handler: ",t.command)},this),this.route(/^state=.*$/,"state",n.bind(this.openState,this))};o.Prototype=function(){this.start=function(){i.history.start()};var t={updateRoute:!1,replace:!1};this.openState=function(){var e=i.history.getFragment(),n=this.app.stateFromFragment(e);console.log("state change triggerd by router",JSON.stringify(n)),this.app.switchState(n,t)},this.navigate=function(t,e){i.history.navigate(t,e)}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"./router":11,underscore:269}],10:[function(t,e){"use strict";var n=t("substance-util"),i=t("substance-regexp"),o=function(t){return this.attributes=t,this.tagName=t.tag,this.children=t.children||[],this.text=t.text||"",this.html=t.html,delete t.children,delete t.text,delete t.html,delete t.tag,this.render()};o.Prototype=function(){this.render=function(){var t=window.document.createElement(this.tagName);this.html?t.innerHTML=this.html:t.textContent=this.text;for(var e in this.attributes){var n=this.attributes[e];t.setAttribute(e,n)}for(var i=0;i<this.children.length;i++){var o=this.children[i];t.appendChild(o)}return this.el=t,t}};var r=function(t,e){e=e||{};var n=/^([a-zA-Z0-9]*)/.exec(t);e.tag=n&&n[1]?n[1]:"div";var r=/#([a-zA-Z0-9_]*)/.exec(t);r&&r[1]&&(e.id=r[1]);var s=new i(/\.([a-zA-Z0-9_-]*)/g);return e["class"]||(e["class"]=s.match(t).map(function(t){return t.match[1]}).join(" ")),new o(e)};o.$$=r,o.Prototype.prototype=n.Events,o.prototype=new o.Prototype,e.exports=o},{"substance-regexp":255,"substance-util":264}],11:[function(t,e){"use strict";var n,i=t("substance-util"),o=t("underscore");"undefined"!=typeof window?n=window.$:(console.error("FIXME: require router.js only when you are in a window context."),n=null);var r=function(t){t=t||{},t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},s=/\((.*?)\)/g,a=/(\(\?)?:\w+/g,c=/\*\w+/g,h=/[\-{}\[\]+?.,\\\^$|#\s]/g;o.extend(r.prototype,i.Events,{initialize:function(){},route:function(t,e,n){o.isRegExp(t)||(t=this._routeToRegExp(t)),o.isFunction(e)&&(n=e,e=""),n||(n=this[e]);var i=this;return r.history.route(t,function(o){var s=i._extractParameters(t,o);n&&n.apply(i,s),i.trigger.apply(i,["route:"+e].concat(s)),i.trigger("route",e,s),r.history.trigger("route",i,e,s)}),this},navigate:function(t,e){return r.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=o.result(this,"routes");for(var t,e=o.keys(this.routes);null!==(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(h,"\\$&").replace(s,"(?:$1)?").replace(a,function(t,e){return e?t:"([^/]+)"}).replace(c,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return o.map(n,function(t){return t?decodeURIComponent(t):null})}});var u=r.History=function(){this.handlers=[],o.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},l=/^[#\/]|\s+$/g,p=/^\/+|\/+$/g,d=/msie [\w.]+/,f=/\/$/;u.started=!1,o.extend(u.prototype,i.Events,{interval:50,getHash:function(t){var e=(t||window).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null===t||void 0===t)if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var n=this.root.replace(f,"");t.indexOf(n)||(t=t.substr(n.length))}else t=this.getHash();return t.replace(l,"")},start:function(t){if(u.started)throw new Error("Router.history has already been started");u.started=!0,this.options=o.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment(),i=window.document.documentMode,r=d.exec(window.navigator.userAgent.toLowerCase())&&(!i||7>=i);this.root=("/"+this.root+"/").replace(p,"/"),r&&this._wantsHashChange&&(this.iframe=n('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?n(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?n(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;var s=this.location,a=s.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!a?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&a&&s.hash&&(this.fragment=this.getHash().replace(l,""),this.history.replaceState({},window.document.title,this.root+this.fragment+s.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){n(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),u.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=o.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e),!0):void 0});return n},navigate:function(t,e){if(!u.started)return!1;if(e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var n=this.root+t;if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},window.document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}e.trigger&&this.loadUrl(t)}},_updateHash:function(t,e,n){if(n){var i=t.href.replace(/(javascript:|#).*$/,"");t.replace(i+"#"+e)}else t.hash="#"+e}}),r.history=new u,e.exports=r},{"substance-util":264,underscore:269}],12:[function(t,e){"use strict";var n=t("substance-util"),i=function(){this.$el=window.$("<div/>"),this.el=this.$el[0],this.dispatchDOMEvents()};i.Prototype=function(){this.dispose=function(){this.stopListening()},this.$=function(t){return this.$el.find(t)},this.dispatchDOMEvents=function(){function t(t){var e=/(\w+)\((.*)\)/.exec(t);if(!e)throw new Error("Invalid click handler '"+t+"'");return{method:e[1],args:e[2].split(",")}}var e=this;this.$el.delegate("[sbs-click]","click",function(n){var i=t(window.$(n.currentTarget).attr("sbs-click")),o=e[i.method];return o?(o.apply(e,i.args),!1):void 0})},this.updateTitle=function(t){window.document.title=t,window.history.replaceState({},window.document.title,window.location.href)}},i.Prototype.prototype=n.Events,i.prototype=new i.Prototype,e.exports=i},{"substance-util":264}],13:[function(t,e){"use strict";var n=t("./src/article");n.Renderer=t("./src/renderer"),n.ViewFactory=t("./src/view_factory"),e.exports=n},{"./src/article":15,"./src/renderer":17,"./src/view_factory":18}],14:[function(t,e){"use strict";var n=t("underscore"),i={};n.each(t("substance-nodes"),function(t,e){i[e]=n.clone(t)}),e.exports=i},{"substance-nodes":145,underscore:269}],15:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=t("substance-document"),r=o.Annotator,s="substance-article",a="0.6.0",c=function(t){t=t||{},t.schema||(t.schema=i.deepclone(o.schema),t.schema.id=s,t.schema.version=a);var e=t.types||c.types;n.each(e,function(e,n){t.schema.types[n]=e});var r=t.nodeTypes||c.nodeTypes;n.each(r,function(e,n){t.schema.types[n]=e.Model.type});var h=t.indexes||c.indexes;n.each(h,function(e,n){t.schema.indexes[n]=e});var u=t.views||c.views;o.call(this,t),this.nodeTypes=r,void 0===t.seed&&(this.create({id:"document",type:"document",guid:t.id,creator:t.creator,created_at:t.created_at,views:["content"],title:"","abstract":""}),n.each(u,function(t){this.create({id:t,type:"view",nodes:[]})},this))};c.Prototype=function(){this.fromSnapshot=function(t,e){return c.fromSnapshot(t,e)},this.newInstance=function(){return new c({schema:this.schema})},this.getAuthorNames=function(){return n.map(this.getAuthors(),function(t){return t.name})},this.getAuthors=function(){return n.map(this.authors,function(t){return this.get(t)},this)},this.setPublishedOn=function(t){this.set(["document","published_on"],t)},this.setId=function(t){this.set(["document","guid"],t)},this.setTitle=function(t){this.set(["document","title"],t)},this.setAuthors=function(t){this.set(["document","authors"],t)},this.createRenderer=function(t){return new c.Renderer(this,t)},this.getAnnotationBehavior=function(){return c.annotationBehavior},this.getMigrations=function(){return t("./article_migrations")}},c.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new c(e)},c.views=["content","figures","citations","info","links","locations"],c.nodeTypes=t("../nodes"),c.annotationBehavior={groups:{emphasis:"style",strong:"style",link_reference:"style",math:"style",issue:"marker"},expansion:{emphasis:{left:r.isOnNodeStart},strong:{left:r.isOnNodeStart}},split:["emphasis","strong"],levels:{idea:1,question:1,remark:1,error:1,issue:1,link_reference:1,math:1,strong:2,emphasis:2,code:2,subscript:2,superscript:2,underline:2,cross_reference:1,figure_reference:1,person_reference:1,contributor_reference:1,citation_reference:1,remark_reference:1,error_reference:1,location_reference:1}},c.types={},c.indexes={comments:{type:"comment",properties:["node"]}};var h={id:"article",nodes:{document:{type:"document",id:"document",views:["content","info"],title:"The Anatomy of a Substance Article",authors:["contributor_1","contributor_2"],guid:"lens_article"},content:{type:"view",id:"content",nodes:["cover"]},cover:{id:"cover",type:"cover"},contributor_1:{id:"contributor_1",type:"contributor",name:"Michael Aufreiter"},contributor_2:{id:"contributor_2",type:"contributor",name:"Oliver Buchtala"}}};c.SCHEMA_ID=s,c.SCHEMA_VERSION=a,c.describe=function(){var t=new c({seed:h}),e=0;return n.each(c.nodeTypes,function(i,o){if("composite"!==o){i=i.Model;var r="heading_"+i.type.id;t.create({id:r,type:"heading",content:i.description.name,level:1});var s=i.description.remarks.join(" "),a="text_"+i.type.id+"_intro";t.create({id:a,type:"text",content:s}),t.show("content",[r,a],-1),t.create({id:r+"_properties",type:"text",content:i.description.name+" uses the following properties:"}),t.show("content",[r+"_properties"],-1);var c=[];n.each(i.description.properties,function(n,i){var o="text_"+ ++e;t.create({id:o,type:"text",content:i+": "+n}),t.create({id:e+"_annotation",type:"code",path:[o,"content"],range:[0,i.length]}),c.push(o)}),t.create({id:r+"_property_list",type:"list",items:c,ordered:!1}),t.show("content",[r+"_property_list"],-1),i.example&&(t.create({id:r+"_example",type:"text",content:"Here's an example:"}),t.create({id:r+"_example_code_block",type:"code_block",content:JSON.stringify(i.example,null,"  ")}),t.show("content",[r+"_example",r+"_example_codeblock"],-1))}}),t},c.Prototype.prototype=o.prototype,c.prototype=new c.Prototype,c.prototype.constructor=c,Object.defineProperties(c.prototype,{id:{get:function(){return this.get("document").guid},set:function(){throw new Error("This is a read-only property alias.")}},creator:{get:function(){return this.get("document").creator},set:function(t){this.get("document").creator=t}},authors:{get:function(){return this.get("document").authors},set:function(){throw new Error("This is a read-only property alias.")}},updated_at:{get:function(){return this.get("document").updated_at},set:function(t){this.get("document").updated_at=t}},created_at:{get:function(){return this.get("document").created_at},set:function(){throw new Error("This is a read-only property alias.")}},published_on:{get:function(){return this.get("document").published_on},set:function(){throw new Error("This is a read-only property alias.")}},license:{get:function(){return this.get("document").license},set:function(){throw new Error("This is a read-only property alias.")}},title:{get:function(){return this.get("document").title},set:function(){throw new Error("This is a read-only property alias.")}},"abstract":{get:function(){return this.get("document")["abstract"]},set:function(){throw new Error("This is a read-only property alias.")}},views:{get:function(){return this.get("document").views.slice(0)},set:function(){throw new Error("This is a read-only property alias.")}}}),e.exports=c},{"../nodes":14,"./article_migrations":16,"substance-document":132,"substance-util":264,underscore:269}],16:[function(t,e){"use strict";var n=t("underscore"),i=function(t){t.addProperty("web_page","width","400px"),t.addProperty("web_page","height","400px")},o=function(t){n.each(t.data.nodes,function(t){"web_resource"===t.type&&(t.title=t.url)})},r=function(){},s={"0.4.0":r,"0.5.0":i,"0.6.0":o};e.exports=s},{underscore:269}],17:[function(t,e){"use strict";var n=t("./view_factory"),i=t("underscore"),o=function(t,e,i){n.call(this,t),this.viewName=e,this.options=i||{},this.nodeViews={}};o.Prototype=function(){var t=n.prototype;this.createView=function(e,n){if(this.nodeViews[e.id]&&!n)return this.nodeViews[e.id];this.nodeViews[e.id]&&n&&this.nodeViews[e.id].dispose();var i=t.createView.call(this,e);return this.nodeViews[e.id]=i,i},this.getView=function(t){if(this.nodeViews[t])return this.nodeViews[t];var e=this.document.get(t);return this.createView(e)},this.render=function(){i.each(this.nodeViews,function(t){t.dispose()});var t=window.document.createDocumentFragment(),e=this.document.get(this.viewName).nodes;return i.each(e,function(e){var n=this.document.get(e),i=this.createView(n);t.appendChild(i.render().el),this.options.afterRender&&this.options.afterRender(this.document,i)},this),t}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"./view_factory":18,underscore:269}],18:[function(t,e){"use strict";var n=function(t){this.document=t,this.nodeTypes=t.nodeTypes};n.Prototype=function(){this.getNodeViewClass=function(t,e){e=e||t.type;var n=this.nodeTypes[e];if(!n)throw new Error("No node registered for type "+e+".");var i=n.View;if(!i)throw new Error('No view registered for type "'+t.type+'".');return i},this.createView=function(t,e,n){var i=this.getNodeViewClass(t,n),o=new i(t,this,e);return o.listenTo(this.document,"operation:applied",o.onGraphUpdate),o}},n.prototype=new n.Prototype,e.exports=n},{}],19:[function(t,e){"use strict";var n=t("./src/chronicle");n.IndexImpl=t("./src/index_impl"),n.ChronicleImpl=t("./src/chronicle_impl"),n.DiffImpl=t("./src/diff_impl"),n.TmpIndex=t("./src/tmp_index"),n.create=n.ChronicleImpl.create,n.Index.create=n.IndexImpl.create,n.Diff.create=n.DiffImpl.create,n.ArrayOperationAdapter=t("./src/array_adapter"),n.TextOperationAdapter=t("./src/text_adapter"),n.IndexedDBBackend=t("./src/backends/indexeddb_backend"),e.exports=n},{"./src/array_adapter":20,"./src/backends/indexeddb_backend":21,"./src/chronicle":22,"./src/chronicle_impl":23,"./src/diff_impl":24,"./src/index_impl":25,"./src/text_adapter":26,"./src/tmp_index":27}],20:[function(t,e){"use strict";var n=t("substance-util"),i=t("./chronicle"),o=t("substance-operator").ArrayOperation,r=function(t,e){i.Versioned.call(this,t),this.array=e};r.Prototype=function(){var t=n.prototype(this);this.apply=function(t){o.fromJSON(t).apply(this.array)},this.invert=function(t){return o.fromJSON(t).invert()},this.transform=function(t,e,n){return o.transform(t,e,n)},this.reset=function(){for(t.reset.call(this);this.array.length>0;)this.array.shift()}},r.Prototype.prototype=i.Versioned.prototype,r.prototype=new r.Prototype,e.exports=r},{"./chronicle":22,"substance-operator":246,"substance-util":264}],21:[function(t,e){"use strict";var n=t("substance-util"),i=t("underscore"),o=t("../chronicle"),r=o.Index,s=function(t,e){this.name=t,this.index=e,this.db=null};s.Prototype=function(){this["delete"]=function(t){var e=this;this.clear(function(){window.indexedDB.deleteDatabase(e.name),t(null)})};var t=function(t,e,n){var i=t.transaction([e],"readwrite"),o=i.objectStore(e),r=o.clear();r.onsuccess=function(){n(null)},r.onerror=function(t){n(t)}};this.clear=function(e){var i=this.db,o=["changes","snapshots","refs"];n.async.each({items:o,iterator:function(e,n){t(i,e,n)}},e)},this.open=function(t){var e=this;this.db=null;var n=window.indexedDB.open(this.name,1);n.onupgradeneeded=function(t){var e=t.target.result;e.createObjectStore("changes",{keyPath:"id"});var n=e.createObjectStore("snapshots",{keyPath:"sha"});n.createIndex("sha","sha",{unique:!0});var i=e.createObjectStore("refs",{keyPath:"name"});i.createIndex("name","name",{unique:!0})},n.onerror=function(n){console.error("Could not open database",e.name),t(n)},n.onsuccess=function(n){e.db=n.target.result,t(null)}},this.close=function(t){this.db.close(),t&&t(null)},this.load=function(t){var e=this,n=this.db.transaction(["changes","refs"]),i=n.objectStore("changes"),o=i.openCursor(),s={};o.onsuccess=function(i){var a=i.target.result;if(a)return s[a.key]=a.value,void a["continue"]();e.index["import"](r.adapt(s));var c=n.objectStore("refs");o=c.openCursor(),o.onsuccess=function(n){var i=n.target.result;return i?(e.index.setRef(i.key,i.value.sha),void i["continue"]()):void t(null)},o.onerror=function(e){console.error("Error during loading...",e),t(e)}},o.onerror=function(e){console.error("Error during loading...",e),t(e)}};var e=function(t,e){var n=t.db.transaction(["changes"],"readwrite");n.onerror=function(t){console.error("Error while saving changes."),e&&e(t)},n.oncomplete=function(){e&&e(null)};var i=n.objectStore("changes");t.index.foreach(function(t){var e=t;t instanceof o.Change&&(e=t.toJSON());var n=i.put(e);n.onerror=function(e){console.error("Could not add change: ",t.id,e)}})},s=function(t,e){var n=t.db.transaction(["refs"],"readwrite");n.onerror=function(t){console.error("Error while saving refs."),e&&e(t)},n.oncomplete=function(){e&&e(null)};var o=n.objectStore("refs");i.each(t.index.listRefs(),function(e){var n={name:e,sha:t.index.getRef(e)},i=o.put(n);i.onerror=function(t){console.error("Could not store ref: ",n,t)}})};this.save=function(t){var n=this;e(n,function(e){return e?t(e):void s(n,t)})},this.saveSnapshot=function(t,e,n){var i=this.db.transaction(["snapshots"],"readwrite");i.oncomplete=function(){n(null)},i.onerror=function(t){console.error("Error while saving snapshot."),n(t)};var o=i.objectStore("snapshots"),r=e;r.toJSON&&(r=r.toJSON()),r.sha=t;var s=o.put(r);s.onerror=function(t){console.error("Could not add snapshot: ",r,t)}},this.listSnapshots=function(t){var e=this.db.transaction(["snapshots"],"readonly"),n=e.objectStore("snapshots"),i=n.index("sha"),o=i.openCursor(),r=[];o.onsuccess=function(e){var n=e.target.result;return n?(r.push(n.key),void n["continue"]()):void t(null,r)},o.onerror=function(e){console.error("Error during loading...",e),t(e)}},this.getSnapshot=function(t,e){var n=this.db.transaction(["snapshots"],"readonly"),i=n.objectStore("snapshots"),o=i.get(t);o.onsuccess=function(t){var n=t.target.result;e(null,n)},o.onerror=function(n){console.error("Error: could not load snapshot for sha",t),e(n)}}},s.prototype=new s.Prototype,e.exports=s},{"../chronicle":22,"substance-util":264,underscore:269}],22:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=i.errors;o.define("ChronicleError",-1),o.define("ChangeError",-1);var r=function(t,e,n){if(this.type="change",!t)throw new o.ChangeError("Every change needs a unique id.");if(this.id=t,!e)throw new o.ChangeError("Every change needs a parent.");this.parent=e,this.data=n,this.uuid=i.uuid};r.prototype={toJSON:function(){return{type:this.type,id:this.id,parent:this.parent,data:this.data}}},r.fromJSON=function(t){return t.type===c.TYPE?new c(t):t.type===h.TYPE?new h(t):new r(t.parent,t.data,t)};var s="ROOT",a=new r(s,!0,null);a.parent=s;var c=function(t,e,n){if(r.call(this,t,e),this.type=c.TYPE,!n)throw new o.ChangeError("Missing branches.");this.branches=n};c.Prototype=function(){var t=i.prototype(this);this.toJSON=function(){var e=t.toJSON.call(this);return e.type=c.TYPE,e.branches=this.branches,e}},c.Prototype.prototype=r.prototype,c.prototype=new c.Prototype,c.TYPE="merge",c.fromJSON=function(t){if(t.type!==c.TYPE)throw new o.ChangeError("Illegal data for deserializing a Merge node.");return new c(t.parent,t.branches,t)};var h=function(t,e,n,i){r.call(this,t,e,n),this.type=h.TYPE,this.original=i};h.Prototype=function(){var t=i.prototype(this);this.toJSON=function(){var e=t.toJSON.call(this);return e.type=h.TYPE,e.original=this.original,e}},h.TYPE="transformed",h.fromJSON=function(t){if(t.type!==h.TYPE)throw new o.ChangeError("Illegal data for deserializing a Transformed node.");return new h(t.parent,t.data,t.original,t)},h.Prototype.prototype=r.prototype,h.prototype=new h.Prototype;var u=function(){};u.prototype={hasReverts:function(){throw new o.SubstanceError("Not implemented.")},reverts:function(){throw new o.SubstanceError("Not implemented.")},hasApplies:function(){throw new o.SubstanceError("Not implemented.")},applies:function(){throw new o.SubstanceError("Not implemented.")},sequence:function(){throw new o.SubstanceError("Not implemented.")},mine:function(){throw new o.SubstanceError("Not implemented.")},theirs:function(){throw new o.SubstanceError("Not implemented.")},root:function(){throw new o.SubstanceError("Not implemented.")},start:function(){throw new o.SubstanceError("Not implemented.")},end:function(){throw new o.SubstanceError("Not implemented.")},inverted:function(){throw new o.SubstanceError("Not implemented.")
}},u.create=function(){throw new o.SubstanceError("Not implemented.")};var l=function(t,e){e=e||{},this.index=t,this.versioned=null,this.__mode__=e.mode||l.DEFAULT_MODE};l.Prototype=function(){this.record=function(){throw new o.SubstanceError("Not implemented.")},this.open=function(){throw new o.SubstanceError("Not implemented.")},this.step=function(){throw new o.SubstanceError("Not implemented.")},this.forward=function(t){var e=this.versioned.getState();if(e!==t){var n=this.index.children[e];if(0!==n.length){var i;if(1===n.length)i=n[0];else if(t){var o=this.index.shortestPath(e,t);o.shift(),i=o.shift()}else i=n[n.length-1];return i?this.step(i):void 0}}},this.rewind=function(){var t,e=this.index.get(this.versioned.getState());return e.id===s?null:(t=e.parent,this.step(t))},this.merge=function(){throw new o.SubstanceError("Not implemented.")},this.manage=function(t){this.versioned=t},this.mark=function(t){this.index.setRef(t,this.versioned.getState())},this.find=function(t){return this.index.getRef(t)},this.getState=function(){return this.versioned.getState()},this.getChanges=function(t,e){var i=[],o=this.path(t,e);return n.each(o,function(t){i.push(this.index.get(t))},this),i},this.canRedo=function(){var t=this.versioned.getState(),e=this.index.children[t];return e.length>0},this.canUndo=function(){var t=this.index.get(s),e=this.index.get(this.versioned.getState());return e!==t}},l.prototype=new l.Prototype,l.PEDANTIC_RECORD=2,l.PEDANTIC_IMPORT=4,l.HYSTERICAL=l.PEDANTIC_RECORD|l.PEDANTIC_IMPORT,l.DEFAULT_MODE=l.PEDANTIC_IMPORT,l.create=function(){throw new o.SubstanceError("Not implemented.")};var p=function(){this.__id__=i.uuid(),this.changes={},this.refs={},this.children={},this.changes[s]=a,this.children[s]=[]};p.Prototype=function(){this.add=function(){throw new o.SubstanceError("Not implemented.")},this.remove=function(){throw new o.SubstanceError("Not implemented.")},this.contains=function(){throw new o.SubstanceError("Not implemented.")},this.path=function(){throw new o.SubstanceError("Not implemented.")},this.get=function(){throw new o.SubstanceError("Not implemented.")},this.getChildren=function(){throw new o.SubstanceError("Not implemented.")},this.list=function(){throw new o.SubstanceError("Not implemented.")},this.diff=function(){throw new o.SubstanceError("Not implemented.")},this.setRef=function(t,e){if(void 0===this.changes[e])throw new o.ChronicleError("Unknown change: "+e);this.refs[t]=e},this.getRef=function(t){return this.refs[t]},this.listRefs=function(){return Object.keys(this.refs)},this["import"]=function(){throw new o.SubstanceError("Not implemented.")}},p.prototype=new p.Prototype,p.INVALID="INVALID",p.ROOT=a,p.create=function(){throw new o.SubstanceError("Not implemented.")},p.adapt=function(t){return{list:function(){return n.keys(t)},get:function(e){return t[e]}}};var d=function(t){this.chronicle=t,this.state=s,t.manage(this)};d.Prototype=function(){this.apply=function(){throw new o.SubstanceError("Not implemented.")},this.revert=function(t){t=this.invert(t),this.apply(t)},this.invert=function(){throw new o.SubstanceError("Not implemented.")},this.transform=function(){throw new o.SubstanceError("Not implemented.")},this.getState=function(){return this.state},this.setState=function(t){this.state=t},this.reset=function(){this.state=s}},d.prototype=new d.Prototype,l.Change=r,l.Merge=c,l.Transformed=h,l.Diff=u,l.Index=p,l.Versioned=d,l.ROOT=s,l.mergeConflict=function(t,e){var n=new o.MergeConflict("Merge conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e));return n.a=t,n.b=e,n},e.exports=l},{"substance-util":264,underscore:269}],23:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=i.errors,r=t("./chronicle"),s=function(t,e){r.call(this,t,e)};s.Prototype=function(){var t=new s.__private__,e=r.Index.ROOT.id;this.uuid=i.uuid,this.internal_uuid=i.uuid,this.record=function(t){(this.__mode__&r.PEDANTIC_RECORD)>0&&(this.versioned.revert(t),this.versioned.apply(t));var e=this.versioned.getState(),n=this.uuid(),i=new r.Change(n,e,t);return this.index.add(i),this.versioned.setState(n),n},this.reset=function(e,n){if(n=n||this.index,!n.contains(e))throw new o.ChronicleError("Invalid argument: unknown change "+e);var i=this.versioned.getState(),r=n.shortestPath(i,e);t.applySequence.call(this,r,n)},this.open=this.reset,this.path=function(t,n){if(n){if(!t)throw new o.ChronicleError("Illegal argument: "+t);return this.index.shortestPath(t,n)}var i=this.index.shortestPath(e,t||this.versioned.getState());return i.shift(),i},this.apply=function(e){return n.isArray(e)?t.applySequence.call(this,e):t.applySequence.call(this,arguments)},this.step=function(t){var e=this.index,n=this.versioned.getState();try{var i=e.get(n);if(i.id===t)return null;var r,s=e.get(t);if(i.parent===t)r=this.versioned.invert(i.data);else{if(s.parent!==i.id)throw new o.ChronicleError("Invalid apply sequence: "+t+" is not parent or child of "+i.id);r=s.data}return this.versioned.apply(r),this.versioned.setState(t),r}catch(a){throw this.reset(n,e),a}},this.merge=function(e,n,i){if(!this.index.contains(e))throw new o.ChronicleError("Invalid argument: unknown change "+e);1==arguments.length&&(n="auto",i={}),i=i||{};var s=this.versioned.getState(),a=this.index.diff(s,e);if(!a.hasApplies())return s;if(!a.hasReverts()&&!i.no_ff)return t.applyDiff.call(this,a),this.versioned.getState();var c;if("mine"===n)c=new r.Merge(this.uuid(),s,[s,e]);else if("theirs"===n)c=new r.Merge(this.uuid(),e,[s,e]);else{if("manual"!==n)throw new o.ChronicleError("Unsupported merge strategy: "+n);if(!i.sequence)throw new o.ChronicleError("Invalid argument: sequence is missing for manual merge");var h=i.sequence;c=t.manualMerge.call(this,s,e,a,h,i)}return this.index.add(c),this.reset(c.id),c.id},this["import"]=function(e){var n=this.index["import"](e);(this.__mode__&r.PEDANTIC_IMPORT)>0&&t.importSanityCheck.call(this,n)}},s.__private__=function(){var t=this;this.applyDiff=function(e,n){if(n=n||this.index,e){var i=this.versioned.getState();if(i!==e.start())throw new o.ChronicleError("Diff can not applied on to this state. Expected: "+e.start()+", Actual: "+i);var s=null,a=[],c=[];try{var h,u,l=e.reverts(),p=e.applies();for(h=0;h<l.length;h++)u=l[h],t.revertTo.call(this,u,n),a.push(u);for(h=0;h<p.length;h++)u=p[h],t.apply.call(this,u,n),c.push(u)}catch(d){s=d}if(s&&(a.length>0||c.length>0)){var f=r.Diff.create(e.start(),a,c),g=f.inverted();try{t.applyDiff.call(this,g,n)}catch(d){console.log("Ohohhhh.... could not rollback partially applied diff.","Without bugs and in HYSTERICAL mode this should not happen.","Resetting to original state"),this.versioned.reset(),this.reset(i,n)}}if(s)throw s}},this.applySequence=function(e,i){i=i||this.index;var r=this.versioned.getState();try{var s=i.get(r);n.each(e,function(e){if(s.id!==e){var n=i.get(e);if(s.parent===e)t.revertTo.call(this,e,i);else{if(n.parent!==s.id)throw new o.ChronicleError("Invalid apply sequence: "+e+" is not parent or child of "+s.id);t.apply.call(this,e,i)}s=n}},this)}catch(a){throw this.reset(r,i),a}},this.revertTo=function(t,e){e=e||this.index;var n=this.versioned.getState(),i=e.get(n);if(!i)throw new o.ChangeError("Illegal state. 'head' is unknown: "+n);if(i.parent!==t)throw new o.ChangeError("Can not revert: change is not parent of current");i.data&&this.versioned.revert(i.data),this.versioned.setState(t)},this.apply=function(t,e){e=e||this.index;var n=e.get(t);if(!n)throw new o.ChangeError("Illegal argument. change is unknown: "+t);n.data&&this.versioned.apply(n.data),this.versioned.setState(t)},this.eliminate=function(e,n,i,s,a){if(!(s instanceof r.TmpIndex))throw new o.ChronicleError("'eliminate' must be called on a TmpIndex instance");var c,h,u=s.get(n),l=s.get(e);return c=new r.Change(this.internal_uuid(),n,this.versioned.invert(u.data)),s.add(c),h=t.rebase0.call(this,c.id,l.id,i,s,a,!0),s.reconnect(h,u.parent),l=s.get(h),l.id},this.rebase0=function(t,e,n,i,s,a){i=i||this.index;var c=i.get(t),h=i.get(e);if(c.parent!==h.parent)throw new o.ChronicleError("Illegal arguments: principal rebase can only be applied on siblings.");for(var u,l,p,d,f,g=[[c.data,c.id,h]],v=null,y=[];g.length>0;){u=g.pop(),l=u[0],t=u[1],h=u[2],p=h.data;var m;if(h instanceof r.Merge)m=[l],d=new r.Merge(this.uuid(),t,h.branches),y.push(d);else{m=this.versioned.transform(l,p,{check:a});var w=h instanceof r.Transformed?h.original:h.id;d=new r.Transformed(this.internal_uuid(),t,m[1],w),n[w]=d.id}n[h.id]=d.id,v||(v=d),i.add(d);var _=i.getChildren(h.id);for(f=0;f<_.length;f++){var b=i.get(_[f]);if(s){var C=b instanceof r.Transformed?b.original:b.id;if(!s[C])continue}g.unshift([m[0],d.id,b])}}for(f=0;f<y.length;f++){for(var x=y[f],P=[],E=0;E<x.branches.length;E++)P.push(n[x.branches[E]]);x.branches=P}return v.id},this.eliminateToSelection=function(e,i,o,s){var a=new r.TmpIndex(s),c=n.intersection(e,i);if(0===c.length)return null;var h=n.difference(e,i).reverse();if(0===h.length)return o[c[0]];for(var u,l,p,d=0,f=0,g=null;d<e.length&&f<h.length;)l=e[e.length-1-d],p=h[f],l===p?(g&&(g=t.eliminate.call(this,g,l,o,a,o)),d++,f++):(g=l,d++);for(u=0;u<c.length;u++)l=c[u],a.save(o[l]);return o[c[0]]},this.manualMerge=function(e,i,s,a,c){if(0===a.length)throw new o.ChronicleError("Nothing selected for merge.");var h=n.intersection(a,s.sequence());if(h.length!==a.length)throw new o.ChronicleError("Illegal merge selection: contains changes that are not contained in the merged branches.");var u=new r.TmpIndex(this.index),l=s.mine(),p=s.theirs(),d=n.object(a,a);t.eliminateToSelection.call(this,l,a,d,u),t.eliminateToSelection.call(this,p,a,d,u),l=n.intersection(l,a),p=n.intersection(p,a);for(var f=0;f<a.length;f++){var g,v,y=a[f];if(0===l.length||0===p.length)break;if(l[0]===y)l.shift(),g=d[y],v=d[p[0]];else{if(p[0]!==y)throw new o.ChronicleError("Reordering of commmits is not supported.");p.shift(),g=d[y],v=d[l[0]]}t.rebase0.call(this,g,v,d,u,null,!c.force)}var m=d[n.last(a)];try{this.reset(m,u)}catch(w){throw this.reset(e,u),w}for(f=0;f<a.length;f++)u.save(d[a[f]]);return new r.Merge(this.uuid(),m,[e,i])},this.importSanityCheck=function(t){var e,n=this.versioned.getState(),i=null;try{for(e=0;e<t.length;e++)this.reset(t[e])}catch(r){i=r,console.log(i.stack)}if(this.reset(n),i){for(t.reverse(),e=0;e<t.length;e++)this.index.remove(t[e]);if(i)throw new o.ChronicleError("Import did not pass sanity check: "+i.toString())}}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,s.create=function(t){t=t||{};var e=r.Index.create(t);return new s(e,t)},e.exports=s},{"./chronicle":22,"substance-util":264,underscore:269}],24:[function(t,e){var n=t("underscore"),i=t("./chronicle"),o=function(t){this.data=t};o.Prototype=function(){this.reverts=function(){return this.data[1].slice(1,this.data[0]+1)},this.applies=function(){return this.data[1].slice(this.data[0]+1)},this.hasReverts=function(){return this.data[0]>0},this.hasApplies=function(){return this.data[1].length-1-this.data[0]>0},this.start=function(){return this.data[1][0]},this.end=function(){return n.last(this.data[1])},this.root=function(){return this.data[1][this.data[0]]},this.sequence=function(){return this.data[1].slice(0)},this.mine=function(){return this.data[1].slice(0,this.data[0]).reverse()},this.theirs=function(){return this.applies()},this.inverted=function(){return new o([this.data[1].length-1-this.data[0],this.data[1].slice(0).reverse()])},this.toJSON=function(){return{data:this.data}}},o.Prototype.prototype=i.Diff.prototype,o.prototype=new o.Prototype,o.create=function(t,e,n){return new o([e.length,[t].concat(e).concat(n)])},e.exports=o},{"./chronicle":22,underscore:269}],25:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=i.errors,r=t("./chronicle"),s=function(){r.Index.call(this)};s.Prototype=function(){var t=new s.__private__,e=r.ROOT;this.add=function(t){t.data=i.freeze(t.data);var e=t.id;if(!t.parent)throw new o.ChronicleError("Change does not have a parent.");if(!this.contains(t.parent))throw new o.ChronicleError("Illegal change: parent is unknown - change="+e+", parent="+t.parent);this.changes[e]=t,this.children[e]=[],this.children[t.parent]||(this.children[t.parent]=[]),this.children[t.parent].push(e)},this.remove=function(t){if(this.children[t].length>0)throw new o.ChronicleError("Can not remove: other changes depend on it.");var e=this.changes[t];delete this.changes[t],delete this.children[t],this.children[e.parent]=n.without(this.children[e.parent],t)},this.contains=function(t){return!!this.changes[t]},this.get=function(t){return this.changes[t]},this.list=function(){return n.keys(this.changes)},this.getChildren=function(t){return this.children[t]},this.diff=function(n,i){var o,s,a=t.getPathToRoot.call(this,n),c=t.getPathToRoot.call(this,i),h=[],u=[],l={};for(s=0;s<c.length;s++)l[c[s]]=!0;for(s=0;s<a.length&&(o=a[s],s>0&&h.push(o),!l[o]);s++);var p=o;for(s=0;s<c.length&&(o=c[s],o!==p&&o!==e);s++)u.unshift(o);return r.Diff.create(n,h,u)},this.shortestPath=function(n,i){if(n===i)return[];if(i===e)return t.getPathToRoot.call(this,n).slice(1);if(n===e)return t.getPathToRoot.call(this,i).reverse().slice(1);for(var r,s,a,c,h,u,l,p={},d=[[n,n]];d.length>0;)if(r=d.shift(),s=r[0],a=r[1],c=this.get(a),!p[a]){if(p[a]=s,a===i){for(var f,g=[];a!==n;)if(g.unshift(a),f=p[a],p[a]=null,a=f,!a)throw new o.SubstanceError("Illegal state: bug in implementation of Index.shortestPath.");return g}for(p[c.parent]||d.push([a,c.parent]),l=this.getChildren(a),h=0;h<l.length;h++)u=l[h],p[u]||d.push([a,u])}throw new o.SubstanceError("Illegal state: no path found.")},this["import"]=function(e){var i=n.difference(e.list(),this.list());if(0!==i.length){var o=t.computeDependencyOrder.call(this,e,i);i.sort(function(t,e){return o[t]-o[e]});for(var r=0;r<i.length;r++)this.add(e.get(i[r]));return i}},this.foreach=function(t,e){e=e||"ROOT";for(var n,i,o=[e];o.length>0;){n=o.shift(),i=this.get(n),t(i);for(var r=this.children[n],s=0;s<r.length;s++)o.push(r[s])}}},s.__private__=function(){var t=r.ROOT;this.getPathToRoot=function(e){var n=[];if(e===t)return n;var i=this.get(e);if(!i)throw new o.ChronicleError("Unknown change: "+e);for(var r;;){if(n.push(i.id),i.id===t)break;r=i.parent,i=this.get(r)}return n},this.computeDependencyOrder=function(e,n){function i(n){if(o[n])return o[n];if(n===t)return 0;var r=e.get(n),s=i(r.parent)+1;return o[n]=s,s}for(var o={},r=0;r<n.length;r++)i(n[r]);return o}},s.Prototype.prototype=r.Index.prototype,s.prototype=new s.Prototype;var a=function(t,e){t.store=e,t.__changes__=e.hash("changes"),t.__refs__=e.hash("refs"),t.__changes__.list=t.__changes__.keys;var i=t.add;t.add=function(t){i.call(this,t),this.__changes__.set(t.id,t)};var o=t.remove;t.remove=function(t){o.call(this,t),this.__changes__["delete"](t)};var r=t.setRef;t.setRef=function(t,e){r.call(this,t,e),this.__refs__.set(t,e)},t.load=function(){this["import"](this.__changes__),n.each(this.__refs__.keys(),function(t){this.setRef(t,this.__refs__.get(t))},this)},t.load()};s.create=function(t){t=t||{};var e=new s;return t.store&&a(e,t.store),e},e.exports=s},{"./chronicle":22,"substance-util":264,underscore:269}],26:[function(t,e){"use strict";var n=t("substance-util"),i=t("./chronicle"),o=t("substance-operator").TextOperation,r=function(t,e){i.Versioned.call(this,t),this.doc=e};r.Prototype=function(){var t=n.prototype(this);this.apply=function(t){this.doc.setText(t.apply(this.doc.getText()))},this.invert=function(t){return t.invert()},this.transform=function(t,e,n){return o.transform(t,e,n)},this.reset=function(){t.reset.call(this),this.doc.setText("")}},r.Prototype.prototype=i.Versioned.prototype,r.prototype=new r.Prototype,e.exports=r},{"./chronicle":22,"substance-operator":246,"substance-util":264}],27:[function(t,e){var n=t("underscore"),i=t("substance-util"),o=i.errors,r=t("./index_impl"),s=function(t){r.call(this),this.index=t};s.Prototype=function(){var t=i.prototype(this);this.get=function(e){return t.contains.call(this,e)?t.get.call(this,e):this.index.get(e)},this.contains=function(e){return t.contains.call(this,e)||this.index.contains(e)},this.getChildren=function(e){var n=t.getChildren.call(this,e)||[];return this.index.contains(e)&&(n=n.concat(this.index.getChildren(e))),n},this.list=function(){return t.list.call(this).concat(this.index.list())},this.save=function(t,e){if(e)for(var n,i,o=[t];o.length>0;){n=o.pop(),i=this.changes[n],this.changes[n]&&this.index.add(i);for(var r=0;r<i.children;r++)o.unshift(i.children[r])}else this.changes[t]&&this.index.add(this.changes[t])},this.reconnect=function(t,e){if(!this.changes[t])throw new o.ChronicleError("Change does not exist to this index.");var i=this.get(t);if(!this.contains(e))throw new o.ChronicleError("Illegal change: parent is unknown parent="+e);this.children[i.parent]||(this.children[i.parent]=[]),this.children[i.parent]=n.without(this.children[i.parent],i.id),i.parent=e,this.children[i.parent]||(this.children[i.parent]=[]),this.children[i.parent].push(t)}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,e.exports=s},{"./index_impl":25,"substance-util":264,underscore:269}],28:[function(t,e){"use strict";e.exports={Keyboard:t("./src/keyboard"),ChromeKeyboard:t("./src/chrome_keyboard")}},{"./src/chrome_keyboard":29,"./src/keyboard":31}],29:[function(t,e){"use strict";function n(t,e,n){t.addEventListener?t.addEventListener(e,n,!0):t.attachEvent("on"+e,n)}function i(t,e,n){t.removeEventListener?t.removeEventListener(e,n,!0):t.detachEvent("on"+e,n)}var o=t("underscore"),r=t("substance-util"),s=function(e,n){if(this.keytable=n,this.map=e,this.registry={},!n){var i=t("./default_keytable.js");this.keytable=new i}this.__registeredKeyCodes={keypress:{},keyup:{},keydown:{}},this.defaultHandlers={keypress:this.PASS,keyup:this.BLOCK,keydown:this.PASS}};s.Prototype=function(){this.PASS=function(){},this.BLOCK=function(t){t.preventDefault(),t.stopPropagation()};for(var t=["ctrlKey","metaKey","shiftKey","altKey","altGraphKey"],e={},s=0;s<t.length;s++)e[t[s]]=s;var a={ctrl:"ctrlKey",command:"metaKey",shift:"shiftKey",alt:"altKey","alt-gr":"altGraphKey"},c={};o.each(a,function(t,e){c[t]=e}),this.defaultHandler=function(t){t.preventDefault()};var h=function(e,n,i){if(!i)return null;for(var o=i,r=0;r<t.length;r++){var s=t[r];if(n[s]&&(o=o[s]),!o)return null}if(o){var a=n.keyCode;return"keypress"===n.type&&(a=n.keyCode||e.keytable.table[String.fromCharCode(n.which)]),o[a]}return null};this.handleKeyPress=function(t){var e="keypress";if(String.fromCharCode(t.which)){var n=h(this,t,this.registry[e]);if(n)try{n(t)}catch(i){throw this.BLOCK(t),console.error(i.message),r.printStackTrace(i),i}else this.defaultHandlers[e]&&this.defaultHandlers[e](t)}else{if(!this.defaultHandlers[e])throw new Error("No default handler for: "+e);this.defaultHandlers[e](t)}},this.handleKey=function(t,e){if(this.__registeredKeyCodes[t][e.keyCode]){var n=h(this,e,this.registry[t]);if(n)try{n(e)}catch(i){throw this.BLOCK(e),console.error(i.message),r.printStackTrace(i),i}}else{if(!this.defaultHandlers[t])throw new Error("No default handler for: "+t);this.defaultHandlers[t](e)}},this.connect=function(t){this.el=t,this.__onKeyPress=this.handleKeyPress.bind(this),this.__onKeyUp=this.handleKey.bind(this,"keyup"),this.__onKeyDown=this.handleKey.bind(this,"keydown"),n(t,"keypress",this.__onKeyPress),n(t,"keydown",this.__onKeyDown),n(t,"keyup",this.__onKeyUp)},this.disconnect=function(){i(this.el,"keypress",this.__onKeyPress),i(this.el,"keydown",this.__onKeyDown),i(this.el,"keyup",this.__onKeyUp)},this.setDefaultHandler=function(t,e){1===arguments.length?o.each(this.defaultHandlers,function(t,e){this.defaultHandlers[e]=arguments[0]},this):this.defaultHandlers[t]=e},this.bindSingle=function(t,n,i){if(["keypress","keydown","keyup"].indexOf(n)<0)throw new Error("Expecting keyboard event type as second argument.");if(!o.isFunction(i))throw new Error("Expecting function handler as third argument.");var r,s,c,h=[];for(r=0;r<t.length-1;r++){if(c=t[r],s=a[c],!s)throw new Error("Unknown modifier: "+c);h.push(s)}var u=o.last(t),l=this.keytable.getKeyCode(u);if(o.isArray(l)){for(r=0;r<l.length-1;r++){if(c=l[r],s=a[c],!s)throw new Error("Unknown modifier: "+c);h.push(s)}l=o.last(l)}h.sort(function(t,n){return e[t]-e[n]}),this.registry[n]=this.registry[n]||{};var p=this.registry[n];for(r=0;r<h.length;r++)s=h[r],p[s]=p[s]||{},p=p[s];p[l]=i,this.__registeredKeyCodes[n][l]=!0},this.bindAll=function(t,e,n){for(var i=0;i<t.length;i++)this.bindSingle(t[i],e,n)},this.bind=function(t,e,n){var i;o.isString(t)?(i=this.compileMapping(t),this.bindAll(i,e,n)):this.bindSingle(t,e,n)},this.pass=function(t){var e;e=o.isString(t)?this.compileMapping(t):[t],this.bindAll(e,"keyup",this.PASS),this.bindAll(e,"keydown",this.PASS),this.bindAll(e,"keypress",this.PASS)},this.compileMapping=function(t){var e=[],n=this.map[t];if(!n)return console.error("No keyboard mappings available for",t),e;for(var i=0;i<n.length;i++){var o=n[i],r=o.split("+");e.push(r)}return e},this.describeEvent=function(e){for(var n=[],i=0;i<t.length;i++){var o=t[i];e[o]===!0&&n.push(c[o])}return n.push(this.keytable.getKeyName(e.keyCode)),n.join("+")}},s.prototype=new s.Prototype,e.exports=s},{"./default_keytable.js":30,"substance-util":264,underscore:269}],30:[function(t,e){"use strict";var n=t("underscore"),i=function(){};i.Prototype=function(){(function(){var t;for(this.table={},t=0;26>t;t++){var e=t+65,i=String.fromCharCode(e).toUpperCase(),o=String.fromCharCode(e).toLowerCase();this.table[i]=e,this.table[o]=e}for(t=0;10>t;t++)this.table[""+t]=48+t;for(t=1;13>t;t++)this.table["f"+t]=111+t;n.extend(this.table,{"*":106,"+":107,"-":109,".":110,"/":111,";":186,"=":187,",":188,"`":192,"[":219,"\\":220,"]":221,'"':222,special:229}),n.extend(this.table,{backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,capslock:20,esc:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,del:46}),this.inverseTable={},n.each(this.table,function(t,e){this.inverseTable[t]=e},this)}).call(this);this.getKeyCode=function(t){if(void 0!==this.table[t])return this.table[t];throw new Error("Unknown key: "+t)},this.getKeyName=function(t){return void 0!==this.inverseTable[t]?this.inverseTable[t]:"native("+t+")"}},i.prototype=new i.Prototype,e.exports=i},{underscore:269}],31:[function(t,e){"use strict";function n(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent("on"+e,n)}function i(t,e,n){t.removeEventListener?t.removeEventListener(e,n,!1):t.detachEvent("on"+e,n)}function o(t){if("keypress"==t.type){var e=String.fromCharCode(t.which);return t.shiftKey||(e=e.toLowerCase()),e}return h[t.which]?h[t.which]:u[t.which]?u[t.which]:String.fromCharCode(t.which).toLowerCase()}function r(t,e){return t.sort().join(",")===e.sort().join(",")}function s(t){var e=[];return t.shiftKey&&e.push("shift"),t.altKey&&e.push("alt"),t.ctrlKey&&e.push("ctrl"),t.metaKey&&e.push("meta"),e}function a(t){return"shift"==t||"ctrl"==t||"alt"==t||"meta"==t}function c(t){return"+"===t?["+"]:t.split("+")}for(var h={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},u={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},l={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},p={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(window.navigator.platform)?"meta":"ctrl"},d=1;20>d;++d)h[111+d]="f"+d;for(d=0;9>=d;++d)h[d+96]=d;var f=function(t){this._REVERSE_MAP={},this._callbacks={},this._directMap={},this._sequenceLevels={},this._resetTimer=null,this._ignoreNextKeyup=!1,this._ignoreNextKeypress=!1,this._nextExpectedAction=!1,this._handler=this._handleKeyEvent.bind(this),this.keymap=t};f.Prototype=function(){function t(t){t=t||{};var e,n=!1;for(e in this._sequenceLevels)t[e]?n=!0:this._sequenceLevels[e]=0;n||(this._nextExpectedAction=!1)}function e(t,e,n,i,o,s){var c,h,u=[],l=n.type;if(!this._callbacks[t])return[];for("keyup"==l&&a(t)&&(e=[t]),c=0;c<this._callbacks[t].length;++c)if(h=this._callbacks[t][c],(i||!h.seq||this._sequenceLevels[h.seq]==h.level)&&l==h.action&&("keypress"==l&&!n.metaKey&&!n.ctrlKey||r(e,h.modifiers))){var p=!i&&h.combo==o,d=i&&h.seq==i&&h.level==s;(p||d)&&this._callbacks[t].splice(c,1),u.push(h)}return u}function u(t,e,n){this.NOT_IN_EDITABLES&&this.stopCallback(e,e.target||e.srcElement,n)||t.call(t.self,e,n)===!1&&(e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,e.cancelBubble=!0)}function d(t,e){var n,i,o,r=[];for(n=c(t),o=0;o<n.length;++o)i=n[o],p[i]&&(i=p[i]),e&&"keypress"!=e&&l[i]&&(i=l[i],r.push("shift")),a(i)&&r.push(i);return e=w.call(this,i,r,e),{key:i,modifiers:r,action:e}}function g(t,n,i,o,r){this._directMap[t+":"+i]=n,t=t.replace(/\s+/g," ");var s,a=t.split(" ");return a.length>1?void _.call(this,t,a,n,i):(s=d.call(this,t,i),this._callbacks[s.key]=this._callbacks[s.key]||[],e.call(this,s.key,s.modifiers,{type:s.action},o,t,r),void this._callbacks[s.key][o?"unshift":"push"]({callback:n,modifiers:s.modifiers,action:s.action,seq:o,level:r,combo:t}))}function v(t,e,n){for(var i=0;i<t.length;++i)g.call(this,t[i],e,n)}function y(){clearTimeout(this._resetTimer),this._resetTimer=setTimeout(t.bind(this),1e3)}function m(){if(!this._REVERSE_MAP){this._REVERSE_MAP={};for(var t in h)t>95&&112>t||h.hasOwnProperty(t)&&(this._REVERSE_MAP[h[t]]=t)}return this._REVERSE_MAP}function w(t,e,n){return n||(n=m.call(this)[t]?"keydown":"keypress"),"keypress"==n&&e.length&&(n="keydown"),n}function _(e,n,i,r){function s(t){return function(){c._nextExpectedAction=t,++c._sequenceLevels[e],y.call(c)}}function a(n){u.call(this,i,n,e),"keyup"!==r&&(this._ignoreNextKeyup=o(n)),setTimeout(t.bind(this),10)}var c=this;this._sequenceLevels[e]=0;for(var h=0;h<n.length;++h){var l=h+1===n.length,p=l?a:s.call(this,r||d(n[h+1]).action);g.call(this,n[h],p,r,e,h)}}this.handleKey=function(n,i,o){var r,s=e.call(this,n,i,o),c={},h=0,l=!1;for(r=0;r<s.length;++r)s[r].seq&&(h=Math.max(h,s[r].level));for(r=0;r<s.length;++r)if(s[r].seq){if(s[r].level!=h)continue;l=!0,c[s[r].seq]=1,u.call(this,s[r].callback,o,s[r].combo)}else f.TRIGGER_PREFIX_COMBOS?u.call(this,s[r].callback,o,s[r].combo):l||u.call(this,s[r].callback,o,s[r].combo);var p="keypress"==o.type&&this._ignoreNextKeypress;return o.type!=this._nextExpectedAction||a(n)||p||t.call(this,c),this._ignoreNextKeypress=l&&"keydown"==o.type,s.length>0},this._handleKeyEvent=function(t){"number"!=typeof t.which&&(t.which=t.keyCode);var e=o(t);if(e)return"keyup"==t.type&&this._ignoreNextKeyup===e?void(this._ignoreNextKeyup=!1):void this.handleKey(e,s(t),t)},this.bind=function(t,e,n,i){return e.self=i,t=t instanceof Array?t:[t],v.call(this,t,e,n),this},this.bindMapped=function(t,e,n,i){return this.bind(this.keymap[t],e,n,i)},this.trigger=function(t,e){return this._directMap[t+":"+e]&&this._directMap[t+":"+e].call(this,{},t),this},this.reset=function(){return this._callbacks={},this._directMap={},this},this.stopCallback=function(t,e){return(" "+e.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==e.tagName||"SELECT"==e.tagName||"TEXTAREA"==e.tagName||e.contentEditable&&"true"==e.contentEditable},this.connect=function(t){n(t,"keypress",this._handler),n(t,"keydown",this._handler),n(t,"keyup",this._handler)},this.disconnect=function(t){i(t,"keypress",this._handler),i(t,"keydown",this._handler),i(t,"keyup",this._handler)},this.TRIGGER_PREFIX_COMBOS=!1,this.NOT_IN_EDITABLES=!1},f.prototype=new f.Prototype,e.exports=f},{}],32:[function(t,e){var n=t("../src/composer");n.WebShell=t("../src/shells/web_shell"),e.exports=n},{"../src/composer":40,"../src/shells/web_shell":111}],33:[function(t,e){"use strict";e.exports=t("./src/composer")},{"./src/composer":40}],34:[function(t,e){"use strict";var n=t("underscore"),i=window.$,o=t("substance-application").View,r=t("substance-application").$$,s=t("substance-util"),a=function(t,e){o.call(this),this.surface=t,this.writerCtrl=e,this.document=e.document,this.el.classList.add("annotation-bar"),this.containerName=t.getContainer().name,this.fragmentElements={},this.el.setAttribute("contenteditable","false"),this.$el.click(".highlight",this.onClickHighlight.bind(this)),this.listenTo(this.document,"operation:applied",this.onGraphUpdate),this.leftRangeHandle=r("span.range-handle.left",{children:[r("span.range-handle-container",{children:[r("i.icon-caret-up")]})],contentEditable:!1}),this.rightRangeHandle=r("span.range-handle.right",{children:[r("span.range-handle-container",{children:[r("i.icon-caret-up")]})],contentEditable:!1})};a.Prototype=function(){n.extend(this,s.Events),this.update=function(){var t=this.writerCtrl.state;if(i(this.leftRangeHandle).remove(),i(this.rightRangeHandle).remove(),t&&(i(".annotation_fragment.subject_reference").removeClass("highlighted"),i(".annotation-bar .highlight").removeClass("active"),t.subjectReferenceId)){var e=this.getFragmentElements(t.subjectReferenceId),o=this.$(".highlight[data-annotation-id="+t.subjectReferenceId+"]");o.addClass("active"),i(e).addClass("highlighted"),e&&e.length>0&&(e[0].insertBefore(this.leftRangeHandle,e[0].firstChild),n.last(e).appendChild(this.rightRangeHandle))}},this.render=function(){i(this.el).empty();for(var t=this.document.getIndex("multi_annotations").get(this.containerName),e=Object.keys(t),n=this.surface.el.getBoundingClientRect().top,o=this.surface.el.scrollTop,s=0;s<e.length;s++){for(var a=e[s],c=this.getFragmentElements(a),h=Number.MAX_VALUE,u=0,l=0;l<c.length;l++){var p=c[l],d=p.getBoundingClientRect();h=Math.min(h,d.top),u=Math.max(u,d.bottom)}var f=r("div.highlight"),g=h-n+o,v=u-h;f.dataset.annotationId=a,f.style.top=g+"px",f.style.height=v+"px",this.el.appendChild(f),this.fragmentElements[a]=c}this.update()},this.getFragmentElements=function(t){var e=this.document.getAnnotationFragments(t),i=Object.keys(e),o=[];return n.each(i,function(t){var e=this.surface.el.querySelectorAll(".annotation."+t);if(e&&e.length>0)for(var n=0;n<e.length;n++)o.push(e[n]);else console.log("Could not find element for fragment",t)},this),o},this.onClickHighlight=function(t){var e=t.target,i=this.document.get(e.dataset.annotationId),o=n.clone(this.writerCtrl.state);o.subjectReferenceId===i.id?this.writerCtrl.switchState({id:"main",contextId:o.contextId},{"no-scroll":!0,updateRoute:!0,replace:!0}):this.writerCtrl.switchState({id:"main",contextId:"subjects",subjectReferenceId:i.id},{updateRoute:!0,replace:!0}),t.preventDefault()},this.onGraphUpdate=function(t){if(("create"===t.type||"delete"===t.type)&&this.document.schema.isInstanceOf(t.val.type,"multi_annotation")){console.log("AnnotationBar.onGraphUpdate");var e=this;window.setTimeout(function(){"create"===t.type&&e.document.get(t.val.id).addFragments(),e.render()},0)}}},a.Prototype.prototype=o.prototype,a.prototype=new a.Prototype,a.prototype.constructor=a,e.exports=a},{"substance-application":6,"substance-util":264,underscore:269}],35:[function(t,e){"use strict";var n=t("substance-article"),i=t("../editable_article"),o=t("substance-chronicle"),r=t("substance-util"),s=function(){};s.Prototype=function(){this.createFromJSON=function(t){var e=i.fromSnapshot(t,{chronicle:o.create()});return e},this.createEmptyDoc=function(){return s.createEmptyDoc()}},s.createEmptyDoc=function(){var t=r.uuid(),e={id:t,schema:[n.SCHEMA_ID,n.SCHEMA_VERSION],nodes:{document:{id:"document",type:"document",views:["content","citations","remarks","info"],license:"licence",guid:t,creator:"",title:"Untitled",authors:[],"abstract":"",created_at:(new Date).toJSON(),updated_at:(new Date).toJSON(),published_on:(new Date).toJSON()},cover:{id:"cover",type:"cover",authors:[]},content:{type:"view",id:"content",nodes:["cover","text1"]},citations:{type:"view",id:"citations",nodes:[]},remarks:{type:"view",id:"remarks",nodes:[]},info:{type:"view",id:"info",nodes:["publication_info","interview_subject","interview_conductor","interview_operator","interview_sound_operator"]},text1:{type:"text",id:"text1",content:""},publication_info:{id:"publication_info",type:"publication_info"},interview_subject:{type:"interview_subject",id:"interview_subject",name:"The Interviewed",role:"Interview Subject",forced_labor:"intracamp work; earthworks (construction of barracks); digging tunnels for military factories",categories:["Ost arbeiter","Cocentration camp worker"],prisons:["location_komorn"],movement:[{location:"location_danzig",density:33},{location:"location_komorn",density:67}],description:"",image:""},interview_conductor:{type:"contributor",id:"interview_conductor",source_id:"",name:"Daniel Beilinson",role:"Interview Conductor",description:"",image:""},interview_operator:{type:"contributor",id:"interview_operator",source_id:"",name:"Oliver Buchtala",role:"Operator",description:"",image:""},interview_sound_operator:{type:"contributor",id:"interview_sound_operator",source_id:"",name:"Michael Aufreiter",role:"Sound Operator",description:"",image:""},license:{id:"license",type:"license",name:"None",code:"none",description:"",version:"1.0",url:""}}},s=new i({seed:e,chronicle:o.create()});
return s},s.prototype=new s.Prototype,e.exports=s},{"../editable_article":51,"substance-article":13,"substance-chronicle":19,"substance-util":264}],36:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=function(){};o.Prototype=function(){this.getSize=function(){throw new Error("FileWrapper.getSize() is abstract")},this.getName=function(){throw new Error("FileWrapper.getSize() is abstract")},this.getType=function(){throw new Error("FileWrapper.getSize() is abstract")},this.getExtension=function(){return n.last(this.name.split("."))||this.type.split("/")[1]},this.getData=function(){throw new Error("FileWrapper.getData() is abstract")},this.asText=function(){throw new Error("FileWrapper.asText() is abstract")},this.initialize=function(){throw new Error("FileWrapper.initialize() is abstract")}},o.prototype=new o.Prototype,Object.defineProperties(o.prototype,{size:{get:function(){return this.getSize()},set:function(){throw new Error("FileWrapper.size is read-only")}},name:{get:function(){return this.getName()},set:function(){throw new Error("FileWrapper.name is read-only")}},type:{get:function(){return this.getType()},set:function(){throw new Error("FileWrapper.type is read-only")}},extension:{get:function(){return this.getExtension()},set:function(){throw new Error("FileWrapper.extension is read-only")}},data:{get:function(){return this.getData()},set:function(){throw new Error("FileWrapper.data is read-only")}},text:{get:function(){return this.asText()},set:function(){throw new Error("FileWrapper.text is read-only")}}}),o.wrapFiles=function(t,e,o){var r=[],s=[];n.each(e,function(e){r.push(function(n){var i=new t(e);i.initialize(function(t){return t?n(t):(s.push(i),void n(null))})})}),i.async.sequential({functions:r},function(t){o(t,s)})},e.exports=o},{"substance-util":264,underscore:269}],37:[function(t,e){"use strict";var n=t("./document_factory"),i=t("substance-util").zip,o=function(){this.documentFactory=new n};o.Prototype=function(){this.newDocument=function(){return this.documentFactory.createEmptyDoc()},this.open=function(){console.error("Abstract interface has not been implemented")},this.save=function(){console.error("Abstract interface has not been implemented")},this.readFromArrayBuffer=function(t,e){try{var n=i.unzipFromArrayBuffer(t,this.documentFactory);e(null,n)}catch(o){e(o)}}},o.prototype=new o.Prototype,e.exports=o},{"./document_factory":35,"substance-util":264}],38:[function(t,e){"use strict";var n=t("./generic_backend"),i=t("substance-util").zip,o=(t("./document_factory"),function(){n.call(this)});o.Prototype=function(){this.open=function(t,e){var n=window.localStorage.getItem(t);if(n){var o=i.unzipFromBase64(n,this.documentFactory);e(null,o)}else{var o=this.newDocument();e(null,o)}},this.save=function(t,e,n){i.zip(t,function(t,i){if(t)return n(t);try{var o=i.generate({type:"base64"});window.localStorage.setItem(e,o),n(null)}catch(t){n(t)}})}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"./document_factory":35,"./generic_backend":37,"substance-util":264}],39:[function(t,e){(function(n){"use strict";var i=t("./file_wrapper"),o=function(t,e){if(i.call(this,e),!t instanceof window.File)throw new Error("Invalid argument: expecting file of type window.File");this._file=t,this._data=null};o.Prototype=function(){this.getSize=function(){return this._file.size},this.getName=function(){return this._file.name},this.getType=function(){return this._file.type},this.initialize=function(t){var e=this,i=new window.FileReader;i.onload=function(i){e._data=new n.Uint8Array(i.target.result),t(null)},i.readAsArrayBuffer(this._file)},this.getData=function(){return this._data},this.asText=function(){return String.fromCharCode.apply(null,this._data)}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.wrapFiles=function(t,e){return i.wrapFiles(o,t,e)},e.exports=o}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./file_wrapper":36}],40:[function(t,e){"use strict";var n=t("substance-application"),i=t("./composer_controller"),o=t("./composer_router"),r=t("./writer_controller"),s=t("./writer_view"),a=t("./panels/panel"),c=t("./panels/panel_view"),h=t("./panels/panel_controller"),u=t("./workflows/workflow.js"),l=t("./panels/nodes_panel_controller"),p=t("./panels/nodes_panel_view"),d=t("./editable_article"),f=function(t){n.call(this,t),this.controller=new i(this,t);var e=new o(this);this.setRouter(e)};f.Prototype=function(){this.render=function(){this.view=this.controller.createView(),this.$el.replaceWith(this.view.render().el)},this.start=function(t){n.prototype.start.call(this,t),this.controller.shell.attachComposer(this)},this.newDocument=function(){this.controller.newDocument(function(t){t?console.error(t):console.log("successfully created new doc")})},this.open=function(t){this.controller.openDocument(t,function(t){t?console.error(t):console.log("successfully opened doc")})},this.save=function(){this.controller.save(function(t){t?console.error(t):console.log("successfully saved doc")})},this.saveAs=function(){this.controller.saveAs(function(t){t?console.error(t):console.log("successfully saved under new file path")})},this.saveToFolder=function(){this.controller.saveToFolder(function(t){t?console.error(t):console.log("successfully saved at folder")})},this.sendError=function(t){this.controller.sendError(t)},this.undo=function(){this.controller.undo()},this.redo=function(){this.controller.redo()},this.cut=function(){this.controller.cut()},this.copy=function(){this.controller.copy()},this.paste=function(){this.controller.paste()},this.selectAll=function(){this.controller.selectAll()}},f.Prototype.prototype=n.prototype,f.prototype=new f.Prototype,f.prototype.constructor=f,f.WriterController=r,f.WriterView=s,f.Controller=i,f.ComposerController=i,f.EditableArticle=d,f.Panel=a,f.PanelController=h,f.PanelView=c,f.NodesPanelController=l,f.NodesPanelView=p,f.Workflow=u,f.defaultWorkflows=t("./default_workflows"),f.defaultTools=t("./default_tools"),e.exports=f},{"./composer_controller":41,"./composer_router":43,"./default_tools":49,"./default_workflows":50,"./editable_article":51,"./panels/nodes_panel_controller":100,"./panels/nodes_panel_view":101,"./panels/panel":102,"./panels/panel_controller":103,"./panels/panel_view":104,"./workflows/workflow.js":117,"./writer_controller":118,"./writer_view":119,"substance-application":6}],41:[function(t,e){"use strict";var n=t("substance-application").Controller,i=t("./writer_controller"),o=t("./composer_view"),r=t("underscore"),s=t("substance-commander"),a=s.ChromeKeyboard,c=t("substance-util"),h=t("./publish/publish_controller"),u={updateRoute:!0,replace:!0},l=function(t,e){this.app=t,this.shell=e.shell,this.panels=e.panels||[],this.workflows=e.workflows||[],this.tools=e.tools||[],this.doc=null;var n=this,o=i._getDefaultKeyMap();this.keyboard=new a(o),this.keyboard.setDefaultHandler(this.keyboard.PASS),this.keyboard.bind("preview","keydown",function(t){n.showPublish(),t.preventDefault(),t.stopPropagation()}),this.keyboard.bind("edit","keydown",function(t){n.showEdit(),t.preventDefault(),t.stopPropagation()}),this.keyboard.bind("undo","keydown",function(t){n.undo(),t.preventDefault(),t.stopPropagation()}),this.keyboard.bind("redo","keydown",function(t){n.redo(),t.preventDefault(),t.stopPropagation()}),this.keyboard.bind("save","keydown",function(t){n.save(),t.preventDefault(),t.stopPropagation()})};l.Prototype=function(){var t=n.prototype;this.createView=function(){return this.view||(this.view=new o(this),this.keyboard.connect(window.document)),this.view},this.initialize=function(t,e){e(null)},this.initChildController=function(t){var e=this;this.writerCtrl||(this.writerCtrl=this.createWriterController(),this.publishCtrl=this.createPublishController(),setInterval(function(){e.requestAutoSave()},1e4));var n;switch(t.id){case"publish":n=this.publishCtrl;break;case"composer":n=this.writerCtrl;break;default:throw new Error("Unknown state")}this.setChildController(n,{nowarn:!0})},this.transition=function(t,e){var n=this;if(t.id===this.state.id){var i=!1;switch(t.id){case"publish":i=!0;break;case"composer":i=t.path===this.state.path&&"new"!==t.path;break;default:throw new Error("Unknown state")}if(i)return e(null,{skip:!0})}return this.state.path!==t.path&&!t.options["save-as"]||t.options["new-doc"]?t.options.data?this.openFromData(t.options.data,function(i){return i?e(i):(n.initChildController(t),void e(null))}):this.open(t.path,function(i){return i?e(i):(n.initChildController(t),void e(null))}):(t.id!==this.state.id&&n.initChildController(t),void e(null))},this.afterTransition=function(t){this.view.transition(t)},this.open=function(t,e){var n=this;this.shell.open(t,function(t,i){return t?e(t):(n.doc=i,void e(null))})},this.openFromData=function(t,e){this.shell.readFromArrayBuffer(t,function(t,n){t?console.error(t):this.doc=n,e(t)})},this.createWriterController=function(){var t=this,e=this.doc,n=new i(e,{onAutoSave:function(){},onDocumentEdit:function(){t.shell.updateTitle(t.doc.title),t.view.toolbarView.update(),t.view.update()},composerCtrl:t,panels:t.panels,tools:t.tools,workflows:t.workflows,shell:t.shell});return n},this.requestAutoSave=function(){var t=this.writerCtrl.document,e=this;t.__dirty&&!this.__isSaving?(this.__isSaving=!0,this.save(function(){e.__isSaving=!1})):console.log("nope")},this.createPublishController=function(){return new h(this.doc,this)};var e=/.*\.sdf$/;this.save=function(t){var n=this;if(this.state.path.match(e)&&window.native_app){var i="Sorry, we can not save to SDF files currently.\nPlease select an empty folder or create a new one.";return window.alert(i),this.saveToFolder(t)}this.state.path&&"new"!==this.state.path?(this.view.beforeSave(),this.shell.save(this.doc,this.state.path,function(e){e||(n.doc.__dirty=!1),n.view.afterSave(e),t&&t(e)})):this.saveAs(t)},this.saveAs=function(t){if(window.native_app)return this.saveToFolder(t);var e=this,n=e.childController.state,i=r.extend({"save-as":!0},u);if(window.native_app){var o=c.slug(e.doc.title)+".sdf";this.shell.selectFile(o,{save:!0},function(o,r){!o&&r&&e.shell.save(e.doc,r,function(o){o?t(o):(e.doc.__dirty=!1,e.app.switchState([{id:"composer",path:r},n],i),t(null)),e.view.afterSave(o)})})}else{var s="localstorage.sdf";e.shell.save(e.doc,s,function(o){o?t(o):(e.doc.__dirty=!1,e.app.switchState([{id:"composer",path:s},n],i),t(null)),e.view.afterSave(o)})}},this.saveToFolder=function(t){var e=this,n=e.childController.state,i=r.extend({"save-as":!0},u);this.shell.selectFolder({save:!0},function(o,r){!o&&r&&(r+="/content.json",e.shell.save(e.doc,r,function(o){return o?t(o):(e.doc.__dirty=!1,e.view.afterSave(),e.app.switchState([{id:"composer",path:r},n],i),void t(null))}))})},this.openExternalLink=function(t){this.shell.openExternalLink(t)},this.getAvailableTemplates=function(t){this.shell.getAvailableTemplates(t)},this.generatePreview=function(t){this.shell.generatePreview(this.doc,t)},this.newDocument=function(){if(window.native_app)this.shell.newDocument();else{var t=r.extend({},u,{"new-doc":!0});this.app.switchState({id:"composer",path:"new"},t)}},this.undo=function(){console.log("Undo..."),"composer"!==this.state.id&&this.showEdit();var t=this.doc.chronicle.rewind();if(t&&t.data){var e=this.writerCtrl,n=t.data.before;n&&window.setTimeout(function(){e.setSelection(n.container,n.sel),e.onDocumentEdit()},0)}},this.redo=function(){console.log("Redo..."),"composer"!==this.state.id&&this.showEdit();var t=this.doc.chronicle.forward();if(t&&t.data){var e=this.writerCtrl,n=t.data.after;n&&window.setTimeout(function(){e.setSelection(n.container,n.sel),e.onDocumentEdit()},0)}},this.cut=function(){if(console.log("Cut..."),"composer"===this.state.id){var t=this.childController.view.clipboard;t.isNative&&t.cut()}},this.copy=function(){if("composer"===this.state.id){var t=this.childController.view.clipboard;t.isNative&&t.copy()}},this.paste=function(){if(console.log("Paste..."),"composer"===this.state.id){var t=this.childController.view.clipboard;t.isNative&&t.paste()}},this.selectAll=function(){if(console.log("Select all..."),"composer"===this.state.id){var t=this.childController;t.currentController&&t.currentController.select("all")}},this.openDocumentFromArrayBuffer=function(t){var e=r.clone(u);e.data=t,this.app.switchState([{id:"composer",path:"new"},{id:"main",contextId:"toc"}],e)},this.exportPublication=function(){var t=this;this.shell.selectFolder({save:!0},function(e,n){!e&&n&&t.shell.writePublication(t.doc,n,function(){console.log("successfull exported publication")})})},this.showPublish=function(){var t=this.state.path;this.app.switchState([{id:"publish",path:t},{id:"default"}],u)},this.showEdit=function(){var t=this.state.path;this.app.switchState([{id:"composer",path:t},{id:"main",contextId:"toc"}],u)},this.sendError=function(t){this.view.renderError(t),console.log("TODO: RENDER ERROR",t)},this.dispose=function(){t.dispose.call(this),this.stopListening(),this.view&&this.view.dispose(),this.childController&&this.childController.dispose()},this.isDocumentDirty=function(){return this.doc?this.doc.__dirty:!1}},l.Prototype.prototype=n.prototype,l.prototype=new l.Prototype,e.exports=l},{"./composer_view":44,"./publish/publish_controller":105,"./writer_controller":118,"substance-application":6,"substance-commander":28,"substance-util":264,underscore:269}],42:[function(t,e){"use strict";var n=t("substance-util"),i=t("underscore"),o=t("substance-document"),r=t("substance-surface").EditorController,s=o.Selection.SelectionError,a=window.DOMParser,c=function(t,e){r.call(this,t,e)};c.Prototype=function(){var t=r.prototype;this._annotate=function(e,n,i){if("remark_reference"===n||"error_reference"===n){i=i||{};var o=c(this,e,n);i.target=o}t._annotate.call(this,e,n,i)};var e={error_reference:"error",remark_reference:"remark"},o={error:"errors",remark:"remarks"},c=function(t,i,r){var s=e[r],a=o[s];if(!s)throw new Error("Unsupported issue type:"+r);var c=i.document,h={id:s+"_"+n.uuid(),type:s,created_at:new Date,creator:Math.random()>.5?"Michael Aufreiter":"Oliver Buchtala"};return c.create(h),c.show(a,[h.id]),h.id};this._createFileNode=function(t,e,n,i){i=i||{binary:!0};var o=t.document;if(o.get(e))throw new Error("File "+e+" already exists.");var r=o.create({id:e,type:"file",content_type:n.type,version:0}),s=i.binary?n.data:n.text;return r.setData(s),r},this._fileId=function(t,e){return[t,".",e.extension].join("")},this._updateFile=function(t,e,n,i){i=i||{binary:!0};var o=t.document,r=o.get(e),s=i.binary?n.data:n.text;r.updateData(s)},this._setFile=function(t,e,n,i){var o=t.document,r=o.get(e);if(r)this._updateFile(t,r,n,i);else{var s=this._createFileNode(t,n.name,n,i);o.set(e,s.id)}},this.setFile=function(t,e,n){var i=this.session.startSimulation();this._setFile(i,t,e,n),i.save()},this.insertFigure=function(t,e){var i=this.session.selection;if(i.isNull())return e(new s("Selection is null!"));var o=this.session.startSimulation(),r=o.document,a="figure_"+n.uuid(),c={id:"text_"+n.uuid(),type:"text",content:""};r.create(c);var h=this._fileId(a,t),u=this._createFileNode(o,h,t),l={type:"figure",id:a,url:"",image:u.id,label:"Figure ",caption:c.id},p=this._insertNode(o,l);if(!p)throw new Error("Could not insert image");o.save();var d=this;window.setTimeout(function(){d.session.selection.set(o.selection),d._afterEdit(this)},500)},this.insertWebPage=function(t,e){var i=this.session.selection;if(i.isNull())return e(new s("Selection is null!"));var o=this.session.startSimulation(),r=o.document,a=n.uuid("web_page_"),c=this._fileId(a,t),h=this._createFileNode(o,c,t,{binary:!1}),u=h.getData(),l=this._determineWebPageDimensions(u),p={id:"text_"+n.uuid(),type:"text",content:""};r.create(p);var d={type:"web_page",id:a,file:h.id,width:l.pageWidth,height:l.pageHeight,caption:p.id},f=this._insertNode(o,d);if(!f)throw new Error("Could not insert web page");o.save(),this.session.selection.set(o.selection),this._afterEdit(this),this.ensureLastNode(o)},this.setWebPageFile=function(t,e){var n=this.session.startSimulation(),i=n.document,o=i.get(t);this.updateFile(o.file,e,{binary:!1});var r=e.getData(),s=this.determineWebPageDimensions(r);i.set([t,"width"],s.pageWidth),i.set([t,"height"],s.pageHeight),n.save()},this._determineWebPageDimensions=function(t){var e=new a,n=e.parseFromString(t,"text/html");return{pageWidth:n.body.getAttribute("data-width")||"400",pageHeight:n.body.getAttribute("data-height")||"400"}},this._updateVideoFiles=function(t,e,n){var o=t.document;e.poster&&o["delete"](e.poster),i.each(e.files,function(t){o["delete"](t)});var r="",s=[];i.each(n,function(n){var i=this._fileId(e.id,n),o=this._createFileNode(t,i,n);o.content_type.indexOf("video")>=0?s.push(o.id):o.content_type.indexOf("image")>=0&&!r?r=o.id:t.document["delete"](o.id)},this),o.set([e.id,"poster"],r),o.set([e.id,"files"],s)},this.insertVideo=function(t){var e=this.session.selection;if(e.isNull())throw new s("Selection is null.");var i=this.session.startSimulation(),o=i.document,r="video_"+n.uuid(),a={id:"text_"+n.uuid(),type:"text",content:""};o.create(a);var c={type:"video",id:r,poster:"",files:[],caption:a.id},h=this._insertNode(i,c);if(!h)throw new Error("Could not insert video");this._updateVideoFiles(i,c,t),i.save(),this.session.selection.set(i.selection),this._afterEdit(this),this.ensureLastNode(i)},this.setVideoFiles=function(t,e){var n=this.session.startSimulation(),i=n.document,o=i.get(t);this._updateVideoFiles(n,o,e),n.save()},this._updateAudioFiles=function(t,e,n){var o=t.document;i.each(e.files,function(t){o["delete"](t)});var r=[];i.each(n,function(n){var i=this._fileId(e.id,n),o=this._createFileNode(t,i,n);r.push(o.id)},this),o.set([e.id,"files"],r)},this.insertAudio=function(t){var e=this.session.selection;if(e.isNull())throw new s("Selection is null!");var i=this.session.startSimulation(),o="audio_"+n.uuid(),r={id:"text_"+n.uuid(),type:"text",content:""};i.document.create(r);var a={type:"audio",id:o,files:[],caption:r.id},c=this._insertNode(i,a);if(!c)throw new Error("Could not insert audio");this._updateAudioFiles(i,a,t),i.save(),this.session.selection.set(i.selection),this._afterEdit(this),this.ensureLastNode(i)},this.setAudioFiles=function(t,e){var n=this.session.startSimulation(),i=n.document,o=i.get(t);this._updateAudioFiles(n,o,e),n.save()},this.addContributor=function(){var t=this,e=this.session.startSimulation(),o={id:n.uuid("contributor_"),type:"contributor",role:"author",name:"",image:"",url:"",description:""};e.document.create(o),e.document.show("info",o.id,-1);var r=i.filter(e.document.get("info").nodes,function(t){return"publication_info"!==t});e.document.set(["document","authors"],r);var s=e.container.getNodeComponents(o.id),a=s[0];return e.selection.set([a.pos,0]),e.save(),window.setTimeout(function(){t.session.selection.set(e.selection)},0),o.id},this.deleteResource=function(t){var e=this.session.document.indexes.references,n=e.get(t);this.session.selection.clear();var o=this.session.startSimulation(),r=o.document;i.each(n,function(t){r["delete"](t.id)},this),r.hide(this.session.container.name,t),r.contains(t)&&r["delete"](t),o.save(),this._afterEdit()},this.createCitationWithReference=function(){var t=this.session.document,e=t.create({id:"web_resource_"+n.uuid(),type:"web_resource",title:this.session.selection.getText(),url:"http://"});return this.document.show("citations",[e.id]),this.annotate("citation_reference",{target:e.id}),this._afterEdit(),e.id},this.createLocationReference=function(){this.annotate("location_reference",{target:"hallo_welt"}),this._afterEdit()},this.addReference=function(t,e){var n=this.session.selection;if(n.isNull())return void console.error("Nothing is selected.");var i=this.session.startSimulation();this._annotate(i,t,e),i.save(),n.set(i.selection),this._afterEdit()},this.addMultiAnnotation=function(t,e){var o=this.session.selection,r=o.range(),s=r.start,a=r.end,c=this.session.container,h=c.getComponent(s[0]),u=c.getComponent(a[0]),l={type:t,id:n.uuid(t+"_"),startPath:h.path,startCharPos:s[1],endPath:u.path,endCharPos:a[1]};i.extend(l,e);var p=this.session.startSimulation();return p.document.create(l),p.save(),o.set(p.selection),this._afterEdit(),l.id},this.undo=function(){throw new Error("This must not be called here.")},this.redo=function(){throw new Error("This must not be called here.")}},c.Prototype.prototype=r.prototype,c.prototype=new c.Prototype,e.exports=c},{"substance-document":132,"substance-surface":257,"substance-util":264,underscore:269}],43:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-application").Router,o=function(t){i.call(this),this.app=t,n.each(o.routes,function(t){this[t.command]?this.route(t.route,t.name,n.bind(this[t.command],this)):console.error("Unknown route handler: ",t.command)},this),this.route(/^state=.*$/,"state",n.bind(this.openState,this))};o.Prototype=function(){this.start=function(){i.history.start()};var t={updateRoute:!1,replace:!1};this.openState=function(){var e=i.history.getFragment(),n=this.app.stateFromFragment(e);console.log("state change triggerd by router",JSON.stringify(n)),this.app.switchState(n,t)},this.navigate=function(t,e){i.history.navigate(t,e)}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.routes=[],e.exports=o},{"substance-application":6,underscore:269}],44:[function(t,e){"use strict";var n=window.$,i=t("substance-util"),o=t("substance-application"),r=t("substance-application").View,s=o.$$,a=(t("./writer_controller"),t("underscore")),c=t("./toolbar_view"),h=(window.document,window.FileReader),u=function(t){function e(t){return function(e){i[t](),e.preventDefault(),e.stopPropagation()}}r.call(this),this.controller=t,this.$el.attr({id:"container"});var i=this;n(this.el).on("click",".toggle-annotation.export",e("export")),n(this.el).on("click",".control.save",e("save")),n(this.el).on("click",".new-document",e("newDocument")),n(this.el).on("click",".export-publication",e("exportPublication")),n(this.el).on("click",".toggle-publish",e("showPublish")),n(this.el).on("click",".toggle-edit",e("showEdit")),n(this.el).on("click",".control.undo",e("undo")),n(this.el).on("click",".control.redo",e("redo"))};u.Prototype=function(){this.showEdit=function(){this.controller.showEdit()},this.showPublish=function(){this.controller.showPublish()},this.render=function(){return this.menuEl=s("#menu"),this.mainEl=s("#main",{html:"<br/><br/><br/><br/><br/>&nbsp;&nbsp;Loading document..."}),this.searchEl=s("#search"),this.statusEl=s("#status",{children:[s(".filename",{text:""}),s(".action",{text:""})]}),this.toolbarView=new c(this.controller),this.toolbarView.render(),this.menuEl.appendChild(this.toolbarView.el),this.el.appendChild(this.menuEl),this.el.appendChild(this.mainEl),this.el.appendChild(this.searchEl),this.el.appendChild(this.statusEl),this},this.update=function(){this.$("#status").removeClass("error");var t=this.controller.doc;this.$("#status .action").html(t.__dirty?"Unsaved changes":"Saved");var e=this.controller.state.path;this.$("#status .filename").html("new"!==e?e:"untitled")},this.save=function(){this.controller.save()},this.undo=function(){this.controller.undo()},this.redo=function(){this.controller.redo()},this.beforeSave=function(){this.$("#status .action").html("Saving ...")},this.afterSave=function(t){t?(console.error(t),this.renderError(t),i.printStackTrace(t)):(this.update(),n(".control.save").removeClass("error"),n(".control.save").addClass("disable"))},this.renderError=function(t){var e=this.$("#status");e.addClass("error"),this.$("#status .action").html(t.message||t),a.delay(function(){e.removeClass("error")},4e3)},this["export"]=function(){var t=this.controller.doc;i.zip.zip(t,function(e,o){if(e)return console.error(e);var r=o.generate({type:"blob"}),s=window.document.querySelector(".export-zip");s.href=window.URL.createObjectURL(r),s.download=i.slug(t.title)+".sdf",/Chrome/.test(window.navigator.userAgent)||/Firefox/.test(window.navigator.userAgent)||alert("Unfortunately, Safari doesn't support downloading of generated zip files. For the time being, please use Google Chrome for storing docs on disk."),n(".export-zip")[0].click()})},this.exportPublication=function(){this.controller.exportPublication()},this.handleDroppedFile=function(t){var e=this;console.log("handled dropped file...");var n=t.originalEvent.dataTransfer.files,i=n[0],o=new h;return o.onload=function(t){e.controller.openDocumentFromArrayBuffer(t.target.result)},o.readAsArrayBuffer(i),!1},this.newDocument=function(){this.controller.newDocument()},this.transition=function(t){var e=this.controller.state;if(e.id===t.id&&"new"!==e.path)return void this.update();if(this.mainEl.innerHTML="",n("body").removeClass(),"composer"===e.id){var i=this.controller.childController;this.writerViewEl||(this.writerViewEl=i.view.el,this.mainEl.appendChild(this.writerViewEl)),n("body").addClass("state-composer"),this.updateTitle(i.document.title),this.$(".modes a").removeClass("active"),this.$(".modes a.toggle-edit").addClass("active"),this.update()}else{var o=this.controller.childController;this.publishViewEl||(this.publishViewEl=o.view.el,this.mainEl.appendChild(this.publishViewEl)),n("body").addClass("state-publish"),this.$(".modes a").removeClass("active"),this.$(".modes a.toggle-publish").addClass("active")}}},u.Prototype.prototype=r.prototype,u.prototype=new u.Prototype,u.prototype.constructor=u,e.exports=u},{"./toolbar_view":112,"./writer_controller":118,"substance-application":6,"substance-util":264,underscore:269}],45:[function(t,e){"use strict";var n=t("./content_tools_view"),i=t("substance-application").Controller,o=function(t){this.parentAdapter=t,this.tools=t.tools,this.state={id:"initialized"}};o.Prototype=function(){this.createView=function(){return this.view||(this.view=new n(this)),this.view},this.initialize=function(t,e){this.createView(),e(null)},this.dispose=function(){this.view&&this.view.dispose(),this.view=null},this.transition=function(t,e){this.view.update(),(this.state.id!==t.id||this.state.annotation!==t.annotation)&&(this.state=t,this.view.transition(t),e&&(console.log("who called this method with a callback?"),e(null)))},this.update=function(){this.transition({id:"main"})}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"./content_tools_view":46,"substance-application":6}],46:[function(t,e){var n=t("underscore"),i=window.$,o=t("substance-application").$$,r=t("substance-application").View,s=function(t){r.call(this),this.$el.addClass("content-tools-view"),this.controller=t,this.tools=this.controller.tools,this.actions={},this.controls={},this.$el.on("click",".select-type",n.bind(this.toggleSelectTextType,this)),this.$el.on("mouseup",".select-type",n.bind(this._stopPropagation,this)),this.$el.on("click",".toggle-annotation",n.bind(this.toggleAnnotation,this)),this.$el.on("mouseup",".toggle-annotation",n.bind(this._stopPropagation,this)),this.$el.on("click",".text-type",n.bind(this.changeTextType,this)),this.$el.on("mouseup",".text-type",n.bind(this._stopPropagation,this))};s.Prototype=function(){this._stopPropagation=function(t){t.preventDefault(),t.stopPropagation()},this.toggleAnnotation=function(t){var e=i(t.currentTarget).attr("data-type");t.preventDefault(),t.stopPropagation(),this.performAction(e)},this.transition=function(t){this.contextView&&this.contextView.dispose(),i(this.el).removeClass().addClass("content-tools-view"),i(this.contextBar).html(""),i(this.el).addClass("mode-"+t.id)},this.render=function(){var t=this;this.el.innerHTML="";var e=o(".annotation-toggles.group");this.controls={},this.controls.emphasis=o("a.control.toggle-annotation.emphasis",{href:"#","data-type":"emphasis",html:'<i class="icon-italic"></i>',title:"Emphasis"}),e.appendChild(this.controls.emphasis),this.controls.strong=o("a.control.toggle-annotation.strong",{href:"#","data-type":"strong",html:'<i class="icon-bold"></i>',title:"Strong Emphasis"}),e.appendChild(this.controls.strong);var r=o(".markers.group");this.controls.remark_reference=o("a.control.toggle-annotation.remark_reference",{href:"#","data-type":"remark_reference",title:"Remark",html:'<i class="icon-comment"></i>'}),r.appendChild(this.controls.remark_reference),n.each(this.tools,function(e){var n=o("a.control.toggle-annotation."+e.name,{href:"#",title:e.title,html:'<i class="'+e.icon+'"></i>'});i(n).on("click",function(){return e.handleToggle(t.controller.parentAdapter),!1}),this.controls[e.name]=n,r.appendChild(n)},this);var s=o(".toolbar-inner"),a=o(".groups");return a.appendChild(e),a.appendChild(r),this.textMode=o(".text-mode",{html:""}),this.save=o("a.insert-media.control.save",{title:"Save",href:"#","data-type":"figure",html:'<i class="icon-save"></i>'}),this.undo=o("a.insert-media.control.undo",{title:"Undo",href:"#","data-type":"figure",html:'<i class="icon-undo"></i>'}),this.redo=o("a.insert-media.control.redo",{title:"Redo",href:"#","data-type":"figure",html:'<i class="icon-rotate-right"></i>'}),s.appendChild(this.save),s.appendChild(this.undo),s.appendChild(this.redo),s.appendChild(a),this.contextBar=o(".context-bar"),s.appendChild(this.contextBar),this.el.appendChild(s),this.update(),this},this.update=function(){var t=this.controller.parentAdapter.getActions();this.$(".toggle-annotation.active").removeClass("active"),this.disableControls(),this.actions={};for(var e=0;e<t.length;e++){var n=t[e];this.actions[n.type]=n}this.updateAnnotationToggles(),this.updateActions(),this.updateTextMode(),this.closeDropdowns()},this.closeDropdowns=function(){this.$(".text-mode").removeClass("active"),this.$(".insert-content").removeClass("active")},this.updateTextMode=function(){function t(t){return"heading"===t?"Heading "+e.level:"blockquote"===t?"Blockquote":"text"===t?"Paragraph":"code_block"===t?"Code":"cover"===t?"Title":"list_item"===t?"List":null}var e=this.controller.parentAdapter.getCurrentNode(),n=this.controller.parentAdapter.getTextMode();this.textMode.innerHTML="",n&&t(n)?"cover"===n?this.textMode.appendChild(o(".select-type",{href:"#",text:t(n)})):(this.textMode.appendChild(o("a.select-type",{title:"Select text type",href:"#",html:t(n)+' &nbsp;&nbsp;<i class="icon-caret-down"></i>'})),this.textMode.appendChild(o(".available-types",{children:[o("a.text-type.text",{href:"#",html:"Paragraph <span>⌃⌘P</span>","data-type":"text"}),o("a.text-type.heading-1",{href:"#",html:"Heading 1 <span>⌃⌘H</span>","data-level":"1","data-type":"heading"}),o("a.text-type.heading-2",{href:"#",html:"Heading 2 <span></span>","data-level":"2","data-type":"heading"}),o("a.text-type.heading-3",{href:"#",html:"Heading 3 <span></span>","data-level":"3","data-type":"heading"}),o("a.text-type.blockquote",{href:"#",html:"Blockquote<span>⌃⌘B</span>","data-type":"blockquote"}),o("a.text-type.list-item",{href:"#",html:"List<span>⌃⌘L</span>","data-level":"1","data-type":"list_item"}),o("a.text-type.code-block",{href:"#",html:"Code Block <span>⌃⌘C</span>","data-type":"code_block"})]}))):this.textMode.appendChild(o(".select-type.disable",{href:"#",text:"No selection"}))},this.updateActions=function(){var t=this.controller.parentAdapter.document;t.__dirty?i(this.save).removeClass("disable"):i(this.save).addClass("disable"),t.chronicle.canRedo()?i(this.redo).removeClass("disable"):i(this.redo).addClass("disable"),t.chronicle.canUndo()?i(this.undo).removeClass("disable"):i(this.undo).addClass("disable")},this.updateAnnotationToggles=function(){n.each(this.actions,function(t){var e=this.controls[t.type];if(e){switch(t.action){case"deleteAnnotation":e.classList.add("active")}e.classList.remove("disable")}},this),n.each(this.tools,function(t){var e=this.controls[t.name];t.isEnabled(this.controller.parentAdapter)?e.classList.remove("disable"):e.classList.add("disable"),t.isActive(this.controller.parentAdapter)?(e.classList.add("active"),e.classList.remove("disable")):e.classList.remove("active")},this)},this.annotate=function(t){this.controller.annotate(t)
},this.notImplemented=function(){console.error("Callback not implemented",arguments)},this.performAction=function(t){var e=this.actions[t];e?(this.controller.parentAdapter.performAction(e),this.update()):console.error("No action available for",t)},this.toggleSelectTextType=function(t){this.$(".text-mode").toggleClass("active"),t.preventDefault()},this.toggleInsertContent=function(t){this.$(".insert-content").toggleClass("active"),t.preventDefault()},this.changeTextType=function(t){var e=i(t.currentTarget).attr("data-type"),n={};("heading"===e||"list_item"===e)&&(n.level=t.currentTarget.getAttribute("data-level"),n.level=parseInt(n.level,10)),this.controller.parentAdapter.switchNodeType(e,n),t.preventDefault(),this.$(".text-mode").removeClass("active")},this.disableControls=function(){this.$("a.control").addClass("disable")}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,e.exports=s},{"substance-application":6,underscore:269}],47:[function(t,e){var n={selection:["up","down","left","right","shift+up","shift+down","shift+left","shift+right","alt+up","alt+down","alt+left","alt+right","alt+shift+up","alt+shift+down","alt+shift+left","alt+shift+right","ctrl+shift+up","ctrl+shift+down","ctrl+shift+left","ctrl+shift+right","command+up","command+down","command+left","command+right","command+shift+up","command+shift+down","command+shift+left","command+shift+right","home","end"],nop:["ctrl+shift+alt+up","ctrl+shift+alt+down","ctrl+shift+alt+left","ctrl+shift+alt+right"],special:["special","shift+special","alt+special","shift+alt+special"],backspace:["backspace","ctrl+backspace","ctrl+shift+backspace","ctrl+alt+backspace","shift+backspace","ctrl+shift+alt+backspace","alt+backspace","alt+shift+backspace","command+backspace","command+shift+backspace"],"delete":["del","shift+del","alt+del","shift+alt+del","ctrl+del","ctrl+alt+del"],"break":["enter"],"soft-break":["shift+enter"],blank:["space","shift+space"],indent:["tab"],unindent:["shift+tab"],undo:["command+z"],redo:["command+shift+z"],copy:["command+c"],paste:["command+v"],cut:["command+x"],"select-all":["command+a"],strong:["ctrl+b","command+b"],emphasis:["ctrl+i","command+i"],text:["ctrl+command+p"],heading:["ctrl+command+h"],list:["ctrl+command+l"],figref:["ctrl+command+f"],code_block:["ctrl+command+c"],save:["command+s"],"new":["command+n"],reload:["command+r"],edit:["command+alt+left"],preview:["command+alt+right"],clear:[]};e.exports=n},{}],48:[function(t,e){var n={selection:["up","down","left","right","shift+up","shift+down","shift+left","shift+right","ctrl+up","ctrl+down","ctrl+left","ctrl+right","ctrl+shift+up","ctrl+shift+down","ctrl+shift+left","ctrl+shift+right","home","end","pageup","pagedown"],backspace:["backspace"],"delete":["del"],"break":["enter"],"soft-break":["shift+enter"],nop:[],special:[],blank:["space","shift+space"],indent:["tab"],unindent:["shift+tab"],undo:["ctrl+z"],redo:["ctrl+shift+z"],copy:["ctrl+c"],paste:["ctrl+v"],cut:["ctrl+x"],"select-all":["ctrl+a"],strong:["ctrl+b"],emphasis:["ctrl+i"],text:["ctrl+shift+t"],heading:["ctrl+shift+h"],figref:["ctrl+shift+f"],list:["ctrl+shift+l"],code_block:["ctrl+shift+c"],save:["ctrl+s"],"new":["ctrl+alt+n"],reload:["ctrl+r"],clear:["ctrl+alt+backspace"]};e.exports=n},{}],49:[function(t,e){var n=t("./tools/add_hyper_link_tool"),i=[new n];e.exports=i},{"./tools/add_hyper_link_tool":113}],50:[function(t,e){"use strict";var n=t("./workflows/toggle_resource_reference"),i=t("./workflows/add_hyper_link"),o=t("./workflows/edit_annotation_range"),r={toggle_resource_reference:new n,add_hyper_link:new i,edit_annotation_range:new o};e.exports=r},{"./workflows/add_hyper_link":114,"./workflows/edit_annotation_range":115,"./workflows/toggle_resource_reference":116}],51:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-article"),o=t("substance-operator").ArrayOperation,r=0,s=function(t){t=t||{},this.__id__=r++,t.nodeTypes=n.extend({},s.nodeTypes,t.nodeTypes),i.call(this,t),this.addIndex("references",{types:["figure_reference","person_reference","remark_reference","error_reference","citation_reference","block_reference","location_reference","definition_reference","subject_reference"],property:"target"}),this.addIndex("multi_annotations",{types:["multi_annotation"],property:"container"}),this.addIndex("annotation_fragments",{types:["annotation_fragment"],property:"annotation_id"}),n.each(this.nodes,function(t){this.get(t.id)},this),n.each(this.getIndex("multi_annotations").get("content"),function(t){t.addFragments({document:this,apply:this.apply.bind(this)})},this)};s.Prototype=function(){var t=i.prototype;this.getAnnotationFragments=function(t){return this.getIndex("annotation_fragments").get(t)},this.getFileSize=function(){var t=JSON.stringify(this.toJSON()).length,e=this.getIndex("files");return n.each(e.nodes,function(e){var n=this.get(e);t+=n.getSize()},this),t},this.createSettings=function(t){var e=this.get("publish_settings.json");if(e){var i=e.getData();n.extend(i,t)}else{var o=this.create({id:"publish_settings.json",type:"file",content_type:"application/json",version:0});o.setData(JSON.stringify(t))}},this.getSettings=function(){var t=this.get("publish_settings.json");return t?t.getData():{templateId:"substance",params:{}}},this.destroySettings=function(){this["delete"]("publish_settings.json")},this["delete"]=function(e){var i=this.get(e);if("contributor"===i.type){var r=o.Delete(this.authors,i.id);this.update(["document","authors"],r)}if(t["delete"].call(this,e),i.target){var s=i.target,a=this.getIndex("references"),c=a.get(s),h=Object.keys(c).length;0===h&&this.get(s)&&(this.hide("citations",s),this.hide("remarks",s),t["delete"].call(this,s))}else"figure"===i.type?t["delete"].call(this,i.image):"video"===i.type?(i.poster&&t["delete"].call(this,i.poster),n.each(i.files,function(e){t["delete"].call(this,e)},this)):"audio"===i.type?n.each(i.files,function(e){t["delete"].call(this,e)},this):"web_page"===i.type&&t["delete"].call(this,i.file)},this.fromSnapshot=function(t,e){return s.fromSnapshot(t,e)},this.newInstance=function(){return new s({schema:this.schema})},this.toJSON=function(){var e=t.toJSON.call(this);return n.each(e.nodes,function(t){"annotation_fragment"===t.type&&delete e.nodes[t.id]}),e}};var a=n.clone(i.nodeTypes),c=t("./nodes");n.each(c,function(t,e){a[e]=n.extend({},a[e],t)}),s.nodeTypes=a,s.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new s(e)},s.ViewFactory=i.ViewFactory,s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,e.exports=s},{"./nodes":84,"substance-article":13,"substance-operator":246,underscore:269}],52:[function(t,e){"use strict";var n=t("./composite_editor"),i=function(t){n.call(this,t),this.textComponents={label:!0},this.subComponents={caption:!0}};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./composite_editor":56}],53:[function(t,e){"use strict";var n=t("./text_node_editor"),i=t("substance-operator"),o=i.ObjectOperation,r=i.TextOperation,s=t("substance-util"),a=function(t){this.factory=t,this.breakType="text"};a.Prototype=function(){this.breakNode=function(t,e,n){var i,a=e.root,c=a.content,h=e.rootPos,u={id:s.uuid()},l="";0===n&&a.content.length>0?(u.type="blockquote",u.content="",i=h):(l=c.substring(n),u.type="text",u.content=l,i=h+1),t.document.apply(o.Create([u.id],u)),l.length>0&&(t.document.apply(o.Update([a.id,"content"],r.Delete(n,l),"string")),t.annotator.transferAnnotations(a,n,u)),t.document.show(t.view,u.id,i),t.selection.set([e.pos+1,0])},this.changeType=function(t,e,n,i){var o={id:s.uuid(),type:i};o.content=e.content,this._replaceNode(t,e,o,n.rootPos)},this.canIndent=function(){return!1},this.indent=function(){}},a.Prototype.prototype=n.prototype,a.prototype=new a.Prototype,e.exports=a},{"./text_node_editor":70,"substance-operator":246,"substance-util":264}],54:[function(t,e){"use strict";var n=t("./not_editable"),i=t("./web_resource_editor"),o=t("./text_node_editor"),r=function(){this.createEditor=function(t){switch(t.type){case"web_resource":return new i(this);case"text":return new o(this);default:return new n(this)}}};e.exports=r},{"./not_editable":67,"./text_node_editor":70,"./web_resource_editor":73}],55:[function(t,e){"use strict";for(var n=t("./text_node_editor"),i=t("substance-operator"),o=i.ObjectOperation,r=i.TextOperation,s=2,a="",c=0;c<s.length;c++)a[c]=" ";var h=function(t){this.factory=t};h.Prototype=function(){this.breakNode=function(t,e,n){t.document.apply(o.Update(e.path,r.Insert(n,"\n"),"string")),t.selection.set([e.pos,n+1])},this.canIndent=function(){return!1},this.indent=function(){}},h.Prototype.prototype=n.prototype,h.prototype=new h.Prototype,e.exports=h},{"./text_node_editor":70,"substance-operator":246}],56:[function(t,e){"use strict";var n=t("./not_editable"),i=t("substance-operator"),o=i.ObjectOperation,r=i.TextOperation,s=function(t){this.factory=t,this.textComponents={},this.subComponents={},this.__componentEditors__={}};s.Prototype=function(){this.__getEditor__=function(t,e){if(!this.__componentEditors__[e.name]){var n=t.document.get(e.path[0]);this.__componentEditors__[e.name]=this.factory.createEditor(n)}return this.__componentEditors__[e.name]},this.canDeleteContent=function(t,e,n,i){if(this.textComponents[e.name])return!0;if(this.subComponents[e.name]){var o=this.__getEditor__(t,e);return o.canDeleteContent(t,e,n,i)}return!1},this.__deleteTextishContent=function(t,e,n,i){var s=e.path,a=t.document.resolve(s),c=a.get(),h=r.Delete(n,c.substring(n,i)),u=o.Update(s,h,"string");t.document.apply(u),t.annotator.update(u)},this.__delegateDelete=function(t,e,n,i){var o=this.__getEditor__(t,e);o.deleteContent(t,e,n,i)},this.deleteContent=function(t,e,n,i){return this.textComponents[e.name]?(this.__deleteTextishContent(t,e,n,i),!0):this.subComponents[e.name]?(this.__delegateDelete(t,e,n,i),!0):!1},this.canInsertContent=function(t,e,n){if(this.textComponents[e.name])return!0;if(this.subComponents[e.name]){var i=this.__getEditor__(t,e);return i.canInsertContent(t,e,n)}return!1},this.__insertTextishContent=function(t,e,n,i){var s=e.path,a=r.Insert(n,i),c=o.Update(s,a,"string");t.document.apply(c),t.annotator.update(c)},this.delegateInsert=function(t,e,n,i){var o=this.__getEditor__(t,e);o.insertContent(t,e,n,i)},this.insertContent=function(t,e,n,i){return this.textComponents[e.name]?(this.__insertTextishContent(t,e,n,i),!0):this.subComponents[e.name]?(this.delegateInsert(t,e,n,i),!0):!1},this.canAnnotate=function(t,e,n,i){if(this.textComponents[e.name])return!0;if(this.subComponents[e.name]){var o=this.__getEditor__(t,e);return o.canAnnotate(t,e,n,i)}return!1},this.annotate=function(t,e,n,i,o){if(this.textComponents[e.name]){var r=e.path,s={type:n,path:r,range:i};return t.document.annotate(s,o),!0}if(this.subComponents[e.name]){var a=this.__getEditor__(t,e);return a.annotate(t,e,n,i,o),!0}return!1}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"./not_editable":67,"substance-operator":246}],57:[function(t,e){"use strict";var n=t("substance-util"),i=t("substance-operator"),o=i.ObjectOperation,r=i.ArrayOperation,s=function(t){this.factory=t,this.view="content"};s.Prototype=function(){this.canDeleteNode=function(t,e){var n=this._nodePos(t,e.id);return n>=1&&n<this._length(t)},this.ensureLastNode=function(t){var e=t.container.last(),i=e.root,o={text:!0,heading:!0,list_item:!0};if(!o[i.type]){var r={type:"text",id:n.uuid("text_"),content:""};t.document.create(r),t.document.show(this.view,r.id)}},this.deleteNode=function(t,e){var i=this._nodePos(t,e.id),s=r.Delete(i,e.id);if(t.document.apply(o.Update([this.view,"nodes"],s)),1===this._length(t)){var a={type:"text",id:"text_"+n.uuid(),content:""};t.document.create(a),t.document.show(this.view,a.id)}},this._length=function(t){return t.document.nodes[this.view].nodes.length},this._nodeId=function(t,e){return t.document.nodes[this.view].nodes[e]},this._nodePos=function(t,e){return t.document.nodes[this.view].nodes.indexOf(e)}},s.prototype=new s.Prototype,e.exports=s},{"substance-operator":246,"substance-util":264}],58:[function(t,e){"use strict";var n=t("./composite_editor"),i=function(t){n.call(this,t),this.textComponents={name:!0,description:!0,email:!0}};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./composite_editor":56}],59:[function(t,e){"use strict";var n=t("substance-util"),i=(t("./not_editable"),t("./composite_editor")),o=function(t){i.call(this,t),this.textComponents={title:!0,"abstract":!0,abstract_en:!0}};o.Prototype=function(){this.canBreak=function(t,e,n){return n===e.length?!0:!1},this.breakNode=function(t){var e={id:n.uuid("text_"),type:"text",content:""};return t.document.create(e),t.document.show(t.container.name,e.id,1),t.selection.set(t.container.first(e.id)),!0}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"./composite_editor":56,"./not_editable":67,"substance-util":264}],60:[function(t,e){"use strict";var n=t("substance-util"),i=t("./composite_editor"),o=function(t){i.call(this,t),this.textComponents={label:!0},this.subComponents={caption:!0}};o.Prototype=function(){this.canBreak=function(t,e,n){return"image"===e.name&&0===n?!0:!1},this.breakNode=function(t,e,i){if("image"===e.name&&0===i){var o={id:n.uuid("text_"),type:"text",content:""},r=e.pos;return t.document.create(o),t.document.show(t.container.name,o.id,e.rootPos),t.selection.set([r+1,0]),!0}throw new Error("Nope.")}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"./composite_editor":56,"substance-util":264}],61:[function(t,e){"use strict";var n=t("./not_editable"),i=t("./figure_editor"),o=t("./text_node_editor"),r=function(){this.createEditor=function(t){switch(t.type){case"figure":return new i(this);case"text":return new o(this);default:return new n(this)}}};e.exports=r},{"./figure_editor":60,"./not_editable":67,"./text_node_editor":70}],62:[function(t,e){"use strict";var n=t("./text_node_editor"),i=t("substance-operator"),o=i.ObjectOperation,r=i.TextOperation,s=t("substance-util"),a=function(t){this.factory=t,this.breakType="text"};a.Prototype=function(){this.breakNode=function(t,e,n){var i,a=e.root,c=a.content,h=e.rootPos,u={id:s.uuid()},l="";0===n&&a.content.length>0?(u.type="heading",u.level=a.level,u.content="",i=h):(l=c.substring(n),u.type="text",u.content=l,i=h+1),t.document.apply(o.Create([u.id],u)),l.length>0&&(t.document.apply(o.Update([a.id,"content"],r.Delete(n,l),"string")),t.annotator.transferAnnotations(a,n,u)),t.document.show(t.view,u.id,i),t.selection.set([e.pos+1,0])},this.changeType=function(t,e,n,i,r){if("heading"===i){if(e.level===r.level)return;return void t.document.apply(o.Set([e.id,"level"],e.level,r.level))}var a={id:s.uuid(),type:i};"heading"===i&&(a.level=r.level),a.content=e.content,this._replaceNode(t,e,a,n.rootPos)},this.canIndent=function(t,e,n){var i=e.root;return"right"===n&&i.level<3||"left"===n&&i.level>0},this.indent=function(t,e,n){var i=e.root,o=i.level;"left"===n?o=Math.max(1,o-1):o+=1,t.document.set([i.id,"level"],o)}},a.Prototype.prototype=n.prototype,a.prototype=new a.Prototype,e.exports=a},{"./text_node_editor":70,"substance-operator":246,"substance-util":264}],63:[function(t,e){"use strict";var n=t("./not_editable"),i=t("./contributor_editor"),o=function(){this.createEditor=function(t){switch(t.type){case"contributor":return new i(this);default:return new n(this)}}};e.exports=o},{"./contributor_editor":58,"./not_editable":67}],64:[function(t,e){"use strict";var n=t("substance-operator"),i=n.ObjectOperation,o=n.TextOperation,r=t("./composite_editor"),s=function(t){r.call(this,t),this.textComponents={title:!0,description:!0}};s.Prototype=function(){this.canBreak=function(t,e,n){var i=e.length;return i>=n},this.breakNode=function(t,e,n){t.document.apply(i.Update(e.path,o.Insert(n,"\n"),"string")),t.selection.set([e.pos,n+1])}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,e.exports=s},{"./composite_editor":56,"substance-operator":246}],65:[function(t,e){"use strict";var n=t("./not_editable"),i=t("./issue_editor"),o=function(){this.createEditor=function(t){switch(t.type){case"error":case"remark":return new i(this);default:return new n(this)}}};e.exports=o},{"./issue_editor":64,"./not_editable":67}],66:[function(t,e){"use strict";var n=t("./text_node_editor"),i=t("substance-operator"),o=i.ObjectOperation,r=i.TextOperation,s=t("substance-util"),a=function(t){this.factory=t,this.breakType="text"};a.Prototype=function(){this.breakNode=function(t,e,n){var i,a=e.root,c=a.content,h=e.rootPos;if(0===e.length)i={type:"text",id:s.uuid("text_"),content:""},t.document.hide(t.view,a.id),t.document["delete"](a.id),t.document.create(i),t.document.show(t.view,i.id,e.rootPos),t.selection.set([e.pos,0]);else{var u=c.substring(n);i={id:s.uuid("list_item_"),type:"list_item",content:u,level:a.level},t.document.apply(o.Create([i.id],i)),u.length>0&&(t.document.apply(o.Update(e.path,r.Delete(n,u),"string")),t.annotator.transferAnnotations(a,n,i));var l=h+1;t.document.show(t.view,i.id,l),t.selection.set([e.pos+1,0])}},this.canIndent=function(t,e,n){var i=e.root;return"right"===n&&i.level<4||"left"===n&&i.level>0},this.indent=function(t,e,n){var i=e.root,o=i.level;"left"===n?o=Math.max(1,o-1):o+=1,t.document.set([i.id,"level"],o)}},a.Prototype.prototype=n.prototype,a.prototype=new a.Prototype,e.exports=a},{"./text_node_editor":70,"substance-operator":246,"substance-util":264}],67:[function(t,e){"use strict";var n=function(t){this.factory=t};n.Prototype=function(){this.canDeleteContent=function(){return!1},this.deleteContent=function(){throw new Error("Nope.")},this.canInsertContent=function(){return!1},this.insertContent=function(){throw new Error("Nope.")},this.canIndent=function(){return!1},this.indent=function(){throw new Error("Nope.")},this.canAnnotate=function(){return!1},this.annotate=function(){throw new Error("Nope.")},this.canBreak=function(){return!1},this.breakNode=function(){throw new Error("Nope.")},this.canChangeType=function(){return!1},this.changeType=function(){throw new Error("Nope.")},this.canJoin=function(){return!1},this.join=function(){throw new Error("Nope.")},this.copy=function(){}},n.prototype=new n.Prototype,e.exports=n},{}],68:[function(t,e){"use strict";var n=t("underscore"),i=function(){};i.Prototype=function(){var t={figure_reference:"ref",citation_reference:"ref",contributor_reference:"ref",location_reference:"ref",person_reference:"ref",subject_reference:"ref",definition_reference:"ref",emphasis:"expression",strong:"expression",subscript:"expression",superscript:"expression",code:"expression",math:"expression",remark_reference:"marker",error_reference:"marker"},e=[],i={};n.each(t,function(t,n){e.push(n),i[t]=i[t]||[],i[t].push(n)}),this.getAllowedActions=function(o,r){var s=[];if(r.isNull())return s;if(r.hasMultipleNodes())return s;var a=o.annotator.getAnnotations(r);if(0===a.length&&r.isCollapsed())return[];var c=0,h={};if(n.each(i,function(t,e){h[e]=[]}),n.each(a,function(e){var n=t[e.type];if(n){var i=h[n];i&&(i.push(e),c++)}}),c>0)n.each(a,function(e){var n=t[e.type];n&&(h[n].length>1||s.push({action:"deleteAnnotation",type:e.type,id:e.id}))},this),r.isCollapsed()||0!==h.marker.length||n.each(i.marker,function(t){s.push({action:"createAnnotation",type:t})});else{var u;u=e,n.each(u,function(t){var e={action:"createAnnotation",type:t};s.push(e)})}return s}},i.prototype=new i.Prototype,e.exports=i},{underscore:269}],69:[function(t,e){"use strict";var n=t("./text_node_editor"),i=t("./heading_editor"),o=t("./blockquote_editor"),r=t("./not_editable"),s=t("./content_view_editor"),a=t("./cover_editor"),c=t("./richtext_annotator"),h=t("./list_item_editor"),u=t("./figure_editor"),l=t("./web_page_editor"),p=t("./video_editor"),d=t("./audio_editor"),f=t("./code_block_editor"),g=function(){this.annotator=new c,this.createEditor=function(t){switch(t.type){case"text":return new n(this);case"code_block":return new f(this);case"heading":return new i(this);case"blockquote":return new o(this);case"cover":return new a(this);case"figure":return new u(this);case"web_page":return new l(this);case"video":return new p(this);case"audio":return new d(this);case"list_item":return new h(this);case"view":return"content"===t.id?new s(this):new r(this);default:return new r(this)}},this.getAnnotator=function(){return this.annotator}};e.exports=g},{"./audio_editor":52,"./blockquote_editor":53,"./code_block_editor":55,"./content_view_editor":57,"./cover_editor":59,"./figure_editor":60,"./heading_editor":62,"./list_item_editor":66,"./not_editable":67,"./richtext_annotator":68,"./text_node_editor":70,"./video_editor":71,"./web_page_editor":72}],70:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-operator"),o=i.ObjectOperation,r=i.TextOperation,s=t("substance-util"),a=function(t){this.factory=t};a.Prototype=function(){this.canDeleteContent=function(t,e,n,i){var o=e.length;return o>=n&&o>=i},this.deleteContent=function(t,e,n,i){var s=t.document.resolve(e.path),a=s.get(),c=i-n;if(c>0){var h=r.Delete(n,a.substring(n,i)),u=o.Update(e.path,h,"string");t.annotator.update(u),t.document.apply(u)}},this.canInsertContent=function(t,e,n){var i=e.length;return i>=n},this.insertContent=function(t,e,n,i){var s=r.Insert(n,i),a=o.Update(e.path,s,"string");t.annotator.update(a),t.document.apply(a)},this.canAnnotate=function(){return!0},this.annotate=function(t,e,n,i,o){var r=e.path;t.document.annotate({type:n,path:r,range:i},o)},this.canBreak=function(t,e,n){var i=e.length;return i>=n},this.breakNode=function(t,e,n){var i=t.document.resolve(e.path),a=i.get(),c=a.substring(n),h=e.rootPos,u={id:s.uuid(),type:"text",content:c};t.document.apply(o.Create([u.id],u)),c.length>0&&(t.annotator.transferAnnotations(i.node,n,u),t.document.apply(o.Update(e.path,r.Delete(n,c),"string"))),t.document.show(t.view,u.id,h+1),t.selection.set([e.pos+1,0])},this.canChangeType=function(){return!1},this.canChangeType=function(t,e,n){var i=new t.document.nodeTypes[n].Model,o=t.document.nodeTypes.text.Model;return i instanceof o},this._replaceNode=function(t,e,n,i){t.document.hide(t.view,e.id),t.document.apply(o.Create([n.id],n)),t.annotator.transferAnnotations(e,0,n),t.document.apply(o.Delete([e.id],e.toJSON())),t.document.show(t.view,n.id,i)},this.changeType=function(t,e,i,o,r){if(e.type!==o){var a={id:o+"_"+s.uuid(),type:o,content:e.content};n.extend(a,r),this._replaceNode(t,e,a,i.nodePos)}},this.canJoin=function(t,e,n){return n instanceof t.document.nodeTypes.text.Model},this.join=function(t,e,n){if(!n.content)throw new Error("Currently only text and heading nodes can be joined.");var i=n.content,s=e.content.length,a=r.Insert(s,i),c=o.Update([e.id,"content"],a,"string");t.document.apply(c),t.annotator.transferAnnotations(n,0,e,s)},this.copy=function(t,e){var n=t.node,i=t.ranges[0],o=n.toJSON();o.content=n.content.substring(i.start,i.end),e.create(o),e.show("content",o.id)}},a.prototype=new a.Prototype,e.exports=a},{"substance-operator":246,"substance-util":264,underscore:269}],71:[function(t,e){"use strict";var n=t("./composite_editor"),i=function(t){n.call(this,t),this.textComponents={label:!0},this.subComponents={caption:!0}};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./composite_editor":56}],72:[function(t,e){"use strict";var n=t("./composite_editor"),i=function(t){n.call(this,t),this.textComponents={label:!0},this.subComponents={caption:!0}};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./composite_editor":56}],73:[function(t,e){"use strict";var n=t("./composite_editor"),i=function(t){n.call(this,t),this.textComponents={title:!0,url:!0,description:!0}};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./composite_editor":56}],74:[function(t,e){"use strict";var n=t("../node").Surface,i=t("../text").Surface,o=function(t,e){n.call(this,t,e),this.node.caption&&(this.captionComponent=i.textProperty(this,"caption",{path:[this.node.caption,"content"]}),this.components.push(this.captionComponent))};o.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.captionComponent&&this.captionComponent.surface.attachView(this.view.childViews.caption)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":88,"../text":90}],75:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("underscore"),o=t("../node").View,r=t("substance-util"),s=function(t,e){o.call(this,t,e),this.childViews={label:null,caption:null}};s.Prototype=function(){this.render=function(){o.prototype.render.call(this),this.audioEl=n("audio",{controls:!0}),this.audioWrapper=n(".audio-wrapper",{contenteditable:!1,children:[this.audioEl]}),this.content.appendChild(this.audioWrapper);var t=this.node.getCaption();if(t){this.captionView=this.viewFactory.createView(t,{property:"caption",propertyPath:[t.id,"content"]}),this.childViews.caption=this.captionView;var e=this.captionView.render().el;e.classList.add("caption"),this.content.appendChild(e)}var i=n(".audio-status",{contenteditable:!1,children:[n(".file-info",{html:['<span class="mp3" title="iPhone, iPad, Safari, Chrome, Internet Explorer (can\'t be played in Composer due to licensing issues)">MP3 <span class="file-size"></span></span>','<span class="ogg" title="Chrome, Firefox, Opera">Ogg <span class="file-size"></span></span>','<span class="wav" title="Chrome, Firefox, Opera">Wav <span class="file-size"></span></span>','<span class="info"><a href="http://substance.io/composer/user-manual/#heading_3dea3851c4f239c3d43dd46219b2d370" target="_blank"><i class="icon-question-sign"></i> Help</a></span>'].join("")}),n(".actions",{children:[n("a.replace",{href:"#",html:'<i class="icon-upload-alt"></i> Replace',"data-id":this.node.id}),n("a.delete-resource",{href:"#",html:'<i class="icon-trash"></i> Delete'})]})]});return this.content.appendChild(i),this.updateAudio(),this},this.updateAudio=function(){var t=this.node.getAudioFiles();this.audioEl.onloadeddata=function(){console.log("AUDIO LOADED")},this.audioEl.innerHTML="",this.$(".file-info .active").removeClass("active"),this.$(".file-info .file-size").html(""),i.each(t,function(t){var e=t.getBlob(),i=window.URL.createObjectURL(e),o=r.getReadableFileSizeString(e.size);"audio/mp3"===t.content_type||"audio/mpeg"===t.content_type?(this.audioEl.appendChild(n("source",{src:i,type:"audio/mpeg"})),this.$(".file-info .mp3").addClass("active"),this.$(".file-info .mp3 .file-size").html(o)):"audio/ogg"===t.content_type?(this.audioEl.appendChild(n("source",{src:i,type:"audio/ogg"})),this.$(".file-info .ogg").addClass("active"),this.$(".file-info .ogg .file-size").html(o)):"audio/wav"===t.content_type&&(this.audioEl.appendChild(n("source",{src:i,type:"audio/wav"})),this.$(".file-info .wav").addClass("active"),this.$(".file-info .wav .file-size").html(o))},this)},this.onNodeUpdate=function(){this.updateAudio()},this.onGraphUpdate=function(t){if(!o.prototype.onGraphUpdate.call(this,t)){var e=this.node.file;t.path[0]===e&&this.updateAudio()}}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,e.exports=s},{"../node":88,"substance-application":6,"substance-util":264,underscore:269}],76:[function(t,e){"use strict";e.exports={View:t("./editable_audio_view"),Surface:t("./audio_surface")}},{"./audio_surface":74,"./editable_audio_view":75}],77:[function(t,e){"use strict";var n=t("../node").Surface,i=t("../text").Surface,o=function(t,e){n.call(this,t,e),this.components.push(this.titleComponent());for(var i=0;i<t.authors.length;i++)this.components.push(this.authorComponent(i));this.components.push(this.sourceComponent())};o.Prototype=function(){this.titleComponent=function(){var t=this,e=new i(this.node,this.surfaceProvider,{property:"title"}),n=e.components[0];return n.element(function(){return t.view.childViews.title.el}).length(function(){return t.node.title.length+1}),n.name="title",n},this.authorComponent=function(t){var e=this,n=this.customComponent([this.node.id,"author"+t],{name:"author"}).element(function(){return e.view.authorEls[t]}).length(function(){return e.node.authors[t].length}).mapping(function(t){var e=window.document.createRange();return e.setStart(this.el.childNodes[0],t),e});return n},this.sourceComponent=function(){var t=this,e=this.customComponent([this.node.id,"source"],{name:"source"});return e.element(function(){return t.view.sourceEl}).length(function(){return t.node.source.length+1}).mapping(function(t){var e=window.document.createRange();return e.setStart(this.el.childNodes[0],t),e}),e}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":88,"../text":90}],78:[function(t,e){"use strict";var n=t("../node").View,i=t("../text").View,o=t("substance-application").$$,r=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("citation"),this.childViews={title:null}};r.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=window.document.createDocumentFragment(),e=this.node,r=this.childViews.title=new i(this.node,this.viewFactory,{property:"title"});t.appendChild(r.render().el);var s=o("a.delete-resource",{href:"#",text:"Delete",contenteditable:!1});r.el.appendChild(s);var a=o(".resource-body");this.authorEls=[];for(var c=o(".authors"),h=0;h<e.authors.length;h++){var u=e.authors[h];this.authorEls.push(o("span.author",{text:u,"data-path":"author"+h})),c.appendChild(this.authorEls[h]),c.appendChild(window.document.createTextNode(" "))}a.appendChild(c);var l=[];return e.source&&e.volume&&l.push([e.source,e.volume].join(", ")+": "),e.fpage&&e.lpage&&l.push([e.fpage,e.lpage].join("-")+", "),e.publisher_name&&e.publisher_location&&l.push([e.publisher_name,e.publisher_location].join(", ")+", "),e.year&&l.push(e.year),this.sourceEl=o(".source",{html:l.join("")}),a.appendChild(this.sourceEl),e.doi&&(this.doiEl=o(".doi",{children:[o("b",{text:"DOI: "}),o("a",{href:e.doi,target:"_new",text:e.doi})]}),a.appendChild(this.doiEl)),t.appendChild(a),this.content.appendChild(t),this}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"../node":88,"../text":90,"substance-application":6}],79:[function(t,e){"use strict";e.exports={View:t("./editable_citation_view"),Surface:t("./citation_surface")}},{"./citation_surface":77,"./editable_citation_view":78}],80:[function(t,e){"use strict";var n=t("../node").Surface,i=t("../text").Surface,o=function(t,e){n.call(this,t,e),this.titleComponent=i.textProperty(this,"title",{property:"title",path:["document","title"]}),this.components.push(this.titleComponent),this.abstractComponent=i.textProperty(this,"abstract",{property:"abstract",path:["document","abstract"]}),this.components.push(this.abstractComponent),this.englishAbstractComponent=i.textProperty(this,"abstract_en",{property:"abstract_en",path:["document","abstract_en"]}),this.components.push(this.englishAbstractComponent)};o.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.titleComponent.surface.attachView(this.view.childViews.title),this.abstractComponent.surface.attachView(this.view.childViews["abstract"]),this.englishAbstractComponent.surface.attachView(this.view.childViews.abstract_en)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":88,"../text":90}],81:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-application").$$,o=window.$,r=t("substance-document").Annotator,s=t("../node").View,a=t("../text").View,c=t("substance-util"),h=function(t,e){s.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node cover"),this.childViews={title:null},this.$el.on("click",".control.next",n.bind(this.nextDay,this)),this.$el.on("click",".control.prev",n.bind(this.prevDay,this)),this.$el.on("click",".actions .delete",n.bind(this.deleteImage,this))
},u=864e5;h.Prototype=function(){this.render=function(){s.prototype.render.call(this),this.imgEl=i("img"),this.updateImage(),this.imageEl=i(".cover-image",{contenteditable:!1,children:[this.imgEl,i(".image-status",{children:[i(".file-info",{text:""}),i(".actions",{children:[i("a.replace",{href:"#",html:'<i class="icon-upload-alt"></i> Replace',"data-path":"cover.image"}),i("a.delete",{href:"#",html:'<i class="icon-trash"></i> Delete'})]})]})]}),this.content.appendChild(this.imageEl),this.pubDateEl=i(".date",{});var t=new a(this.node,this.viewFactory,{property:"title",propertyPath:["document","title"]});t.listenTo(this.node.document,"operation:applied",t.onGraphUpdate),this.content.appendChild(t.render().el),t.el.classList.add("title"),this.renderPublicationDate();var e=new a(this.node,this.viewFactory,{property:"abstract",propertyPath:["document","abstract"]});e.listenTo(this.node.document,"operation:applied",e.onGraphUpdate),this.content.appendChild(e.render().el),e.el.classList.add("abstract");var n=new a(this.node,this.viewFactory,{property:"abstract_en",propertyPath:["document","abstract_en"]});return n.listenTo(this.node.document,"operation:applied",n.onGraphUpdate),this.content.appendChild(n.render().el),n.el.classList.add("abstract"),this.childViews.title=t,this.childViews["abstract"]=e,this.childViews.abstract_en=n,this},this.deleteImage=function(t){this.node.deleteImage(),t.preventDefault(),t.stopPropagation()},this.updateImage=function(){var t=this.node.getUrl(),e=this;t?(o(this.imagePlaceholder).addClass("hidden"),o(this.imgEl).removeClass("hidden"),this.imgEl.setAttribute("src",t),this.imgEl.onload=function(){var t=e.node.getBlob(),n=c.getReadableFileSizeString(t.size);e.$(".file-info").html([e.imgEl.naturalWidth,"x",e.imgEl.naturalHeight,", ",n])}):(o(this.imagePlaceholder).removeClass("hidden"),o(this.imgEl).addClass("hidden"))},this.renderPublicationDate=function(){var t=new Date(this.node.document.published_on).toDateString();this.pubDateEl.innerHTML=t},this.nextDay=function(t){var e=this.node.document,n=new Date(e.published_on),i=new Date(n.getTime()+u);e.setPublishedOn(i),t.preventDefault()},this.prevDay=function(t){var e=this.node.document,n=new Date(e.published_on),i=new Date(n.getTime()-u);e.setPublishedOn(i),t.preventDefault()},this.onNodeUpdate=function(t){return this.updateImage(),s.prototype.onNodeUpdate.call(this,t)},this.onGraphUpdate=function(t){if(s.prototype.onGraphUpdate.call(this,t))return!0;var e=this.node.image;return t.path[0]===e&&this.updateImage(),n.isEqual(t.path,["document","published_on"])?(this.renderPublicationDate(),!0):r.changesAnnotations(this.node.document,t,["cover","title"])?(this.childViews.title.renderContent(),!0):r.changesAnnotations(this.node.document,t,["cover","abstract"])?(this.childViews["abstract"].renderContent(),!0):r.changesAnnotations(this.node.document,t,["cover","abstract_en"])?(this.childViews.abstract_en.renderContent(),!0):!1}},h.Prototype.prototype=s.prototype,h.prototype=new h.Prototype,e.exports=h},{"../node":88,"../text":90,"substance-application":6,"substance-document":132,"substance-util":264,underscore:269}],82:[function(t,e){"use strict";e.exports={View:t("./editable_cover_view"),Surface:t("./cover_surface")}},{"./cover_surface":80,"./editable_cover_view":81}],83:[function(t,e){"use strict";e.exports={View:t("../issue/editable_issue_view"),Surface:t("../issue/issue_surface")}},{"../issue/editable_issue_view":85,"../issue/issue_surface":87}],84:[function(t,e){"use strict";e.exports={node:t("./node"),text:t("./text"),cover:t("./cover"),citation:t("./citation"),issue:t("./issue"),web_resource:t("./web_resource"),web_page:t("./web_page"),video:t("./video"),audio:t("./audio"),remark:t("./remark"),error:t("./error")}},{"./audio":76,"./citation":79,"./cover":82,"./error":83,"./issue":86,"./node":88,"./remark":89,"./text":90,"./video":92,"./web_page":95,"./web_resource":98}],85:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node").View,o=t("../text").View,r=function(t,e){i.call(this,t,e),this.$el.addClass("issue"),this.childViews={title:null,description:null}};r.Prototype=function(){var t=i.prototype;this._updateTitle=function(){this.titleTextEl.innerHTML="",this.ref&&this.titleTextEl.appendChild(n("span.title-annotation",{text:this.ref.getContent()}))},this.render=function(){i.prototype.render.call(this);var t=n("div.issue-title-wrapper.toggle-resource");this.titleTextEl=n(".text.title",{});var e=n("a.delete-resource",{href:"#",html:'<i class="icon-remove-sign"></i>',contenteditable:!1});t.appendChild(this.titleTextEl),t.appendChild(e),t.setAttribute("contenteditable","false"),this.content.appendChild(t);var r=this.childViews.description=new o(this.node,this.viewFactory,{property:"description"});this.content.appendChild(r.render().el);var s=this.node.getReferences(),a=Object.keys(s);return a.length>0&&(this.ref=s[a[0]],this._updateTitle()),this},this.onNodeUpdate=function(t){var e=null;return"title"===t.path[1]?e=this.childViews.title:"description"===t.path[1]&&(e=this.childViews.description),e?(e.onNodeUpdate(t),!0):!1},this.onGraphUpdate=function(e){return t.onGraphUpdate.call(this,e)?!0:"create"===e.type&&e.val.target===this.node.id?(this.ref=this.node.document.get(e.val.id),this.later(this._updateTitle),!0):"delete"===e.type&&e.val.target===this.node.id?(this.ref=null,this.later(this._updateTitle),!0):this.ref&&e.path[0]===this.ref.id?(this.later(this._updateTitle),!0):!1}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":88,"../text":90,"substance-application":6}],86:[function(t,e){"use strict";e.exports={View:t("./editable_issue_view"),Surface:t("./issue_surface")}},{"./editable_issue_view":85,"./issue_surface":87}],87:[function(t,e){"use strict";var n=t("../node").Surface,i=t("../text").Surface,o=function(t,e){n.call(this,t,e),this.descriptionComp=i.textProperty(this,"description"),this.components.push(this.descriptionComp)};o.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.descriptionComp.surface.attachView(this.view.childViews.description)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":88,"../text":90}],88:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.node},{"substance-nodes":145}],89:[function(t,e){e.exports=t(83)},{"../issue/editable_issue_view":85,"../issue/issue_surface":87,"/Users/danielbeilinson/Documents/code/archivist/node_modules/substance-composer/src/nodes/error/index.js":83}],90:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.text},{"substance-nodes":145}],91:[function(t,e){"use strict";var n=(window.$,t("substance-application").$$),i=t("underscore"),o=t("../node").View,r=t("substance-util"),s=function(t,e){o.call(this,t,e),this.childViews={label:null,caption:null}};s.Prototype=function(){this.render=function(){o.prototype.render.call(this),this.videoEl=n("video",{controls:!0}),this.videoWrapper=n(".video-wrapper",{contenteditable:!1,children:[this.videoEl,n(".video-status",{children:[n(".file-info",{html:['<span class="mp4" title="iPhone, iPad, Safari, Chrome, Internet Explorer (can\'t be played in Composer due to licensing issues)">MP4 <span class="file-size"></span></span>','<span class="ogg" title="Chrome, Firefox, Opera">Ogg <span class="file-size"></span></span>','<span class="webm" title="Chrome, Firefox, Opera">WebM <span class="file-size"></span></span>','<span class="info"><a href="http://substance.io/composer/user-manual/#heading_2ff4a51b4539e184e47ad3b6c1f1efb9" target="_blank"><i class="icon-question-sign"></i> Help</a></span>'].join("")}),n(".actions",{children:[n("a.replace",{href:"#",html:'<i class="icon-upload-alt"></i> Replace',"data-id":this.node.id}),n("a.delete-resource",{href:"#",html:'<i class="icon-trash"></i> Delete'})]})]})]}),this.content.appendChild(this.videoWrapper),this.updateVideo();var t=this.node.getCaption();if(t){this.captionView=this.viewFactory.createView(t,{property:"caption",propertyPath:[t.id,"content"]}),this.childViews.caption=this.captionView;var e=this.captionView.render().el;e.classList.add("caption"),this.content.appendChild(e)}return this},this.updatePoster=function(){if(this.node.poster){var t=this.node.document.get(this.node.poster),e=window.URL.createObjectURL(t.getBlob());this.videoEl.setAttribute("poster",e)}else this.videoEl.setAttribute("poster","")},this.updateVideo=function(){var t=this.node.getVideoFiles();this.videoEl.onload=function(){},this.videoEl.innerHTML="",this.$(".file-info .active").removeClass("active"),this.$(".file-info .file-size").html(""),i.each(t,function(t){var e=t.getBlob(),i=window.URL.createObjectURL(e),o=r.getReadableFileSizeString(e.size);"video/mp4"===t.content_type?(this.videoEl.appendChild(n("source",{src:i,type:"video/mp4; codecs='avc1.42E01E, mp4a.40.2'"})),this.$(".file-info .mp4").addClass("active"),this.$(".file-info .mp4 .file-size").html(o)):"video/webm"===t.content_type?(this.videoEl.appendChild(n("source",{src:i,type:"video/webm"})),this.$(".file-info .webm").addClass("active"),this.$(".file-info .webm .file-size").html(o)):"video/ogg"===t.content_type&&(this.videoEl.appendChild(n("source",{src:i,type:"video/ogg"})),this.$(".file-info .ogg").addClass("active"),this.$(".file-info .ogg .file-size").html(o))},this)},this.onNodeUpdate=function(t){"poster"===t.path[1]?this.updatePoster():"files"===t.path[1]&&this.updateVideo()}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,e.exports=s},{"../node":88,"substance-application":6,"substance-util":264,underscore:269}],92:[function(t,e){"use strict";e.exports={View:t("./editable_video_view"),Surface:t("./video_surface")}},{"./editable_video_view":91,"./video_surface":93}],93:[function(t,e){"use strict";var n=t("../node").Surface,i=t("../text").Surface,o=function(t,e){n.call(this,t,e),this.node.caption&&(this.captionComponent=i.textProperty(this,"caption",{path:[this.node.caption,"content"]}),this.components.push(this.captionComponent))};o.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.captionComponent&&this.captionComponent.surface.attachView(this.view.childViews.caption)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":88,"../text":90}],94:[function(t,e){"use strict";var n=window.$,i=t("substance-application").$$,o=t("../node").View,r=t("substance-util"),s=t("underscore"),a=function(t,e){o.call(this,t,e),this.childViews={label:null,caption:null},this.$el.on("click",".actions .replace",s.bind(this.replaceFile,this))};a.Prototype=function(){this.replaceFile=function(t){this.$(".web-page-file").click(),t.preventDefault(),t.stopPropagation()},this.render=function(){o.prototype.render.call(this),this.iFrame=i("iframe",{}),this.pageWrapper=i(".page-wrapper",{contenteditable:!1,children:[i("input.web-page-file",{contenteditable:!1,type:"file",name:"files","data-id":this.node.id,accept:"text/html"}),this.iFrame,i(".page-status",{contenteditable:!1,children:[i(".file-info",{html:""}),i(".actions",{children:[i("a.replace",{href:"#",html:'<i class="icon-upload-alt"></i> Replace'}),i("a.delete-resource",{href:"#",html:'<i class="icon-trash"></i> Delete'})]})]})]}),this.content.appendChild(this.pageWrapper);var t=this;this.iFrame.onload=function(){t.updatePage();var e=(t.iFrame.contentWindow,t.node.getHTML()),n=r.getReadableFileSizeString(e.length);t.$(".file-info").html(["<b>HTML</b> ",'<span class="file-size">'+n+"</span>",'<span class="info"><a href="http://substance.io/composer/user-manual/#heading_b4326b925dccb30afaef82607576eb0c" target="_blank"><i class="icon-question-sign"></i> Help</a></span>'].join(""))};var e=this.node.getCaption();if(e){this.captionView=this.viewFactory.createView(e,{property:"caption",propertyPath:[e.id,"content"]}),this.childViews.caption=this.captionView;var n=this.captionView.render().el;n.classList.add("caption"),this.content.appendChild(n)}return this},this.updatePage=function(){var t=this.iFrame.contentWindow.document;n(this.iFrame).css({width:this.node.width,height:this.node.height});var e=this.node.width;e.match(/.*px$/)||(e+="px"),this.$(".page-status").css({"max-width":e}),t.open();var i=this.node.getHTML();t.write(i),t.close()},this.onNodeUpdate=function(){this.updatePage()},this.onGraphUpdate=function(t){if(!o.prototype.onGraphUpdate.call(this,t)){var e=this.node.file;t.path[0]===e&&this.updatePage()}}},a.Prototype.prototype=o.prototype,a.prototype=new a.Prototype,e.exports=a},{"../node":88,"substance-application":6,"substance-util":264,underscore:269}],95:[function(t,e){"use strict";e.exports={View:t("./editable_web_page_view"),Surface:t("./web_page_surface")}},{"./editable_web_page_view":94,"./web_page_surface":96}],96:[function(t,e){"use strict";var n=t("../node").Surface,i=t("../text").Surface,o=function(t,e){n.call(this,t,e),this.node.caption&&(this.captionComponent=i.textProperty(this,"caption",{path:[this.node.caption,"content"]}),this.components.push(this.captionComponent))};o.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.captionComponent&&this.captionComponent.surface.attachView(this.view.childViews.caption)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":88,"../text":90}],97:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node").View,o=t("../text").View,r=function(t,e){i.call(this,t,e),this.$el.addClass("web-resource"),this.childViews={title:null,url:null,description:null}};r.Prototype=function(){i.prototype;this.render=function(){i.prototype.render.call(this);var t=this.childViews.title=new o(this.node,this.viewFactory,{property:"title"});this.content.appendChild(t.render().el);var e=this.childViews.url=new o(this.node,this.viewFactory,{property:"url"});this.content.appendChild(e.render().el);var r=n(".select-citation",{text:"",contenteditable:!1});e.el.appendChild(r);var s=n("a.delete-resource",{href:"#",html:'<i class="icon-remove-sign"></i>',contenteditable:!1});this.content.appendChild(s);var a=this.childViews.description=new o(this.node,this.viewFactory,{property:"description"});return this.content.appendChild(a.render().el),this.el.appendChild(n(".resource-active")),this},this.onNodeUpdate=function(t){return"title"===t.path[1]?(this.childViews.title.onNodeUpdate(t),!0):"description"===t.path[1]?(this.childViews.description.onNodeUpdate(t),!0):"url"===t.path[1]?(this.childViews.url.onNodeUpdate(t),!0):!1}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":88,"../text":90,"substance-application":6}],98:[function(t,e){"use strict";e.exports={View:t("./editable_web_resource_view"),Surface:t("./web_resource_surface")}},{"./editable_web_resource_view":97,"./web_resource_surface":99}],99:[function(t,e){"use strict";var n=t("../node").Surface,i=t("../text").Surface,o=function(t,e){n.call(this,t,e),this.titleComp=i.textProperty(this,"title"),this.urlComp=i.textProperty(this,"url"),this.descriptionComp=i.textProperty(this,"description"),this.components.push(this.titleComp),this.components.push(this.urlComp),this.components.push(this.descriptionComp)};o.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.titleComp.surface.attachView(this.view.childViews.title),this.urlComp.surface.attachView(this.view.childViews.url),this.descriptionComp.surface.attachView(this.view.childViews.description)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":88,"../text":90}],100:[function(t,e){"use strict";var n=t("./panel_controller"),i=(t("./nodes_panel_view"),function(t,e){n.call(this,t,e)});i.Prototype=function(){this.getNodes=function(){throw new Error("this method is abstract")},this.createView=function(){throw new Error("this method is abstract")},this.createViewFactory=function(){var t=this.document.constructor.ViewFactory;return new t(this.document)}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./nodes_panel_view":101,"./panel_controller":103}],101:[function(t,e){"use strict";var n=t("underscore"),i=t("./panel_view"),o=function(t,e,n){i.call(this,t,n),this.viewFactory=e,this.$nodes=$("<div>").addClass("nodes"),this.$el.append(this.$nodes)};o.Prototype=function(){this.render=function(){return this.$nodes.html(this.build()),this},this.findNodeView=function(t){return this.el.querySelector("#"+t)},this.build=function(){var t=document.createDocumentFragment();this.nodes={},n.each(this.nodes,function(t){t.dispose()});var e=this.controller.getNodes();return n.each(e,function(e){var n=this.renderNodeView(e);this.nodes[e.id]=n,t.appendChild(n.el)},this),t},this.renderNodeView=function(t){var e=this.viewFactory.createView(t,{topLevel:!0});return e.render(),e},this.hide=function(){i.prototype.hide.call(this)},this.show=function(){i.prototype.show.call(this)}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"./panel_view":104,underscore:269}],102:[function(t,e){"use strict";var n=(t("underscore"),function(t){this.name=t});n.Prototype=function(){this.createController=function(){throw new Error("this method is abstract")},this.getName=function(){return this.name}},n.prototype=new n.Prototype,n.prototype.constructor=n,e.exports=n},{underscore:269}],103:[function(t,e){"use strict";var n=t("substance-application").Controller,i=(t("underscore"),t("substance-util"),function(t,e,n){this.document=t,this.writerCtrl=e,this.config=n});i.Prototype=function(){var t=n.prototype;this.createView=function(){throw new Error("this is an abstract method")},this.getConfig=function(){return this.config},this.getName=function(){return this.config.name},this.getDocument=function(){return this.document},this.initialize=function(t,e){e(null)},this.transition=function(t,e){e(null)},this.afterTransition=function(t){this.view.transition(t)},this.dispose=function(){t.dispose.call(this),this.stopListening(),this.view&&this.view.dispose()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"substance-application":6,"substance-util":264,underscore:269}],104:[function(t,e){var n=t("underscore"),i=t("substance-application"),o=i.$$,r=i.View,s=function(t,e){r.call(this),this.controller=t,this.config=e,this.doc=t.getDocument(),this.name=e.name,this.toggleEl=o("a.context-toggle."+this.name,{title:this.config.title,html:'<i class="'+this.config.icon+'"></i><span> '+this.config.label+"</span>"}),this.$toggleEl=$(this.toggleEl),this.$el.addClass("panel").addClass(this.name),"resource"===this.config.type&&this.$el.addClass("resource-view"),this._onToggle=n.bind(this.onToggle,this),this.$toggleEl.click(this._onToggle)};s.Prototype=function(){this.dispose=function(){this.$toggleEl.off("click",this._onClick),this.$el.off("scroll",this._onScroll),this.stopListening()},this.onToggle=function(){this.trigger("toggle",this.name)},this.getToggleControl=function(){return this.toggleEl},this.jumpToResource=function(){},this.hasOutline=function(){return!1},this.updateOutline=function(){},this.show=function(){this.$el.removeClass("hidden")},this.hide=function(){this.$el.addClass("hidden"),this.$toggleEl.removeClass("active")},this.activate=function(){this.show(),this.$toggleEl.addClass("active")},this.showToggle=function(){this.$toggleEl.removeClass("hidden")},this.hideToggle=function(){this.$toggleEl.addClass("hidden")},this.getDocument=function(){return this.doc},this.findNodeView=function(t){return this.el.querySelector("*[data-id="+t+"]")}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,e.exports=s},{"substance-application":6,underscore:269}],105:[function(t,e){"use strict";var n=t("underscore"),i=(t("substance-util"),t("substance-application").Controller),o=t("./publish_view"),r=(window.localStorage,window.app,function(t,e){this.document=t,this.composerCtrl=e});r.Prototype=function(){this.createView=function(){return this.view||(this.view=new o(this)),this.view},this.getDefaultParams=function(t){var e={};return n.each(this.availableTemplates[t].params,function(t,n){e[n]=t["default"]}),e},this.updatePublishSettings=function(t){t.params||(t.params=this.getDefaultParams(t.templateId)),this.document.createSettings(t)},this.openExternalLink=function(t){this.composerCtrl.openExternalLink(t)},this.initialize=function(t,e){this.createView().render(),e(null)},this.generatePreview=function(t){this.composerCtrl.generatePreview(t)},this.loadAvailableTemplates=function(t){var e=this;this.composerCtrl.getAvailableTemplates(function(n,i){e.availableTemplates=i,t(null)})},this.getTemplateConfig=function(t){var e=this.availableTemplates[t];return e||(e=this.availableTemplates.substance),e},this.DEFAULT_STATE={id:"default"},this.transition=function(t,e){var n=!1;return n?e(null,{skip:n}):void this.loadAvailableTemplates(e)},this.afterTransition=function(t){this.view.transition(t)},this.dispose=function(){this.view&&this.view.dispose(),this.view=null}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,e.exports=r},{"./publish_view":106,"substance-application":6,"substance-util":264,underscore:269}],106:[function(t,e){var n=t("substance-application").View,i=t("substance-application").$$,o=window.$,r=t("underscore"),s=function(t){n.call(this),this.publishCtrl=t,this.$el.addClass("publish-settings-view"),this.$el.on("click",".choose-template a.template",this.selectTemplate.bind(this)),this.$el.on("change",".template-settings input",this.updatePublishSettings.bind(this)),this.$el.on("mouseup",function(t){return t.stopPropagation()})};s.Prototype=function(){this.updatePublishSettings=function(){var t={};this.$(".template-settings input").each(function(){var e=this.getAttribute("data-param-name"),n=this.checked;t[e]=n});var e=this.publishCtrl.document,n=e.getSettings().templateId;this.publishCtrl.updatePublishSettings({templateId:n,params:t}),this.renderPreview()},this.selectTemplate=function(t){var e=o(t.currentTarget).attr("data-id"),n=this;this.publishCtrl.updatePublishSettings({templateId:e}),n.renderTemplateSettings(),n.renderPreview(),t.preventDefault(),t.stopPropagation()},this.transition=function(){this.contextView&&this.contextView.dispose(),this.renderPreview(),this.renderTemplateSettings()},this.renderPreview=function(){var t=this;this.publishCtrl.generatePreview(function(e,n){o(t.iFrameEl).css({opacity:0}),t.iFrameEl.contentWindow?t.iFrameEl.contentWindow.location.reload():t.iFrameEl.setAttribute("src",n),window.native_app&&(t.iFrameEl.onload=function(){r.delay(function(){o(t.iFrameEl).animate({opacity:1},350)},50),this.contentDocument.onclick=function(e){var n=e.target||e.srcElement;if("A"==n.tagName){var i=n.href;(i.match(/^http/)||i.match(/^mailto/))&&(console.log("Opening external url",i),t.publishCtrl.openExternalLink(i),e.preventDefault(),e.stopPropagation())}}})})},this.render=function(){return this.el.innerHTML="",this.header=i(".publish-settings-header"),this.el.appendChild(this.header),this.chooseTemplate=i(".choose-template"),this.header.appendChild(this.chooseTemplate),this.exportLink=i("a.export-publication",{href:"#",html:'<i class="icon-signout"></i> Export web page'}),this.header.appendChild(this.exportLink),this.el.appendChild(this.header),this.templateSettings=i(".template-settings"),this.el.appendChild(this.templateSettings),this.preview=i(".document-preview"),this.el.appendChild(this.preview),this.iFrameEl=i("iframe",{sandbox:"allow-same-origin allow-scripts"}),this.preview.appendChild(this.iFrameEl),this},this.renderTemplateSettings=function(){var t=this.publishCtrl.document.getSettings(),e=this.publishCtrl.getTemplateConfig(t.templateId),n=this;n.chooseTemplate.innerHTML="";var o=Object.keys(this.publishCtrl.availableTemplates).length;o>=2?r.each(this.publishCtrl.availableTemplates,function(t){n.chooseTemplate.appendChild(i("a.template",{href:"#","data-id":t.id,text:t.name}))}):n.chooseTemplate.appendChild(i(".template",{text:"Publish settings"})),this.$(".choose-template .template").removeClass("active"),this.$(".template[data-id="+e.id+"]").addClass("active"),this.templateSettings.innerHTML="",r.each(e.params,function(e,o){var r={type:"checkbox","data-param-name":o};t.params[o]&&(r.checked="checked");var s=i(".setting",{children:[i(".label",{text:e.name}),i("input",r)]});n.templateSettings.appendChild(s)})}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,e.exports=s},{"substance-application":6,underscore:269}],107:[function(t,e){"use strict";var n=t("./resource_tools_view"),i=t("substance-application").Controller,o=function(t){this.parentAdapter=t,this.state={id:"initialized"}};o.Prototype=function(){this.createView=function(){return this.view||(this.view=new n(this)),this.view},this.initialize=function(t,e){this.createView(),e(null)},this.dispose=function(){this.view&&this.view.dispose(),this.view=null},this.update=function(){}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"./resource_tools_view":108,"substance-application":6}],108:[function(t,e){var n=t("substance-application").View,i=t("substance-application").$$,o=(t("underscore"),function(t){n.call(this),this.$el.addClass("resource-tools-view"),this.controller=t});o.Prototype=function(){this.render=function(){return this.el.innerHTML="",this.titleEl=i(".title"),this.messageEl=i(".message"),this.actionsEl=i(".actions"),this.el.appendChild(this.titleEl),this.el.appendChild(this.messageEl),this.el.appendChild(this.actionsEl),this},this.clear=function(){this.titleEl.innerHTML="",this.messageEl.innerHTML="",this.actionsEl.innerHTML=""},this.update=function(){var t=this.controller.parentAdapter.state;switch(this.clear(),t.contextId){case"figures":this.updateTitle("Figures");break;case"toc":this.updateTitle("Contents");break;case"citations":this.updateTitle("References");break;case"info":this.updateTitle("Article Info");break;case"remarks":this.updateTitle("Remarks");break;case"errors":this.updateTitle("Errors");break;default:return}},this.updateTitle=function(t){this.titleEl.innerHTML=t},this.updateMessage=function(t){this.messageEl.innerHTML=t},this.updateActions=function(t){this.actionsEl.innerHTML="",this.actionsEl.appendChild(i("a",{href:"#",text:t.name,"class":t["class"]}))}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"substance-application":6,underscore:269}],109:[function(t,e){"use strict";var n=(t("substance-util").zip,function(t){this.backend=t});n.Prototype=function(){this.readFromArrayBuffer=function(t){return this.backend.readFromArrayBuffer(t)},this.open=function(t,e){this.backend.open(t,e)},this.save=function(t,e,n){this.backend.save(t,e,n)},this.newDocument=function(){console.error("Abstract interface not implemented")},this.updateTitle=function(t){window.document.title=t},this.attachComposer=function(){},this.openExternalLink=function(t){window.open(t)},this.openFileDialog=function(){throw new Error("GenericShell.openFileDialog is abstract")}},n.prototype=new n.Prototype,e.exports=n},{"substance-util":264}],110:[function(t,e){"use strict";var n=t("substance-converter/src/html_converter"),i=t("substance-converter/src/html_exporter"),o=function(t){this.writerCtrl=t,this.el=window.document.createElement("DIV"),this.el.setAttribute("contenteditable","true"),this.el.classList.add("clipboard"),this.el.onpaste=this.onPaste.bind(this),this._lastSelection=null,this._contentText=""};o.Prototype=function(){this._copySelection=function(){var t=window.getSelection();this._contentText="",this._contentDoc=null;var e=this.writerCtrl.currentController;if(e&&t.rangeCount>0&&e.session.selection.hasMultipleNodes()){var n=t.getRangeAt(0);this._contentText=n.toString(),this._contentDoc=e.copy()}else this._contentDoc=null,this._contentText=""},this.onCopy=function(t){if(console.log("WebClipboard.onCopy",arguments),this._copySelection(),t.clipboardData&&this._contentDoc){var e=new i,n=e.toHtml(this._contentDoc,{containers:["content"]});t.clipboardData.setData("application/substance",JSON.stringify(this._contentDoc.toJSON())),t.clipboardData.setData("text/html",n),t.preventDefault()}},this.onCut=function(){console.log("WebClipboard.onCut",arguments),this.onCopy(),event.preventDefault()},this.onPaste=function(t){console.log("Paste post-processing...",this.el);var e=this,i=this.writerCtrl.currentController,o=i.session.document;if(t.clipboardData){for(var r=t.clipboardData.items,s=null,a=null,c=0;c<r.length;c++)"application/substance"===r[c].type&&(s=r[c]),"text/html"===r[c].type&&(a=r[c]);if(s)return void s.getAsString(function(t){console.log("Received Substance JSON via Clipboard",t);try{var n=o.fromSnapshot(JSON.parse(t),{schema:o.schema});i.session.selection.set(e._lastSelection,{silent:"true"}),i.paste(n,""),e._lastSelection=null}catch(r){e.writerCtrl.onError(r)}});if(a){var i=this.writerCtrl.currentController,o=i.session.document;return void a.getAsString(function(t){console.log("Received HTML via Clipboard",t);try{var r=o.newInstance(),s=new n({trimWhitespaces:!0,REMOVE_INNER_WS:!0}),a=(new window.DOMParser).parseFromString(t,"text/html");s.convert(a,r),i.session.selection.set(e._lastSelection,{silent:"true"}),i.paste(r,a.body.textContent),e._lastSelection=null}catch(c){e.writerCtrl.onError(c)}})}}window.setTimeout(function(){var t=window.document.createRange();t.selectNode(e.el);var n=t.toString(),i=e.writerCtrl.currentController;if(n===e._contentText)try{i.session.selection.set(e._lastSelection,{silent:"true"}),i.paste(e._contentDoc,n),e._lastSelection=null}catch(o){e.writerCtrl.onError(o)}else try{i.session.selection.set(e._lastSelection,{silent:"true"}),i.write(n),e._lastSelection=null}catch(o){e.writerCtrl.onError(o)}e.el.innerHTML=""},10)},this.attachSurface=function(t){var e=this,n=t.keyboard;n.bind("cut","keydown",function(t){var n=window.getSelection(),i=n.getRangeAt(0),o=i.cloneContents();e.el.innerHTML="",e.el.appendChild(o),e._copySelection();try{e.writerCtrl.currentController["delete"]()}catch(r){return e.writerCtrl.onError(r),t.preventDefault(),void t.stopPropagation()}var s=window.document.createRange();s.selectNodeContents(e.el),n.removeAllRanges(),n.addRange(s),window.setTimeout(function(){var t=e.writerCtrl.currentController.session.selection;t.set(t)},10)}),n.bind("paste","keydown",function(){e.el.innerHTML="";var t=e.writerCtrl.currentController.session.selection;e._lastSelection=t.range();var n=window.getSelection(),i=window.document.createRange();i.setStart(e.el,0),n.removeAllRanges(),n.addRange(i)})}},o.prototype=new o.Prototype,e.exports=o},{"substance-converter/src/html_converter":120,"substance-converter/src/html_exporter":121}],111:[function(t,e){"use strict";var n=window.$,i=(t("underscore"),t("../backends/localstorage_backend")),o=t("./generic_shell"),r=t("../backends/web_file_wrapper"),s=t("./web_clipboard"),a=function(t){o.call(this,t||new i(this));var e=window.document.getElementById("backstage");if(!e)throw new Error("Could not find backstage element.");var r=n(e);this.$openFile=n('<input id="openfile" type="file"></input>');var s=n('<dialog id="info-dialog"></dialog>');s.append("<div>").addClass("title"),s.append("<div>").addClass("message"),s.append("<div>").addClass("buttons"),s.append("<div>").addClass("detail"),this.$infoDialog=s,r.append(this.$openFile),r.append(this.$infoDialog)};a.Prototype=function(){this.getClipboard=function(t){return new s(t)},this.getAvailableTemplates=function(t){var e={substance:{id:"substance",name:"Substance",params:{include_toc:{type:"boolean",name:"Table of Contents","default":!1},include_references:{name:"References",type:"boolean","default":!1},enable_section_numbering:{name:"Numbering",type:"boolean","default":!1}}}};t(null,e)},this.generatePreview=function(t,e){var n="http://zive.at";e(null,n)},this.openFileDialog=function(t,e){var n=this.$openFile;t.multiple?n.attr("multiple",!0):n.removeAttr("multiple"),t.accept?n.attr("accept",t.accept):n.removeAttr("accept"),n.unbind("change"),n.bind("change",function(t){r.wrapFiles(t.target.files,e)
}),n.click()},this.showModalDialog=function(){console.log("TODO: implement confirm modal dialog appropriately")}},a.Prototype.prototype=o.prototype,a.prototype=new a.Prototype,a.prototype.constructor=a,e.exports=a},{"../backends/localstorage_backend":38,"../backends/web_file_wrapper":39,"./generic_shell":109,"./web_clipboard":110,underscore:269}],112:[function(t,e){"use strict";var n=(window.$,t("substance-application").$$),i=t("substance-application").View,o=function(t){i.call(this),this.$el.addClass("toolbar-view"),this.controller=t,this.actions={},this.controls={}};o.Prototype=function(){this.render=function(){this.el.innerHTML="";var t=n(".workflows.group");this.controls.dashboard=n("a.dashboard",{href:"/",html:'<i class="icon-tasks"></i><span class="label">Dashboard</span>'}),t.appendChild(this.controls.dashboard),this.controls.subjects=n("a.subjects",{href:"/subjects",html:'<i class="icon-tags"></i><span class="label">Subjects</span>'}),t.appendChild(this.controls.subjects);var e=n(".workflows.group"),i=n(".toolbar-inner"),o=n(".groups");return o.appendChild(t),o.appendChild(e),i.appendChild(o),this.contextBar=n(".context-bar"),i.appendChild(this.contextBar),this.el.appendChild(i),this},this.update=function(){},this.dispose=function(){this.stopListening()},this.getState=function(){return this.controller.state}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"substance-application":6}],113:[function(t,e){var n=function(){this.name="link",this.title="Link",this.icon="icon-link",this.action="select-location"};n.Prototype=function(){this.isActive=function(t){return!!t.getActiveAnnotationByType("citation_reference")},this.isEnabled=function(t){var e=t.getCurrentEditor();if(!e)return!1;if("content"!==e.view)return!1;var n=e.selection;return!n.isCollapsed()},this.handleToggle=function(t){var e=t.getActiveAnnotationByType("citation_reference");e?t.deleteAnnotation(e):t.workflows.add_hyper_link.beginWorkflow()}},n.Prototype.prototype=n.prototype,n.prototype=new n.Prototype,n.prototype.constructor=n,e.exports=n},{}],114:[function(t,e){"use strict";var n=(t("underscore"),t("./workflow")),i=function(){n.apply(this,arguments),this.handlers=[]};i.Prototype=function(){this.registerHandlers=function(){},this.unRegisterHandlers=function(){},this.transition=function(){},this.handlesStateUpdate=!0,this.handleStateUpdate=function(t,e){if("addref"===t.id){console.error("HACK: Attaching click handler....");var n;switch(t.contextId){case"locations":n="location";break;case"citations":n="citation"}return n&&(this.$addRefEls=this.writerView.$(".resource-view."+t.contextId+" .nodes > .content-node"),this.$addRefEls.on("click",function(t){var e=t.currentTarget.id;this.endWorkflow(e,n),t.preventDefault()}.bind(this)),this.$addRefEls.on("mouseup",function(t){t.stopPropagation()})),!0}return"addref"===e.id?(this.$addRefEls.off("click"),this.$addRefEls.off("mouseup"),!0):!1},this.beginWorkflow=function(){var t=this.writerCtrl.getCurrentEditor(),e=this.writerCtrl.document,n=this.writerCtrl.currentSession,i=e.state,o=this.writerCtrl.citationsCtrl;if(!n)return console.error("Workflow 'AddRef': nothing selected."),!1;var r=n.container,s=n.selection;if(s.isNull())throw new errors.SelectionError("Selection is null");var a=n.container.id,c=s.getCursor(),h=r.getRootNodeFromPos(c.pos),u=c.charPos,l=t.createCitationWithReference("citation_reference",l),p=o.session.container.getNodeComponents(l),d=p[1];o.session.selection.set({start:[d.pos,0],end:[d.pos,d.length]}),this.writerCtrl.switchState({id:"addref",contextId:"citations",containerId:a,nodeId:h.id,referenceType:"citation_reference",resourceId:l,recover:i,charPos:""+u},{"no-scroll":!0})},this.endWorkflow=function(t){console.log("NEW!! WriterController.endAddRef");var e=this.writerCtrl.contentCtrl;t!==this.writerCtrl.state.resourceId&&(this.writerCtrl.rollBack(),e.addReference("citation_reference",{target:t})),e.focus()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./workflow":117,underscore:269}],115:[function(t,e){"use strict";var n=t("underscore"),i=window.$,o=t("./workflow"),r=function(){o.apply(this,arguments),this._onMouseDown=this.onMouseDown.bind(this),this._onMouseMove=this.onMouseMove.bind(this),this._onMouseUp=this.onMouseUp.bind(this),this.wRange=null,this.data=null};r.Prototype=function(){function t(t){var e,n,i;if(window.document.caretPositionFromPoint)e=window.document.caretPositionFromPoint(t.clientX,t.clientY),n=e.offsetNode,i=e.offset;else{if(!window.document.caretRangeFromPoint)return void console.error("Browser not supported");e=window.document.caretRangeFromPoint(t.clientX,t.clientY),n=e.startContainer,i=e.startOffset}return{startContainer:n,startOffset:i}}this.constructor=r,this.registerHandlers=function(){this.writerView.el.addEventListener("mousedown",this._onMouseDown,!0)},this.unRegisterHandlers=function(){this.writerView.el.removeEventListener("mousedown",this._onMouseDown,!0)},this.onMouseDown=function(t){for(var e=null,n=t.target,o=0;3>o;o++){if(n&&n.classList.contains("range-handle")){e=n;break}n=n.parentElement}if(e){console.log("YAY",o,t);var r=e.parentElement,s=i(e).parents(".surface")[0],a=r.dataset.annotationId,c=e.classList.contains("left")?"left":"right",h=s.id,u=this.writerView.getSurface(h);this.data={surfaceName:h,annotationId:a,boundary:c};var l=window.getSelection();l.removeAllRanges();var p=this.writerCtrl.document.get(a);if(!p)return void console.error("Could not find annotation",a);var d,f;"left"===c?(d={path:p.endPath,offset:p.endCharPos},f={path:p.startPath,offset:p.startCharPos}):(d={path:p.startPath,offset:p.startCharPos},f={path:p.endPath,offset:p.endCharPos});var g,v,y,m,w=window.document.createRange(),_=u.getPositionFromCoordinate(d.path,d.offset),b=u.getPositionFromCoordinate(f.path,f.offset),C=function(t){for(var e=t.firstChild;e;e=e.nextSibling){if(e.nodeType===window.document.TEXT_NODE)return e;if(e.nodeType===window.document.ELEMENT_NODE){var n=C(e);if(n)return n}}return null};"left"===c?(g=_.startContainer,v=_.startOffset,y=C(b.startContainer.nextSibling),m=0):(g=C(_.startContainer.nextSibling),v=0,y=b.startContainer,m=b.startOffset),console.log("Anchoring:",g,v),console.log("Focussing:",y,m),w.setStart(g,v),this.wRange=w,l.addRange(w),l.extend(y,m),this.isDragging=!0,this.writerView.el.addEventListener("mousemove",this._onMouseMove,!0),this.writerView.el.addEventListener("mouseup",this._onMouseUp,!0),t.preventDefault(),t.stopPropagation()}},this.onMouseMove=function(e){if(this.isDragging){var n=t(e),i=window.getSelection();i.extend(n.startContainer,n.startOffset),e.stopPropagation(),e.preventDefault()}},this.onMouseUp=function(e){if(this.isDragging){console.log("Egg dropped.",e);var i=this.data;this.data=null,this.isDragging=!1,this.writerView.el.removeEventListener("mousemove",this._onMouseMove,!0),this.writerView.el.removeEventListener("mouseup",this._onMouseUp,!0),window.getSelection().removeAllRanges(),e.stopPropagation(),e.preventDefault();var o=t(e),r=this.writerView.getSurface(i.surfaceName),s=i.annotationId,a=r.getCoordinateForPosition(o);if(!a)return;var c,h,u=r.getContainer().getComponent(a[0]),l=a[1],p=this.writerCtrl.document.get(s);"left"===i.boundary?(c="startPath",h="startCharPos"):(c="endPath",h="endCharPos");var d=r.docCtrl.session.startSimulation();n.isEqual(p[c],u.path)||d.document.set([s,c],u.path,{"multi-annotation-update":!0}),p[h]!==l&&d.document.set([s,h],l,{"multi-annotation-update":!0}),p.removeFragments(d),d.document.get(s).addFragments(d),d.save(),r.docCtrl._afterEdit(this)}}},r.Prototype.prototype=o.prototype,r.prototype=new r.Prototype,e.exports=r},{"./workflow":117,underscore:269}],116:[function(t,e){"use strict";var n=(t("underscore"),t("./workflow")),i=function(){n.apply(this,arguments),this.handlers=[]};i.Prototype=function(){this.registerHandlers=function(){},this.unRegisterHandlers=function(){},this.toggleResourceReference=function(){}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./workflow":117,underscore:269}],117:[function(t,e){"use strict";var n=function(){this.writerController=null,this.writerView=null};n.Prototype=function(){this.attach=function(t,e){this.writerCtrl=t,this.writerView=e,this.registerHandlers()},this.detach=function(){this.unRegisterHandlers(),this.writerView=null,this.writerController=null},this.registerHandlers=function(){throw new Error("This method is abstract")},this.unRegisterHandlers=function(){throw new Error("This method is abstract")},this.handlesStateUpdate=!1,this.handleStateUpdate=function(){throw new Error("This method is abstract")}},n.prototype=new n.Prototype,e.exports=n},{}],118:[function(t,e){(function(n,i){"use strict";var o=t("substance-application").Controller,r=t("./writer_view"),s=t("underscore"),a=t("./editors/richtext_editor_factory"),c=t("./editors/figures_editor_factory"),h=t("./editors/infos_editor_factory"),u=t("./editors/issues_editor_factory"),l=t("./editors/citations_editor_factory"),p=t("./editors/richtext_annotator"),d=t("substance-document"),f=d.Session,g=t("substance-util"),v=t("./composer_editor_controller.js"),y=g.errors,m=y.define("FileUploadError",-1),w=157286400,_=function(t){for(var e=0,n=0;n<t.length;n++)e+=t[n].size;return e},b=function(t){return _(t)<=w},C=function(t,e){this.document=t,this.shell=e.shell,this.panels=e.panels,this.tools=e.tools,this.panelControllers={},s.each(this.panels,function(e){this.panelControllers[e.getName()]=e.createController(t,this)},this),this.workflows=e.workflows||[],console.log("registered workflows",this.workflows),this.composerCtrl=e.composerCtrl,this.options=e||{},this.keymap=C._getDefaultKeyMap()};C.Prototype=function(){function t(t){window.setTimeout(function(){t.view.tocView&&t.view.tocView.render()},0)}var e=o.prototype;this.createView=function(){return this.view||(this.view=new r(this,this.options)),this.view},this.DEFAULT_STATE={id:"main",contextId:"content"},this.initialize=function(t,e){var n=this.document;this.lastContext="toc",this.contentCtrl=new v(new f(n.get("content")),new a(n)),this.annotator=new p,n.contains("figures")&&(this.figuresCtrl=new v(new f(n.get("figures")),new c)),n.contains("info")&&(this.infoCtrl=new v(new f(n.get("info")),new h)),n.contains("citations")&&(this.citationsCtrl=new v(new f(n.get("citations")),new l)),n.contains("remarks")&&(this.remarksCtrl=new v(new f(n.get("remarks")),new u)),n.contains("errors")&&(this.errorsCtrl=new v(new f(n.get("errors")),new u)),this.referenceIndex=n.getIndex("references");var i=["content","figures","citations","info","errors","remarks"];this.allCtrls=[];for(var o=0;o<i.length;o++){var r=i[o]+"Ctrl",d=this[r];d&&this.allCtrls.push(d)}s.each(this.allCtrls,function(t){this.listenTo(t.session.selection,"selection:changed",this.onSelectionChange.bind(this,t)),this.listenTo(t,"document:edited",this.onDocumentEdit),this.listenTo(t,"error",this.onError)},this),this.listenTo(this.document,"property:updated",this.onPropertyUpdate),this.createView().render(),e(null)},this.transition=function(t,e){if(t.id===this.state.id){var n=!1;switch(t.id){case"main":n=t.contextId===this.state.contextId&&t.resourceId===this.state.resourceId&&t.nodeId===this.state.nodeId&&t.subjectReferenceId===this.state.subjectReferenceId&&this.state.mode===t.mode;break;case"imageurl":n=!0}if(n)return e(null,{skip:!0})}e(null)},this.dispose=function(){if(e.dispose.call(this),this.stopListening(),this.view&&this.view.dispose(),this.contentCtrl&&this.contentCtrl.dispose(),this.figuresCtrl&&this.figuresCtrl.dispose(),this.infoCtrl&&this.infoCtrl.dispose(),this.issueCtrl&&this.issueCtrl.dispose(),this.referenceIndex&&this.referenceIndex.dispose(),this.__saveDocumentThread&&window.clearInterval(this.__saveDocumentThread),this.childController&&this.childController.dispose(),this.document.__backend__){var t=this;this.document.__backend__.save(function(e){e?console.error("Could not save document:",t.document.id):t.document.__backend__.close()})}this.view=null,this.contentCtrl=null,this.figuresCtrl=null,this.infoCtrl=null,this.referenceIndex=null,this.__saveDocumentThread=null},this.afterTransition=function(t){this.view&&this.view.updateState(this.state,t)};var n={figure_reference:"figures",contributor_reference:"info",remark_reference:"remarks",error_reference:"errors",citation_reference:"citations",location_reference:"locations",person_reference:"persons",definition_reference:"definitions"},i=function(t){return void 0!==n[t.type]},d=function(t,e,n){var i=(t.state,[]);i.push({id:"main",contextId:e,resourceId:n}),t.switchState(i,{updateRoute:!0,replace:!1})};this.onSelectionChange=function(t){this.currentController=t,this.viewName=t.session.container.name,this.currentSession=t.session,this.view.onSelectionUpdate();var e=this.currentSession.annotator.getAnnotations(this.currentSession.selection);e=s.filter(e,i);var o=Object.keys(e);if(1===o.length){var r=e[o[0]];d(this,n[r.type],r.target)}else if(s.include(["figures","info","errors","remarks","citations"],this.viewName)){if(!this.currentSession.selection.isNull()){var a=this.currentSession.selection.getCursor(),c=this.currentSession.container.getRootNodeFromPos(a.pos);this.switchState({id:"main",contextId:this.state.contextId,resourceId:c.id},{updateRoute:!0,replace:!0,"no-scroll":!0})}}else this.switchState({id:"main",contextId:this.state.contextId},{updateRoute:!0,replace:!0})},this.getCurrentEditor=function(){return this.currentController},this._scheduleSaveDocument=function(){var t=this;!this.document.__backend__&&!t.options.onAutoSave||this.__saveDocumentTask||(this.__saveDocumentTask=window.setTimeout(function(){t.view&&(t.options.onAutoSave&&t.options.onAutoSave(),t.view.updateOutline(),t.view.contentView.annotationBar.render()),t.__saveDocumentTask=null},200))},this.onDocumentEdit=function(){this.view&&(this.document.__dirty=!0,this.view.onDocumentEdit(),this.options.onDocumentEdit&&this.options.onDocumentEdit(),this._scheduleSaveDocument())},this.onError=function(t){console.error(t.message),g.printStackTrace(t),"SelectionError"===t.name||this.composerCtrl.sendError(t)},this.onPropertyUpdate=function(e){if(this.view){var n=!1;if("content"===e[0])n=!0;else if("content"===e[1]||"level"===e[1]){var i=this.document.get(e[0]);"heading"===i.type&&(n=!0)}n&&t(this)}},this.getContextId=function(){return this.state.contextId||"toc"},this.getResourceReferenceContainers=function(t){var e=this.referenceIndex.get(t),n=this.contentCtrl.session.container,i=s.uniq(s.map(e,function(t){if("block_reference"===t.type)return t.id;var e=n.lookup(t.path);return e.root.id}));return i},this.getCurrentView=function(){return this.viewName||"content"},this.hasFigures=function(){return this.figuresCtrl},this.hasCitations=function(){return this.citationsCtrl},this.hasInfo=function(){return this.infoCtrl},this.hasRemarks=function(){return this.remarksCtrl},this.hasErrors=function(){return this.errorsCtrl},this.hasView=function(t){return this[t+"Ctrl"]},this.insertNode=function(t,e){this.currentController.insertNode(t,e)},this.getTextMode=function(){var t=this.getCurrentNode();return t?t.type:null},this.getCurrentNode=function(){var t=this.currentSession;if(!t)return null;var e=t.selection;if(e.hasMultipleNodes())return null;if(e.isNull())return null;var n=e.getCursorPosition(),i=t.container.getComponent(n[0]);return i?i.root:(console.log("FIXME: selection is not null, but there is no component."),null)},this.getAnnotations=function(){var t=this.currentSession;return t?t.annotator.getAnnotations(t.selection):{}},this.getActiveAnnotation=function(){var t=this.getAnnotations();return t.length>1?null:t[0]},this.getActiveAnnotationByType=function(t){var e=this.getCurrentEditor();if(!e)return null;for(var n=e.annotator.getAnnotations(e.selection),i=0;i<n.length;i++){var o=n[i];if(o.type===t)return o.id}},this.generatePreview=function(t,e){this.options.generatePreview&&this.options.generatePreview(t,e)},this.openExternalLink=function(t){this.options.openExternalLink?this.options.openExternalLink(t):window.open(t)},this.setSelection=function(t,e){this[t+"Ctrl"].session.selection.set(e)},this.createAnnotation=function(t,e){this.currentController.annotate(t,e);var n,i,o,r,s;"remark_reference"===t?(r=this.remarksCtrl,n=this.document.get("remarks"),o=n.getNodeComponents(this.state.resourceId),i=o[0],s=[i.pos,0]):"error_reference"===t&&(r=this.errorsCtrl,n=this.document.get("errors"),o=n.getNodeComponents(this.state.resourceId),i=o[0],s=[i.pos,0]),s&&window.setTimeout(function(){r.selection.set(s)},0)},this.deleteAnnotation=function(t){this.currentController.deleteAnnotation(t)},this.switchNodeType=function(t,e){this.currentController.changeType(t,e)};var y={multiple:!1,accept:"image/*"},_={multiple:!0,accept:"video/*,image/*"},C={multiple:!0,accept:"audio/*"},x={multiple:!1,accept:"text/html"};this.insertFigure=function(){var t=this;this.shell.openFileDialog(y,function(e,n){if(e)return console.error(e);if(1===n.length){var i=n[0],o=t.contentCtrl;o.insertFigure(i),t.onDocumentEdit()}})},this.replaceImage=function(t){var e=this;this.shell.openFileDialog(y,function(n,i){if(n)return console.error(n);if(1===i.length){var o=i[0],r=e.contentCtrl;r.setFile(t,o),e.onDocumentEdit()}})},this.insertVideo=function(){var t=this;this.shell.openFileDialog(_,function(e,n){if(e)return console.error(e);var i=t.contentCtrl;i.insertVideo(n),t.onDocumentEdit()})},this.replaceVideo=function(t){var e=this;this.shell.openFileDialog(_,function(n,i){if(n)return console.error(n);var o=e.contentCtrl;o.setVideoFiles(t,i),e.onDocumentEdit()})},this.insertAudio=function(){var t=this;this.shell.openFileDialog(C,function(e,n){if(e)return console.error(e);var i=t.contentCtrl;i.insertAudio(n),t.onDocumentEdit()})},this.replaceAudio=function(t){var e=this;this.shell.openFileDialog(C,function(n,i){if(n)return console.error(n);var o=e.contentCtrl;o.setAudioFiles(t,i),e.onDocumentEdit()})},this.insertWebPage=function(){var t=this;this.shell.openFileDialog(x,function(e,n){if(e)return console.error(e);if(1===n.length){var i=n[0],o=t.contentCtrl;o.insertWebPage(i),t.onDocumentEdit()}})},this.replaceWebPageFile=function(t){var e=this;this.shell.openFileDialog(x,function(n,i){if(n)return console.error(n);if(1===i.length){var o=i[0],r=e.contentCtrl;r.setWebPageFile(t,o),e.onDocumentEdit()}})},this.setFile=function(t,e,n){if(!b([e]))return this.sendError(new m("Limit of "+g.getReadableFileSizeString(w)+" exceeded"));var i=this.contentCtrl;i.setFile(t,e,n),this.onDocumentEdit()},this.addContributor=function(){var t=this.infoCtrl.addContributor();this.onDocumentEdit(),this.switchState({id:"main",contextId:"info",resourceId:t})},this.deleteResource=function(t,e){var n=this[t+"Ctrl"];if(n.deleteResource(e),this.onDocumentEdit(),"main"===this.state.id){var i=s.clone(this.state);delete i.resourceId,this.switchState(i,{updateRoute:!0,replace:!0})}},this.getActions=function(){var t=this.currentSession;if(!t)return[];if("content"!==this.currentController.view)return[];var e=this.annotator.getAllowedActions(t,t.selection);return e=e.concat(this.currentController.getAllowedActions())},this.performAction=function(t){switch(t.action){case"createAnnotation":"citation_reference"===t.type?this.beginAddRef("citation"):this.createAnnotation(t.type,t.data);break;case"deleteAnnotation":this.deleteAnnotation(t.id);break;default:return void console.error("Action not implemented: ",t)}},this.rollBack=function(){this.document.chronicle.reset(this.state.recover),this.document.chronicle.mark("master")}},C.Prototype.prototype=o.prototype,C.prototype=new C.Prototype,C._getDefaultKeyMap=function(){var e=t("./default_keymap_osx");if(void 0!==i.navigator){var o=i.navigator.platform;o.toLowerCase().search("linux")>=0?e=t("./default_keymap_unix"):o.toLowerCase().search("win32")>=0&&(e=t("./default_keymap_unix"))}else void 0!==n&&"darwin"!==n.platform&&(e=t("./default_keymap_unix"));return e},e.exports=C}).call(this,t("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./composer_editor_controller.js":42,"./default_keymap_osx":47,"./default_keymap_unix":48,"./editors/citations_editor_factory":54,"./editors/figures_editor_factory":61,"./editors/infos_editor_factory":63,"./editors/issues_editor_factory":65,"./editors/richtext_annotator":68,"./editors/richtext_editor_factory":69,"./writer_view":119,_process:306,"substance-application":6,"substance-document":132,"substance-util":264,underscore:269}],119:[function(t,e){"use strict";var n,i,o,r=t("underscore"),s=t("substance-util"),a=window.$,c=t("substance-surface").EditableSurface,h=t("substance-outline"),u=t("substance-application").View,l=t("./content_tools_controller"),p=t("./resource_tools_controller"),d=t("substance-toc"),f=t("substance-application").$$,g=t("./annotation_bar"),v=0,y={citations:{name:"Links",icon:"icon-link"},remarks:{name:"Remarks",icon:"icon-comments"}},m=function(t,e){u.call(this),this.writerCtrl=t,this.options=e||{};var n=this.writerCtrl.document;this.$el.addClass("article article-view"),this.$el.addClass(n.schema.id),this.clipboard=this.writerCtrl.shell.getClipboard(this.writerCtrl),window.useNativeClipboard||(this.el.oncopy=this.clipboard.onCopy.bind(this.clipboard)),this.surfaces=[],this.contentView=i(this,n,"content"),this.contentView.el.classList.add("content"),this.contentView.el.setAttribute("id","content");var s=new g(this.contentView,this.writerCtrl);this.contentView.annotationBar=s,this.contentView.el.appendChild(s.el),this.surfaces.push(this.contentView),this.contentToolsCtrl=new l(this.writerCtrl),this.contentToolsView=this.contentToolsCtrl.createView(),this.resourceToolsCtrl=new p(this.writerCtrl),this.resourceToolsView=this.resourceToolsCtrl.createView(),this.tocView=new d(this.writerCtrl.contentCtrl),this.tocView.SHOW_ALWAYS=!0,this.tocView.$el.addClass("resource-view"),r.each(y,function(t,e){this.writerCtrl.hasView(e)&&o(this,n,e)},this),this.panelViews={},this._onToggleResourcePanel=r.bind(this.switchContext,this),r.each(this.writerCtrl.panels,function(t){var e=this.writerCtrl.panelControllers[t.getName()].createView();e.on("toggle",this._onToggleResourcePanel),this.panelViews[t.getName()]=e},this),r.each(this.writerCtrl.workflows,function(t){t.attach(this.writerCtrl,this)},this),this.resources=this.writerCtrl.referenceIndex,this.outline=new h(this.contentView),this.resourcesOutline=new h(this.figuresView),this.contentView.$el.on("scroll",r.bind(this.onContentScroll,this)),this.selectionState="no-selection",r.each(y,function(t,e){var n=e+"View";this[n]&&this[n].$el.on("scroll",r.bind(this.onResourceContentScroll,this))},this),this.listenTo(n,"resource-ready",this.onResourceReady.bind(this)),this.$el.on("click",".authors .toggle-author",r.bind(this.toggleAuthor,this)),this.$el.on("click",".insert-media",r.bind(this.onInsertMedia,this)),this.$el.on("mouseup",".insert-media",r.bind(this._stopPropagation,this)),this.$el.on("click",".insert-author",r.bind(this.onInsertAuthor,this)),this.$el.on("click",".document .toggle-resource",r.bind(this.onToggleResourceReference,this)),this.$el.on("click",".resources .toggle-resource",r.bind(this.onToggleResource,this)),this.$el.on("click",".image-status .actions .replace",r.bind(this.onReplaceImage,this)),this.$el.on("click",".image-placeholder .add-image",r.bind(this.onReplaceImage,this)),this.$el.on("click",".video-status .actions .replace",r.bind(this.onReplaceVideo,this)),this.$el.on("click",".audio-status .actions .replace",r.bind(this.onReplaceAudio,this)),this.$el.on("click",".content-node .delete-resource",r.bind(this.onDeleteResource,this)),this.$el.on("click",".content-node.contributor .image",r.bind(this.onReplaceImage,this))};m.Prototype=function(){this._stopPropagation=function(t){t.stopPropagation()},this.onToggleResourceReference=function(t){var e=a(t.currentTarget).closest(".content-node").attr("id"),n=this.writerCtrl.document,i=n.get(e),o=i.target,s=r.clone(this.writerCtrl.state);s.resourceId===o?this.writerCtrl.switchState({id:"main",contextId:s.contextId},{"no-scroll":!0,updateRoute:!0}):this.writerCtrl.switchState({id:"main",contextId:"figures",resourceId:o},{updateRoute:!0}),t.preventDefault()},this.onToggleResource=function(t){var e=a(t.currentTarget).closest(".content-node").attr("id"),n=this.writerCtrl.document,i=n.get(e),o=r.clone(this.writerCtrl.state);o.resourceId===e?this.writerCtrl.switchState({id:"main",contextId:o.contextId},{"no-scroll":!0,updateRoute:!0}):this.writerCtrl.switchState({id:"main",contextId:i.type+"s",resourceId:e},{"no-scroll":!0,updateRoute:!0}),t.preventDefault()},this.onReplaceImage=function(t){var e=a(t.currentTarget),n=e.attr("data-path").split(".");this.writerCtrl.replaceImage(n)},this.onReplaceVideo=function(t){var e=a(t.currentTarget),n=e.attr("data-id");this.writerCtrl.replaceVideo(n)},this.onReplaceAudio=function(t){var e=a(t.currentTarget),n=e.attr("data-id");this.writerCtrl.replaceAudio(n)},this.toggleAuthor=function(t){var e=t.currentTarget.getAttribute("data-id"),n=this.writerCtrl.state;return this.writerCtrl.switchState(n.resourceId===e?{id:"main",contextId:"toc"}:{id:"main",contextId:"info",resourceId:e}),!1},this.checkMediaValidity=function(t){var e=this.writerCtrl.currentSession,n=window.document.querySelector(".insert-media."+t);return!(!n||n.classList.contains("disable")||!e||e.selection.isNull())},this.onInsertMedia=function(t){var e=a(t.currentTarget).attr("data-type");if(this.checkMediaValidity(e))switch(e){case"figure":this.writerCtrl.insertFigure();break;case"video":this.writerCtrl.insertVideo();break;case"audio":this.writerCtrl.insertAudio();break;case"web_page":this.writerCtrl.insertWebPage();break;default:throw"Not implemented"}t.preventDefault()},this.onInsertAuthor=function(t){this.writerCtrl.addContributor(),t.preventDefault()},this.onDeleteResource=function(t){var n=e(t.currentTarget,".content-node"),i=e(t.currentTarget,".surface"),o=n.getAttribute("id"),r=i.getAttribute("id");return this.writerCtrl.deleteResource(r,o),!1},this.toggleFullscreen=function(){var t=this.writerCtrl.state,e=t.fullscreen||!1,n=r.clone(t);n.fullscreen=!e,this.writerCtrl.switchState(n)},this._jumpToNode=function(t){var e=a(t.currentTarget).attr("id").replace("outline_","");return this.jumpToNode(e),!1},this.followCrossReference=function(t){var e=a(t.currentTarget).attr("id"),n=this.writerCtrl.document.get(e);this.jumpToNode(n.target)},this.onContentScroll=function(){var t=this.contentView.$el.scrollTop();this.outline.updateVisibleArea(t),this.markActiveHeading(t)},this.onSelectionUpdate=function(){this.updateOutline(),this.contentToolsCtrl.update()},this.onDocumentEdit=function(){this.updateContextToggles(),this.contentToolsCtrl.update()},this.onResourceContentScroll=function(){var t=this.resourcesOutline.surface.$el.scrollTop();this.resourcesOutline.updateVisibleArea(t)},this.markActiveHeading=function(t){var e=a(".nodes").height(),n=a(this.contentView.el).height(),i=t+n,o=t-v,s=2*i-e,c=Math.max(o,s);if(a(".scanline").css({top:c-t+50+"px"}),0!==this.tocView.headings.length){var h=r.first(this.tocView.headings).id;this.contentView.$(".content-node.heading").each(function(){c>=a(this).position().top&&(h=this.id)}),this.tocView.setActiveNode(h)}},this.onResourceReady=function(){this.updateOutline()},this.jumpToNode=function(t){var e=a("#"+t);if(e.length>0){var n=e.position().top,i=a(".nodes").height(),o=a(this.contentView.el).height(),r=n+v,s=.5*(n+i-2*o),c=Math.min(r,s);this.contentView.$el.scrollTop(Math.ceil(c))}},this.jumpToResource=function(t){var e=this.writerCtrl.state,n=e.contextId,i=a("#"+t);if(i.length>0){var o=i.position().top;this[n+"View"]&&this[n+"View"].$el.scrollTop(o)}},this.switchContext=function(t){this.writerCtrl.switchState({id:"main",contextId:t})},this.updateState=function(t,e){var n=this.writerCtrl.document;if(t){var i,o={};if(t.resourceId&&(o.resource=n.get(t.resourceId)),this.$el.removeClass(),this.$el.addClass("article substance-article "+this.selectionState),this.contentView.$(".content-node.active").removeClass("active"),this.$(".annotation.active").removeClass("active"),this.$(".context-toggle").removeClass("focus").removeClass("left").removeClass("right"),this.$el.addClass("state-"+t.id),this.$el.addClass(this.writerCtrl.getContextId()),"publish"===e.id&&(this.publishPanelEl.innerHTML="",a(this.publishPanelEl).hide(),this.$(".toggle-publish-settings").removeClass("active")),"publish"===t.id){var s=this.writerCtrl.publishCtrl;this.publishPanelEl.appendChild(s.view.el),a(this.publishPanelEl).show(),this.$(".toggle-publish-settings").addClass("active")}r.each(this.panelViews,function(e,n){n===t.contextId?e.activate():e.hide()});for(var c=Object.keys(this.writerCtrl.workflows),h=0;h<c.length;h++){var u=this.writerCtrl.workflows[c[h]];if(u.handlesStateUpdate&&(i=u.handleStateUpdate(t,e,o))){console.log("handled by ",u);break}}this.resourceToolsView.update(),i||(this.updateOutline(t,e),this.updateResource(t,e))}},this.getActivePanelView=function(){var t=this.writerCtrl.state,e=t.contextId,n=this[e+"View"];return n||(n=this.panelViews[e]),n},this.focusResource=function(){var t=this.writerCtrl.state,e=this.getActivePanelView();if(e.focusResource)e.focusResource(t.resourceId);else{var n=this.$("#"+t.resourceId);n.addClass("active")}},this.updateResource=function(t){if(t){this.$(".resources .content-node.active").removeClass("active fullscreen"),this.$(".toggle-author").removeClass("active"),this.focusResource(t.resourceId);var e;if(void 0!==t.resourceId){var n=this;t.options["no-scroll"]||r.delay(function(){t.nodeId&&n.jumpToNode(t.nodeId),t.resourceId&&n.jumpToResource(t.resourceId)},0),e=this.resources.get(t.resourceId),r.each(e,function(t){this.contentView.$("#"+t.id).addClass("active")},this),this.$("#toggle_"+t.resourceId).addClass("active")}}},this.updateContextToggles=function(){var t=this,e=this.writerCtrl.document;r.each(y,function(n,i){var o=e.get(i);o.nodes.length>0?t.$(".context-toggle."+i).removeClass("hidden"):t.$(".context-toggle."+i).addClass("hidden")})},this.updateOutline=function(){var t=this,e=this.writerCtrl.state;if(e){var n,i=this.writerCtrl.getContextId(),o={context:i};void 0!==e.resourceId&&(n=this.writerCtrl.getResourceReferenceContainers(e.resourceId),o.highlightedNodes=n);var s=this.writerCtrl.currentSession;if(s&&(o.selectedNodes=r.pluck(s.selection.getNodes(),"id")),t.outline.update(o),"toc"===e.contextId||this.panelViews[e.contextId])return void a(t.resourcesOutline.el).addClass("hidden");t.resourcesOutline.surface=this[e.contextId+"View"],a(t.resourcesOutline.el).removeClass("hidden"),t.resourcesOutline.update({context:e.contextId,highlightedNodes:[e.resourceId]})}},this.annotate=function(t){return this.writerCtrl.content.annotate(t),!1},this.render=function(){var e=this;this.el.appendChild(t(this)),this.updateContextToggles(),this.$(".document").append(e.outline.el),this.resourcesEl=this.el.querySelector(".resources"),this.resourcesEl.appendChild(e.resourcesOutline.el),this.contentView.annotationBar.render();var n=r.debounce(function(){e.updateOutline(),e.contentView.annotationBar.render()},1);return a(window).resize(n),r.delay(function(){e.updateOutline(),e.contentView.annotationBar.render(),e.contentView.annotationBar.render()},0),this},this.dispose=function(){this.stopListening(),r.each(this.workflows,function(t){t.detach()}),this.contentView&&this.contentView.dispose(),r.each(y,function(t,e){this[e+"View"]&&this[e+"View"].dispose()},this)};var t=function(t){var e=window.document.createDocumentFragment(),n=f(".document"),i=t.contentToolsView.render().el;n.appendChild(i),n.appendChild(t.contentView.render().el);var o=[];t.tocView&&o.push(f("a.context-toggle.toc",{href:"#","sbs-click":"switchContext(toc)",title:"Table of Contents",html:'<i class="icon-align-left"></i><span> Contents</span>'})),r.each(y,function(e,n){t[n+"View"]&&o.push(f("a.context-toggle."+n,{href:"#","sbs-click":"switchContext("+n+")",title:e.name,html:'<i class="'+e.icon+'"></i><span> '+e.name+"</span>"}))
}),r.each(t.writerCtrl.panels,function(e){var n=t.panelViews[e.getName()];o.push(n.getToggleControl())});var s=f(".context-toggles",{children:o}),a=f(".medial-strip");a.appendChild(f(".separator-line")),a.appendChild(s);var c=f(".resources"),h=t.resourceToolsView.render().el;c.appendChild(h),c.appendChild(a),c.appendChild(t.tocView.render().el),r.each(y,function(e,n){t[n+"View"]&&c.appendChild(t[n+"View"].render().el)}),r.each(t.writerCtrl.panels,function(e){var n=t.panelViews[e.getName()];c.appendChild(n.render().el)}),t.publishPanelEl=f(".publish-panel"),e.appendChild(t.publishPanelEl),e.appendChild(n),e.appendChild(c);var u=f(".scanline");return e.appendChild(u),window.useNativeClipboard||e.appendChild(t.clipboard.el),e},e=function(t,e){for(var n=t;void 0!==n;){if(a(n).is(e))return n;n=n.parentElement}return null};this.onMouseup=function(t){console.log("WriterView.onMouseup....");var e=this;window.setTimeout(function(){var t=e.writerCtrl.currentSession;t&&t.selection.clear()},0),this.outline.mouseUp(),this.resourcesOutline.mouseUp(),t.preventDefault(),t.stopPropagation()},this.getSurface=function(t){return this[t+"View"]},this.getElementsForAnnotationFragments=function(t){var e=this.writerCtrl.document.getAnnotationFragments(t),n=[];return r.each(e,function(t){var e=this.contentView.el.querySelector("#"+t.id);e?n.push(e):console.log("Could not find element for fragment",t.id)},this),n}},m.Prototype.prototype=u.prototype,m.prototype=new m.Prototype,m.prototype.constructor=m,n=function(t,e){return t.createRenderer(e)};var w=function(t,e,n){var i=function(t){return function(e){try{t(e)}catch(i){console.log("EditableSurface: triggering error",i),s.printStackTrace(i),n.trigger("error",i)}e.preventDefault(),e.stopPropagation()}};e.pass("copy"),e.pass("cut"),e.pass("paste"),e.bind("nop","keydown",function(t){t.preventDefault(),t.stopPropagation()}),e.bind("backspace","keydown",i(function(){n["delete"]("left")})),e.bind("delete","keydown",i(function(){n["delete"]("right")})),e.bind("break","keydown",i(function(){n.breakNode()})),e.bind("soft-break","keydown",i(function(){n.write("\n")})),e.bind("blank","keydown",i(function(){n.write(" ")})),e.bind("indent","keydown",i(function(){n.indent("right")})),e.bind("unindent","keydown",i(function(){n.indent("left")})),e.bind("select-all","keydown",i(function(){n.select("all")})),e.bind("strong","keydown",i(function(){n.toggleAnnotation("strong")})),e.bind("emphasis","keydown",i(function(){n.toggleAnnotation("emphasis")})),e.bind("text","keydown",i(function(){n.changeType("text")})),e.bind("heading","keydown",i(function(){n.changeType("heading",{level:1})})),e.bind("code_block","keydown",i(function(){n.changeType("code_block")})),e.bind("list","keydown",i(function(){n.changeType("list_item",{level:1})}))};i=function(t,e,i){var o=t.writerCtrl[i+"Ctrl"],r=n(e,i),s=new c(o,r,{keymap:t.writerCtrl.keymap,registerBindings:w.bind(t)});window.useNativeClipboard||t.clipboard.attachSurface(s),s.keyboard.bind("figref","keypress",function(e){t.writerCtrl.beginAddRef("figure"),e.preventDefault(),e.stopPropagation()});var a=r.render;return r.render=function(){var t=a.apply(r,arguments);return o.session.container.rebuild(),t},o.session.container.renderer=r,s},o=function(t,e,n){var o=n+"View",r=i(t,e,n);t[o]=r,t.surfaces.push(r);var s=t[o].el;s.classList.add(n),s.classList.add("resource-view"),s.setAttribute("id",n)},e.exports=m},{"./annotation_bar":34,"./content_tools_controller":45,"./resource_tools_controller":107,"substance-application":6,"substance-outline":253,"substance-surface":257,"substance-toc":262,"substance-util":264,underscore:269}],120:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=function(t){this.options=t||{}};o.Prototype=function(){this.createState=function(t,e){var n={doc:t,htmlDoc:e,annotations:[],trimWhitespaces:!!this.options.trimWhitespaces,contexts:[],lastChar:"",skipTypes:{},ignoreAnnotations:!1};return n},this.convert=function(t,e){var n=this.createState(e,t),i=t.getElementsByTagName("body")[0];this.body(n,i);for(var o=0;o<n.annotations.length;o++)e.create(n.annotations[o])};var t=["p","h1","h2","h3","h4","h5"],e=function(e){return t.indexOf(e)>=0};this.body=function(t,e){for(var n=null,r={p:this.paragraph,h1:this.heading,h2:this.heading,h3:this.heading,h4:this.heading,h5:this.heading},s=new o.ChildNodeIterator(e);s.hasNext();){var a=s.next(),c=this.getNodeType(a);if(r[c]){n&&n.content.length>0&&(t.doc.create(n),t.doc.show("content",n.id),n=null);var h=r[c].call(this,t,a);h&&t.doc.show("content",h.id)}else s.back(),n||(n={type:"text",id:i.uuid("text"),content:""}),t.contexts.push({path:[n.id,"content"]}),n.content+=this._annotatedText(t,s,n.content.length),t.contexts.pop()}n&&n.content.length>0&&(t.doc.create(n),t.doc.show("content",n.id),n=null)},this.paragraph=function(t,e){var n={type:"text",id:e.id||i.uuid("text"),content:null};return n.content=this.annotatedText(t,e,[n.id,"content"]),t.doc.create(n),n},this.heading=function(t,e){var n={type:"heading",id:e.id||i.uuid("heading"),content:null,level:-1},o=this.getNodeType(e);return n.level=parseInt(o.substring(1)),n.content=this.annotatedText(t,e,[n.id,"content"]),t.doc.create(n),n},this.annotatedText=function(t,e,n,i){i=i||{},t.contexts.push({path:n});var r=new o.ChildNodeIterator(e),s=this._annotatedText(t,r,i.offset||0);return t.contexts.pop(),s},this._annotatedText=function(t,n,i){var r="";for(void 0===i&&(i=0);n.hasNext();){var s=n.next(),a=this.getNodeType(s);if(s.nodeType===window.Document.TEXT_NODE){var c=this._prepareText(t,s.textContent);r=r.concat(c),i+=c.length}else{if(s.nodeType===window.Document.COMMENT_NODE)continue;if(e(a)){n.back();break}if(!t.skipTypes[a]){var h=i,u=new o.ChildNodeIterator(s),l=this._annotatedText(t,u,i,"nested");r=r.concat(l),i+=l.length,this.isAnnotation(a)&&!t.ignoreAnnotations&&this.createAnnotation(t,s,h,i)}}}return r},this.getNodeType=function(t){if(t.nodeType===window.Document.TEXT_NODE)return"text";if(t.nodeType===window.Document.COMMENT_NODE)return"comment";if(t.tagName)return t.tagName.toLowerCase();throw new Error("Unknown node type")};var r={b:"strong",i:"emphasis"};this.isAnnotation=function(t){return!!r[t]},this.createAnnotation=function(t,e,o,s){var a=n.last(t.contexts);if(!a||!a.path)throw new Error("Illegal state: context for annotation is required.");var c=r[this.getNodeType(e)],h={id:e.id||i.uuid(c),type:c,path:n.clone(a.path),range:[o,s]};t.annotations.push(h)};var s=/^\s+/g,a=/^\s*/g,c=/\s+$/g,h=/\s+/g,u=" ",l=/[\t\n\r]+/g;this._prepareText=function(t,e){return t.trimWhitespaces?(e=e.replace(l,""),e=t.lastChar===u?e.replace(a,""):e.replace(s,u),e=e.replace(c,u),this.options.REMOVE_INNER_WS&&(e=e.replace(h,u)),t.lastChar=e[e.length-1]||t.lastChar,e):e}},o.prototype=new o.Prototype,o.ChildNodeIterator=function(t){this.nodes=t.childNodes,this.length=this.nodes.length,this.pos=-1},o.ChildNodeIterator.Prototype=function(){this.hasNext=function(){return this.pos<this.length-1},this.next=function(){return this.pos+=1,this.nodes[this.pos]},this.back=function(){return this.pos>=0&&(this.pos-=1),this}},o.ChildNodeIterator.prototype=new o.ChildNodeIterator.Prototype,e.exports=o},{"substance-util":264,underscore:269}],121:[function(t,e){"use strict";var n=t("substance-util").Fragmenter,i=function(t){this.config=t||{}};i.Prototype=function(){this.constructor=i,this.toHtml=function(t,e){e={}||e;for(var n=e.containers||["content"],i={document:t,options:e,output:[]},o=0;o<n.length;o++){var r=t.get(n[o]);this.container(i,r)}return i.output.join("")},this.container=function(t,e){for(var n=e.nodes,i=0;i<n.length;i++){var o=t.document.get(n[i]);switch(o.type){case"heading":return this.heading(t,o);case"text":return this.text(t,o);default:console.error("Not yet implemented: ",o.type,o)}}},this.heading=function(t,e){var n="h"+e.level;t.output.push("<"+n+">"),this.annotatedText(t,[e.id,"content"]),t.output.push("</"+n+">")},this.text=function(t,e){t.output.push("<p>"),this.annotatedText(t,[e.id,"content"]),t.output.push("</p>")},this.annotatedText=function(t,e){var i=t.document,o=i.get(e),r=i.getIndex("annotations").get(e),s=new n,a=[];s.onText=function(e,n){t.output.push(n)},s.onEnter=function(e){var n=i.get(e.id);switch(n.type){case"strong":t.output.push("<b>");break;case"emphasis":t.output.push("<i>");break;default:console.error("Not yet supported:",n.type,n)}return a.push(n),n},s.onExit=function(e){console.log("###########",e);var n=a.pop();switch(n.type){case"strong":t.output.push("</b>");break;case"emphasis":t.output.push("</i>");break;default:console.error("Not yet supported:",n.type,n)}},s.start(null,o,r)}},i.prototype=new i.Prototype,e.exports=i},{"substance-util":264}],122:[function(t,e){"use strict";var n={};n.VERSION="0.8.0",n.Graph=t("./src/graph");var i=t("underscore");n.defineNodeProperties=function(t,e,n){i.each(e,function(e){var i={get:function(){return this.properties[e]}};n||(i.set=function(t){return this.properties[e]=t,this}),Object.defineProperty(t,e,i)})},e.exports=n},{"./src/graph":125,underscore:269}],123:[function(t,e){"use strict";var n=t("substance-chronicle"),i=t("substance-operator"),o=function(t){this.graph=t,this.graph.state="ROOT"};o.Prototype=function(){this.apply=function(t){this.graph.__apply__(t,{chronicle:!0}),this.graph.updated_at=new Date(t.timestamp)},this.invert=function(t){return i.ObjectOperation.fromJSON(t).invert()},this.transform=function(t,e,n){return i.ObjectOperation.transform(t,e,n)},this.reset=function(){this.graph.reset()},this.getState=function(){return this.graph.state},this.setState=function(t){this.graph.state=t}},o.Prototype.prototype=n.Versioned.prototype,o.prototype=new o.Prototype,e.exports=o},{"substance-chronicle":19,"substance-operator":246}],124:[function(t,e){var n=t("underscore"),i=t("./graph_index"),o=function(t,e,n){n=n||{},this.__graph=t,this.__name=e,this.data={},n.filter?this.__filter=n.filter:n.types&&(this.__filter=i.typeFilter(t.schema,n.types)),this.__property=n.property||"id",n.getKey&&(this.__getKey=n.getKey),n.getValue&&(this.__getValue=n.getValue),this.__createIndex()};o.Prototype=function(){this.__add=function(t,e){this.data[t]||(this.data[t]=[]),this.data[t].push(e)},this.__remove=function(t,e){var n=this.data[t];if(n){var i=n.indexOf(e);i>=0&&(n=n.splice(i,1)),0===n.length&&delete this.data[t]}},this.__getKey=function(t,e){return e},this.__getValue=function(t){return t},this.onGraphChange=function(t){var e=this,n={create:function(t){if(!e.__filter||e.__filter(t)){var n=e.__getKey(t,t[e.__property]);if(!n)return;var i=e.__getValue(t,t[e.__property]);e.__add(n,i)}},"delete":function(t){if(!e.filter||e.filter(t)){var n=e.__getKey(t,t[e.__property]);if(!n)return;var i=e.__getValue(t,t[e.__property]);e.__remove(n,i)}},update:function(t,n,i,o){if(e.__property===n&&(!e.__filter||e.__filter(t))){var r=e.__getKey(t,o);r&&e.__remove(r,o),r=e.__getKey(t,i);var s=e.__getValue(t,i);e.__add(r,s)}}};this.__graph.cotransform(n,t)},this.__createIndex=function(){var t=this.__graph.nodes;n.each(t,function(t){if(!this.__filter||this.__filter(t)){var e=this.__getKey(t,t[this.__property]);if(!e)return;var n=this.__getValue(t,t[this.__property]);this.__add(e,n)}},this)}},o.prototype=new o.Prototype,e.exports=o},{"./graph_index":126,underscore:269}],125:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=i.errors,r=t("./schema"),s=t("./property"),a=t("substance-chronicle"),c=t("substance-operator"),h=t("./persistence_adapter"),u=t("./chronicle_adapter"),l=t("./graph_index"),p=t("./custom_index"),d=t("./simple_index"),f=t("./migrations"),g=o.define("GraphError"),v=["object","array","string","number","boolean","date"],y=function(t){return n.isArray(t)&&(t=t[0]),v.indexOf(t)>=0},m=function(t,e){e=e||{},this.schema=new r(t);var n=e.seed;if(n&&!n.schema&&console.error("FIXME: a document seed MUST have a schema."),n&&n.schema&&(n.schema[0]!==this.schema.id||n.schema[1]!==this.schema.version)&&this.migrate(n),this.objectAdapter=new m.ObjectAdapter(this),this.nodes={},this.indexes={},this.__mode__=e.mode||m.DEFAULT_MODE,this.__seed__=e.seed,this.isVersioned=!!e.chronicle,this.isPersistent=!!e.store,this.isVersioned&&(this.chronicle=e.chronicle,this.chronicle.manage(new m.ChronicleAdapter(this))),this.isPersistent){var i=e.store.hash("nodes");this.__store__=e.store,this.__nodes__=i,this.isVersioned&&(this.__version__=e.store.hash("__version__")),this.objectAdapter=new h(this.objectAdapter,i)}e.load?this.load():this.init(),e.graph&&this.merge(e.graph)};m.Prototype=function(){n.extend(this,i.Events);var t=new m.Private;this.create=function(t){var e=c.ObjectOperation.Create([t.id],t);return this.apply(e)},this["delete"]=function(t){var e=this.get(t);if(void 0===e)throw new g("Could not resolve a node with id "+t);e.toJSON&&(e=e.toJSON());var n=c.ObjectOperation.Delete([t],e);return this.apply(n)},this.update=function(t,e){var i=this.resolve(t);if(!i)throw new g("Could not resolve property with path "+JSON.stringify(t));if(n.isArray(e))if("string"===i.baseType)e=c.TextOperation.fromSequence(i.get(),e);else{if("array"!==i.baseType)throw new g("There is no convenient notation supported for this type: "+i.baseType);e=c.ArrayOperation.create(i.get(),e)}if(e){var o=c.ObjectOperation.Update(t,e,i.baseType);return this.apply(o)}},this.set=function(t,e,n){var i=this.resolve(t);if(!i)throw new g("Could not resolve property with path "+JSON.stringify(t));var o=i.get(),r=c.ObjectOperation.Set(t,o,e);return n&&(r.data=n),this.apply(r)},this.__apply__=function(t,e){c.Helpers.each(t,function(t){t instanceof c.ObjectOperation||(t=c.ObjectOperation.fromJSON(t)),t.apply(this.objectAdapter),this.updated_at=new Date,this._internalUpdates(t),n.each(this.indexes,function(e){e.onGraphChange(t)},this);var i;i="create"===t.type||"delete"===t.type?t.val:this.get(t.path[0]),this.trigger("operation:applied",t,this,i,e)},this)},this._internalUpdates=function(t){c.Helpers.each(t,function(t){n.each(this.indexes,function(e){e.onGraphChange(t)},this)},this)},this.apply=function(t,e){return this.__apply__(t,e),!this.__is_initializing__&&this.isVersioned&&(t.timestamp=new Date,this.chronicle.record(i.clone(t))),t},this.get=function(t){if(void 0===t||null===t)throw new g("Invalid argument: provided undefined or null.");if(!n.isArray(t)&&!n.isString(t))throw new g("Invalid argument path. Must be String or Array");if(n.isString(t))return this.nodes[t];var e=this.resolve(t);return e.get()},this.query=function(e){var n=this.resolve(e),i=n.type,o=n.baseType,r=n.get();return"array"===o?t.queryArray.call(this,r,i):y(o)?r:this.get(r)},this.toJSON=function(){return{id:this.id,schema:[this.schema.id,this.schema.version],nodes:i.deepclone(this.nodes)}},this.contains=function(t){return!!this.nodes[t]},this.resolve=function(t){return new s(this,t)},this.reset=function(){this.isPersistent&&this.__nodes__&&this.__nodes__.clear(),this.init(),this.isVersioned&&(this.state=a.ROOT),this.trigger("graph:reset")},this.init=function(){this.__is_initializing__=!0,this.nodes=this.__seed__?i.clone(this.__seed__.nodes):{},n.each(this.indexes,function(t){t.reset()}),this.isPersistent&&n.each(this.nodes,function(t,e){this.__nodes__.set(e,t)},this),delete this.__is_initializing__},this.merge=function(t){return n.each(t.nodes,function(t){this.create(t)},this),this},this.traverse=function(t){return n.map(this.getView(t),function(t){return this.get(t)},this)},this.load=function(){if(!this.isPersistent)return void console.log("Graph is not persistent.");this.__is_initializing__=!0,this.nodes={},this.indexes={};for(var e=this.__nodes__.keys(),n=0;n<e.length;n++)t.create.call(this,this.__nodes__.get(e[n]));return this.isVersioned&&(this.state=this.__version__.get("state")||"ROOT"),delete this.__is_initializing__,this},this.cotransform=function(t,e){if("create"===e.type)t.create.call(t,e.val);else if("delete"===e.type)t["delete"].call(t,e.val);else{var i=this.resolve(e.path);if(void 0===i)throw new Error("Key error: could not find element for path "+JSON.stringify(e.path));var o,r=i.get();if(void 0===r)return;if("set"===e.type)o=e.original;else{var s=c.Helpers.invert(e.diff,i.baseType);o=s.apply(n.clone(r))}t.update.call(t,i.node,i.key,r,o)}},this.addIndex=function(t,e){if(this.indexes[t])return this.indexes[t];var n;return n=e&&e.custom?new p(this,t,e):e&&e.simple?new d(this,t,e):new l(this,e),this.indexes[t]=n,n},this.getIndex=function(t){if(!this.indexes[t])throw new g("No index available with name:"+t);return this.indexes[t]},this.removeIndex=function(t){delete this.indexes[t]},this.enableVersioning=function(t){this.isVersioned||(t||(t=a.create()),this.chronicle=t,this.chronicle.manage(new m.ChronicleAdapter(this)),this.isVersioned=!0)},this.getMigrations=function(){return{}},this.migrate=function(t){var e=new f(this);return e.migrate(t)}},m.STRICT_INDEXING=2,m.DEFAULT_MODE=m.STRICT_INDEXING,m.Private=function(){var t=this;this.createNode=function(t,e){if(!e.id||!e.type)throw new g("Can not create Node: 'id' and 'type' are mandatory.");var o=t.type(e.type);if(!o)throw new g("Type '"+e.type+"' not found in the schema");var r=t.properties(e.type),s={type:e.type,id:e.id};return n.each(r,function(n,o){var r=t.propertyBaseType(e.type,o),a=void 0!==e[o]?e[o]:t.defaultValue(r);s[o]=i.deepclone(a)}),s},this.create=function(e){var n=t.createNode(this.schema,e);if(this.contains(n.id))throw new g("Node already exists: "+n.id);return this.nodes[n.id]=n,this.trigger("node:created",n),this},this["delete"]=function(t){delete this.nodes[t.id],this.trigger("node:deleted",t.id)},this.set=function(t,e){var n=this.resolve(t);if(void 0===n)throw new Error("Key error: could not find element for path "+JSON.stringify(t));if(!n.type)throw new Error("Could not lookup schema for path "+JSON.stringify(t));var o=i.deepclone(n.get());n.set(e),this.trigger("property:updated",t,null,o,e)};var e=function(t,e){c.Helpers.each(e,function(e){this.trigger("property:updated",t,e,this)},this)};this.update=function(t,n,i){var o=this.resolve(t);if(void 0===o)throw new Error("Key error: could not find element for path "+JSON.stringify(t));o.set(n),e.call(this,t,i)},this.queryArray=function(e,i){if(!n.isArray(i))throw new g("Illegal argument: array types must be specified as ['array'(, 'array')*, <type>]");var o,r;if("array"===i[1])for(o=[],r=0;r<e.length;r++)o.push(t.queryArray.call(this,e[r],i.slice(1)));else if(y(i[1]))o=e;else for(o=[],r=0;r<e.length;r++)o.push(this.get(e[r]));return o}},m.prototype=new m.Prototype,m.ObjectAdapter=function(t){this.graph=t},m.ObjectAdapter.Prototype=function(){var t=new m.Private;this.get=function(t){var e=this.graph.resolve(t);if(void 0===e)throw new Error("Key error: could not find element for path "+JSON.stringify(t));return e.get()},this.create=function(e,n){t.create.call(this.graph,n)},this.set=function(e,n){t.set.call(this.graph,e,n)},this.update=function(e,n,i){t.update.call(this.graph,e,n,i)},this["delete"]=function(e,n){t["delete"].call(this.graph,n)},this.inplace=function(){return!1}},m.ObjectAdapter.Prototype.prototype=c.ObjectOperation.Object.prototype,m.ObjectAdapter.prototype=new m.ObjectAdapter.Prototype,m.Schema=r,m.Property=s,m.PersistenceAdapter=h,m.ChronicleAdapter=u,m.Index=l,e.exports=m},{"./chronicle_adapter":123,"./custom_index":124,"./graph_index":126,"./migrations":127,"./persistence_adapter":128,"./property":129,"./schema":130,"./simple_index":131,"substance-chronicle":19,"substance-operator":246,"substance-util":264,underscore:269}],126:[function(t,e){var n=t("underscore"),i=t("substance-util"),o=function(t,e){e=e||{},this.graph=t,this.nodes={},this.scopes={},e.filter?this.filter=e.filter:e.types&&(this.filter=o.typeFilter(t.schema,e.types)),e.property&&(this.property=e.property),this.createIndex()};o.Prototype=function(){n.extend(this,i.Events.Listener);var t=function(t){var e=this;if(null!==t)for(var n=0;n<t.length;n++){var i=t[n];e.scopes[i]=e.scopes[i]||{nodes:{},scopes:{}},e=e.scopes[i]}return e},e=function(t){if(!this.property)return null;var e=t[this.property]?t[this.property]:null;return n.isString(e)&&(e=[e]),e},o=function(t){var e=n.extend({},t.nodes);return n.each(t.scopes,function(t,i){"nodes"!==i&&n.extend(e,o(t))}),e},r=function(e,n){var i=t.call(this,e);i.nodes[n.id]=n.id},s=function(e,n){var i=t.call(this,e);delete i.nodes[n.id]};this.onGraphChange=function(t){var i=this,o={create:function(t){if(!i.filter||i.filter(t)){var n=e.call(i,t);r.call(i,n,t)}},"delete":function(t){if(!i.filter||i.filter(t)){var n=e.call(i,t);s.call(i,n,t)}},update:function(t,e,o,a){if(i.property===e&&(!i.filter||i.filter(t))){var c=a;n.isString(c)&&(c=[c]),s.call(i,c,t),c=o,n.isString(c)&&(c=[c]),r.call(i,c,t)}}};this.graph.cotransform(o,t)},this.createIndex=function(){this.reset();var t=this.graph.nodes;n.each(t,function(t){if(!this.filter||this.filter(t)){var n=e.call(this,t);r.call(this,n,t)}},this)},this.get=function(e){0===arguments.length?e=null:n.isString(e)&&(e=[e]);var i,r=t.call(this,e);return i=o(r),n.each(i,function(t){i[t]=this.graph.get(t)},this),i},this.getGroups=function(){var t={};return n.each(this.scopes,function(e,n){var i=this.get(n);t[n]=Object.keys(i)},this),t},this.reset=function(){this.nodes={},this.scopes={}},this.dispose=function(){this.stopListening()}},o.prototype=new o.Prototype,o.typeFilter=function(t,e){return function(n){for(var i=t.typeChain(n.type),o=0;o<e.length;o++)if(i.indexOf(e[o])>=0)return!0;return!1}},e.exports=o},{"substance-util":264,underscore:269}],127:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=i.errors.define("MigrationError",-1),r=function(t){Array.call(this);var e=this;this.graph=t,n.each(t.getMigrations(),function(t,n){e.push({version:r.versionFromString(n),process:t})}),this.sort(r.compareMigrations)};r.Prototype=function(){this.findIndex=function(t){for(var e={version:r.versionFromString(t)},n=this.length-1;n>=0;n--)if(0===r.compareMigrations(e,this[n]))return n;return-1},this.migrate=function(t){var e=new r.Migrator(t);if(e.getVersion()!==this.graph.schema.version){var n=this.findIndex(e.getVersion());if(0>n)throw new o("No migration found for version"+e.getVersion());for(n+=1;n<this.length;n++){var i=this[n],s=i.version.join(".");console.log("Migrating",this.graph.schema.id+"@"+e.getVersion(),"->",this.graph.schema.id+"@"+s),i.process(e),e.setVersion()}return e}}},r.Prototype.prototype=Array.prototype,r.prototype=new r.Prototype;var s=function(t){var e=t.split(".");return e.map(function(t){return parseInt(t,10)})},a=function(t,e){for(var n=t.version,i=e.version,o=0;3>o;o++){if(n[o]<i[o])return-1;if(n[o]>i[o])return 1}return 0},c=function(t){this.data=t,this.warnings=[]};c.Prototype=function(){this.getVersion=function(){return this.data.schema[1]},this.setVersion=function(t){this.data.schema[1]=t},this.removeType=function(t){throw new o("Not yet implemented",t)},this.renameType=function(t,e){throw new o("Not yet implemented",t,e)},this.removeProperty=function(t,e){throw new o("Not yet implemented",t,e)},this.renameProperty=function(t,e,n){throw new o("Not yet implemented",t,e,n)},this.addProperty=function(t,e,i){n.each(this.data.nodes,function(n){n.type===t&&(n[e]=i)},this)},this.reportWarning=function(t,e){this.warnings.push({message:t,data:e})}},c.prototype=new c.Prototype,r.MigrationError=o,r.versionFromString=s,r.compareMigrations=a,r.Migrator=c,e.exports=r},{"substance-util":264,underscore:269}],128:[function(t,e){"use strict";var n=t("substance-operator"),i=function(t,e){this.delegate=t,this.nodes=e};i.Prototype=function(){this.get=function(t){return this.delegate.get(t)},this.create=function(t,e){this.delegate.create(t,e),this.nodes.set(e.id,e)},this.set=function(t,e){this.delegate.set(t,e);var n=t[0],i=this.delegate.get([n]);this.nodes.set(n,i)},this["delete"]=function(t,e){this.delegate["delete"](t,e),this.nodes["delete"](e.id)},this.inplace=function(){return!1}},i.Prototype.prototype=n.ObjectOperation.Object.prototype,i.prototype=new i.Prototype,e.exports=i},{"substance-operator":246}],129:[function(t,e){"use strict";var n=t("underscore"),i=function(t,e){if(!e)throw new Error("Illegal argument: path is null/undefined.");this.graph=t,this.schema=t.schema;var i=this.resolve(e);return void 0===i?void 0:void n.extend(this,i)};i.Prototype=function(){this.resolve=function(t){for(var e,n,i=this.graph,o=i,r="graph",s=0;s<t.length;s++)if("graph"===r||void 0!==this.schema.types[r]){if(o=this.graph.get(t[s]),void 0===o)return void 0;i=o,r=this.schema.properties(o.type),n=i,e=void 0}else{if(void 0===o)return void 0;e=t[s];var a=t[s];r=r[a],n=o[e],s<t.length-1&&(o=o[a])}return{node:i,parent:o,type:r,key:e,value:n}},this.get=function(){return void 0!==this.key?this.parent[this.key]:this.node},this.set=function(t){if(void 0===this.key)throw new Error("'set' is only supported for node properties.");this.parent[this.key]=this.schema.parseValue(this.baseType,t)}},i.prototype=new i.Prototype,Object.defineProperties(i.prototype,{baseType:{get:function(){return n.isArray(this.type)?this.type[0]:this.type}},path:{get:function(){return[this.node.id,this.key]}}}),e.exports=i},{underscore:269}],130:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=function(t){n.extend(this,t)};o.Prototype=function(){this.defaultValue=function(t){return"object"===t?{}:"array"===t?[]:"string"===t?"":"number"===t?0:"boolean"===t?!1:"date"===t?new Date:null},this.parseValue=function(t,e){if(null===e)return e;if(n.isString(e)){if("object"===t)return JSON.parse(e);if("array"===t)return JSON.parse(e);if("string"===t)return e;if("number"===t)return parseInt(e,10);if("boolean"===t){if("true"===e)return!0;if("false"===e)return!1;throw new Error("Can not parse boolean value from: "+e)}return"date"===t?new Date(e):e}if("array"===t){if(!n.isArray(e))throw new Error("Illegal value type: expected array.");e=i.deepclone(e)}else if("string"===t){if(!n.isString(e))throw new Error("Illegal value type: expected string.")}else if("object"===t){if(!n.isObject(e))throw new Error("Illegal value type: expected object.");e=i.deepclone(e)}else if("number"===t){if(!n.isNumber(e))throw new Error("Illegal value type: expected number.")}else if("boolean"===t){if(!n.isBoolean(e))throw new Error("Illegal value type: expected boolean.")}else{if("date"!==t)throw new Error("Unsupported value type: "+t);e=new Date(e)}return e},this.type=function(t){return this.types[t]},this.typeChain=function(t){var e=this.types[t];if(!e)throw new Error("Type "+t+" not found in schema");var n=e.parent?this.typeChain(e.parent):[];return n.push(t),n},this.isInstanceOf=function(t,e){var n=this.typeChain(t);return n&&n.indexOf(e)>=0?!0:!1},this.baseType=function(t){return this.typeChain(t)[0]},this.properties=function(t){t=n.isObject(t)?t:this.type(t);var e=t.parent?this.properties(t.parent):{};return n.extend(e,t.properties),e},this.propertyType=function(t,e){var i=this.properties(t),o=i[e];if(!o)throw new Error("Property not found for"+t+"."+e);return n.isArray(o)?o:[o]},this.propertyBaseType=function(t,e){return this.propertyType(t,e)[0]}},o.prototype=new o.Prototype,e.exports=o},{"substance-util":264,underscore:269}],131:[function(t,e){var n=(t("underscore"),t("./custom_index")),i=function(t,e,i){i=i||{},n.call(this,t,e,i)};i.Prototype=function(){this.__add=function(t,e){this.data[t]=e},this.__remove=function(t){delete this.data[t]}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"./custom_index":124,underscore:269}],132:[function(t,e){"use strict";var n=(t("underscore"),t("./src/document"));n.Annotator=t("./src/annotator"),n.Cursor=t("./src/cursor"),n.Selection=t("./src/selection"),n.Container=t("./src/container"),n.Component=t("./src/component"),n.Session=t("./src/document_session"),n.NodeViewFactory=t("./src/node_view_factory"),n.DocumentRenderer=t("./src/document_renderer"),e.exports=n},{"./src/annotator":133,"./src/component":134,"./src/container":136,"./src/cursor":137,"./src/document":138,"./src/document_renderer":139,"./src/document_session":140,"./src/node_view_factory":143,"./src/selection":144,underscore:269}],133:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=t("./document"),r=t("substance-operator"),s=function(t){var e=t.getAnnotationBehavior();if(!e)throw new Error("No Annotation behavior specified.");return e.expansion=e||{},e.expansion.annotation_fragment={left:function(t){return!t.isFirst()},right:function(t){return!t.isLast()}},e.split.push("annotation_fragment"),e},a=function(t){this.config=s(t),this.document=t};a.Prototype=function(){this.update=function(e,i){i=i||{};var o=i.path||e.path,r=this.document.getIndex("annotations"),s=r.get(o);n.each(s,function(n){t(this,n,e,i)},this)},this.copy=function(){throw new Error("FIXME: this must be updated considering the other API changes.")},this.paste=function(){throw new Error("FIXME: this must be updated considering the other API changes.")},this.transferAnnotations=function(t,e,o,r){r=r||0;var s=a(this,t,{start:e});n.each(s,function(t){var s,a=e>t.range[0]||e[1]<t.range[1];if(a){if(this.isSplittable(t.type)){var c=i.clone(t);c.range=[r,r+t.range[1]-e],c.id=i.uuid(),c.path[0]=o.id,this.document.create(c)}s=n.clone(t.range),s[1]=e,s[1]===s[0]?this.document["delete"](t.id):this.document.set([t.id,"range"],s)}else{var h=n.clone(t.path);if(h[0]=o.id,s=[r+t.range[0]-e,r+t.range[1]-e],this.document.set([t.id,"path"],h),this.document.set([t.id,"range"],s),"annotation_fragment"===t.type){var u=this.document.get(t.annotation_id);h=n.clone(u.startPath),h[0]=o.id,this.document.set([u.id,"startPath"],h)}}},this)},this.getAnnotationsForNode=function(t){return this.index.get(t)},this.getAnnotations=function(t,e){if(!(t instanceof o.Selection))throw new Error("API has changed: now getAnnotations() takes only a selection.");for(var n=[],i=t.getRanges(),r=0;r<i.length;r++){var a=i[r],c=s(this,this.document,a,e);n=n.concat(c)}return n},this.isExclusive=function(t,e){return this.config.groups[t]===this.config.groups[e]},this.isSplittable=function(t){return this.config.split.indexOf(t)>=0};var t=function(t,e,o,s){var a=s.path||o.path;if(n.isEqual(e.path,a))if("update"===o.type){var c=!1,h=!1,u=t.config.expansion[e.type];u&&(u.left&&(c=u.left(e)),u.right&&(h=u.right(e)));var l=i.clone(e.range),p=r.TextOperation.Range.transform(l,o.diff,c,h);if(p&&(l[0]===l[1]?t.document["delete"](e.id):t.document.set([e.id,"range"],l,{incremental:!0}),"annotation_fragment"===e.type)){var d=e.getAnnotation();e.isFirst()&&d.startCharPos!==l[0]?t.document.set([e.annotation_id,"startCharPos"],l[0]):e.isLast()&&d.endCHarPos!==l[1]&&t.document.set([e.annotation_id,"endCharPos"],l[1])}}else("delete"===o.type||"set"===o.type)&&t.document["delete"](e.id)},e=function(t,e,i,o){var r=i.start,s=i.end,a=e.range[0],c=e.range[1],h=!1,u=!1;if(o&&o[e.type])h=o[e.type].left||!1,u=o[e.type].right||!1;else{var l=t.config.expansion[e.type];l&&(l.left&&(h=l.left(e)),l.right&&(u=l.right(e)))}var p;return p=u?c>=r:c>r,n.isNumber(s)&&(p=h?p&&s>=a:p&&s>a),p},s=function(t,i,o,r){var s,a=[],c=o.component,h=i.getIndex("annotations");return s=h.get(c.path),c.alias&&(s=n.extend(s,h.get(c.alias))),n.each(s,function(n){e(t,n,o,r)&&a.push(n)}),a},a=function(t,i,o){var r=[],s=t.document.getIndex("annotations"),a=s.get(i.id);return n.each(a,function(n){e(t,n,o)&&r.push(n)}),r}},a.Prototype.prototype=i.Events,a.prototype=new a.Prototype,a.isOnNodeStart=function(t){return 0===t.range[0]},a.isTrue=function(){return!0};var c=function(t,e,n){var i=t.getSchema();return i.isInstanceOf(e.type,n)};a.changesAnnotations=function(t,e,i){var o;o="delete"===e.type?e.val:t.get(e.path[0]);var r=!1;return c(t,o,"annotation")&&(n.isEqual(i,o.path)?r=!0:"set"===e.type&&"path"===e.path[1]&&(n.isEqual(i,e.original)||n.isEqual(i,e.val))&&(r=!0)),r},a.createIndex=function(t){return t.addIndex("annotations",{types:["annotation"],property:"path"})},e.exports=a},{"./document":138,"substance-operator":246,"substance-util":264,underscore:269}],134:[function(t,e){"use strict";
var n=function(t,e,n){if(n=n||{},!t||!e)throw new Error("Inclomplete arguments for Component");this.root=t,this.path=e,this.pos=null,this.rootPos=null,this.name=n.name,this.alias=n.alias,n.length&&(this.__getLength__=n.length)};n.Protoype=function(){this.__getLength__=function(){throw new Error("This is abstract and must be overridden")},this.getLength=function(){return this.length},this.clone=function(){var t=function(){};return t.prototype=this,new t}},n.prototype=new n.Protoype,Object.defineProperties(n.prototype,{length:{get:function(){return this.__getLength__.call(this)}},nodePos:{get:function(){return this.rootPos},set:function(){throw new Error("DEPRECATED")}},node:{get:function(){return console.log("DEPRECATED: please use component.root instead"),this.root},set:function(){throw new Error("DEPRECATED")}}}),e.exports=n},{}],135:[function(t,e){"use strict";function n(t,e,n){this.component=t,this.start=e,this.end=n}n.Prototype=function(){this.getLength=function(){return this.end-this.start},this.isRightBound=function(){return this.end===this.component.length},this.isLeftBound=function(){return 0===this.start},this.isFull=function(){return this.isLeftBound()&&this.isRightBound()},this.isPartial=function(){return!this.isFull()}},n.prototype=new n.Prototype,e.exports=n},{}],136:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),i=t("substance-util"),o=i.errors,r=o.define("ContainerError"),s=0,a=function(t,e,n){this.document=t,this.name=e,this.__id__=s++;var i=this.document.nodes[e];if(i instanceof a&&(i={type:"container",id:i.id,nodes:i.nodes}),!i||!i.nodes)throw new r("Illegal argument: no view with name "+e);this.__viewNode=i,this.__components=null,this.__children=null,this.__updater=null,this.surfaceProvider=n||new a.DefaultNodeSurfaceProvider(t),this.listenTo(this.document,"operation:applied",this.update)};a.Prototype=function(){n.extend(this,i.Events),this.rebuild=function(){for(var t=[],e={},n=[],i=this.__viewNode.nodes,o=0;o<i.length;o++){var s=i[o],a=this.surfaceProvider.getNodeSurface(s);if(!a)throw new r("Aaaaah! no surface available for node "+s);a.update&&n.push(a.update.bind(a));var c=a.components;if(!c)throw new r("Node Surface did not provide components: "+a.node.type);e[s]=[];for(var h=0;h<c.length;h++){var u=c[h].clone();u.surface.detachView(),u.pos=t.length,u.rootPos=o,e[s].push(u),t.push(u)}}this.__components=t,this.__children=e,this.__updater=n},this.getComponents=function(){return this.__components||this.rebuild(),this.__components},this.lookup=function(t){for(var e=this.getComponents(),i=0;i<e.length;i++){var o=e[i];if(o.alias&&n.isEqual(o.alias,t))return o;if(n.isEqual(o.path,t))return o}return console.error("Could not find a view component for path "+JSON.stringify(t)),null},this.getNodes=function(t){var e=this.__viewNode.nodes;if(t)return n.clone(e);for(var i=[],o=0;o<e.length;o++)i.push(this.document.get(e[o]));return i},this.update=function(t){var e=t.path,n=!this.__components||e[0]===this.__viewNode.id;if(!n)for(var i=0;i<this.__updater.length;i++)if(this.__updater[i](t)){n=!0;break}n&&this.rebuild()},this.getLength=function(t){var e=this.getComponents();return void 0===t?e.length:e[t].length},this.getRootNodeFromPos=function(t){return this.__components||this.rebuild(),this.__components[t].root},this.getNodePos=function(t){this.__components||this.rebuild();var e=this.__components[t].root.id;return this.__viewNode.nodes.indexOf(e)},this.lookupRootNode=function(t){for(var e=this.getComponents(),i=0;i<e.length;i++){var o=e[i];if(o.alias&&n.isEqual(t,o.alias)||n.isEqual(t,o.path))return o.root}return console.error("Could not find a root node for the given path:"+t),null},this.getComponent=function(t){var e=this.getComponents();return e[t]},this.last=function(){var t=this.getComponents();return t[t.length-1]},this.getNodeComponents=function(t){var e=this.__children[t];if(!e)throw new r("Node is not in this container:"+t);return e},this.dispose=function(){console.error("Typically we do not want this, as a container is bound to the life-time of a document."),this.stopListening()},this.createContainer=function(t){var e=new a(t,this.name,this.surfaceProvider.createCopy(t));return e.__components=this.__components,e.__children=this.__children,e.__updater=this.__updater,t.nodes[this.name]=e,e},this.after=function(t){var e=this.getNodeComponents(t),n=e[e.length-1];return this.__components.length-1===n.pos?[n.pos,n.length]:[n.pos+1,0]},this.first=function(t){var e=this.getNodeComponents(t);return[e[0].pos,0]},this.getLastCoor=function(){var t=this.__components[this.__components.length-1];return[t.pos,t.length]},this.toJSON=function(){return i.clone(this.__viewNode)}},a.prototype=n.extend(new a.Prototype,i.Events.Listener),Object.defineProperties(a.prototype,{id:{get:function(){return this.__viewNode.id}},type:{get:function(){return this.__viewNode.type}},nodes:{get:function(){return this.__viewNode.nodes},set:function(t){this.__viewNode.nodes=t}}}),a.DefaultNodeSurfaceProvider=t("./node_surface_provider"),a.ContainerError=r,e.exports=a},{"./node_surface_provider":142,"substance-util":264,underscore:269}],137:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=i.errors,r=o.define("CursorError"),s=function(t,e,i,o){if(this.container=t,this.view=o||"content",this.pos=e,this.charPos=i,null!==e&&!n.isNumber(e))throw new r("Illegal argument: expected pos as number");if(null!==i&&!n.isNumber(i))throw new r("Illegal argument: expected charPos as number")};s.Prototype=function(){this.toJSON=function(){return[this.pos,this.charPos]},this.copy=function(){return new s(this.container,this.pos,this.charPos,this.view)},this.isValid=function(){return null===this.pos||null===this.charPos?!1:this.pos<0||this.charPos<0?!1:!0},this.isRightBound=function(){return this.charPos===this.container.getLength(this.pos)},this.isLeftBound=function(){return 0===this.charPos},this.isEndOfDocument=function(){return this.isRightBound()&&this.pos===this.container.getLength()-1},this.isBeginOfDocument=function(){return this.isLeftBound()&&0===this.pos},this.prevNode=function(){this.isLeftBound()?this.pos>0&&(this.pos-=1,this.charPos=this.container.getLength(this.pos)):this.charPos=0},this.nextNode=function(){this.isRightBound()?this.pos<this.container.getLength()-1&&(this.pos+=1,this.charPos=0):this.charPos=this.container.getLength(this.pos)},this.prevWord=function(){throw new Error("Not implemented")},this.nextWord=function(){throw new Error("Not implemented")},this.nextChar=function(){this.isRightBound()?this.pos<this.container.getLength()-1&&(this.pos+=1,this.charPos=0):this.charPos+=1},this.prevChar=function(){if(this.charPos<0)throw new r("Invalid char position");this.isLeftBound()?this.pos>0&&(this.pos-=1,this.charPos=this.container.getLength(this.pos)):this.charPos-=1},this.move=function(t,e){"left"===t?"word"===e?this.prevWord():"char"===e?this.prevChar():"node"===e&&this.prevNode():"word"===e?this.nextWord():"char"===e?this.nextChar():"node"===e&&this.nextNode()},this.set=function(t,e){if(null!==t&&!n.isNumber(t))throw new r("Illegal argument: expected pos as number");if(null!==e&&!n.isNumber(e))throw new r("Illegal argument: expected charPos as number");if(null!==t&&!n.isNumber(t))throw new r("Illegal argument: expected pos as number");this.pos=t,this.charPos=e},this.position=function(){return[this.pos,this.charPos]}},s.prototype=new s.Prototype,e.exports=s},{"substance-util":264,underscore:269}],138:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=i.errors,r=t("substance-data"),s=t("substance-operator"),a=t("./container"),c=o.define("DocumentError"),h=function(t){r.Graph.call(this,t.schema,t),this.fileData={},this.addIndex("annotations",{types:["annotation"],property:"path"}),this.addIndex("files",{types:["file"]})};h.schema={indexes:{},types:{content:{properties:{}},container:{properties:{nodes:["array","content"]}},view:{properties:{nodes:["array","content"]}}}},h.Prototype=function(){var t=i.prototype(this);this.getIndex=function(t){return this.indexes[t]},this.getSchema=function(){return this.schema},this.create=function(e){return t.create.call(this,e),this.get(e.id)},this.get=function(e){var n=t.get.call(this,e);if(!n)return n;var i=this.nodeTypes[n.type],o=void 0!==i?i.Model:null;return!o||n instanceof o||(n=new o(n,this),this.nodes[n.id]=n),"view"!==n.type&&"container"!==n.type||n instanceof a||(n=new a(this,n.id),this.nodes[n.id]=n),n},this.toJSON=function(){var e=t.toJSON.call(this);return e.id=this.id,e},this.hide=function(t,e){var i=this.get(t);if(!i)throw new c("Invalid view id: "+t);n.isString(e)&&(e=[e]);var o=[];if(n.each(e,function(t){var e=i.nodes.indexOf(t);e>=0&&o.push(e)},this),0!==o.length){o=o.sort().reverse(),o=n.uniq(o);var r=n.map(o,function(t){return s.ArrayOperation.Delete(t,i.nodes[t])}),a=s.ObjectOperation.Update([t,"nodes"],s.ArrayOperation.Compound(r));return this.apply(a)}},this.comment=function(t){var e=i.uuid();t.id=e,t.type="comment";var n=s.ObjectOperation.Create([t.id],t);return this.__apply__(n)},this.annotate=function(t,e){t.id=t.type+"_"+i.uuid(),n.extend(t,e),this.create(t)},this.show=function(t,e,i){void 0===i&&(i=-1);var o=this.get(t);if(!o)throw new c("Invalid view id: "+t);n.isString(e)&&(e=[e]);var r=o.nodes.length;i=Math.min(i,r),0>i&&(i=Math.max(0,r+i+1));for(var a=[],h=0;h<e.length;h++){var u=e[h];if(void 0===this.nodes[u])throw new c("Invalid node id: "+u);a.push(s.ArrayOperation.Insert(i+h,u))}if(a.length>0){var l=s.ObjectOperation.Update([t,"nodes"],s.ArrayOperation.Compound(a));return this.apply(l)}},this.startSimulation=function(){var t=this,e=this.clone(),i=[];e.ops=i;var o=e.apply;return e.apply=function(t){return i.push(t),t=o.call(e,t)},e.save=function(o){n.each(e.fileData,function(e,n){t.fileData[n]=e});for(var r=[],a=0;a<i.length;a++)"compound"!==i[a].type?r.push(i[a]):r=r.concat(i[a].ops);if(0!==r.length){var c=s.ObjectOperation.Compound(r);o&&(c.data=n.clone(o)),t.apply(c)}},e.simulation=!0,e},this.fromSnapshot=function(t,e){return h.fromSnapshot(t,e)},this.newInstance=function(){return new h({schema:this.schema})},this.uuid=function(t){return t+"_"+i.uuid()},this.clone=function(){var t=new this.constructor;return t.schema=this.schema,t.nodes={},n.each(this.nodes,function(e){t.nodes[e.id]=e.toJSON()}),n.each(t.indexes,function(t){t.createIndex()}),t}},h.Prototype.prototype=r.Graph.prototype,h.prototype=new h.Prototype,h.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new h(e)},h.DocumentError=c,e.exports=h},{"./container":136,"substance-data":122,"substance-operator":246,"substance-util":264,underscore:269}],139:[function(t,e){"use strict";var n=t("./node_view_factory"),i=t("underscore"),o=function(t,e,i){n.call(this,t),this.viewName=e,this.options=i||{},this.nodeViews={}};o.Prototype=function(){var t=n.prototype;this.createView=function(e,n){if(this.nodeViews[e.id]&&!n)return this.nodeViews[e.id];this.nodeViews[e.id]&&n&&this.nodeViews[e.id].dispose();var i=t.createView.call(this,e);return this.nodeViews[e.id]=i,i},this.getView=function(t){if(this.nodeViews[t])return this.nodeViews[t];var e=this.document.get(t);return this.createView(e)},this.render=function(){i.each(this.nodeViews,function(t){t.dispose()});var t=window.document.createDocumentFragment(),e=this.document.get(this.viewName).nodes;return i.each(e,function(e){var n=this.document.get(e),i=this.createView(n);t.appendChild(i.render().el),this.options.afterRender&&this.options.afterRender(this.document,i)},this),t}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"./node_view_factory":143,underscore:269}],140:[function(t,e){"use strict";var n=t("./annotator"),i=t("./selection"),o=function(t){this.document=t.document,this.container=t,this.annotator=new n(this.document),this.selection=new i(this.container)};o.Prototype=function(){this.startSimulation=function(){var t=this.document.startSimulation(),e=new n(t),o=this.container.createContainer(t),r=new i(o,this.selection),s={};return r.isNull()||(s.before={container:this.container.name,sel:r.toJSON()}),{document:t,view:o.name,selection:r,annotator:e,container:o,dispose:function(){},save:function(){s.after={container:this.container.name,sel:r.toJSON()},t.save(s),this.dispose()}}},this.dispose=function(){}},o.prototype=new o.Prototype,Object.defineProperties(o.prototype,{view:{get:function(){return this.container.name},set:function(){throw new Error("Immutable.")}}}),e.exports=o},{"./annotator":133,"./selection":144}],141:[function(t,e){"use strict";function n(t,e,n){this.node=t,this.nodeComponents=e,this.ranges=n}n.Prototype=function(){this.isFull=function(){return this.ranges.length===this.nodeComponents.length&&this.ranges[0].isFull()&&this.ranges[this.ranges.length-1].isFull()?!0:!1},this.isPartial=function(){return!this.isFull()}},n.prototype=new n.Prototype,e.exports=n},{}],142:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=function(t){this.document=t,this.nodeTypes=this.document.nodeTypes,this.nodeSurfaces={},this.listenTo(this.document,"operation:applied",this.onGraphUpdate)};o.Prototype=function(){this.onGraphUpdate=function(t){"delete"===t.type&&delete this.nodeSurfaces[t.path[0]]},this.getNodeSurface=function(t){var e,i;return n.isString(t)?e=t:(i=t,e=i.id),this.nodeSurfaces[e]||(i=i||this.document.get(e),this.nodeSurfaces[e]=this.createNodeSurface(i)),this.nodeSurfaces[e]},this.createNodeSurface=function(t){var e;if(!t)return null;var n=this.nodeTypes[t.type].Surface;return e=n?new n(t,this):new o.EmptySurface(t)},this.createCopy=function(t){return new o(t)}},o.Prototype.prototype=i.Events,o.prototype=new o.Prototype,o.EmptySurface=function(t){this.node=t,this.view=null,this.components=[]},e.exports=o},{"substance-util":264,underscore:269}],143:[function(t,e){"use strict";var n=function(t){this.document=t,this.nodeTypes=t.nodeTypes};n.Prototype=function(){this.createView=function(t,e){var n=this.nodeTypes[t.type].View;if(!n)throw new Error('Node type "'+t.type+'" not supported');var i=new n(t,this,e);return i.listenTo(this.document,"operation:applied",i.onGraphUpdate),i}},n.prototype=new n.Prototype,e.exports=n},{}],144:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=i.errors,r=t("./cursor"),s=t("./component_selection"),a=t("./node_selection"),c=o.define("SelectionError"),h=function(t,e){this.container=t,this.start=null,this.__cursor=new r(t,null,null),e&&this.set(e)};h.Prototype=function(){this.copy=function(){var t=new h(this.container);return this.isNull()||t.set(this),t},this.set=function(t,e){if(null===t)return this.clear();var i=this.__cursor;if(t instanceof h){if(t.isNull())return void this.clear();this.start=n.clone(t.start),i.set(t.__cursor.pos,t.__cursor.charPos)}else n.isArray(t)?(this.start=n.clone(t),i.set(t[0],t[1])):(this.start=n.clone(t.start),i.set(t.end[0],t.end[1]));this.start;return this.trigger("selection:changed",this.range(),e),this},this.clear=function(t){this.start=null,this.__cursor.set(null,null),this.trigger("selection:changed",null,t)},this.range=function(){if(this.isNull())return null;var t=this.start,e=this.__cursor.position();return this.isReverse()?{start:e,end:t}:{start:t,end:e}},this.isReverse=function(){var t=this.__cursor;return t.pos<this.start[0]||t.pos===this.start[0]&&t.charPos<this.start[1]},this.setCursor=function(t){return this.__cursor.set(t[0],t[1]),this.start=t,this},this.getCursor=function(){return this.__cursor.copy()},this.getCursorPosition=function(){return[this.__cursor.pos,this.__cursor.charPos]},this.selectNode=function(t){var e=this.container.getNodeComponents(t),n=e[0],i=e[e.length-1],o=this.container.getLength(i.pos);this.set({start:[n.pos,0],end:[i.pos,o]})},this.getPredecessor=function(){throw new Error("Not supported anymore")},this.getSuccessor=function(){throw new Error("Not supported anymore")},this.hasPredecessor=function(t){return t>0},this.hasSuccessor=function(t){var e=this.container.getLength();return e-1>t},this.collapse=function(t,e){if("right"!==t&&"left"!==t&&"start"!==t&&"cursor"!==t)throw new c("Invalid direction: "+t);if(!this.isCollapsed()&&!this.isNull()){if("start"===t)this.__cursor.set(this.start[0],this.start[1]);else if("cursor"===t)this.start[0]=this.__cursor.pos,this.start[1]=this.__cursor.charPos;else{var n=this.range();this.isReverse()?"left"===t?this.start=n.start:this.__cursor.set(n.end[0],n.end[1]):"left"===t?this.__cursor.set(n.start[0],n.start[1]):this.start=n.end}this.trigger("selection:changed",this.range(),e)}},this.move=function(t,e,n){this.isCollapsed()||"char"!==e?(this.__cursor.move(t,e),this.start=this.__cursor.position()):this.collapse(t),this.trigger("selection:changed",this.range(),n)},this.expand=function(t,e,n){this.__cursor.move(t,e),this.trigger("selection:changed",this.range(),n)},this.toJSON=function(){var t=null;return this.isNull()||(t=this.isCollapsed()?this.__cursor.toJSON():{start:n.clone(this.start),end:this.__cursor.toJSON()}),t},this.getRanges=function(){if(this.isNull())return[];for(var t=[],e=this.range(),i=e.start[0];i<=e.end[0];i++){var o=0,r=null;i===e.start[0]&&(o=e.start[1]),i===e.end[0]&&(r=e.end[1]),n.isNumber(r)||(r=this.container.getLength(i));var a=this.container.getComponent(i);t.push(new s(a,o,r))}return t},this.getNodeSelections=function(){if(this.isNull())return[];for(var t=[],e=this.range(),n=null,i=e.start[0];i<=e.end[0];i++){var o=this.container.getComponent(i),r=0,c=o.length;if(!n||n.node!==o.root){var h=o.root,u=this.container.getNodeComponents(h.id);n=new a(h,u,[]),t.push(n)}i===e.start[0]?r=e.start[1]:i===e.end[0]&&(c=e.end[1]),n.ranges.push(new s(o,r,c))}return t},this.startPos=function(){return this.isReverse()?this.__cursor.pos:this.start[0]},this.endPos=function(){return this.isReverse()?this.start[0]:this.__cursor.pos},this.getNodeByComponentPos=function(t){return this.container.getComponent(t).root},this.getStartNode=function(){return this.getNodeByComponentPos(this.start[0])},this.getEndNode=function(){return this.getNodeByComponentPos(this.end[0])},this.getNodes=function(){if(this.isNull())return[];for(var t=this.startPos(),e=this.endPos(),n=[],i=t;e>=i;i++)n.push(this.getNodeByComponentPos(i));return n},this.startChar=function(){return this.isReverse()?this.__cursor.charPos:this.start[1]},this.endChar=function(){return this.isReverse()?this.start[1]:this.__cursor.charPos},this.isNull=function(){return null===this.start},this.isCollapsed=function(){return!this.isNull()&&this.start[0]===this.__cursor.pos&&this.start[1]===this.__cursor.charPos},this.hasMultipleNodes=function(){return!this.isNull()&&this.startPos()!==this.endPos()},this.getText=function(){if(this.isNull()||this.hasMultipleNodes())return"";var t=this.container.getComponent(this.start[0]),e=this.container.document.get(t.path);return void 0!==e?e.substring(this.startChar(),this.endChar()):(console.error("FIXME: expecting text node but got: ",node),"")}},h.Prototype.prototype=i.Events,h.prototype=new h.Prototype,Object.defineProperties(h.prototype,{cursor:{get:function(){return this.__cursor.copy()},set:function(){throw"immutable property"}}}),h.SelectionError=c,e.exports=h},{"./component_selection":135,"./cursor":137,"./node_selection":141,"substance-util":264,underscore:269}],145:[function(t,e){"use strict";e.exports={node:t("./src/node"),text:t("./src/text"),document:t("./src/document"),container:t("./src/container"),heading:t("./src/heading"),blockquote:t("./src/blockquote"),code_block:t("./src/code_block"),figure:t("./src/figure"),contributor:t("./src/contributor"),interview_subject:t("./src/interview_subject"),cover:t("./src/cover"),citation:t("./src/citation"),annotation:t("./src/annotation"),emphasis:t("./src/emphasis"),strong:t("./src/strong"),subscript:t("./src/subscript"),superscript:t("./src/superscript"),code:t("./src/code"),web_resource:t("./src/web_resource"),video:t("./src/video"),audio:t("./src/audio"),web_page:t("./src/web_page"),list_item:t("./src/list_item"),issue:t("./src/issue"),remark:t("./src/remark"),error:t("./src/error"),file:t("./src/file"),license:t("./src/license"),publication_info:t("./src/publication_info"),figure_reference:t("./src/figure_reference"),citation_reference:t("./src/citation_reference"),cross_reference:t("./src/cross_reference"),remark_reference:t("./src/remark_reference"),error_reference:t("./src/error_reference"),multi_annotation:t("./src/multi_annotation"),annotation_fragment:t("./src/annotation_fragment"),location_reference:t("./src/location_reference"),person_reference:t("./src/person_reference"),definition_reference:t("./src/definition_reference"),subject_reference:t("./src/subject_reference")}},{"./src/annotation":148,"./src/annotation_fragment":151,"./src/audio":153,"./src/blockquote":156,"./src/citation":159,"./src/citation_reference":161,"./src/code":163,"./src/code_block":166,"./src/container":168,"./src/contributor":171,"./src/cover":174,"./src/cross_reference":176,"./src/definition_reference":178,"./src/document":180,"./src/emphasis":182,"./src/error":185,"./src/error_reference":187,"./src/figure":189,"./src/figure_reference":191,"./src/file":193,"./src/heading":196,"./src/interview_subject":197,"./src/issue":200,"./src/license":203,"./src/list_item":205,"./src/location_reference":208,"./src/multi_annotation":210,"./src/node":212,"./src/person_reference":217,"./src/publication_info":219,"./src/remark":222,"./src/remark_reference":225,"./src/strong":227,"./src/subject_reference":229,"./src/subscript":231,"./src/superscript":233,"./src/text":235,"./src/video":239,"./src/web_page":241,"./src/web_resource":243}],146:[function(t,e){"use strict";var n=t("../node/node"),i=(t("underscore"),function(t,e){n.call(this,t,e)});i.type={id:"annotation",properties:{path:["array","string"],range:"object"}},i.description={name:"Annotation",remarks:["Abstract type for all available annotations"],properties:{path:"References node and property in the graph.",range:"Tuple describing start and end character offset."}},i.example={type:"emphasis",id:"emphasis_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){this.getContent=function(){var t=this.document.get(this.path);if(t){var e=this.range;return t.substring(e[0],e[1])}return console.error("FIXME: this annotation references a deleted node",this,this.path),"N/A"}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213,underscore:269}],147:[function(t,e){"use strict";var n=function(t,e){this.node=t,this.viewFactory=e,this.el=this.createElement()};n.Prototype=function(){this.elementType="span",this.createElement=function(){var t=window.document.createElement(this.elementType);return t.dataset.id=this.node.id,t.classList.add("annotation"),t.classList.add(this.node.type),t},this.render=function(){return this},this.appendChild=function(t){this.el.appendChild(t)}},n.prototype=new n.Prototype,n.prototype.constructor=n,e.exports=n},{}],148:[function(t,e){"use strict";e.exports={Model:t("./annotation"),View:t("./annotation_view")}},{"./annotation":146,"./annotation_view":147}],149:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"annotation_fragment",parent:"annotation",properties:{annotation_id:"string",fragment_number:"number"}},i.Prototype=function(){this.isInternal=!0,this.isFirst=function(){return 0===this.properties.fragment_number},this.isLast=function(){return this.properties.fragment_number===this.getAnnotation().numberOfFragments-1},this.getAnnotation=function(){return this.annotation||(this.annotation=this.document.get(this.annotation_id)),this.annotation}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],150:[function(t,e){"use strict";var n=(t("substance-application").$$,t("../annotation/annotation_view")),i=function(){n.apply(this,arguments),this.content=window.document.createElement("span")};i.Prototype=function(){var t=n.prototype;this.createElement=function(){var e=t.createElement.call(this),n=this.node.document.get(this.node.annotation_id);return e.classList.add(n.type),e.classList.add(this.node.id),e.dataset.annotationId=n.id,e},this.render=function(){return this.el.innerHTML="",this.el.appendChild(this.content),this},this.appendChild=function(t){this.content.appendChild(t)}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.Prototype.constructor=i,e.exports=i},{"../annotation/annotation_view":147,"substance-application":6}],151:[function(t,e){"use strict";e.exports={Model:t("./annotation_fragment"),View:t("./annotation_fragment_view")}},{"./annotation_fragment":149,"./annotation_fragment_view":150}],152:[function(t,e){"use strict";var n=t("../node/node"),i=t("underscore"),o=function(t,e){n.call(this,t,e)};o.type={id:"audio",parent:"content",properties:{files:["array","file"],caption:"paragraph"}},o.description={name:"Audio",remarks:["A web video."],properties:{files:"An array of different video files (MP3, WAV)",caption:"A reference to a paragraph that describes the audio piece"}},o.example={id:"audio",label:"Audio",files:["song1.mp3"],caption:"text_1"},o.Prototype=function(){this.hasCaption=function(){return!!this.properties.caption},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0},this.getAudioFiles=function(){return i.map(this.properties.files,function(t){return this.document.get(t)},this)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,o.prototype.defineProperties(),e.exports=o},{"../node/node":213,underscore:269}],153:[function(t,e){"use strict";e.exports={Model:t("./audio")}},{"./audio":152}],154:[function(t,e){"use strict";var n=t("../text/text_node"),i=function(t,e){n.call(this,t,e)};i.type={id:"blockquote",parent:"content",properties:{source_id:"string",content:"string",level:"number"}},i.example={type:"blockquote",id:"blockquote_1",content:"Introduction"},i.description={name:"Blockquote",remarks:["Denotes a blockquote."],properties:{content:"Blockquote content"}},i.Prototype=function(){this.splitInto="paragraph"},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../text/text_node":236}],155:[function(t,e){"use strict";var n=t("../text/text_view"),i=function(t){n.call(this,t),this.$el.addClass("blockquote")};i.Prototype=function(){var t=n.prototype;this.onNodeUpdate=function(e){t.onNodeUpdate.call(this,e)}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../text/text_view":238}],156:[function(t,e){"use strict";e.exports={Model:t("./blockquote"),View:t("./blockquote_view"),Surface:t("../text/text_surface")}},{"../text/text_surface":237,"./blockquote":154,"./blockquote_view":155}],157:[function(t,e){var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"article_citation",parent:"content",properties:{source_id:"string",title:"string",label:"string",authors:["array","string"],doi:"string",source:"string",volume:"string",publisher_name:"string",publisher_location:"string",fpage:"string",lpage:"string",year:"string",citation_urls:["array","string"]}},i.description={name:"Citation",remarks:["A journal citation.","This element can be used to describe all kinds of citations."],properties:{title:"The article's title",label:"Optional label (could be a number for instance)",doi:"DOI reference",source:"Usually the journal name",volume:"Issue number",publisher_name:"Publisher Name",publisher_location:"Publisher Location",fpage:"First page",lpage:"Last page",year:"The year of publication",citation_urls:"A list of links for accessing the article on the web"}},i.example={id:"article_nature08160",type:"article_citation",label:"5",title:"The genome of the blood fluke Schistosoma mansoni",authors:["M Berriman","BJ Haas","PT LoVerde"],doi:"http://dx.doi.org/10.1038/nature08160",source:"Nature",volume:"460",fpage:"352",lpage:"8",year:"1984",citation_urls:["http://www.ncbi.nlm.nih.gov/pubmed/19606141"]},i.Prototype=function(){this.urls=function(){return this.properties.citation_urls.length>0?this.properties.citation_urls:[this.properties.doi]}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),Object.defineProperties(i.prototype,{header:{get:function(){return this.properties.title},set:function(){throw new Error("This is a read-only alias property.")}}}),e.exports=i},{"../node/node":213}],158:[function(t,e){"use strict";var n=t("../node").View,i=t("../text").View,o=t("substance-application").$$,r=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("citation")};r.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=document.createDocumentFragment(),e=this.node;this.titleView=new i(this.node,this.viewFactory,{property:"title"}),t.appendChild(this.titleView.render().el);var r=o(".resource-body");this.authorEls=[];for(var s=o(".authors"),a=0;a<e.authors.length;a++){var c=e.authors[a];this.authorEls.push(o("span.author",{text:c})),s.appendChild(this.authorEls[a]),s.appendChild(document.createTextNode(" "))}r.appendChild(s);var h=[];return e.source&&e.volume&&h.push([e.source,e.volume].join(", ")+": "),e.fpage&&e.lpage&&h.push([e.fpage,e.lpage].join("-")+", "),e.publisher_name&&e.publisher_location&&h.push([e.publisher_name,e.publisher_location].join(", ")+", "),e.year&&h.push(e.year),this.sourceEl=o(".source",{html:h.join("")}),r.appendChild(this.sourceEl),e.doi&&(this.doiEl=o(".doi",{children:[o("b",{text:"DOI: "}),o("a",{href:e.doi,target:"_new",text:e.doi})]}),r.appendChild(this.doiEl)),t.appendChild(r),this.content.appendChild(t),this},this.dispose=function(){n.dispose.call(this),this.titleView.dispose()}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"../node":212,"../text":235,"substance-application":6}],159:[function(t,e){"use strict";e.exports={Model:t("./citation"),View:t("./citation_view")}},{"./citation":157,"./citation_view":158}],160:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"citation_reference",parent:"annotation",properties:{target:"citation"}},i.description={name:"CitationReference",remarks:["References a range in a text-ish node and references a citation."],properties:{}},i.example={type:"citation_reference_1",id:"citation_reference_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],161:[function(t,e){"use strict";e.exports={Model:t("./citation_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./citation_reference":160}],162:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"code",parent:"annotation",properties:{}},i.description={name:"Code",remarks:["References a range in a text-ish node and tags it as subscript"],properties:{}},i.example={type:"code_1",id:"code_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":146}],163:[function(t,e){"use strict";e.exports={Model:t("./code")}},{"./code":162}],164:[function(t,e){"use strict";var n=t("../text/text_node"),i=function(t,e){n.call(this,t,e)};i.type={id:"code_block",parent:"content",properties:{source_id:"string",content:"string"}},i.config={zoomable:!0},i.description={name:"CodeBlock",remarks:["Text in a codeblock is displayed in a fixed-width font, and it preserves both spaces and line breaks"],properties:{content:"Content"}},i.example={type:"code_block",id:"code_block_1",content:'var text = "Sun";\nvar op1 = Operator.TextOperation.Delete(2, "n");\ntext = op2.apply(op1.apply(text));\nconsole.log(text);'},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i
},{"../text/text_node":236}],165:[function(t,e){"use strict";var n=t("../text/text_view"),i=function(t){n.call(this,t),this.$el.addClass("content-node code-block")};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../text/text_view":238}],166:[function(t,e){"use strict";e.exports={Model:t("./code_block"),View:t("./code_block_view"),Surface:t("../text/text_surface")}},{"../text/text_surface":237,"./code_block":164,"./code_block_view":165}],167:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"container",properties:{nodes:["array","content"]}},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213}],168:[function(t,e){"use strict";e.exports={Model:t("./container_node")}},{"./container_node":167}],169:[function(t,e){var n=t("underscore"),i=t("../node/node"),o=function(t,e){i.call(this,t,e)};o.type={id:"contributor",parent:"content",properties:{source_id:"string",name:"string",role:"string",description:"string",image:"file",email:"string",contribution:"string"}},o.description={name:"Contributor",remarks:["Describes an article contributor such as an author or editor."],properties:{name:"Full name."}},o.example={id:"contributor_1",type:"contributor",role:"author",name:"John Doe",email:"a@b.com",description:"Revising the article, data cleanup"},o.Prototype=function(){this.getAffiliations=function(){return n.map(this.properties.affiliations,function(t){return this.document.get(t)},this)},this.getBlob=function(){if(!this.properties.image)return null;var t=this.document.get(this.properties.image);return t?t.getBlob():null},this.getUrl=function(){var t=this.getBlob();return t?window.URL.createObjectURL(t):this.properties.image_url}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,o.prototype.defineProperties(),Object.defineProperties(o.prototype,{header:{get:function(){return this.properties.name},set:function(){throw new Error("This is a read-only alias property.")}}}),e.exports=o},{"../node/node":213,underscore:269}],170:[function(t,e){"use strict";var n=t("../node").View,i=t("substance-application").$$,o=t("../text/text_view"),r=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node contributor")};r.Prototype=function(){this.render=function(){n.prototype.render.call(this),this.roleEl=i(".contributor-role",{text:this.node.role}),this.content.appendChild(this.roleEl),this.nameView=new o(this.node,this.viewFactory,{property:"name"}),this.content.appendChild(this.nameView.render().el);var t=i(".resource-body");return this.imgEl=i("img"),this.updateImage(),this.imageEl=i(".image",{contenteditable:!1,children:[this.imgEl],"data-path":this.node.id+".image"}),t.appendChild(this.imageEl),this.descriptionView=new o(this.node,this.viewFactory,{property:"description"}),t.appendChild(this.descriptionView.render().el),this.content.appendChild(t),this},this.updateImage=function(){var t=this.node.getUrl()||"styles/contributor-image-placeholder.png";this.imgEl.setAttribute("src",t)},this.dispose=function(){n.prototype.dispose.call(this),this.nameView.dispose(),this.descriptionView.dispose()}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":212,"../text/text_view":238,"substance-application":6}],171:[function(t,e){"use strict";e.exports={Model:t("./contributor"),View:t("./contributor_view")}},{"./contributor":169,"./contributor_view":170}],172:[function(t,e){var n=(t("underscore"),t("../node/node")),i=function(t,e){n.call(this,t,e)};i.type={id:"cover",parent:"content",properties:{source_id:"string",image:"string"}},i.description={name:"Cover",remarks:["Virtual view on the title and authors of the paper."],properties:{}},i.example={id:"cover",type:"cover",image:"http://example.com/image.png"},i.Prototype=function(){this.deleteImage=function(){this.document["delete"](this.properties.image),this.document.set([this.id,"image"],"")},this.getBlob=function(){if(!this.properties.image)return null;var t=this.document.get(this.properties.image);return t?t.getBlob():null},this.getUrl=function(){var t=this.getBlob();return t?window.URL.createObjectURL(t):this.properties.image_url}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),Object.defineProperties(i.prototype,{title:{get:function(){return this.document.title},set:function(t){this.document.title=t}},"abstract":{get:function(){return this.document["abstract"]},set:function(t){this.document["abstract"]=t}}}),e.exports=i},{"../node/node":213,underscore:269}],173:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-application").$$,o=t("../node/node_view"),r=t("../text/text_view"),s=t("substance-document").Annotator,a=function(t,e){o.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node cover")};a.Prototype=function(){this.render=function(){return o.prototype.render.call(this),this.node.document.published_on&&this.content.appendChild(i(".published-on",{contenteditable:!1,html:new Date(this.node.document.published_on).toDateString()})),this.titleView=new r(this.node,this.viewFactory,{property:"title"}),this.content.appendChild(this.titleView.render().el),this.titleView.el.classList.add("title"),this.authorsEl=i(".authors"),this.renderAuthors(),this.content.appendChild(this.authorsEl),this},this.dispose=function(){o.dispose.call(this),this.titleView.dispose()},this.renderAuthors=function(){this.authorsEl.innerHTML="";var t=this.node.document.getAuthors();n.each(t,function(t){var e=i("a.toggle-author",{id:"toggle_"+t.id,href:"#",text:t.name,"data-id":t.id});this.authorsEl.appendChild(e)},this)},this.onGraphUpdate=function(t){return o.prototype.onGraphUpdate.call(this,t)?!0:n.isEqual(t.path,["document","title"])?(this.titleView.renderContent(),!0):(n.isEqual(t.path,["document","authors"])&&this.renderAuthors(),s.changesAnnotations(this.node.document,t,["cover","title"])?(this.titleView.renderContent(),!0):void 0)}},a.Prototype.prototype=o.prototype,a.prototype=new a.Prototype,e.exports=a},{"../node/node_view":215,"../text/text_view":238,"substance-application":6,"substance-document":132,underscore:269}],174:[function(t,e){"use strict";e.exports={Model:t("./cover"),View:t("./cover_view")}},{"./cover":172,"./cover_view":173}],175:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"cross_reference",parent:"annotation",properties:{target:"content"}},i.description={name:"CrossReference",remarks:["References a range in a text-ish node and references a content node."],properties:{}},i.example={type:"cross_reference_1",id:"cross_reference_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],176:[function(t,e){"use strict";e.exports={Model:t("./cross_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./cross_reference":175}],177:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"definition_reference",parent:"annotation",properties:{target:"string"}},i.description={name:"DefinitionReference",remarks:["References a range in a text-ish node and references a location node."],properties:{}},i.example={id:"definition_reference_1",type:"definition_reference",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],178:[function(t,e){"use strict";e.exports={Model:t("./definition_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./definition_reference":177}],179:[function(t,e){var n=(t("underscore"),t("../node/node")),i=function(t,e){n.call(this,t,e)};i.type={id:"document",parent:"content",properties:{views:["array","view"],guid:"string",creator:"string",authors:["array","contributor"],project:"string",location:"string",place:"place",duration:"string",license:"license",title:"string",timemarks:"object","abstract":"string",abstract_en:"string",created_at:"date",updated_at:"date",published_on:"date",meta:"object"}},i.description={name:"document",remarks:["A node containing meta information for a document."],properties:{}},i.example={},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213,underscore:269}],180:[function(t,e){"use strict";e.exports={Model:t("./document_node")}},{"./document_node":179}],181:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"emphasis",parent:"annotation",properties:{}},i.description={name:"Emphasis",remarks:["References a range in a text-ish node and tags it as emphasized"],properties:{}},i.example={type:"emphasis",id:"emphasis_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":146}],182:[function(t,e){"use strict";e.exports={Model:t("./emphasis"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./emphasis":181}],183:[function(t,e){"use strict";var n=t("../issue/issue"),i=function(t,e){n.call(this,t,e)};i.type={id:"error",parent:"issue",properties:{}},i.description={name:"Error",remarks:["References a range in a text-ish node and tags it as emphasized"],properties:{}},i.example={type:"error",id:"error_1",title:"Hi I am an a error",description:"An error, yes."},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../issue/issue":201}],184:[function(t,e){"use strict";var n=t("../issue/issue_view"),i=function(t,e){n.call(this,t,e)};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../issue/issue_view":202}],185:[function(t,e){"use strict";e.exports={Model:t("./error"),View:t("./error_view")}},{"./error":183,"./error_view":184}],186:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"error_reference",parent:"annotation",properties:{target:"error"}},i.description={name:"ErrorReference",remarks:["References a range in a text-ish node and references an error"],properties:{target:"Referenced error id"}},i.example={type:"error_reference_1",id:"error_reference_1",path:["text_54","content"],range:[85,95],target:"error_1"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],187:[function(t,e){"use strict";e.exports={Model:t("./error_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./error_reference":186}],188:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"figure",parent:"content",properties:{image:"file",caption:"paragraph"}},i.description={name:"Figure",remarks:["A figure holding an image, a label and a caption."],properties:{image:"File id that has the image data",caption:"A reference to a paragraph that describes the figure"}},i.example={id:"figure_1",image:"figure_1.png",caption:"paragraph_1"},i.Prototype=function(){this.deleteImage=function(){this.document["delete"](this.properties.image),this.document.set([this.id,"image"],"")},this.hasCaption=function(){return!!this.properties.caption},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0},this.getBlob=function(){if(!this.properties.image)return null;var t=this.document.get(this.properties.image);return t?t.getBlob():null},this.getUrl=function(){var t=this.getBlob();if(t){var e=window.URL;return e.createObjectURL(t)}return this.properties.image_url}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),Object.defineProperties(i.prototype,{header:{get:function(){return this.properties.label},set:function(){throw new Error("This is a read-only alias property.")}}}),i.create=function(t){var e={},n=t.id,i={id:n,type:"figure"};if(t.caption){var o="caption_"+t.id,r={id:o,type:"text",content:t.caption};e[o]=r,i.caption=o}return e[n]=i,e},e.exports=i},{"../node/node":213}],189:[function(t,e){"use strict";e.exports={Model:t("./figure")}},{"./figure":188}],190:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"figure_reference",parent:"annotation",properties:{target:"figure"}},i.description={name:"FigureReference",remarks:["References a range in a text-ish node and references a figure"],properties:{target:"Referenced figure id"}},i.example={type:"figure_reference_1",id:"figure_reference_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],191:[function(t,e){"use strict";e.exports={Model:t("./figure_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./figure_reference":190}],192:[function(t,e){"use strict";var n=t("../node/node"),i=t("underscore"),o=function(t,e){n.call(this,t,e)};o.type={id:"file",parent:"content",properties:{version:"number",content_type:"string"}},o.description={name:"File",remarks:["A file is a file is a file."],properties:{content_type:"Content MIME type",version:"File version, gets incremented every time the file content changes."}},o.example={id:"figure1.png",version:1,content_type:"image/png"},o.Prototype=function(){this.isText=function(){return i.include(["application/json","text/css","text/plain","text/html"],this.properties.content_type)},this.isBinary=function(){return!this.isText()},this.isJSON=function(){return"application/json"===this.properties.content_type},this.getData=function(t){var e=this.properties.id+".v"+(t||this.properties.version);return this.document.fileData[e]},this.getSize=function(){var t=this.getData();return this.isJSON()?JSON.stringify(t).length:this.isBinary()?t.byteLength||t.length||0:t.length},this.getBlob=function(t){var e=this.getData(t);return new window.Blob([e],{type:this.properties.content_type})},this.setData=function(t,e){e=e||this.properties.version;var n=this.properties.id+".v"+e;this.document.fileData[n]=this.isJSON()?JSON.parse(t):this.isText()?t:t},this.updateData=function(t){var e=this.properties.version;e=e?e+1:1,this.setData(t,e),this.document.set([this.properties.id,"version"],e)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,o.prototype.defineProperties(),e.exports=o},{"../node/node":213,underscore:269}],193:[function(t,e){"use strict";e.exports={Model:t("./file")}},{"./file":192}],194:[function(t,e){"use strict";var n=t("../text/text_node"),i=function(t,e){n.call(this,t,e)};i.type={id:"heading",parent:"content",properties:{source_id:"string",content:"string",level:"number"}},i.example={type:"heading",id:"heading_1",content:"Introduction",level:1},i.description={name:"Heading",remarks:["Denotes a section or sub section in your article."],properties:{content:"Heading content",level:"Heading level. Ranges from 1..4"}},i.Prototype=function(){this.splitInto="paragraph"},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../text/text_node":236}],195:[function(t,e){"use strict";var n=t("../text/text_view"),i=function(t){n.call(this,t),this.$el.addClass("heading"),this._level=this.node.level,this.$el.addClass("level-"+this._level)};i.Prototype=function(){var t=n.prototype;this.onNodeUpdate=function(e){t.onNodeUpdate.call(this,e),"level"===e.path[1]&&(this.$el.removeClass("level-"+this._level),this._level=this.node.level,this.$el.addClass("level-"+this._level))}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../text/text_view":238}],196:[function(t,e){"use strict";e.exports={Model:t("./heading"),View:t("./heading_view"),Surface:t("../text/text_surface")}},{"../text/text_surface":237,"./heading":194,"./heading_view":195}],197:[function(t,e){"use strict";e.exports={Model:t("./interview_subject"),View:t("./interview_subject_view")}},{"./interview_subject":198,"./interview_subject_view":199}],198:[function(t,e){var n=(t("underscore"),t("../node/node")),i=function(t,e){n.call(this,t,e)};i.type={id:"interview_subject",parent:"content",properties:{source_id:"string",name:"string",role:"string",description:"string",forced_labor:"string",categories:["array","string"],prisons:["array","location"],movement:["array","object"],image:"file",email:"string",contribution:"string"}},i.Prototype=function(){this.getBlob=function(){if(!this.properties.image)return null;var t=this.document.get(this.properties.image);return t?t.getBlob():null},this.getUrl=function(){var t=this.getBlob();return t?window.URL.createObjectURL(t):this.properties.image_url}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213,underscore:269}],199:[function(t,e){"use strict";var n=t("../node").View,i=t("substance-application").$$,o=t("../text/text_view"),r=t("substance-operator").ArrayOperation,s=t("underscore"),a=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node contributor interview-subject")};a.Prototype=function(){this.render=function(){n.prototype.render.call(this),this.roleEl=i(".contributor-role",{text:this.node.role}),this.content.appendChild(this.roleEl),this.nameView=new o(this.node,this.viewFactory,{property:"name"}),this.content.appendChild(this.nameView.render().el);var t=i(".resource-body");return this.imgEl=i("img"),this.updateImage(),this.imageEl=i(".image",{contenteditable:!1,children:[this.imgEl],"data-path":this.node.id+".image"}),t.appendChild(i(".label",{text:"Biography"})),this.descriptionView=new o(this.node,this.viewFactory,{property:"description"}),t.appendChild(this.descriptionView.render().el),t.appendChild(i(".label",{text:"Forced labor"})),this.forcedLaborEl=i(".forced-labor.node-property",{text:this.node.forced_labor}),t.appendChild(this.forcedLaborEl),t.appendChild(i(".label",{text:"Categories"})),this.categoriesEl=i(".categories.node-property",{text:this.node.categories.join(", ")}),t.appendChild(this.categoriesEl),t.appendChild(i(".label",{text:"Prisons"})),this.prisonsEl=i(".prisons.node-property",{text:this.node.prisons.join(", ")}),t.appendChild(this.prisonsEl),t.appendChild(i(".label",{text:"Movement"})),this.movementEl=i(".movement-entries"),s.each(this.node.movement,function(t){var t=i(".movement-entry",{children:[i(".location-name",{text:t.location}),i("input.density",{value:t.density}),i(".remove",{html:'<i class="icon-remove-sign"/>'})]});this.movementEl.appendChild(t)},this),t.appendChild(this.movementEl),this.content.appendChild(t),this},this.addMovementEntry=function(){var t=r.Push(this.node.movement,{location:"foo",density:2});this.node.document.update([this.node.id,"movement"],t),console.log("le movement AFTER:",this.node.movement)},this.updateImage=function(){var t=this.node.getUrl()||"styles/contributor-image-placeholder.png";this.imgEl.setAttribute("src",t)},this.dispose=function(){n.prototype.dispose.call(this),this.nameView.dispose(),this.descriptionView.dispose()}},a.Prototype.prototype=n.prototype,a.prototype=new a.Prototype,e.exports=a},{"../node":212,"../text/text_view":238,"substance-application":6,"substance-operator":246,underscore:269}],200:[function(t,e){"use strict";e.exports={Model:t("./issue"),View:t("./issue_view")}},{"./issue":201,"./issue_view":202}],201:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"issue",properties:{title:"string",description:"string",creator:"string",created_at:"date"}},i.description={name:"Issue",remarks:["References a range in a text-ish node and tags it as subscript"],properties:{title:"Issue Title",description:"More verbose issue description",creator:"Issue creator",created_at:"Date and time of issue creation."}},i.example={"abstract":"type"},i.Prototype=function(){this.hasDescription=function(){return!!this.properties.caption},this.getDescription=function(){return this.properties.description?this.document.get(this.properties.description):void 0},this.getReferences=function(){var t=this.document.getIndex("references");return t?t.get(this.properties.id):(console.error("No index for references."),[])}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213}],202:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node/node_view"),o=t("../text/text_view"),r=function(t,e){i.call(this,t,e),this.$el.addClass("issue")};r.Prototype=function(){var t=i.prototype;this._updateTitle=function(){this.titleTextEl.innerHTML=this.ref?this.ref.getContent():""},this.render=function(){i.prototype.render.call(this);var t=n("div.issue-title-wrapper");this.titleTextEl=n(".text.title",{children:[n("span.title-annotation",{text:"meeh"})]}),t.appendChild(this.titleTextEl);n("div.creator",{text:(this.node.creator||"Anonymous")+", "+jQuery.timeago(new Date(this.node.created_at)),contenteditable:!1});this.descriptionView=new o(this.node,this.viewFactory,{property:"description"}),this.content.appendChild(this.descriptionView.render().el);var e=this.node.getReferences(),r=Object.keys(e);return r.length>0&&(this.ref=e[r[0]],this._updateTitle()),this},this.dispose=function(){i.dispose.call(this),this.descriptionView.dispose()},this.onNodeUpdate=function(t){return"description"===t.path[1]?(this.descriptionView.onNodeUpdate(t),!0):!1},this.onGraphUpdate=function(e){return t.onGraphUpdate.call(this,e)?!0:"create"===e.type&&e.val.target===this.node.id?(this.ref=this.node.document.get(e.val.id),this._updateTitle(),!0):"delete"===e.type&&e.val.target===this.node.id?(this.ref=null,this._updateTitle(),!0):this.ref&&e.path[0]===this.ref.id?(this._updateTitle(),!0):!1}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node/node_view":215,"../text/text_view":238,"substance-application":6}],203:[function(t,e){"use strict";e.exports={Model:t("./license")}},{"./license":204}],204:[function(t,e){"use strict";var n=t("../node/node"),i=(t("underscore"),function(t,e){n.call(this,t,e)});i.type={id:"license",properties:{name:"string",code:"string",version:"string",description:"string",url:"string"}},i.description={name:"License",remarks:["Describes the content license used by the document"],properties:{name:"License name",code:"Coded license name, e.g. cc-by",version:"License version",description:"Text describing the license",url:"URL for more information about the license"}},i.Prototype=function(){},i.available_licenses={none:{id:"license",type:"license",name:"None",code:"none",description:"No license is attached to this article.",version:"1.0",url:""},"public-domain":{id:"license",type:"license",name:"Public Domain",code:"public-domain",description:"This work has been identified as being free of known restrictions under copyright law, including all related and neighboring rights. You can copy, modify, distribute and perform the work, even for commercial purposes, all without asking permission.",version:"1.0",url:"http://creativecommons.org/publicdomain/mark/1.0/"},"cc-by":{id:"license",type:"license",name:"Creative Commons Attribution License",code:"cc-by",version:"3.0",description:"This article is distributed under the terms of the Creative Commons Attribution License, which permits unrestricted use and redistribution provided that the original author and source are credited.",url:"http://creativecommons.org/licenses/by/3.0/us/"},gutenberg:{id:"license",type:"license",name:"Project Gutenberg License",code:"gutenberg",version:"1.0",description:"This article is distributed under the terms of the Project Gutenberg License.",url:"http://www.gutenberg.org/wiki/Gutenberg:The_Project_Gutenberg_License"}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213,underscore:269}],205:[function(t,e){"use strict";e.exports={Model:t("./list_item"),View:t("./list_item_view"),Surface:t("../text/text_surface")}},{"../text/text_surface":237,"./list_item":206,"./list_item_view":207}],206:[function(t,e){"use strict";var n=(t("underscore"),t("../text/text_node")),i=function(t,e){n.call(this,t,e)};i.type={id:"list_item",parent:"content",properties:{level:"number",content:"string"}},i.description={name:"ListItem",remarks:["ListItems have a level of nesting."],properties:{level:"Specifies the indentation level",content:"The item's content"}},i.example={type:"list_item",id:"list_item_1",level:1,content:"This is item 1"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../text/text_node":236,underscore:269}],207:[function(t,e){"use strict";var n=t("../text/text_view"),i=(t("underscore"),t("substance-application").$$,function(t){n.call(this,t),this._level=this.node.level,this.$el.addClass("level-"+this._level)});i.Prototype=function(){var t=n.prototype;this.onNodeUpdate=function(e){t.onNodeUpdate.call(this,e),"level"===e.path[1]&&(this.$el.removeClass("level-"+this._level),this._level=this.node.level,this.$el.addClass("level-"+this._level))},this.dispose=function(){t.dispose.call(this)}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../text/text_view":238,"substance-application":6,underscore:269}],208:[function(t,e){"use strict";e.exports={Model:t("./location_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./location_reference":209}],209:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"location_reference",parent:"annotation",properties:{target:"string"}},i.description={name:"LocationReference",remarks:["References a range in a text-ish node and references a location node."],properties:{}},i.example={id:"location_reference_1",type:"location_reference",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],210:[function(t,e){"use strict";e.exports={Model:t("./multi_annotation")}},{"./multi_annotation":211}],211:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e),this.numberOfFragments=0,this.fragmentIds=[]};i.type={id:"annotation",properties:{container:"string",startPath:["array","string"],startCharPos:"number",endPath:["array","string"],endCharPos:"number"}},i.Prototype=function(){this.removeFragments=function(t){for(var e=t?t.document:this.document,n=0;n<this.fragmentIds.length;n++){var i=this.fragmentIds[n],o=e.get(i);e.apply({type:"delete",path:[i],val:o})}},this.addFragments=function(t){var e;e=t?t.document:this.document;var n=e.get(this.container),i=this.id,o=n.lookup(this.startPath),r=n.lookup(this.endPath),s=o.pos,a=r.pos;this.fragmentIds=[],this.numberOfFragments=a-s+1;for(var c=s;a>=c;c++){var h=c-s,u=i+"_"+h,l=e.get(u);if(!l){var p,d,f;d=0,c===s?(p=o,d=this.startCharPos,f=c===a?this.endCharPos:p.getLength()):c===a?(p=r,f=this.endCharPos):(p=n.getComponent(c),f=p.getLength());var g={type:"annotation_fragment",id:u,annotation_id:i,path:p.path,range:[d,f],fragment_number:h};e.apply({type:"create",path:[u],val:g})}this.fragmentIds.push(u)}},this.update=function(t){this.removeFragments(t),this.addFragments(t)}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213}],212:[function(t,e){"use strict";e.exports={Model:t("./node"),View:t("./node_view"),Surface:t("./node_surface")}},{"./node":213,"./node_surface":214,"./node_view":215}],213:[function(t,e){"use strict";var n=t("underscore"),i=function(t,e){this.document=e,this.properties=t};i.type={parent:"content",properties:{}},i.Prototype=function(){this.toJSON=function(){return n.clone(this.properties)},this.getAnnotations=function(){return this.document.getIndex("annotations").get(this.properties.id)},this.isInstanceOf=function(t){var e=this.document.getSchema();return e.isInstanceOf(this.type,t)},this.defineProperties=function(t){if(!this.hasOwnProperty("constructor"))throw new Error("Constructor property is not set. E.g.: MyNode.prototype.constructor = MyNode;");var e=this.constructor;i.defineAllProperties(e,t)}},i.prototype=new i.Prototype,i.prototype.constructor=i,i.defineProperties=function(t,e,i){n.each(e,function(e){var n={get:function(){return this.properties[e]}};i||(n.set=function(t){return this.properties[e]=t,this}),Object.defineProperty(t,e,n)})},i.defineAllProperties=function(t,e){i.defineProperties(t.prototype,Object.keys(t.type.properties),e)},i.defineProperties(i.prototype,["id","type"]),e.exports=i},{underscore:269}],214:[function(t,e){"use strict";var n=t("./surface_component"),i=0,o=function(t,e){this.__id__=i++,this.node=t,this.surfaceProvider=e,this.view=null,this.components=[]};o.Prototype=function(){this.hasView=function(){return null!==this.view},this.attachView=function(t){this.view=t},this.detachView=function(){this.view=null},this.getCharPosition=function(t,e){if(!this.view)throw new Error("No view attached.");var n=this.__getCharPosition__(t,e);return n},this.getDOMPosition=function(t){if(!this.view)throw new Error("No view attached.");var e=this.__getDOMPosition__(t);return e},this.__getCharPosition__=function(t,e){var n=window.document.createRange();n.setStart(t,e);for(var i=0,o=0;o<this.components.length;o++){var r=this.components[o],s=n.compareBoundaryPoints(0,r.getRange());if(0>s)break;var a=n.compareBoundaryPoints(3,r.getRange());i=0>a?e:r.length}return i},this.__getDOMPosition__=function(t){for(var e,n,i=0;i<this.components.length;i++){if(n=this.components[i],e=n.getLength(),e>t)return n.mapCharPos(t);t-=e}return n.mapCharPos(e)},this.__createRange__=function(t){var e=window.document.createRange();return e.selectNode(t),e}},o.prototype=new o.Prototype,o.SurfaceComponent=n,e.exports=o},{"./surface_component":216}],215:[function(t,e){"use strict";var n=t("substance-application").View,i=t("underscore"),o=0,r=function(t,e){this.__id__=o++,n.call(this),this.node=t,this.viewFactory=e,this.$el.addClass("content-node").addClass(t.type.replace("_","-")),this.$el.attr("id",this.node.id)};r.Prototype=function(){this.render=function(){return this.disposeChildViews(),this.el.innerHTML="",this.content=window.document.createElement("DIV"),this.content.classList.add("content"),this.el.appendChild(this.content),this},this.dispose=function(){this.stopListening(),this.disposeChildViews()},this.disposeChildViews=function(){this.childViews&&i.each(this.childViews,function(t){t&&t.dispose()})},this.onGraphUpdate=function(t){return t.path[0]!==this.node.id||"update"!==t.type&&"set"!==t.type?!1:(this.onNodeUpdate(t),!0)},this.onNodeUpdate=function(){},this.onFocus=function(){},this.onBlur=function(){},this.later=function(t){var e=this;window.setTimeout(function(){t.call(e)},0)}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r
},{"substance-application":6,underscore:269}],216:[function(t,e){"use strict";function n(t,e,n,o){i.call(this,e,n,o),this.surface=t,this.__range__=null,this.__el__=null,o&&(o.element&&(this.__getElement__=o.element),o.mapCharPos&&(this.__mapCharPos__=o.mapCharPos))}var i=(t("underscore"),t("substance-document").Component),o=function(t){var e=window.document.createRange();return e.selectNode(t),e};n.Prototype=function(){this.__getElement__=function(){throw new Error("This method is abstract and must be overridden")},this.__mapCharPos__=function(){throw new Error("This method is abstract and must be overridden")},this.mapCharPos=function(t){return this.__mapCharPos__.call(this,t)},this.getElement=function(){return this.el},this.getRange=function(){return this.range}},n.Prototype.prototype=i.prototype,n.prototype=new n.Prototype,Object.defineProperties(n.prototype,{range:{get:function(){return this.__range__||(this.__range__=o(this.el)),this.__range__}},el:{get:function(){if(!this.__el__&&(this.__el__=this.__getElement__.call(this),!this.__el__))throw new Error("You tried to access a component which has not been rendered!");return this.__el__}}}),e.exports=n},{"substance-document":132,underscore:269}],217:[function(t,e){"use strict";e.exports={Model:t("./person_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./person_reference":218}],218:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"location_reference",parent:"annotation",properties:{target:"string"}},i.description={name:"PersonReference",remarks:["References a range in a text-ish node and references a person node."],properties:{}},i.example={id:"person_reference_1",type:"person_reference",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],219:[function(t,e){"use strict";e.exports={Model:t("./publication_info"),View:t("./publication_info_view")}},{"./publication_info":220,"./publication_info_view":221}],220:[function(t,e){var n=(t("underscore"),t("../node/node")),i=t("../license/license"),o=function(t,e){n.call(this,t,e)};o.type={id:"publication_info",parent:"content",properties:{}},o.description={name:"PublicationInfo",remarks:["Describes an article contributor such as an author or editor."],properties:{name:"Full name."}},o.example={id:"publication_info",type:"publication_info",description:"Revising the article, data cleanup"},o.Prototype=function(){this.getLicense=function(){var t=this.document.get("license");return t?t.code:null},this.setLicense=function(t){this.document["delete"]("license"),this.document.create(i.available_licenses[t])}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,o.prototype.defineProperties(),e.exports=o},{"../license/license":204,"../node/node":213,underscore:269}],221:[function(t,e){"use strict";var n=t("underscore"),i=t("../node").View,o=t("substance-application").$$,r=(t("../license").Model,function(t){i.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node publication-info"),this.$el.on("change","#license",n.bind(this.updateLicense,this)),this.$el.on("change","#published_on",n.bind(this.updatePublicationDate,this))});r.Prototype=function(){this.updatePublicationDate=function(){var t=this.$("#published_on");console.log("Published_on",t)},this.updateLicense=function(){var t=this.$("#license").val();this.node.setLicense(t)},this.render=function(){i.prototype.render.call(this);var t=o(".resource-body",{contenteditable:!1}),e={created_at:new Date(this.node.document.created_at).toDateString(),updated_at:jQuery.timeago(new Date(this.node.document.updated_at)),published_on:new Date(this.node.document.published_on).toDateString()},n=o(".project",{children:[o(".label",{text:"Project"}),o(".value",{html:this.node.document.project})]});t.appendChild(n);var r=o(".location",{children:[o(".label",{text:"Location"}),o(".value",{html:this.node.document.location})]});t.appendChild(r);var s=o(".place",{children:[o(".label",{text:"Place"}),o(".value",{html:this.node.document.place})]});t.appendChild(s);var a=o(".place",{children:[o(".label",{text:"Interview type"}),o(".value",{html:"Video"})]});t.appendChild(a);var c=o(".place",{children:[o(".label",{text:"Duration"}),o(".value",{html:this.node.interview_duration})]});t.appendChild(c);var h=o("input#interview_keywords",{style:"width: 300px",children:[]}),u=o(".keywords",{children:[o(".label",{text:"Keywords"}),h]});t.appendChild(u),$(h).select2({tags:["Cat","Dog","Rhinozeros"],placeholder:"Enter keywords"});var l=o(".dates",{html:["This article was created on <b>",e.created_at,"</b> and published on <b>",e.published_on,"</b>. Last update was made ",'<span class="updated-at"><b>'+e.updated_at+"</b></span>."].join("")});return t.appendChild(l),this.content.appendChild(t),this},this.updateModificationDate=function(){var t=jQuery.timeago(new Date(this.node.document.updated_at));this.$(".updated-at").html(t)},this.onGraphUpdate=function(t){return i.prototype.onGraphUpdate.call(this,t)?!0:n.isEqual(t.path,["document","published_on"])?(this.render(),!0):(this.updateModificationDate(),!0)},this.dispose=function(){i.prototype.dispose.call(this)}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,e.exports=r},{"../license":203,"../node":212,"substance-application":6,underscore:269}],222:[function(t,e){"use strict";e.exports={Model:t("./remark"),View:t("./remark_view")}},{"./remark":223,"./remark_view":224}],223:[function(t,e){"use strict";var n=t("../issue/issue"),i=function(t,e){n.call(this,t,e)};i.type={id:"remark",parent:"issue",properties:{}},i.description={name:"Remark",remarks:["References a range in a text-ish node and tags it as emphasized"],properties:{}},i.example={type:"remark",id:"remark_1",title:"Can you explain?",description:"I don't get the argument here."},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../issue/issue":201}],224:[function(t,e){"use strict";var n=t("../issue/issue_view"),i=function(t,e){n.call(this,t,e)};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../issue/issue_view":202}],225:[function(t,e){"use strict";e.exports={Model:t("./remark_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./remark_reference":226}],226:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"remark_reference",parent:"annotation",properties:{target:"remark"}},i.description={name:"RemarkReference",remarks:["References a range in a text-ish node and references a remark"],properties:{target:"Referenced remark id"}},i.example={type:"remark_reference_1",id:"remark_reference_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":146}],227:[function(t,e){"use strict";e.exports={Model:t("./strong"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./strong":228}],228:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"strong",parent:"annotation",properties:{}},i.description={name:"Strong",remarks:["References a range in a text-ish node and tags it as strong emphasized"],properties:{}},i.example={type:"strong",id:"strong_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":146}],229:[function(t,e){"use strict";e.exports={Model:t("./subject_reference"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./subject_reference":230}],230:[function(t,e){"use strict";var n=t("../multi_annotation/multi_annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"subject_reference",parent:"multi_annotation",properties:{target:["array","string"]}},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../multi_annotation/multi_annotation":211}],231:[function(t,e){"use strict";e.exports={Model:t("./subscript"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./subscript":232}],232:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"subscript",parent:"annotation",properties:{}},i.description={name:"Subscript",remarks:["References a range in a text-ish node and tags it as subscript"],properties:{}},i.example={type:"subscript",id:"subscript_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":146}],233:[function(t,e){"use strict";e.exports={Model:t("./superscript"),View:t("../annotation/annotation_view")}},{"../annotation/annotation_view":147,"./superscript":234}],234:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"superscript",parent:"annotation",properties:{}},i.description={name:"Superscript",remarks:["References a range in a text-ish node and tags it as strong emphasized"],properties:{}},i.example={type:"strong",id:"superscript_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":146}],235:[function(t,e){"use strict";e.exports={Model:t("./text_node"),View:t("./text_view"),Surface:t("./text_surface")}},{"./text_node":236,"./text_surface":237,"./text_view":238}],236:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-regexp"),o=t("substance-operator"),r=o.ObjectOperation,s=o.TextOperation,a=t("../node/node"),c=function(t,e){a.call(this,t,e)};c.type={id:"text",parent:"content",properties:{source_id:"string",content:"string"}},c.description={name:"Text",remarks:["A simple text fragement that can be annotated. Usually text nodes are combined in a paragraph."],properties:{source_id:"Text element source id",content:"Content"}},c.example={type:"paragraph",id:"paragraph_1",content:"Lorem ipsum dolor sit amet, adipiscing elit."},c.Prototype=function(){this.getChangePosition=function(t){if("content"===t.path[1]){var e=o.Helpers.last(t.diff);if(e.isInsert())return e.pos+e.getLength();if(e.isDelete())return e.pos}return-1},this.getLength=function(){return this.properties.content.length},this.insertOperation=function(t,e){return r.Update([this.properties.id,"content"],s.Insert(t,e))},this.deleteOperation=function(t,e){var n=this.properties.content;return r.Update([this.properties.id,"content"],s.Delete(t,n.substring(t,e)),"string")},this.prevWord=function(t){var e=this.properties.content,o=new i(/\b\w/g).match(e),r=n.select(o,function(e){return e.index<t},this);return 0===r.length?0:n.last(r).index},this.nextWord=function(t){var e=this.properties.content,n=new i(/\w\b/g).match(e.substring(t));if(0===n.length)return e.length;var o=n[0];return t+o.index+1},this.canJoin=function(t){return t instanceof c},this.join=function(t,e){var i=this.properties.content.length,o=e.content;t.update([this.id,"content"],[i,o]);var r=t.getIndex("annotations").get(e.id);n.each(r,function(e){t.set([e.id,"path"],[this.properties.id,"content"]),t.set([e.id,"range"],[e.range[0]+i,e.range[1]+i])},this)},this.isBreakable=function(){return!0},this["break"]=function(t,e){var i=this.properties.content.substring(e),o=this.toJSON();o.type=this.splitInto?this.splitInto:this.properties.type,o.id=t.uuid(this.properties.type),o.content=i,t.create(o);var r=t.getIndex("annotations").get(this.properties.id);return n.each(r,function(n){n.range[0]>=e&&(t.set([n.id,"path"],[o.id,"content"]),t.set([n.id,"range"],[n.range[0]-e,n.range[1]-e]))}),t.update([this.properties.id,"content"],s.Delete(e,i)),o}},c.Prototype.prototype=a.prototype,c.prototype=new c.Prototype,c.prototype.constructor=c,c.prototype.defineProperties(),e.exports=c},{"../node/node":213,"substance-operator":246,"substance-regexp":255,underscore:269}],237:[function(t,e){"use strict";var n=t("../node/node_surface"),i=t("../node/surface_component"),o=function(t,e,o){n.call(this,t,e),o=o||{};var r=this;if(this.property=o.property||"content",void 0===r.node[r.property])throw new Error("Illegal property",r.node,r.property);o.length=o.length||function(){return r.node[r.property].length};var s=new i(this,o.root||t,[t.id,r.property],o);s.__getElement__=o.property?function(){return r.view.childViews[r.property].el}:function(){return r.view.el},this.components.push(s)};o.Prototype=function(){this.getCharPosition=function(t,e){if(!this.view)throw new Error("No view attached.");if(0===this.view._fragments.length)return 0;if(t===this.view._fragments[0].el.parentElement)return 0===e?0:this.components[0].length;for(var n,i=0;i<this.view._fragments.length;i++){var o=this.view._fragments[i];if(o.el===t){n=o;break}}if(!n)throw console.error("TextSurface.getCharPosition(): Could not lookup text element.",t),new Error("Could not lookup text element.");var r=n.charPos+e;return r},this.getDOMPosition=function(t){if(!this.view)throw new Error("No view attached.");var e=this.view._lookupPostion(t),n=e[0],i=e[1],o=window.document.createRange();return o.setStart(n.el,i),o},this.getComponent=function(){return this.components[0]}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.textProperty=function(t,e,n){n=n||{},n.root=n.root||t.node,n.name=e;var i=t.node;n.path?(i=t.node.document.get(n.path[0]),n.alias=[t.node.id,e]):n.property=e;var r=new o(i,t.surfaceProvider,n),s=r.components[0];return s},e.exports=o},{"../node/node_surface":214,"../node/surface_component":216}],238:[function(t,e){"use strict";function n(t){var e=t.getAnnotationBehavior();if(!e)throw new Error("Missing AnnotationBehavior.");return e}var i,o=t("underscore"),r=t("substance-util").Fragmenter,s=t("substance-document").Annotator,a=t("../node").View,c=0,h=function(t,e,i){a.call(this,t,e,i),i=i||{},this.__id__=c++,this.property=i.property||"content",this.propertyPath=i.propertyPath||[this.node.id,this.property],this.$el.addClass("content-node text"),"text"===t.type&&this.$el.addClass("text-node"),i.property&&(this.$el.removeAttr("id"),this.$el.removeClass("content-node"),this.$el.addClass(i.property)),this.$el.attr("data-path",this.property),this._annotations={},this.annotationBehavior=n(t.document),this._fragments=[]};h.Prototype=function(){var t=a.prototype;this.render=function(e){return t.render.call(this,e),this.renderContent(),this},this.renderContent=function(){this.content.innerHTML="",this._annotations=this.node.document.getIndex("annotations").get(this.propertyPath),this.renderWithAnnotations(this._annotations);var t=window.document.createElement("BR");this.content.appendChild(t);var e=this.getText();0!==e.length||this.__hasFocus||this.content.classList.add("empty")},this.onBlur=function(){var t=this.getText();this.__hasFocus=!1,t&&0!==t.length?this.content.classList.remove("empty"):this.content.classList.add("empty")},this.onFocus=function(){this.__hasFocus=!0,this.content.classList.remove("empty")},this.insert=function(t,e){var n=this._lookupPostion(t),i=n[0],o=i.el,r=n[1],s=o.textContent;s=s.substring(0,r)+e+s.substring(r),o.textContent=s;for(var a=i.index+1;a<this._fragments.length;a++)this._fragments[a].charPos+=e.length},this["delete"]=function(t,e){if(0===e)return void console.log("FIXME: received empty deletion which could be avoided.");var n=this._lookupPostion(t,"delete"),i=n[0],o=i.el,r=n[1],s=o.textContent;if(r+e>s.length)return void this.renderContent();s=s.substring(0,r)+s.substring(r+e),o.textContent=s;for(var a=i.index+1;a<this._fragments.length;a++)this._fragments[a].charPos-=e},this._lookupPostion=function(t,e){for(var n,i,o=0;o<this._fragments.length;o++){if(n=this._fragments[o],i=n.getLength(),i>t)return[n,t];if(!(t>i)){var r=this._fragments[o+1];return r&&r.level<n.level||e?[r,0]:[n,i]}t-=i}return[n,i]},this.onNodeUpdate=function(t){if(o.isEqual(t.path,this.propertyPath))if("update"===t.type){var e=t.diff;if(e.isInsert())return this.insert(e.pos,e.str),!0;if(e.isDelete())return this["delete"](e.pos,e.str.length),!0}else if("set"===t.type)return this.renderContent(),!0;return!1},this.onGraphUpdate=function(e,n,i,r){return r&&r.chronicle?(this.renderContent(),!0):t.onGraphUpdate.call(this,e)?!0:o.isEqual(e.path,this.propertyPath)?(this.onNodeUpdate(e),!0):!s.changesAnnotations(this.node.document,e,this.propertyPath)||"create"!==e.type&&"delete"!==e.type&&"path"!==e.path[1]&&"range"!==e.path[1]?!1:e.data&&e.data.incremental?!1:(this.renderContent(),!0)},this.createAnnotationView=function(t){var e=this.node.document.get(t.id),n=this.viewFactory.getNodeViewClass(e),i=new n(e,this.viewFactory);return i},this.getText=function(){return this.node.document.get(this.propertyPath)},this.renderWithAnnotations=function(t){var e=this,n=this.getText(),i=window.document.createDocumentFragment(),o=new r(this.annotationBehavior.levels);this._fragments=[];var s=null,a=0,c=0,u=0;o.onText=function(t,n){var i=window.document.createTextNode(n);e._fragments.push(new h.DefaultFragment(i,a++,c,u)),c+=n.length,t.appendChild(i)},o.onEnter=function(t,n){s=t,u++;var i=e.createAnnotationView(t);return n.appendChild(i.render().el),i},o.onExit=function(){u--},o.start(i,n,t),this.content.innerHTML="",this.content.appendChild(i)},this.dispose=function(){this.stopListening()}},h.Prototype.prototype=a.prototype,h.prototype=new h.Prototype;var u=function(t,e){for(var n=0;n<e.length;n++)t.unshift(e[n])};i=function(t,e){var n=[];for(u(n,t.childNodes);n.length;){var i=n.shift();if(i.nodeType===window.Node.TEXT_NODE){var o=i.textContent;if(o.length>=e)return[i,e];e-=o.length}else u(n,i.childNodes)}},h.Fragment=function(t,e,n,i){this.el=t,this.index=e,this.charPos=n,this.level=i},h.Fragment.Prototype=function(){this.getLength=function(){throw new Error("This method is abstract")}},h.Fragment.prototype=new h.Fragment.Prototype,h.DefaultFragment=function(){h.Fragment.apply(this,arguments)},h.DefaultFragment.Prototype=function(){this.getLength=function(){return this.el.length}},h.DefaultFragment.Prototype.prototype=h.Fragment.prototype,h.DefaultFragment.prototype=new h.DefaultFragment.Prototype,e.exports=h},{"../node":212,"substance-document":132,"substance-util":264,underscore:269}],239:[function(t,e){"use strict";e.exports={Model:t("./video")}},{"./video":240}],240:[function(t,e){"use strict";var n=t("../node/node"),i=t("underscore"),o=function(t,e){n.call(this,t,e)};o.type={id:"video",parent:"content",properties:{poster:["file"],files:["array","file"],caption:"paragraph"}},o.description={name:"Video",remarks:["A web video."],properties:{poster:"Video placeholder",files:"An array of different video files (MP4, OGV)",caption:"A reference to a paragraph that describes the video"}},o.example={id:"video",label:"Video",files:["video1.mp4"],caption:"text_1"},o.Prototype=function(){this.hasCaption=function(){return!!this.properties.caption},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0},this.getVideoFiles=function(){return i.map(this.properties.files,function(t){return this.document.get(t)},this)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,o.prototype.defineProperties(),e.exports=o},{"../node/node":213,underscore:269}],241:[function(t,e){"use strict";e.exports={Model:t("./web_page")}},{"./web_page":242}],242:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"webpage",parent:"content",properties:{file:"file",width:"string",height:"string",caption:"paragraph"}},i.description={name:"WebPage",remarks:["A webpage wraps an HTML site."],properties:{file:"File id that has the html",caption:"A reference to a paragraph that describes the figure"}},i.example={id:"web_page",label:"Webpage",file:"web_page_1.html",caption:"text_1"},i.Prototype=function(){this.hasCaption=function(){return!!this.properties.caption},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0},this.getHTML=function(){if(!this.properties.file)return"";var t=this.document.get(this.properties.file);return t?t.getData():""}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213}],243:[function(t,e){"use strict";e.exports={Model:t("./web_resource"),View:t("./web_resource_view")}},{"./web_resource":244,"./web_resource_view":245}],244:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"webresource",properties:{title:"string",description:"string",url:"string"}},i.description={name:"WebResource",remarks:["A WebResource"],properties:{title:"Webpage title",description:"More verbose WebResource description, if available",url:"WebResource URL"}},i.example={"abstract":"type"},i.Prototype=function(){this.hasDescription=function(){return!!this.properties.caption},this.getDescription=function(){return this.properties.description?this.document.get(this.properties.description):void 0},this.getReferences=function(){var t=this.document.getIndex("references");return t?t.get(this.properties.id):(console.error("No index for references."),[])}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":213}],245:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node/node_view"),o=t("../text/text_view"),r=function(t,e){i.call(this,t,e),this.$el.addClass("web-resource")};r.Prototype=function(){var t=i.prototype;this._updateTitle=function(){console.log("updating.."),this.titleTextEl.innerHTML=this.ref?this.ref.getContent():""},this.render=function(){i.prototype.render.call(this);var t=n("div.issue-title-wrapper");this.titleTextEl=n(".text.title",{children:[n("span.title-annotation",{text:"meeh"})]}),t.appendChild(this.titleTextEl),this.urlView=new o(this.node,this.viewFactory,{property:"url"}),this.content.appendChild(this.urlView.render().el),this.descriptionView=new o(this.node,this.viewFactory,{property:"description"}),this.content.appendChild(this.descriptionView.render().el);var e=this.node.getReferences(),r=Object.keys(e);return r.length>0&&(this.ref=e[r[0]],this._updateTitle()),this},this.dispose=function(){i.prototype.dispose.call(this),this.descriptionView.dispose()},this.onNodeUpdate=function(t){return"description"===t.path[1]?(this.descriptionView.onNodeUpdate(t),!0):!1},this.onGraphUpdate=function(e){return t.onGraphUpdate.call(this,e)?!0:"create"===e.type&&e.val.target===this.node.id?(this.ref=this.node.document.get(e.val.id),this._updateTitle(),!0):"delete"===e.type&&e.val.target===this.node.id?(this.ref=null,this._updateTitle(),!0):this.ref&&e.path[0]===this.ref.id?(this._updateTitle(),!0):!1}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node/node_view":215,"../text/text_view":238,"substance-application":6}],246:[function(t,e){"use strict";e.exports={Operation:t("./src/operation"),Compound:t("./src/compound"),ArrayOperation:t("./src/array_operation"),TextOperation:t("./src/text_operation"),ObjectOperation:t("./src/object_operation"),Helpers:t("./src/operation_helpers")}},{"./src/array_operation":247,"./src/compound":248,"./src/object_operation":249,"./src/operation":250,"./src/operation_helpers":251,"./src/text_operation":252}],247:[function(t,e){"use strict";function n(t,e,n){t.pos===e.pos?n?e.pos+=1:t.pos+=1:t.pos<e.pos?e.pos+=1:t.pos+=1}function i(t,e){return t.pos===e.pos?(e.type=p,void(t.type=p)):void(t.pos<e.pos?e.pos-=1:t.pos-=1)}function o(t,e){if(t.type===d){var n=t;t=e,e=n}t.pos<=e.pos?e.pos+=1:t.pos-=1}function r(t,e,n,i){if(t.type!==g)return r(e,t,n,!i);var o={type:d,pos:t.pos},s={type:f,pos:t.target},a={inplace:!0,check:n};e.type===d&&t.pos===e.pos?(t.type=p,e.pos=t.target):e.type===g&&t.pos===e.pos?i?(e.pos=t.target,t.type=p):(t.pos=e.target,e.type=p):(i?(x(o,e,a),x(s,e,a)):(x(e,o,a),x(e,s,a)),t.pos=o.pos,t.target=s.pos)}var s,a=t("underscore"),c=t("substance-util"),h=c.errors,u=t("./operation"),l=t("./compound"),p="NOP",d="delete",f="insert",g="move",v=function(t){if(void 0===t.type)throw new h.OperationError("Illegal argument: insufficient data.");if(this.type=t.type,this.type!==p){if(this.pos=t.pos,this.val=t.val,this.target=t.target,this.type!==p&&this.type!==f&&this.type!==d&&this.type!==g)throw new h.OperationError("Illegal type.");if(this.type===f||this.type===d){if(void 0===this.pos||void 0===this.val)throw new h.OperationError("Illegal argument: insufficient data.");if(!a.isNumber(this.pos)&&this.pos<0)throw new h.OperationError("Illegal argument: expecting positive number as pos.")}else if(this.type===g){if(void 0===this.pos||void 0===this.target)throw new h.OperationError("Illegal argument: insufficient data.");if(!a.isNumber(this.pos)&&this.pos<0)throw new h.OperationError("Illegal argument: expecting positive number as pos.");if(!a.isNumber(this.target)&&this.target<0)throw new h.OperationError("Illegal argument: expecting positive number as target.")}}};v.fromJSON=function(t){if(a.isArray(t))return t[0]===g?new s(t[1],t[2]):new v(t);if(t.type===g)return s.fromJSON(t);if(t.type===l.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(v.fromJSON(t.ops[n]));return v.Compound(e,t.data)}return new v(t)},v.Prototype=function(){this.clone=function(){return new v(this)},this.apply=function(t){if(this.type===p)return t;var e=t instanceof v.ArrayAdapter?t:new v.ArrayAdapter(t);if(this.type===f)e.insert(this.pos,this.val);else{if(this.type!==d)throw new h.OperationError("Illegal state.");e["delete"](this.pos,this.val)}return t},this.invert=function(){var t=this.toJSON();if(this.type===f)t.type=d;else if(this.type===d)t.type=f;else{if(this.type!==p)throw new h.OperationError("Illegal state.");t.type=p}return new v(t)},this.hasConflict=function(t){return v.hasConflict(this,t)},this.toJSON=function(){var t={type:this.type};return this.type===p?t:(t.pos=this.pos,t.val=this.val,t)},this.isInsert=function(){return this.type===f},this.isDelete=function(){return this.type===d},this.isNOP=function(){return this.type===p},this.isMove=function(){return this.type===g}},v.Prototype.prototype=u.prototype,v.prototype=new v.Prototype;var y=0,m=1,w=2,_=4,b={};b[p]=y,b[d]=m,b[f]=w,b[g]=_;var C=[];C[m|m]=function(t,e){return t.pos===e.pos},C[m|w]=function(){return!1},C[w|w]=function(t,e){return t.pos===e.pos};var x,P=function(t,e){if(t.type===p||e.type===p)return!1;var n=b[t.type]|b[e.type];return C[n]?C[n](t,e):!1};x=function(t,e,s){if(s=s||{},s.check&&P(t,e))throw u.conflict(t,e);return s.inplace||(t=c.clone(t),e=c.clone(e)),t.type===p||e.type===p||(t.type===f&&e.type===f?n(t,e,!0):t.type===d&&e.type===d?i(t,e,!0):t.type===g||e.type===g?r(t,e,s.check,!0):o(t,e,!0)),[t,e]};var E=function(t,e){return a.isArray(t)?t=t[0]===g?new s(t[1],t[2]):new v(t):t instanceof v||(t=v.fromJSON(t)),t.apply(e)};v.transform=l.createTransform(x),v.hasConflict=P,v.perform=E,v.apply=E;var s=function(t,e){if(this.type=g,this.pos=t,this.target=e,!a.isNumber(this.pos)||!a.isNumber(this.target)||this.pos<0||this.target<0)throw new h.OperationError("Illegal argument")};s.Prototype=function(){this.clone=function(){return new s(this.pos,this.target)},this.apply=function(t){if(this.type===p)return t;var e=t instanceof v.ArrayAdapter?t:new v.ArrayAdapter(t),n=t[this.pos];return e.move(n,this.pos,this.target),t},this.invert=function(){return new s(this.target,this.pos)},this.toJSON=function(){return{type:g,pos:this.pos,target:this.target}}},s.Prototype.prototype=v.prototype,s.prototype=new s.Prototype,s.fromJSON=function(t){return new s(t.pos,t.target)};var k=function(t,e){var n,i,o=[0];for(n=0;n<t.length;n++)for(i=0;i<e.length;i++)o[i+1]=o[i+1]||0,o[i+1]=a.isEqual(t[n],e[i])?Math.max(o[i+1],o[i]+1):Math.max(o[i+1],o[i]);var r=[];for(i=e.length;i>=0;i--)o[i]>o[i-1]&&r.unshift(e[i-1]);return r};v.Insert=function(t,e){return new v({type:f,pos:t,val:e})},v.Delete=function(t,e){var n=t;return a.isArray(n)&&(n=n.indexOf(e)),new v(0>n?{type:p}:{type:d,pos:n,val:e})},v.Move=function(t,e){return new s(t,e)},v.Push=function(t,e){var n=t.length;return v.Insert(n,e)},v.Pop=function(t){var e=t.length-1;return v.Delete(e,t[e])},v.Update=function(t,e){var n,i,o,r=k(t,e),s=r,a=t,c=e;for(n=0,i=0,o=0,r=[];i<a.length||o<c.length;)s[n]===a[i]&&a[i]===c[o]?(n++,i++,o++,r.push(1)):r.push(s[n]===a[i]?["+",c[o++]]:["-",a[i++]]);return v.Sequence(r)},v.Compound=function(t,e){return 1!==t.length||e?new l(t,e):t[0]},v.Clear=function(t){for(var e=[],n=0;n<t.length;n++)e.push(v.Delete(0,t[n]));return v.Compound(e)},v.Sequence=function(t){for(var e=0,n=[],i=0;i<t.length;i++){var o=t[i];if(a.isNumber(o)&&o>0)e+=o;else if("+"===o[0])n.push(v.Insert(e,o[1])),e+=1;else{if("-"!==o[0])throw new h.OperationError("Illegal operation.");n.push(v.Delete(e,o[1]))}}return new l(n)},v.create=function(t,e){var n,i,o=e[0];if(o===f||"+"===o)return i=e[1],n=e[2],v.Insert(i,n);if(o===d||"-"===o)return i=e[1],n=t[i],v.Delete(i,n);if(o===g||">>"===o){i=e[1];var r=e[2];return v.Move(i,r)}throw new h.OperationError("Illegal specification.")};var S=function(t){this.array=t};S.prototype={insert:function(t,e){if(this.array.length<t)throw new h.OperationError("Provided array is too small.");this.array.splice(t,0,e)},"delete":function(t,e){if(this.array.length<t)throw new h.OperationError("Provided array is too small.");if(!a.isEqual(this.array[t],e))throw new h.OperationError("Unexpected value at position "+t+". Expected "+e+", found "+this.array[t]);this.array.splice(t,1)},move:function(t,e,n){if(this.array.length<e)throw new h.OperationError("Provided array is too small.");if(this.array.splice(e,1),this.array.length<n)throw new h.OperationError("Provided array is too small.");this.array.splice(n,0,t)}},v.ArrayAdapter=S,v.NOP=p,v.DELETE=d,v.INSERT=f,v.MOVE=g,e.exports=v},{"./compound":248,"./operation":250,"substance-util":264,underscore:269}],248:[function(t,e){"use strict";var n=t("substance-util"),i=t("./operation"),o="compound",r=function(t,e){if(this.type=o,this.ops=t,this.alias=void 0,this.data=e,!t||0===t.length)throw new i.OperationError("No operations given.")};r.Prototype=function(){this.clone=function(){for(var t=[],e=0;e<this.ops.length;e++)t.push(n.clone(this.ops[e]));return new r(t,n.clone(this.data))},this.apply=function(t){for(var e=0;e<this.ops.length;e++)t=this.ops[e].apply(t);return t},this.invert=function(){for(var t=[],e=0;e<this.ops.length;e++)t.unshift(this.ops[e].invert());return new r(t,this.data)},this.toJSON=function(){var t={type:o,ops:this.ops};return this.alias&&(t.alias=this.alias),this.data&&(t.data=this.data),t}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,r.TYPE=o;var s=function(t,e,n,i,r){var a;if(e.type===o)for(a=0;a<e.ops.length;a++)s(t,e.ops[a],n,i,r);else for(a=0;a<t.ops.length;a++){var c,h;n?(c=t.ops[a],h=e):(c=e,h=t.ops[a]),r(c,h,{inplace:!0,check:i})}};r.createTransform=function(t){return function(e,i,r){return r=r||{},e.type===o||i.type===o?(r.inplace||(e=n.clone(e),i=n.clone(i)),e.type===o?s(e,i,!0,r.check,t):i.type===o&&s(i,e,!1,r.check,t),[e,i]):t(e,i,r)}},e.exports=r},{"./operation":250,"substance-util":264}],249:[function(t,e){"use strict";function n(t){return t instanceof a?n(t.ops[0]):t instanceof c?"string":t instanceof h?"array":"other"}var i=t("underscore"),o=t("substance-util"),r=o.errors,s=t("./operation"),a=t("./compound"),c=t("./text_operation"),h=t("./array_operation"),u="NOP",l="create",p="delete",d="update",f="set",g=function(t){if(this.type=t.type,this.path=t.path,this.type===l||this.type===p)this.val=t.val;
else if(this.type===d){if(void 0===t.diff)throw new r.OperationError("Illegal argument: update by value or by diff must be provided");this.diff=t.diff,this.propertyType=t.propertyType}else this.type===f&&(this.val=t.val,this.original=t.original);this.data=t.data};g.fromJSON=function(t){if(t.type===a.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(g.fromJSON(t.ops[n]));return g.Compound(e,t.data)}var i=new g(t);if("update"===t.type)switch(t.propertyType){case"string":i.diff=c.fromJSON(i.diff);break;case"array":i.diff=h.fromJSON(i.diff);break;default:throw new Error("Don't know how to deserialize this operation:"+JSON.stringify(t))}return i},g.Prototype=function(){this.clone=function(){return new g(this)},this.isNOP=function(){return this.type===u?!0:this.type===d?this.diff.isNOP():void 0},this.apply=function(t){if(this.type===u)return t;var e=t instanceof g.Object?t:new g.Object(t);if(this.type===l)return e.create(this.path,o.clone(this.val)),t;var n=e.get(this.path);if(this.type===p){if(void 0===n)throw new r.OperationError("Property "+JSON.stringify(this.path)+" not found.");e["delete"](this.path,n)}else if(this.type===d)if("object"===this.propertyType)n=g.apply(this.diff,n),e.inplace()||e.update(this.path,n,this.diff);else if("array"===this.propertyType)n=h.apply(this.diff,n),e.inplace()||e.update(this.path,n,this.diff);else{if("string"!==this.propertyType)throw new r.OperationError("Unsupported type for operational update.");n=c.apply(this.diff,n),e.update(this.path,n,this.diff)}else{if(this.type!==f)throw new r.OperationError("Illegal state.");e.set(this.path,o.clone(this.val))}return t},this.invert=function(){if(this.type===u)return{type:u};var t=new g(this);if(this.type===l)t.type=p;else if(this.type===p)t.type=l;else if(this.type===d){var e;"string"===this.propertyType?e=c.fromJSON(this.diff).invert():"array"===this.propertyType&&(e=h.fromJSON(this.diff).invert()),t.diff=e,t.propertyType=this.propertyType}else{if(this.type!==f)throw new r.OperationError("Illegal state.");t.val=this.original,t.original=this.val}return t},this.hasConflict=function(t){return g.hasConflict(this,t)},this.toJSON=function(){if(this.type===u)return{type:u};var t={type:this.type,path:this.path,data:this.data};return this.type===l||this.type===p?t.val=this.val:this.type===d?(t.diff=this.diff,t.propertyType=this.propertyType):this.type===f&&(t.val=this.val,t.original=this.original),t}},g.Prototype.prototype=s.prototype,g.prototype=new g.Prototype,g.Object=function(t){this.obj=t},g.Object.Prototype=function(){function t(t,e,n,i){for(var o=e,r=0;r<n.length-1;r++){if(void 0===o)throw new Error("Key error: could not find element for path "+JSON.stringify(t.path));void 0===o[n[r]]&&i&&(o[n[r]]={}),o=o[n[r]]}return{parent:o,key:n[r]}}this.get=function(e){var n=t(this,this.obj,e);return n.parent[n.key]},this.create=function(e,n){var i=t(this,this.obj,e,!0);if(void 0!==i.parent[i.key])throw new r.OperationError("Value already exists. path ="+JSON.stringify(e));i.parent[i.key]=n},this.update=function(t,e){this.set(t,e)},this.set=function(e,n){var i=t(this,this.obj,e);i.parent[i.key]=n},this["delete"]=function(e){var n=t(this,this.obj,e);delete n.parent[n.key]},this.inplace=function(){return!0}},g.Object.prototype=new g.Object.Prototype;var v=function(t,e){return t.type===u||e.type===u?!1:i.isEqual(t.path,e.path)},y=function(t,e){t.type=u,e.type=u},m=function(){throw new r.OperationError("Can not transform two concurring creates of the same property")},w=function(t,e,n){return t.type!==p?w(e,t,!0):void(n?(t.val=e.val,e.type=u):t.type=u)},_=function(t,e,n){if(t.type!==p)return _(e,t,!0);var i;"string"===e.propertyType?i=c.fromJSON(e.diff):"array"===e.propertyType&&(i=h.fromJSON(e.diff)),n?(t.val=i.apply(t.val),e.type=u):(t.type=u,e.type=l,e.val=i.apply(t.val))},b=function(){throw new r.OperationError("Can not transform a concurring create and update of the same property")},C=function(t,e){var n,i,o;"string"===e.propertyType?(n=c.fromJSON(t.diff),i=c.fromJSON(e.diff),o=c.transform(n,i,{inplace:!0})):"array"===e.propertyType?(n=h.fromJSON(t.diff),i=h.fromJSON(e.diff),o=h.transform(n,i,{inplace:!0})):"object"===e.propertyType&&(n=g.fromJSON(t.diff),i=g.fromJSON(e.diff),o=g.transform(n,i,{inplace:!0})),t.diff=o[0],e.diff=o[1]},x=function(t,e,n){return t.type!==l?x(e,t,!0):void(n?(t.type=f,t.original=e.val,e.type=u):(t.type=u,e.original=t.val))},P=function(t,e,n){return t.type!==p?P(e,t,!0):void(n?(t.val=e.val,e.type=u):(t.type=u,e.type=l,e.original=void 0))},E=function(){throw new r.OperationError("Can not transform update/set of the same property.")},k=function(t,e){t.type=u,e.original=t.val},S=0,T=1,N=2,O=4,A=8,V={};V[u]=S,V[l]=T,V[p]=N,V[d]=O,V[f]=A;var I=[];I[N|N]=y,I[N|T]=w,I[N|O]=_,I[T|T]=m,I[T|O]=b,I[O|O]=C,I[T|A]=x,I[N|A]=P,I[O|A]=E,I[A|A]=k;var D=function(t,e,n){n=n||{};var i=v(t,e);if(n.check&&i)throw s.conflict(t,e);return n.inplace||(t=o.clone(t),e=o.clone(e)),i?(I[V[t.type]|V[e.type]](t,e),[t,e]):[t,e]};g.transform=a.createTransform(D),g.hasConflict=v;var j=function(t,e){return t instanceof g||(t=g.fromJSON(t)),t.apply(e)};g.apply=j,g.Create=function(t,e){return new g({type:l,path:t,val:e})},g.Delete=function(t,e){return new g({type:p,path:t,val:e})},g.Update=function(t,e,i){return i=i||n(e),new g({type:d,path:t,diff:e,propertyType:i})},g.Set=function(t,e,n){return new g({type:f,path:t,val:o.clone(n),original:o.clone(e)})},g.Compound=function(t,e){return 0===t.length?null:new a(t,e)};var R=function(t,e,n,o,s,a){for(var c=Object.getOwnPropertyNames(e),h=0;h<c.length;h++){var u=c[h],l=n.concat(u);if(void 0===e[u]&&void 0!==t[u])o.push(g.Delete(l,t[u]));else if(i.isObject(e[u])){if(!i.isObject(t[u]))throw new r.OperationError("Incompatible arguments: newVals must have same structure as obj.");R(t[u],e[u],l,o,s,a)}else if(void 0===t[u])s.push(g.Create(l,e[u]));else{var p=t[u],d=e[u];i.isEqual(p,d)||a.push(g.Set(l,p,d))}}};g.Extend=function(t,e){var n=[],i=[],o=[];return R(t,e,[],n,i,o),g.Compound(n.concat(i).concat(o))},g.NOP=u,g.CREATE=l,g.DELETE=p,g.UPDATE=d,g.SET=f,e.exports=g},{"./array_operation":247,"./compound":248,"./operation":250,"./text_operation":252,"substance-util":264,underscore:269}],250:[function(t,e){"use strict";var n=t("substance-util"),i=n.errors,o=i.define("OperationError",-1),r=i.define("Conflict",-1),s=function(){};s.Prototype=function(){this.clone=function(){throw new Error("Not implemented.")},this.apply=function(){throw new Error("Not implemented.")},this.invert=function(){throw new Error("Not implemented.")},this.hasConflict=function(){throw new Error("Not implemented.")}},s.prototype=new s.Prototype,s.conflict=function(t,e){var n=new i.Conflict("Conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e));return n.a=t,n.b=e,n},s.OperationError=o,s.Conflict=r,e.exports=s},{"substance-util":264}],251:[function(t,e){"use strict";var n=t("./text_operation"),i=t("./array_operation"),o={};o.last=function(t){return"compound"===t.type?t.ops[t.ops.length-1]:t},o.each=function(t,e,n,i){if("compound"===t.type){for(var r=t.ops.length,s=0;r>s;s++){var a=t.ops[s];if(i&&(a=t.ops[r-s-1]),"compound"===a.type){if(o.each(a,e,n,i)===!1)return!1}else if(e.call(n,a)===!1)return!1}return!0}return e.call(n,t)},o.invert=function(t,e){switch(e){case"string":return n.fromJSON(t).invert();case"array":return i.fromJSON(t).invert();default:throw new Error("Don't know how to invert this operation.")}},o.flatten=function(t){var e=[];for(t=t.slice(0);t.length>0;){var n=t.shift();"compound"!==n.type?e.push(n):t=[].concat(n.ops,t)}return e},e.exports=o},{"./array_operation":247,"./text_operation":252}],252:[function(t,e){"use strict";function n(t,e,n){t.pos===e.pos?n?e.pos+=t.str.length:t.pos+=e.str.length:t.pos<e.pos?e.pos+=t.str.length:t.pos+=e.str.length}function i(t,e,n){if(t.pos>e.pos)return i(e,t,!n);if(t.pos===e.pos&&t.str.length>e.str.length)return i(e,t,!n);if(e.pos<t.pos+t.str.length){var o=e.pos-t.pos,r=t.str.length-o,s=o+e.str.length;t.str=t.str.slice(0,o)+t.str.slice(s),e.str=e.str.slice(r),e.pos-=o}else e.pos-=t.str.length}function o(t,e){if(t.type===l)return o(e,t);if(t.pos<=e.pos)e.pos+=t.str.length;else if(t.pos>=e.pos+e.str.length)t.pos-=e.str.length;else{var n=t.pos-e.pos;e.str=e.str.slice(0,n)+t.str+e.str.slice(n),t.str=""}}var r=t("underscore"),s=t("substance-util"),a=s.errors,c=t("./operation"),h=t("./compound"),u="+",l="-",p=function(t){if(r.isArray(t)&&(t={type:t[0],pos:t[1],str:t[2]}),void 0===t.type||void 0===t.pos||void 0===t.str)throw new a.OperationError("Illegal argument: insufficient data.");if(this.type=t.type,this.pos=t.pos,this.str=t.str,!this.isInsert()&&!this.isDelete())throw new a.OperationError("Illegal type.");if(!r.isString(this.str))throw new a.OperationError("Illegal argument: expecting string.");if(!r.isNumber(this.pos)&&this.pos<0)throw new a.OperationError("Illegal argument: expecting positive number as pos.")};p.fromJSON=function(t){if(t.type===h.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(p.fromJSON(t.ops[n]));return p.Compound(e,t.data)}return new p(t)},p.Prototype=function(){this.clone=function(){return new p(this)},this.isNOP=function(){return"NOP"===this.type||0===this.str.length},this.isInsert=function(){return this.type===u},this.isDelete=function(){return this.type===l},this.getLength=function(){return this.str.length},this.apply=function(t){if(this.isEmpty())return t;var e=t instanceof p.StringAdapter?t:new p.StringAdapter(t);if(this.type===u)e.insert(this.pos,this.str);else{if(this.type!==l)throw new a.OperationError("Illegal operation type: "+this.type);e["delete"](this.pos,this.str.length)}return e.get()},this.invert=function(){var t={type:this.isInsert()?"-":"+",pos:this.pos,str:this.str};return new p(t)},this.hasConflict=function(t){return p.hasConflict(this,t)},this.isEmpty=function(){return 0===this.str.length},this.toJSON=function(){return{type:this.type,pos:this.pos,str:this.str}}},p.Prototype.prototype=c.prototype,p.prototype=new p.Prototype;var d=function(t,e){if(t.type===u&&e.type===u)return t.pos===e.pos;if(t.type===l&&e.type===l)return!(t.pos>=e.pos+e.str.length||e.pos>=t.pos+t.str.length);var n,i;return t.type===l?(n=t,i=e):(n=e,i=t),i.pos>=n.pos&&i.pos<n.pos+n.str.length},f=function(t,e,r){if(r=r||{},r.check&&d(t,e))throw c.conflict(t,e);return r.inplace||(t=s.clone(t),e=s.clone(e)),t.type===u&&e.type===u?n(t,e,!0):t.type===l&&e.type===l?i(t,e,!0):o(t,e),[t,e]},g=function(t,e){return r.isArray(t)?t=new p(t):t instanceof p||(t=p.fromJSON(t)),t.apply(e)};p.transform=h.createTransform(f),p.apply=g;var v=function(t){this.str=t};v.prototype={insert:function(t,e){if(this.str.length<t)throw new a.OperationError("Provided string is too short.");this.str=this.str.slice(0,t)+e+this.str.slice(t)},"delete":function(t,e){if(this.str.length<t+e)throw new a.OperationError("Provided string is too short.");this.str=this.str.slice(0,t)+this.str.slice(t+e)},get:function(){return this.str}},p.Insert=function(t,e){return new p(["+",t,e])},p.Delete=function(t,e){return new p(["-",t,e])},p.Compound=function(t,e){return 1!==t.length||e?new h(t,e):t[0]},p.fromOT=function(t,e){var n=[],i=0,o=0;return r.isArray(e)||(e=r.toArray(arguments).slice(1)),r.each(e,function(e){if(r.isString(e))n.push(p.Insert(o,e)),o+=e.length;else if(0>e){var s=-e;n.push(p.Delete(o,t.slice(i,i+s))),i+=s}else i+=e,o+=e}),0===n.length?null:p.Compound(n)},p.fromSequence=p.fromOT;var y=function(t){r.isArray(t)?(this.start=t[0],this.length=t[1]):(this.start=t.start,this.length=t.length)},m=function(t,e,n,i){var o=!1;{if(e.type!==h.TYPE){var s,a;if(r.isArray(t)?(s=t[0],a=t[1]):(s=t.start,a=s+t.length),e.type===l){var c=e.pos,p=e.pos+e.str.length;s>=c&&(s-=Math.min(p-c,s-c),o=!0),a>=c&&(a-=Math.min(p-c,a-c),o=!0)}else if(e.type===u){var d=e.pos,f=e.str.length;(s>d||d===s&&!n)&&(s+=f,o=!0),(a>d||d===a&&i)&&(a+=f,o=!0)}return o&&(r.isArray(t)?(t[0]=s,t[1]=a):(t.start=s,t.length=a-s)),o}for(var g=0;g<e.ops.length;g++){var v=e.ops[g];m(t,v)}}};y.Prototype=function(){this.clone=function(){return new y(this)},this.toJSON=function(){var t={start:this.start,length:this.length};return t},this.transform=function(t,e){return m(this.range,t,e)}},y.prototype=new y.Prototype,y.transform=function(t,e,n,i){return m(t,e,n,i)},y.fromJSON=function(t){return new y(t)},p.StringAdapter=v,p.Range=y,p.INSERT=u,p.DELETE=l,e.exports=p},{"./compound":248,"./operation":250,"substance-util":264,underscore:269}],253:[function(t,e){"use strict";var n=t("./outline");e.exports=n},{"./outline":254}],254:[function(t,e){"use strict";var n=t("underscore"),i=window.$,o=t("substance-application").View,r=t("substance-application").$$,s=function(t){o.call(this),this.surface=t,this.state={selectedNode:null,highlightedNodes:[]},this.$el.addClass("lens-outline"),n.bindAll(this,"mouseDown","mouseUp","mouseMove","updateVisibleArea"),this.$el.mousedown(this.mouseDown),i(window).mousemove(this.mouseMove),i(window).mouseup(this.mouseUp)};s.Prototype=function(){this.render=function(){var t=this,e=window.document.createDocumentFragment();this.visibleArea=r(".visible-area"),e.appendChild(this.visibleArea);var n=this.surface.$(".nodes").height(),i=this.surface.$el.height(),o=n/i;if(this.factor=o,i>=n)return this.$el.addClass("needless"),this.el.innerHTML="",this;var s=t.surface.$el.scrollTop();return t.el.innerHTML="",t.el.appendChild(e),t.updateVisibleArea(s),this},this.updateVisibleArea=function(t){var e=this.surface.$el.height()/this.factor;i(this.visibleArea).css({top:t/this.factor,height:Math.max(e,20)})},this.update=function(t){this.render(),n.extend(this.state,t);var e=t.selectedNodes||[t.selectedNode];this.$(".node").removeClass("selected").removeClass("highlighted"),this.$el.removeClass("figures").removeClass("citations").removeClass("errors").removeClass("remarks").removeClass("links").removeClass("citations"),this.$el.addClass(t.context),n.each(e,function(t){this.$("#outline_"+t).addClass("selected")},this),n.each(t.highlightedNodes,function(t){this.$("#outline_"+t).addClass("highlighted")},this)},this.mouseDown=function(t){this._mouseDown=!0;var e=t.pageY;t.target!==this.visibleArea?(this.offset=i(this.visibleArea).height()/2,this.mouseMove(t)):this.offset=e-i(this.visibleArea).position().top,t.preventDefault(),t.stopPropagation()},this.mouseUp=function(){this._mouseDown=!1},this.mouseMove=function(t){if(this._mouseDown){var e=t.pageY,n=(e-this.offset)*this.factor;this.surface.$el.scrollTop(n)}}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":6,underscore:269}],255:[function(t,e){"use strict";e.exports=t("./src/regexp")},{"./src/regexp":256}],256:[function(t,e){"use strict";var n=function(t){this.index=t.index,this.match=[];for(var e=0;e<t.length;e++)this.match.push(t[e])};n.Prototype=function(){this.captures=function(){return this.match.slice(1)},this.toString=function(){return this.match[0]}},n.prototype=new n.Prototype;var i=function(t){this.exp=t};i.Prototype=function(){this.match=function(t){if(void 0===t)throw new Error("No string given");if(this.exp.global){var e,i=[];for(this.exp.compile(this.exp);null!==(e=this.exp.exec(t));)i.push(new n(e));return i}return this.exp.exec(t)}},i.prototype=new i.Prototype,i.Match=n,e.exports=i},{}],257:[function(t,e){"use strict";var n=t("./src/surface");n.SurfaceController=t("./src/surface_controller"),n.EditableSurface=t("./src/editable_surface"),n.EditorController=t("./src/editor_controller"),e.exports=n},{"./src/editable_surface":258,"./src/editor_controller":259,"./src/surface":260,"./src/surface_controller":261}],258:[function(t,e){"use strict";var n,i=t("substance-util"),o=t("./surface"),r=t("substance-commander").ChromeKeyboard,n=window.MutationObserver;window.MutationObserver?n=window.MutationObserver:window.WebKitMutationObserver&&(n=window.WebKitMutationObserver);var s=0,a=function(t,e,n){o.call(this,t,e),this.__id__=s++,n=n||{};var i=n.keymap;i||console.error("WARNING: no keymap specified."),this.keyboard=new r(i),this.editorCtrl=t,this.el.spellcheck=!1,this._domChanges=[],this._hasDeadKey=!1,this._initEditor(n),this.activate()};a.Prototype=function(){var t=this.dispose;this.dispose=function(){t.call(this),this.deactivate()},this.revertDOMChanges=function(){var t=this._domChanges[0];t.el.textContent=t.oldValue,this._domChanges=[]},this.onTextInput=function(t){var e=this,n=t.data;if(t.data||!e._hasDeadKey){if(t.data){e._hasDeadKey&&(e._hasDeadKey=!1,e.revertDOMChanges(),e.renderSelection());try{e.updateSelection(),e.editorCtrl.write(n)}catch(i){e.editorCtrl.trigger("error",i)}e._domChanges=[]}e._domChanges=[],t.preventDefault(),t.stopPropagation()}},this._initEditor=function(t){var e=this,o=this.keyboard,r=this.editorCtrl;this._onModelSelectionChanged=this.onModelSelectionChanged.bind(this),this._onTextInput=this.onTextInput.bind(this),t.registerBindings&&t.registerBindings(this,o,r),o.setDefaultHandler("keypress",function(t){try{r.write(String.fromCharCode(t.which))}catch(e){r.trigger("error",e),i.printStackTrace(e)}t.preventDefault(),t.stopPropagation()}),o.setDefaultHandler("keyup",function(t){t.preventDefault(),t.stopPropagation(),e._domChanges=[]}),o.bind("special","keydown",function(){e._hasDeadKey||(e._hasDeadKey=!0,e._domChanges=[])}),this._mutationObserver=new n(function(t){e._hasDeadKey&&t.forEach(function(t){var n={mutation:t,el:t.target,value:t.target.textContent,oldValue:t.oldValue};e._domChanges.push(n)})}),this._onMouseup=this.onMouseup.bind(this),this._onMousedown=this.onMousedown.bind(this),o.pass("selection"),o.bind("selection","keydown",function(){window.setTimeout(function(){e.updateSelection()})})},this.onMousedown=function(t){t.target.isContentEditable&&(this.__selecting=!0)},this.onMouseup=function(t){if(this.__selecting){this.__selecting=!1;var e=this;window.setTimeout(function(){e.updateSelection(t)}),t.stopPropagation()}},this.onModelSelectionChanged=function(t,e){this.renderSelection(t,e)},this.activate=function(){var t=this.el;this.editorCtrl.session.selection.on("selection:changed",this._onModelSelectionChanged),t.addEventListener("mousedown",this._onMousedown,!1),window.document.addEventListener("mouseup",this._onMouseup,!1),t.addEventListener("textInput",this._onTextInput,!1),t.addEventListener("input",this._onTextInput,!1);var e={subtree:!0,characterData:!0,characterDataOldValue:!0};this._mutationObserver.observe(t,e),this.keyboard.connect(t),t.setAttribute("contenteditable","true")},this.deactivate=function(){var t=this.el;this.editorCtrl.session.selection.off("selection:changed",this._onModelSelectionChanged),t.removeEventListener("mousedown",this._onMousedown,!1),window.document.removeEventListener("mouseup",this._onMouseup,!1),t.removeEventListener("textInput",this._onTextInput,!1),t.removeEventListener("input",this._onTextInput,!1),this._mutationObserver.disconnect(),this.keyboard.disconnect(),t.setAttribute("contenteditable","true")}},a.Prototype.prototype=o.prototype,a.prototype=new a.Prototype,e.exports=a},{"./surface":260,"substance-commander":28,"substance-util":264}],259:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=t("./surface_controller"),r=i.errors,s=r.define("EditingError"),a=function(t,e){this.session=t,this.editorFactory=e,this.editors={}};a.Prototype=function(){n.extend(this,i.Events),this.isEditor=function(){return!0},this.dispose=function(){this.session.dispose()},this.write=function(t){var e=this.session.selection;if(e.isNull())throw new s("Can not write, the current position is not valid.");var n=this.startTransaction();this._write(n,t)&&(n.save(),e.set(n.selection),this._afterEdit())},this["delete"]=function(t){var e=this.startTransaction(),n=e.selection;n.isNull()||(n.isCollapsed()&&n.expand(t,"char"),a(this,e)&&(e.save(),this.session.selection.set(n),this._afterEdit()))},this.breakNode=function(){var t=this.session.selection;if(t.isNull())return void console.error("Can not break, as no position has been selected.");var e=this.startTransaction();r(this,e)&&(e.save(),t.set(e.selection),this._afterEdit())},this.indent=function(t){var e=this.session.selection;if(e.isNull())return void console.error("Nothing is selected.");if(e.hasMultipleNodes())return void console.error("Indenting Multi-Node selection is not supported yet.");var n=this.startTransaction(),i=n.selection,r=i.getCursor(),s=r.pos,a=n.container.getRootNodeFromPos(s),c=n.container.getComponent(s),h=o(this,a);return h.canIndent(n,c,t)?(h.indent(n,c,t),n.save(),void this._afterEdit()):void console.log("Can not indent at the given position.")},this.copy=function(){var t=this.session.selection;if(t.isNull())return null;for(var e,n=t.getNodeSelections(),i=this.session.document.newInstance(),r=0;r<n.length;r++){var s=n[r];e=o(this,s.node),s.ranges.length>0&&s.ranges[0].getLength()>0&&e.copy(s,i)}return i},this.cut=function(){console.log("I am sorry. Currently disabled.")},this.paste=function(t,e){if(this.session.selection.isNull())return void console.error("Can not paste, as no position has been selected.");var o=this.startTransaction(),s=o.document,c=o.container,h=o.selection;if(!h.isCollapsed()&&!a(this,o))return console.log("Could not delete the selected content"),!1;var l=o.selection.cursor.pos,p=o.selection.cursor.charPos;if(!r(this,o))return this._write(o,e)?(h.set([l,p+e.length]),o.save(),void this.selection.set(h)):void console.error("Can not paste at the given position.");var d=h.cursor.pos,f=c.getComponent(d),g=f.rootPos;0===f.length&&(s.hide(c.name,f.root.id),s["delete"](f.root.id),f=null);var v=c.getComponent(l);0===v.length&&(s.hide(c.name,v.root.id),s["delete"](v.root.id),v=null,g--);for(var y=t.get("content").nodes,m=t.getIndex("annotations"),w=[],_=0;_<y.length;_++){var b=y[_],C=t.get(b).toJSON();s.get(b)&&(C.id=i.uuid(C.type)),s.create(C),s.show(c.name,C.id,g++),w.push(C);var x=m.get(b);for(var P in x){var E=x[P];C.id!==b&&(E.path[0]=C.id),s.get(E.id)&&(E.id=i.uuid(E.type)),s.create(E.toJSON())}}var k;if(w.length>0){var S=w[0],T=n.last(w),N=c.getNodeComponents(T.id),O=n.last(N);k=[O.pos,O.length],f&&T.type===f.root.type&&u(this,o,s.get(T.id),f.root),v&&S.type===v.root.type&&(w.length>1&&v?k[1]+=v.getLength():k[1]=O.getLength(),k[0]--,u(this,o,v.root,s.get(S.id))),h.set(k),o.save(),this.session.selection.set(h)}},this.undo=function(){if(this.session.document.chronicle){var t=this.session.document.chronicle.rewind();if(t&&t.data){var e=t.data.before;e.container===this.session.container.name&&this.session.selection.set(e.sel)}}},this.redo=function(){if(this.session.document.chronicle){var t=this.session.document.chronicle.forward();if(t&&t.data){var e=t.data.after;e.container===this.session.container.name&&this.session.selection.set(e.sel)}}},this.annotate=function(t,e){var n=this.session.selection;if(n.isNull())throw new Error("Nothing selected.");if(n.hasMultipleNodes())throw new Error("Can only annotate within a single node/component.");if(!n.isCollapsed()){var i=this.startTransaction();this._annotate(i,t,e),i.save(),this.session.selection.set(i.selection),this._afterEdit()}},this.toggleAnnotation=function(t,e){var n=this.session.annotator.getAnnotations(this.session.selection),i=null;for(var o in n)if(n.hasOwnProperty(o)&&n[o].type===t){i=n[o];break}i?this.deleteAnnotation(i.id):this.annotate(t,e)},this.deleteAnnotation=function(t){var e=this.session.document,n=e.get(t),i=this.session.container.lookup(n.path);e["delete"](t),this.session.selection.set({start:[i.pos,n.range[0]],end:[i.pos,n.range[1]]}),this._afterEdit()},this.canInsertNode=function(){var t=this.session.selection,e=this.session.container;if(t.isNull())return!1;var n=t.range().start,i=n[0],r=n[1],s=e.getComponent(i),a=s.root,c=o(this,a);return c.canBreak(this.session,s,r)},this.insertNode=function(e,o){var r=this.session.selection;if(r.isNull())throw new Error("Selection is null!");var s=this.startTransaction(),a={id:e+"_"+i.uuid(),type:e};o&&n.extend(a,o),t(this,s,a)&&(s.save(),this.session.selection.set(s.selection),this._afterEdit())},this.changeType=function(t,e){var n=this.session.selection;if(n.isNull())return void console.error("Nothing selected.");if(n.hasMultipleNodes())return void console.error("Can not switch type of multiple nodes.");var i=this.startTransaction();this._changeType(i,t,e)&&(i.save(),this.session.selection.set(i.selection),this._afterEdit())},this._changeType=function(t,e,n){var i=t.selection.start[0],r=t.container.getComponent(i),s=r.root,a=o(this,s);return a.canChangeType(t,s,e)?(a.changeType(t,s,r,e,n),this.ensureLastNode(t),!0):!1},this.select=function(t){var e=this.session.selection;if(e.isNull())return void console.error("Nothing selected.");var n=this.session.container,i=e.cursor.pos,o=n.getComponent(i);if("all"===t){var r=n.getNodeComponents(o.root.id),s=r[0],a=r[r.length-1];e.set({start:[s.pos,0],end:[a.pos,a.length]})}else console.error("Unsupported selection mode:",t)},this.focus=function(){this.session.selection.set(this.session.selection)},this.startTransaction=function(){return this.session.startSimulation()};var t=function(t,e,n){var i=e.selection;if(!i.isCollapsed()&&!a(t,e))return console.log("Could not delete the selected content"),!1;var o,s,c=i.getCursor(),h=c.pos,u=c.charPos,l=e.container.getComponent(h);if(u<l.length){var p=r(t,e);if(!p)return!1;o=i.range().start,s=e.container.getNodePos(o[0])}else o=i.range().start,s=e.container.getNodePos(o[0])+1;return e.document.create(n),e.document.show(e.view,n.id,s),t.ensureLastNode(e),i.set(e.container.after(n.id)),!0};this._insertNode=function(e,n){return t(this,e,n)};var e=[{action:"createNode",type:"heading",data:{level:1}},{action:"createNode",type:"figure",data:{}},{action:"createNode",type:"code_block",data:{}}];i.freeze(e),this.getAllowedActions=function(){return this.canInsertNode()?e:[]},this.ensureLastNode=function(t){var e=o(this,{type:"view",id:t.container.name});e.ensureLastNode&&e.ensureLastNode(t)},this._annotate=function(t,e,n){var i=t.selection.range(),r=i.start[0],s=[i.start[1],i.end[1]],a=t.container.getRootNodeFromPos(r),c=t.container.getComponent(r),h=o(this,a);return h.canAnnotate(t,c,e,s)?(h.annotate(t,c,e,s,n),void t.selection.set(i)):void console.log("Can not annotate component",c)},this._afterEdit=function(){var t=this.session.document;t.chronicle&&t.chronicle.mark("master"),this.trigger("document:edited")};var o=function(t,e){return t.editors[e.id]||(t.editors[e.id]=t.editorFactory.createEditor(e)),t.editors[e.id]};this._write=function(t,e){var n=t.selection,i=this;if(!n.isCollapsed()&&!a(i,t))return console.log("Could not delete the selected content"),!1;var r=n.getCursor(),s=r.pos,c=r.charPos,h=t.container.getRootNodeFromPos(s),u=t.container.getComponent(s),l=o(i,h);return l.canInsertContent(t,u,c)?(l.insertContent(t,u,c,e),n.set([s,c+e.length]),!0):(console.log("Can not insert at the given position."),!1)};var r=function(t,e){var n=e.selection,i=n.range().start,r=i[0],s=i[1],c=e.container.getComponent(r),h=e.container.getRootNodeFromPos(r),u=o(t,h);return u.canBreak(e,c,s)?n.isCollapsed()||a(t,e)?(s=n.getCursor().charPos,u.breakNode(e,c,s),!0):(console.log("Could not delete the selected content"),!1):!1},a=function(t,e){var n,i=e.selection,o=i.range().start;if(i.hasMultipleNodes())n=h(t,e);else{var r=i.start[0],s=e.container.getComponent(r);n=c(t,e,s)}return n?(t.ensureLastNode(e),i.set(e.container.getLength()<=o[0]?e.container.getLastCoor():o),!0):!1},c=function(t,e,n){var i=e.selection,r=e.container.getRootNodeFromPos(n.pos),s=i.startChar(),a=i.endChar(),c=o(t,r);return c.canDeleteContent(e,n,s,a)?(c.deleteContent(e,n,s,a),!0):(console.log("Can not delete content",r.type,s,a),!1)},h=function(t,e){var n,i,r,s,a=e.container,c=[],h=o(t,{type:"view",id:a.name}),l=e.selection.getNodeSelections(),p=l[0],d=l[l.length-1];for(n=0;n<l.length;n++){s=l[n],r=s.node;var f,g,v=s.isFull();if(v&&s===d&&p.isFull()&&1===s.ranges.length&&0===s.ranges[0].component.length&&(v=!1),v){if(g=h,f=g.canDeleteNode(e,r),c.push({type:"node",editor:g,node:r}),!f)return console.log("Can't delete node:",r),!1}else{g=o(t,r);for(var y=0;y<s.ranges.length;y++)if(i=s.ranges[y],f=g.canDeleteContent(e,i.component,i.start,i.end),c.push({type:"content",editor:g,range:i}),!f)return console.log("Can't delete component:",i.component),!1}}var m=p&&p.isPartial()&&d&&d.isPartial();for(n=c.length-1;n>=0;n--){var w=c[n];"content"===w.type?(i=w.range,w.editor.deleteContent(e,i.component,i.start,i.end)):(r=w.node,w.editor.deleteNode(e,r),e.document["delete"](r.id))}return m&&u(t,e,p.node,d.node),!0},u=function(t,e,n,i){var r=o(t,n),s=o(t,{type:"view",id:e.container.name});return r.canJoin(e,n,i)&&s.canDeleteNode(e,i)?(r.join(e,n,i),s.deleteNode(e,i),e.document["delete"](i.id),!0):!1}},a.Prototype.prototype=o.prototype,a.prototype=new a.Prototype,Object.defineProperties(a.prototype,{selection:{get:function(){return this.session.selection},set:function(){throw new Error("Immutable.")}},annotator:{get:function(){return this.session.annotator},set:function(){throw new Error("Immutable.")}},container:{get:function(){return this.session.container},set:function(){throw new Error("Immutable.")}},document:{get:function(){return this.session.document},set:function(){throw new Error("Immutable.")}},view:{get:function(){return this.session.container.name},set:function(){throw new Error("Immutable.")}}}),a.EditingError=s,e.exports=a},{"./surface_controller":261,"substance-util":264,underscore:269}],260:[function(t,e){"use strict";var n=t("underscore"),i=window.$,o=t("substance-application").View,r=t("substance-util"),s=r.errors.define("SurfaceError",500),a=r.errors.define("SelectionError",501,s),c=function(t,e){o.call(this),this.docCtrl=t,this.renderer=e,this.document=t.session.document,this.nodeTypes=this.document.nodeTypes,this.nodeViews=this.renderer.nodeViews,this.$el.addClass("surface"),this.listenTo(this.document,"property:updated",this.onUpdateView),this.listenTo(this.document,"graph:reset",this.reset),this.$el.blur(this.onBlur.bind(this)),this.__lastFocussed=null};c.Prototype=function(){function t(t,e,n){var i=t.childNodes;if(e<i.length){var o=i[e];t.insertBefore(n,o)}else t.appendChild(n)}var e={source:"surface"},o=function(t){for(var e=[],n=t;n;){if(n.getAttribute){if("false"===n.getAttribute("contenteditable"))return null;var o=n.getAttribute("data-path");o&&e.unshift(o)}if(i(n).is(".content-node")){var r=n.getAttribute("id");if(!r)throw new Error("Every element with class 'content-node' must have an 'id' attribute.");return e.unshift(r),e}n=n.parentElement}return null},s=function(t,e){var n,i,r=this.docCtrl.container,s=o(t);if(!s)return null;var a=r.lookup(s);if(!a)return null;if(a.surface.hasView()||this._attachViewToNodeSurface(a),!a.surface.hasView())throw new Error("NodeView.attachView() must propagate down to child views.");return n=a.pos,i=a.surface.getCharPosition(t,e),[n,i]};this.getCoordinateForPosition=function(t){return s.call(this,t.startContainer,t.startOffset)},this.updateSelection=function(){try{var t=window.getSelection();if(null===t.anchorNode)return void this.clearModelSelection();if(i(t.anchorNode.parentElement).is(".cursor"))return void this.docCtrl.selection.collapse("cursor",e);var n,o,c=t.getRangeAt(0);if(n=[c.startContainer,c.startOffset],o=[c.endContainer,c.endOffset],c.endContainer===t.anchorNode&&c.endOffset===t.anchorOffset){var h=n;n=o,o=h}var u=s.call(this,n[0],n[1]);if(!u)return t.removeAllRanges(),void this.clearModelSelection();var l;if(c.collapsed)l=u;else if(l=s.call(this,o[0],o[1]),!l)return t.removeAllRanges(),void this.clearModelSelection();try{this._emitFocusAndBlur(u[0]===l[0],u[0])}catch(p){console.error(p)}this.docCtrl.selection.set({start:u,end:l},e)}catch(d){console.error(d),r.printStackTrace(d);var p=new a("Could not map to model cordinates.",d);this.clearModelSelection(),this.docCtrl.trigger("error",p)}};var c=function(t){var e=this.docCtrl.container,n=e.getComponent(t[0]);return this.getPositionFromComponent(n,t[1])};this.getPositionFromCoordinate=function(t,e){var n=this.docCtrl.container,i=n.lookup(t);return this.getPositionFromComponent(i,e)
},this.getPositionFromComponent=function(t,e){t.surface.hasView()||this._attachViewToNodeSurface(t);var n=t.surface.getDOMPosition(e);return n},this._attachViewToNodeSurface=function(t){var e=t.root.id,n=t.surface.surfaceProvider.getNodeSurface(e),i=this.nodeViews[e];n.attachView(i)},this._emitFocusAndBlur=function(t,e){if(t){var n=this.docCtrl.container.getComponent(e);n.surface.hasView()||this._attachViewToNodeSurface(n);var i=n.surface.view;i!==this.__lastFocussedView&&(this.__lastFocussedView&&this.__lastFocussedView.onBlur(),i.onFocus(),this.__lastFocussedView=i)}else this.__lastFocussedView&&(this.__lastFocussedView.onBlur(),this.__lastFocussedView=null)},this.onBlur=function(){this.__lastFocussedView&&(this.__lastFocussedView.onBlur(),this.__lastFocussedView=null)},this.renderSelection=function(t,e){try{var n=this.docCtrl.selection;if(n.isCollapsed()){var i=n.getCursorPosition();try{this._emitFocusAndBlur("is-collapsed",i[0])}catch(o){console.error(o)}}else this._emitFocusAndBlur();if(e&&("surface"===e.source||e.silent===!0))return void this.scrollToCursor();var s=window.getSelection();if(s.removeAllRanges(),n.isNull())return;var h=window.document.createRange(),u=c.call(this,n.start);if(h.setStart(u.startContainer,u.startOffset),s.addRange(h),!n.isCollapsed()){var l=c.call(this,[n.cursor.pos,n.cursor.charPos]);s.extend(l.endContainer,l.endOffset)}this.scrollToCursor()}catch(p){console.error(p),r.printStackTrace(p);var o=new a("Could not map to DOM cordinates.",p);this.clearModelSelection(),this.docCtrl.trigger("error",o)}},this.clearModelSelection=function(){this.docCtrl.selection.clear(e)},this.scrollToCursor=function(){var t=this.docCtrl.selection;if(t.isCollapsed()){var e=this;window.setTimeout(function(){var t=i(e.el).offset().top,n=window.getSelection();if(0!==n.rangeCount){var o=n.getRangeAt(0),r=o.getClientRects()[0];if(!r){var s=i(o.startContainer).parents(".content");if(0===s.length)return;r=s.offset()}var a,c=r.top-t,h=i(e.el).height(),u=i(e.el).scrollTop(),l=50;c>h?(a=u+c-h+l,i(e.el).scrollTop(a)):0>c&&(a=u+c-3*l,i(e.el).scrollTop(a))}},5)}},this.render=function(){var t=window.document.createElement("div");return t.className="nodes",this.el.appendChild(t),t.appendChild(this.renderer.render()),this.$("input.image-files").hide(),this.$cursor=this.$(".cursor"),this.$cursor.hide(),this._nodesEl=t,this},this.reset=function(){n.each(this.nodeViews,function(t){t.dispose()}),this.render()},this.dispose=function(){this.stopListening(),n.each(this.nodeViews,function(t){t.dispose()},this),this.keyboard&&this.keyboard.disconnect(this.el)},this.getContainer=function(){return this.docCtrl.container},this.onUpdateView=function(e,n){if(2===e.length&&e[0]===this.docCtrl.session.container.name&&"nodes"===e[1]){var i,o,r,s,a=this._nodesEl;if(n.isInsert()){if(i=n.val,o=this.document.get(i),this.nodeTypes[o.type]){var c=this.renderer.createView(o);this.nodeViews[i]=c,s=c.render().el,t(a,n.pos,s)}}else if(n.isDelete())i=n.val,this.nodeViews[i]&&this.nodeViews[i].dispose(),delete this.nodeViews[i],r=a.children,a.removeChild(r[n.pos]);else if(n.isMove())r=a.children,s=r[n.pos],a.removeChild(s),t(a,n.target,s);else if("NOP"!==n.type)throw new Error("Illegal state.")}},this.getNodeView=function(t){return this.renderer.getView(t)}},n.extend(c.Prototype,r.Events.Listener),c.Prototype.prototype=o.prototype,c.prototype=new c.Prototype,Object.defineProperties(c.prototype,{name:{get:function(){return this.docCtrl.session.container.name}}}),e.exports=c},{"substance-application":6,"substance-util":264,underscore:269}],261:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),o=function(t){this.session=t};o.Prototype=function(){n.extend(this,i.Events),this.isEditor=function(){return!1}},o.prototype=new o.Prototype,Object.defineProperties(o.prototype,{selection:{get:function(){return this.session.selection},set:function(){throw new Error("Immutable.")}},annotator:{get:function(){return this.session.annotator},set:function(){throw new Error("Immutable.")}},container:{get:function(){return this.session.container},set:function(){throw new Error("Immutable.")}},document:{get:function(){return this.session.document},set:function(){throw new Error("Immutable.")}},view:{get:function(){return console.error("TODO: rename this property."),this.session.container.name},set:function(){throw new Error("Immutable.")}}}),e.exports=o},{"substance-util":264,underscore:269}],262:[function(t,e){"use strict";var n=t("./toc_view");e.exports=n},{"./toc_view":263}],263:[function(t,e){"use strict";var n=t("substance-application").View,i=t("substance-application").$$,o=t("underscore"),r=function(t){n.call(this),this.docCtrl=t,this.$el.addClass("toc")};r.Prototype=function(){this.render=function(){return this.el.innerHTML="",this.headings=o.filter(this.docCtrl.container.getNodes(),function(t){return"heading"===t.type}),this.headings.length>0?o.each(this.headings,function(t){this.el.appendChild(i("a.heading-ref.level-"+t.level,{id:"toc_"+t.id,text:t.content,"sbs-click":"jumpToNode("+t.id+")"}))},this):this.el.appendChild(i(".toc-placeholder",{html:"Add structure to your article using headings."})),this},this.setActiveNode=function(t){this.$(".heading-ref.active").removeClass("active"),this.$("#toc_"+t).addClass("active")}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"substance-application":6,underscore:269}],264:[function(t,e){"use strict";var n=t("./src/util");n.async=t("./src/async"),n.errors=t("./src/errors"),n.Fragmenter=t("./src/fragmenter"),e.exports=n},{"./src/async":265,"./src/errors":266,"./src/fragmenter":267,"./src/util":268}],265:[function(t,e){"use strict";function n(t,e){function n(t){var e=a[c];if(!e)return u.length>0?i(new Error("Multiple errors occurred.",t)):i(null,t);var s=o.once(function(t,e){if(t){if(h)return i(t,null);u.push(t)}c+=1,n(e)});try{0===e.length?(e(),s(null,t)):1===e.length?e(s):e(t,s)}catch(l){console.log("util.async caught error:",l),r.printStackTrace(l),i(l)}}var i=t["finally"]||function(t,n){e(t,n)};i=o.once(i);var s=t.data||{},a=t.functions;if(!o.isFunction(e))return e("Illegal arguments: a callback function must be provided");var c=0,h=void 0===t.stopOnError?!0:t.stopOnError,u=[];n(s)}function i(t){return function(e,i){function r(t,e){return function(n,i){2===l.length?l(t,i):3===l.length?l(t,e,i):l(t,e,n,i)}}function s(t,e){return function(n,i){2===l.length?l(t,i):3===l.length?l(t,e,i):l(t,e,n,i)}}var a=t.selector?t.selector(e):t.items,c=t["finally"]||function(t,e){i(t,e)};if(c=o.once(c),!a)return c(null,e);var h=o.isArray(a);t.before&&t.before(e);var u=[],l=t.iterator;if(h)for(var p=0;p<a.length;p++)u.push(r(a[p],p));else for(var d in a)u.push(s(a[d],d));var f={functions:u,data:e,"finally":c,stopOnError:t.stopOnError};n(f,i)}}var o=t("underscore"),r=t("./util.js"),s={};s.sequential=function(t,e){o.isArray(t)&&(t={functions:t}),n(t,e)},s.iterator=function(t,e){var n;return n=1==arguments.length?t:{items:t,iterator:e},i(n)},s.each=function(t,e){var n=i(t);n(null,e)},e.exports=s},{"./util.js":268,underscore:269}],266:[function(t,e){"use strict";var n=t("./util"),i={},o=function(t,e){e?(Error.call(this,t,e.fileName,e.lineNumber),this.__stack=e instanceof o?e.__stack:e.stack?n.parseStackTrace(e):n.callstack(1)):(Error.call(this,t),this.__stack=n.callstack(1)),this.message=t};o.Prototype=function(){this.name="SubstanceError",this.code=-1,this.toString=function(){return this.name+":"+this.message},this.toJSON=function(){return{name:this.name,message:this.message,code:this.code,stack:this.stack}},this.printStackTrace=function(){n.printStackTrace(this)}},o.Prototype.prototype=Error.prototype,o.prototype=new o.Prototype,Object.defineProperty(o.prototype,"stack",{get:function(){for(var t=[],e=0;e<this.__stack.length;e++){var n=this.__stack[e];t.push(n.file+":"+n.line+":"+n.col+" ("+n.func+")")}return t.join("\n")},set:function(){throw new Error("SubstanceError.stack is read-only.")}}),i.SubstanceError=o;var r=function(t,e,n){return function(i){t.call(this,i),this.name=e,this.code=n}};i.define=function(t,e,n){if(!t)throw new o("Name is required.");void 0===e&&(e=-1),n=n||o;var s=r(n,t,e),a=function(){};return a.prototype=n.prototype,s.prototype=new a,s.prototype.constructor=s,i[t]=s,s},e.exports=i},{"./util":268}],267:[function(t,e){"use strict";var n=t("underscore"),i=1,o=-1,r=function(){};r.Prototype=function(){var t=function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(t.mode===i){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(t.mode===o){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0},e=function(t){var e=[];return n.each(t,function(t){var n=t.constructor.level||1e3;e.push({pos:t.range[0],mode:i,level:n,id:t.id,type:t.type}),e.push({pos:t.range[1],mode:o,level:n,id:t.id,type:t.type})}),e};this.onText=function(){},this.onEnter=function(){return null},this.onExit=function(){},this.enter=function(t,e){return this.onEnter(t,e)},this.exit=function(t,e){this.onExit(t,e)},this.createText=function(t,e){this.onText(t,e)},this.start=function(n,r,s){var a=e.call(this,s);a.sort(t.bind(this));for(var c=[{context:n,entry:null}],h=0,u=0;u<a.length;u++){var l=a[u];this.createText(c[c.length-1].context,r.substring(h,l.pos)),h=l.pos;var p,d=1;if(l.mode===i){for(;d<c.length&&!(l.level<c[d].entry.level);d++);c.splice(d,0,{entry:l})}else if(l.mode===o){for(;d<c.length&&c[d].entry.id!==l.id;d++);for(p=d;p<c.length;p++)this.exit(c[p].entry,c[p-1].context);c.splice(d,1)}for(p=d;p<c.length;p++)c[p].context=this.enter(c[p].entry,c[p-1].context)}this.createText(n,r.substring(h))}},r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{underscore:269}],268:[function(t,e){"use strict";var n=t("underscore"),i={};i.uuid=function(t,e){var n,i="0123456789abcdefghijklmnopqrstuvwxyz".split(""),o=[],r=16;if(e=e||32)for(n=0;e>n;n++)o[n]=i[0|Math.random()*r];else{var s;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",n=0;36>n;n++)o[n]||(s=0|16*Math.random(),o[n]=i[19==n?3&s|8:s])}return(t?t:"")+o.join("")},i.uuidGen=function(t){var e=1;return t=void 0!==t?t:"uuid_",function(n){return n=n||t,n+e++}};var o=function(t,e){var n,i=-1,o=t.length,r=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;++i<o;)(n=t[i]).callback.call(n.ctx);return;case 1:for(;++i<o;)(n=t[i]).callback.call(n.ctx,r);return;case 2:for(;++i<o;)(n=t[i]).callback.call(n.ctx,r,s);return;case 3:for(;++i<o;)(n=t[i]).callback.call(n.ctx,r,s,a);return;default:for(;++i<o;)(n=t[i]).callback.apply(n.ctx,e)}},r=/\s+/,s=function(t,e,n,i){if(!n)return!0;if("object"==typeof n){for(var o in n)t[e].apply(t,[o,n[o]].concat(i));return!1}if(r.test(n)){for(var s=n.split(r),a=0,c=s.length;c>a;a++)t[e].apply(t,[s[a]].concat(i));return!1}return!0};i.Events={on:function(t,e,n){if(!s(this,"on",t,[e,n])||!e)return this;this._events=this._events||{};var i=this._events[t]||(this._events[t]=[]);return i.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,i){if(!s(this,"once",t,[e,i])||!e)return this;var o=this,r=n.once(function(){o.off(t,r),e.apply(this,arguments)});return r._callback=e,this.on(t,r,i)},off:function(t,e,i){var o,r,a,c,h,u,l,p;if(!this._events||!s(this,"off",t,[e,i]))return this;if(!t&&!e&&!i)return this._events={},this;for(c=t?[t]:n.keys(this._events),h=0,u=c.length;u>h;h++)if(t=c[h],a=this._events[t]){if(this._events[t]=o=[],e||i)for(l=0,p=a.length;p>l;l++)r=a[l],(e&&e!==r.callback&&e!==r.callback._callback||i&&i!==r.context)&&o.push(r);o.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=Array.prototype.slice.call(arguments,1);if(!s(this,"trigger",t,e))return this;var n=this._events[t],i=this._events.all;return n&&o(n,e),i&&o(i,arguments),this},triggerLater:function(){var t=this,e=arguments;window.setTimeout(function(){t.trigger.apply(t,e)},0)},stopListening:function(t,e,n){var i=this._listeners;if(!i)return this;var o=!e&&!n;"object"==typeof e&&(n=this),t&&((i={})[t._listenerId]=t);for(var r in i)i[r].off(e,n,this),o&&delete this._listeners[r];return this}};var a={listenTo:"on",listenToOnce:"once"};n.each(a,function(t,e){i.Events[e]=function(e,i,o){var r=this._listeners||(this._listeners={}),s=e._listenerId||(e._listenerId=n.uniqueId("l"));return r[s]=e,"object"==typeof i&&(o=this),e[t](i,o,this),this}}),i.Events.bind=i.Events.on,i.Events.unbind=i.Events.off,i.Events.Listener={listenTo:function(t,e,i){if(!n.isFunction(i))throw new Error("Illegal argument: expecting function as callback, was: "+i);return this._handlers=this._handlers||[],t.on(e,i,this),this._handlers.push({unbind:function(){t.off(e,i)}}),this},stopListening:function(){if(this._handlers)for(var t=0;t<this._handlers.length;t++)this._handlers[t].unbind()}},i.propagate=function(t,e){if(!n.isFunction(e))throw"Illegal argument: provided callback is not a function";return function(n){return n?e(n):void e(null,t)}};var c=function(){};i.inherits=function(t,e,i){var o;return o=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},n.extend(o,t),c.prototype=t.prototype,o.prototype=new c,e&&n.extend(o.prototype,e),i&&n.extend(o,i),o.prototype.constructor=o,o.__super__=t.prototype,o},i.getJSON=function(e,n){if("undefined"==typeof window||"undefined"!=typeof nwglobal){var i=t("fs"),o=JSON.parse(i.readFileSync(e,"utf8"));n(null,o)}else{var r=window.$;r.getJSON(e).done(function(t){n(null,t)}).error(function(t){n(t,null)})}},i.prototype=function(t){return Object.getPrototypeOf?Object.getPrototypeOf(t):t.__proto__},i.inherit=function(t,e){var i,o=n.isFunction(t)?new t:t;if(n.isFunction(e))e.prototype=o,i=new e;else{var r=function(){};r.prototype=o,i=n.extend(new r,e)}return i},i.pimpl=function(t){var e=function(t){this.self=t};return e.prototype=t,function(t){return t=t||this,new e(t)}},i.parseStackTrace=function(t){var e,n=/([^@]*)@(.*):(\d+)/,i=/\s*at ([^(]*)[(](.*):(\d+):(\d+)[)]/,o=t.stack.split("\n"),r=[];for(e=0;e<o.length;e++){var s=n.exec(o[e]);s||(s=i.exec(o[e]));var a;s?(a={func:s[1],file:s[2],line:s[3],col:s[4]||0},""===a.func&&(a.func="<anonymous>")):a={func:"",file:o[e],line:"",col:""},r.push(a)}return r},i.callstack=function(t){var e;try{throw new Error}catch(n){e=n}var o=i.parseStackTrace(e);return t=t||0,o.splice(t+1)},i.stacktrace=function(t){var e=0===arguments.length?i.callstack().splice(1):i.parseStackTrace(t),o=[];return n.each(e,function(t){o.push(t.file+":"+t.line+":"+t.col+" ("+t.func+")")}),o.join("\n")},i.printStackTrace=function(t,e){if(t.stack){var o;if(void 0!==t.__stack)o=t.__stack;else{if(!n.isString(t.stack))return;o=i.parseStackTrace(t)}e=e||o.length,e=Math.min(e,o.length);for(var r=0;e>r;r++){var s=o[r];console.log(s.file+":"+s.line+":"+s.col,"("+s.func+")")}}},i.diff=function(t,e){var o;return n.isArray(t)&&n.isArray(e)?(o=n.difference(e,t),0===o.length?null:o):n.isObject(t)&&n.isObject(e)?(o={},n.each(Object.keys(e),function(n){var r=i.diff(t[n],e[n]);r&&(o[n]=r)}),n.isEmpty(o)?null:o):t!==e?e:void 0},i.deepclone=function(t){return void 0===t?void 0:null===t?null:JSON.parse(JSON.stringify(t))},i.clone=function(t){return null===t||void 0===t?t:n.isFunction(t.clone)?t.clone():i.deepclone(t)},i.freeze=function(t){var e;if(n.isObject(t)){if(Object.isFrozen(t))return t;var o=Object.keys(t);for(e=0;e<o.length;e++){var r=o[e];t[r]=i.freeze(t[r])}return Object.freeze(t)}if(n.isArray(t)){var s=t;for(e=0;e<s.length;e++)s[e]=i.freeze(s[e]);return Object.freeze(s)}return t},i.later=function(t,e){return function(){var n=arguments;window.setTimeout(function(){t.apply(e,n)},0)}},i.isEmpty=function(t){return!t.match(/\w/)},i.slug=function(t){t=t.replace(/^\s+|\s+$/g,""),t=t.toLowerCase();for(var e="àáäâèéëêìíïîòóöôùúüûñç·/_,:;",n="aaaaeeeeiiiioooouuuunc------",i=0,o=e.length;o>i;i++)t=t.replace(new RegExp(e.charAt(i),"g"),n.charAt(i));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")},i.getReadableFileSizeString=function(t){var e=-1,n=[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"];do t/=1024,e++;while(t>1024);return Math.max(t,.1).toFixed(1)+n[e]},i.getProp=function(t,e){var n,i=t;for(n=0;n<e.length;n++){if(void 0===i||null===i)return void 0;i=i[e[n]]}return i};var h=function(){this.startTime=Date.now(),this.lastStop=this.startTime};h.prototype.stop=function(){var t=Date.now(),e=t-this.lastStop;return this.lastStop=t,e},h.prototype.total=function(){var t=Date.now(),e=t-this.startTime;return e},i.startTimer=function(){return new h},e.exports=i},{fs:304,underscore:269}],269:[function(t,e,n){(function(){var t=this,i=t._,o=Array.prototype,r=Object.prototype,s=Function.prototype,a=o.push,c=o.slice,h=o.concat,u=r.toString,l=r.hasOwnProperty,p=Array.isArray,d=Object.keys,f=s.bind,g=function(t){return t instanceof g?t:this instanceof g?void(this._wrapped=t):new g(t)};"undefined"!=typeof n?("undefined"!=typeof e&&e.exports&&(n=e.exports=g),n._=g):t._=g,g.VERSION="1.7.0";var v=function(t,e,n){if(void 0===e)return t;switch(null==n?3:n){case 1:return function(n){return t.call(e,n)};case 2:return function(n,i){return t.call(e,n,i)};case 3:return function(n,i,o){return t.call(e,n,i,o)};case 4:return function(n,i,o,r){return t.call(e,n,i,o,r)}}return function(){return t.apply(e,arguments)}};g.iteratee=function(t,e,n){return null==t?g.identity:g.isFunction(t)?v(t,e,n):g.isObject(t)?g.matches(t):g.property(t)},g.each=g.forEach=function(t,e,n){if(null==t)return t;e=v(e,n);var i,o=t.length;if(o===+o)for(i=0;o>i;i++)e(t[i],i,t);else{var r=g.keys(t);for(i=0,o=r.length;o>i;i++)e(t[r[i]],r[i],t)}return t},g.map=g.collect=function(t,e,n){if(null==t)return[];e=g.iteratee(e,n);for(var i,o=t.length!==+t.length&&g.keys(t),r=(o||t).length,s=Array(r),a=0;r>a;a++)i=o?o[a]:a,s[a]=e(t[i],i,t);return s};var y="Reduce of empty array with no initial value";g.reduce=g.foldl=g.inject=function(t,e,n,i){null==t&&(t=[]),e=v(e,i,4);var o,r=t.length!==+t.length&&g.keys(t),s=(r||t).length,a=0;if(arguments.length<3){if(!s)throw new TypeError(y);n=t[r?r[a++]:a++]}for(;s>a;a++)o=r?r[a]:a,n=e(n,t[o],o,t);return n},g.reduceRight=g.foldr=function(t,e,n,i){null==t&&(t=[]),e=v(e,i,4);var o,r=t.length!==+t.length&&g.keys(t),s=(r||t).length;if(arguments.length<3){if(!s)throw new TypeError(y);n=t[r?r[--s]:--s]}for(;s--;)o=r?r[s]:s,n=e(n,t[o],o,t);return n},g.find=g.detect=function(t,e,n){var i;return e=g.iteratee(e,n),g.some(t,function(t,n,o){return e(t,n,o)?(i=t,!0):void 0}),i},g.filter=g.select=function(t,e,n){var i=[];return null==t?i:(e=g.iteratee(e,n),g.each(t,function(t,n,o){e(t,n,o)&&i.push(t)}),i)},g.reject=function(t,e,n){return g.filter(t,g.negate(g.iteratee(e)),n)},g.every=g.all=function(t,e,n){if(null==t)return!0;e=g.iteratee(e,n);var i,o,r=t.length!==+t.length&&g.keys(t),s=(r||t).length;for(i=0;s>i;i++)if(o=r?r[i]:i,!e(t[o],o,t))return!1;return!0},g.some=g.any=function(t,e,n){if(null==t)return!1;e=g.iteratee(e,n);var i,o,r=t.length!==+t.length&&g.keys(t),s=(r||t).length;for(i=0;s>i;i++)if(o=r?r[i]:i,e(t[o],o,t))return!0;return!1},g.contains=g.include=function(t,e){return null==t?!1:(t.length!==+t.length&&(t=g.values(t)),g.indexOf(t,e)>=0)},g.invoke=function(t,e){var n=c.call(arguments,2),i=g.isFunction(e);return g.map(t,function(t){return(i?e:t[e]).apply(t,n)})},g.pluck=function(t,e){return g.map(t,g.property(e))},g.where=function(t,e){return g.filter(t,g.matches(e))},g.findWhere=function(t,e){return g.find(t,g.matches(e))},g.max=function(t,e,n){var i,o,r=-1/0,s=-1/0;if(null==e&&null!=t){t=t.length===+t.length?t:g.values(t);for(var a=0,c=t.length;c>a;a++)i=t[a],i>r&&(r=i)}else e=g.iteratee(e,n),g.each(t,function(t,n,i){o=e(t,n,i),(o>s||o===-1/0&&r===-1/0)&&(r=t,s=o)});return r},g.min=function(t,e,n){var i,o,r=1/0,s=1/0;if(null==e&&null!=t){t=t.length===+t.length?t:g.values(t);for(var a=0,c=t.length;c>a;a++)i=t[a],r>i&&(r=i)}else e=g.iteratee(e,n),g.each(t,function(t,n,i){o=e(t,n,i),(s>o||1/0===o&&1/0===r)&&(r=t,s=o)});return r},g.shuffle=function(t){for(var e,n=t&&t.length===+t.length?t:g.values(t),i=n.length,o=Array(i),r=0;i>r;r++)e=g.random(0,r),e!==r&&(o[r]=o[e]),o[e]=n[r];return o},g.sample=function(t,e,n){return null==e||n?(t.length!==+t.length&&(t=g.values(t)),t[g.random(t.length-1)]):g.shuffle(t).slice(0,Math.max(0,e))},g.sortBy=function(t,e,n){return e=g.iteratee(e,n),g.pluck(g.map(t,function(t,n,i){return{value:t,index:n,criteria:e(t,n,i)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(i>n||void 0===i)return-1}return t.index-e.index}),"value")};var m=function(t){return function(e,n,i){var o={};return n=g.iteratee(n,i),g.each(e,function(i,r){var s=n(i,r,e);t(o,i,s)}),o}};g.groupBy=m(function(t,e,n){g.has(t,n)?t[n].push(e):t[n]=[e]}),g.indexBy=m(function(t,e,n){t[n]=e}),g.countBy=m(function(t,e,n){g.has(t,n)?t[n]++:t[n]=1}),g.sortedIndex=function(t,e,n,i){n=g.iteratee(n,i,1);for(var o=n(e),r=0,s=t.length;s>r;){var a=r+s>>>1;n(t[a])<o?r=a+1:s=a}return r},g.toArray=function(t){return t?g.isArray(t)?c.call(t):t.length===+t.length?g.map(t,g.identity):g.values(t):[]},g.size=function(t){return null==t?0:t.length===+t.length?t.length:g.keys(t).length},g.partition=function(t,e,n){e=g.iteratee(e,n);var i=[],o=[];return g.each(t,function(t,n,r){(e(t,n,r)?i:o).push(t)}),[i,o]},g.first=g.head=g.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:0>e?[]:c.call(t,0,e)},g.initial=function(t,e,n){return c.call(t,0,Math.max(0,t.length-(null==e||n?1:e)))},g.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:c.call(t,Math.max(t.length-e,0))},g.rest=g.tail=g.drop=function(t,e,n){return c.call(t,null==e||n?1:e)},g.compact=function(t){return g.filter(t,g.identity)};var w=function(t,e,n,i){if(e&&g.every(t,g.isArray))return h.apply(i,t);for(var o=0,r=t.length;r>o;o++){var s=t[o];g.isArray(s)||g.isArguments(s)?e?a.apply(i,s):w(s,e,n,i):n||i.push(s)}return i};g.flatten=function(t,e){return w(t,e,!1,[])},g.without=function(t){return g.difference(t,c.call(arguments,1))},g.uniq=g.unique=function(t,e,n,i){if(null==t)return[];g.isBoolean(e)||(i=n,n=e,e=!1),null!=n&&(n=g.iteratee(n,i));for(var o=[],r=[],s=0,a=t.length;a>s;s++){var c=t[s];if(e)s&&r===c||o.push(c),r=c;else if(n){var h=n(c,s,t);g.indexOf(r,h)<0&&(r.push(h),o.push(c))}else g.indexOf(o,c)<0&&o.push(c)}return o},g.union=function(){return g.uniq(w(arguments,!0,!0,[]))},g.intersection=function(t){if(null==t)return[];for(var e=[],n=arguments.length,i=0,o=t.length;o>i;i++){var r=t[i];if(!g.contains(e,r)){for(var s=1;n>s&&g.contains(arguments[s],r);s++);s===n&&e.push(r)}}return e},g.difference=function(t){var e=w(c.call(arguments,1),!0,!0,[]);return g.filter(t,function(t){return!g.contains(e,t)})},g.zip=function(t){if(null==t)return[];for(var e=g.max(arguments,"length").length,n=Array(e),i=0;e>i;i++)n[i]=g.pluck(arguments,i);return n},g.object=function(t,e){if(null==t)return{};for(var n={},i=0,o=t.length;o>i;i++)e?n[t[i]]=e[i]:n[t[i][0]]=t[i][1];return n},g.indexOf=function(t,e,n){if(null==t)return-1;var i=0,o=t.length;if(n){if("number"!=typeof n)return i=g.sortedIndex(t,e),t[i]===e?i:-1;i=0>n?Math.max(0,o+n):n}for(;o>i;i++)if(t[i]===e)return i;return-1},g.lastIndexOf=function(t,e,n){if(null==t)return-1;var i=t.length;for("number"==typeof n&&(i=0>n?i+n+1:Math.min(i,n+1));--i>=0;)if(t[i]===e)return i;return-1},g.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=n||1;for(var i=Math.max(Math.ceil((e-t)/n),0),o=Array(i),r=0;i>r;r++,t+=n)o[r]=t;return o};var _=function(){};g.bind=function(t,e){var n,i;if(f&&t.bind===f)return f.apply(t,c.call(arguments,1));if(!g.isFunction(t))throw new TypeError("Bind must be called on a function");return n=c.call(arguments,2),i=function(){if(!(this instanceof i))return t.apply(e,n.concat(c.call(arguments)));_.prototype=t.prototype;var o=new _;_.prototype=null;var r=t.apply(o,n.concat(c.call(arguments)));return g.isObject(r)?r:o}},g.partial=function(t){var e=c.call(arguments,1);return function(){for(var n=0,i=e.slice(),o=0,r=i.length;r>o;o++)i[o]===g&&(i[o]=arguments[n++]);for(;n<arguments.length;)i.push(arguments[n++]);return t.apply(this,i)}},g.bindAll=function(t){var e,n,i=arguments.length;if(1>=i)throw new Error("bindAll must be passed function names");for(e=1;i>e;e++)n=arguments[e],t[n]=g.bind(t[n],t);return t},g.memoize=function(t,e){var n=function(i){var o=n.cache,r=e?e.apply(this,arguments):i;return g.has(o,r)||(o[r]=t.apply(this,arguments)),o[r]};return n.cache={},n},g.delay=function(t,e){var n=c.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},g.defer=function(t){return g.delay.apply(g,[t,1].concat(c.call(arguments,1)))},g.throttle=function(t,e,n){var i,o,r,s=null,a=0;n||(n={});var c=function(){a=n.leading===!1?0:g.now(),s=null,r=t.apply(i,o),s||(i=o=null)};return function(){var h=g.now();a||n.leading!==!1||(a=h);var u=e-(h-a);return i=this,o=arguments,0>=u||u>e?(clearTimeout(s),s=null,a=h,r=t.apply(i,o),s||(i=o=null)):s||n.trailing===!1||(s=setTimeout(c,u)),r}},g.debounce=function(t,e,n){var i,o,r,s,a,c=function(){var h=g.now()-s;e>h&&h>0?i=setTimeout(c,e-h):(i=null,n||(a=t.apply(r,o),i||(r=o=null)))};return function(){r=this,o=arguments,s=g.now();var h=n&&!i;return i||(i=setTimeout(c,e)),h&&(a=t.apply(r,o),r=o=null),a}},g.wrap=function(t,e){return g.partial(e,t)},g.negate=function(t){return function(){return!t.apply(this,arguments)}},g.compose=function(){var t=arguments,e=t.length-1;return function(){for(var n=e,i=t[e].apply(this,arguments);n--;)i=t[n].call(this,i);return i}},g.after=function(t,e){return function(){return--t<1?e.apply(this,arguments):void 0}},g.before=function(t,e){var n;return function(){return--t>0?n=e.apply(this,arguments):e=null,n}},g.once=g.partial(g.before,2),g.keys=function(t){if(!g.isObject(t))return[];if(d)return d(t);var e=[];for(var n in t)g.has(t,n)&&e.push(n);return e},g.values=function(t){for(var e=g.keys(t),n=e.length,i=Array(n),o=0;n>o;o++)i[o]=t[e[o]];return i},g.pairs=function(t){for(var e=g.keys(t),n=e.length,i=Array(n),o=0;n>o;o++)i[o]=[e[o],t[e[o]]];return i},g.invert=function(t){for(var e={},n=g.keys(t),i=0,o=n.length;o>i;i++)e[t[n[i]]]=n[i];return e},g.functions=g.methods=function(t){var e=[];for(var n in t)g.isFunction(t[n])&&e.push(n);return e.sort()},g.extend=function(t){if(!g.isObject(t))return t;for(var e,n,i=1,o=arguments.length;o>i;i++){e=arguments[i];for(n in e)l.call(e,n)&&(t[n]=e[n])}return t},g.pick=function(t,e,n){var i,o={};if(null==t)return o;if(g.isFunction(e)){e=v(e,n);for(i in t){var r=t[i];e(r,i,t)&&(o[i]=r)}}else{var s=h.apply([],c.call(arguments,1));t=new Object(t);for(var a=0,u=s.length;u>a;a++)i=s[a],i in t&&(o[i]=t[i])}return o},g.omit=function(t,e,n){if(g.isFunction(e))e=g.negate(e);else{var i=g.map(h.apply([],c.call(arguments,1)),String);e=function(t,e){return!g.contains(i,e)}}return g.pick(t,e,n)},g.defaults=function(t){if(!g.isObject(t))return t;for(var e=1,n=arguments.length;n>e;e++){var i=arguments[e];for(var o in i)void 0===t[o]&&(t[o]=i[o])}return t},g.clone=function(t){return g.isObject(t)?g.isArray(t)?t.slice():g.extend({},t):t},g.tap=function(t,e){return e(t),t};var b=function(t,e,n,i){if(t===e)return 0!==t||1/t===1/e;if(null==t||null==e)return t===e;t instanceof g&&(t=t._wrapped),e instanceof g&&(e=e._wrapped);var o=u.call(t);if(o!==u.call(e))return!1;switch(o){case"[object RegExp]":case"[object String]":return""+t==""+e;case"[object Number]":return+t!==+t?+e!==+e:0===+t?1/+t===1/e:+t===+e;case"[object Date]":case"[object Boolean]":return+t===+e}if("object"!=typeof t||"object"!=typeof e)return!1;for(var r=n.length;r--;)if(n[r]===t)return i[r]===e;var s=t.constructor,a=e.constructor;if(s!==a&&"constructor"in t&&"constructor"in e&&!(g.isFunction(s)&&s instanceof s&&g.isFunction(a)&&a instanceof a))return!1;n.push(t),i.push(e);var c,h;if("[object Array]"===o){if(c=t.length,h=c===e.length)for(;c--&&(h=b(t[c],e[c],n,i)););}else{var l,p=g.keys(t);if(c=p.length,h=g.keys(e).length===c)for(;c--&&(l=p[c],h=g.has(e,l)&&b(t[l],e[l],n,i)););}return n.pop(),i.pop(),h};g.isEqual=function(t,e){return b(t,e,[],[])},g.isEmpty=function(t){if(null==t)return!0;if(g.isArray(t)||g.isString(t)||g.isArguments(t))return 0===t.length;for(var e in t)if(g.has(t,e))return!1;return!0},g.isElement=function(t){return!(!t||1!==t.nodeType)},g.isArray=p||function(t){return"[object Array]"===u.call(t)},g.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},g.each(["Arguments","Function","String","Number","Date","RegExp"],function(t){g["is"+t]=function(e){return u.call(e)==="[object "+t+"]"}}),g.isArguments(arguments)||(g.isArguments=function(t){return g.has(t,"callee")}),"function"!=typeof/./&&(g.isFunction=function(t){return"function"==typeof t||!1}),g.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},g.isNaN=function(t){return g.isNumber(t)&&t!==+t},g.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"===u.call(t)},g.isNull=function(t){return null===t},g.isUndefined=function(t){return void 0===t},g.has=function(t,e){return null!=t&&l.call(t,e)},g.noConflict=function(){return t._=i,this},g.identity=function(t){return t},g.constant=function(t){return function(){return t}},g.noop=function(){},g.property=function(t){return function(e){return e[t]}},g.matches=function(t){var e=g.pairs(t),n=e.length;return function(t){if(null==t)return!n;t=new Object(t);for(var i=0;n>i;i++){var o=e[i],r=o[0];if(o[1]!==t[r]||!(r in t))return!1}return!0}},g.times=function(t,e,n){var i=Array(Math.max(0,t));e=v(e,n,1);for(var o=0;t>o;o++)i[o]=e(o);return i},g.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))},g.now=Date.now||function(){return(new Date).getTime()};var C={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},x=g.invert(C),P=function(t){var e=function(e){return t[e]},n="(?:"+g.keys(t).join("|")+")",i=RegExp(n),o=RegExp(n,"g");return function(t){return t=null==t?"":""+t,i.test(t)?t.replace(o,e):t}};g.escape=P(C),g.unescape=P(x),g.result=function(t,e){if(null==t)return void 0;var n=t[e];return g.isFunction(n)?t[e]():n};var E=0;g.uniqueId=function(t){var e=++E+"";return t?t+e:e},g.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var k=/(.)^/,S={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},T=/\\|'|\r|\n|\u2028|\u2029/g,N=function(t){return"\\"+S[t]};g.template=function(t,e,n){!e&&n&&(e=n),e=g.defaults({},e,g.templateSettings);var i=RegExp([(e.escape||k).source,(e.interpolate||k).source,(e.evaluate||k).source].join("|")+"|$","g"),o=0,r="__p+='";t.replace(i,function(e,n,i,s,a){return r+=t.slice(o,a).replace(T,N),o=a+e.length,n?r+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":i?r+="'+\n((__t=("+i+"))==null?'':__t)+\n'":s&&(r+="';\n"+s+"\n__p+='"),e}),r+="';\n",e.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+r+"return __p;\n";try{var s=new Function(e.variable||"obj","_",r)}catch(a){throw a.source=r,a}var c=function(t){return s.call(this,t,g)},h=e.variable||"obj";return c.source="function("+h+"){\n"+r+"}",c},g.chain=function(t){var e=g(t);return e._chain=!0,e};var O=function(t){return this._chain?g(t).chain():t};g.mixin=function(t){g.each(g.functions(t),function(e){var n=g[e]=t[e];g.prototype[e]=function(){var t=[this._wrapped];return a.apply(t,arguments),O.call(this,n.apply(g,t))}})},g.mixin(g),g.each(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=o[t];g.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!==t&&"splice"!==t||0!==n.length||delete n[0],O.call(this,n)}}),g.each(["concat","join","slice"],function(t){var e=o[t];g.prototype[t]=function(){return O.call(this,e.apply(this._wrapped,arguments))}}),g.prototype.value=function(){return this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return g})}).call(this)},{}],270:[function(t,e){"use strict";var n=t("./archivist_document_factory"),i=t("./metadata"),o=function(){this.documentFactory=new n,this.metadata=i.instance()
};o.Prototype=function(){this.newDocument=function(){return this.documentFactory.createEmptyDoc()},this.open=function(t,e){var n,i=this;this.metadata.load(function(){$.getJSON("/api/documents/"+t,function(t){console.log("version fetched:",t.__v),n=i.documentFactory.createFromJSON(t),n.version=t.__v,n.metadata=i.metadata,e(null,n)})})},this.save=function(t,e,n){var i=this,o=t.toJSON();o.__v=t.version,console.log("local version:",t.version),console.log("local subjectDBVersion:",t.metadata.subjectDBVersion),$.ajax({type:"PUT",url:"/api/documents/"+e,contentType:"application/json",data:JSON.stringify(o),success:function(e){console.log("new documentVersion: ",e.documentVersion),console.log("new subjectDBVersion: ",e.subjectDBVersion),t.version=e.documentVersion,t.metadata.subjectDBVersion!==e.subjectDBVersion?(console.log("outdated subjects metadata.. loading again from server"),i.metadata.load(function(e){return e?n(e):(t.trigger("metadata:updated"),void n(null))})):n(null)},error:function(t){n(t.responseText)}})},this.readFromArrayBuffer=function(t,e){console.error("TODO: handle dropped file"),e("Not implemented yet.")}},o.prototype=new o.Prototype,e.exports=o},{"./archivist_document_factory":271,"./metadata":273}],271:[function(t,e){"use strict";var n=t("substance-composer"),i=n.EditableArticle,o=t("substance-chronicle"),r=t("substance-document"),s=t("substance-util"),a=t("./nodes"),c="archivist-interview",h="0.1.0",u=function(){};u.Prototype=function(){this.createFromJSON=function(t){var e=s.deepclone(r.schema);e.id=c,e.version=h;var n=i.fromSnapshot(t,{schema:e,nodeTypes:a,chronicle:o.create()});return n},this.createEmptyDoc=function(){return u.createEmptyDoc()}},u.createEmptyDoc=function(){var t=s.uuid(),e={id:t,schema:[c,h],nodes:{document:{id:"document",type:"document",views:["content","citations","remarks","info"],license:"licence",guid:t,creator:"",title:"Untitled",authors:[],"abstract":"",created_at:(new Date).toJSON(),updated_at:(new Date).toJSON(),published_on:(new Date).toJSON()},cover:{id:"cover",type:"cover",authors:[]},content:{type:"view",id:"content",nodes:["cover","text1"]},citations:{type:"view",id:"citations",nodes:[]},remarks:{type:"view",id:"remarks",nodes:[]},info:{type:"view",id:"info",nodes:["publication_info","interview_subject","interview_conductor","interview_operator","interview_sound_operator"]},text1:{type:"text",id:"text1",content:""},publication_info:{id:"publication_info",type:"publication_info"},interview_subject:{type:"interview_subject",id:"interview_subject",name:"The Interviewed",role:"Interview Subject",forced_labor:"intracamp work; earthworks (construction of barracks); digging tunnels for military factories",categories:["Ost arbeiter","Cocentration camp worker"],prisons:["location_komorn"],movement:[{location:"location_danzig",density:33},{location:"location_komorn",density:67}],description:"",image:""},interview_conductor:{type:"contributor",id:"interview_conductor",source_id:"",name:"Daniel Beilinson",role:"Interview Conductor",description:"",image:""},interview_operator:{type:"contributor",id:"interview_operator",source_id:"",name:"Oliver Buchtala",role:"Operator",description:"",image:""},interview_sound_operator:{type:"contributor",id:"interview_sound_operator",source_id:"",name:"Michael Aufreiter",role:"Sound Operator",description:"",image:""},license:{id:"license",type:"license",name:"None",code:"none",description:"",version:"1.0",url:""}}},n=new i({seed:e,nodeTypes:a,chronicle:o.create()});return n},u.prototype=new u.Prototype,u.prototype.constructor=u,e.exports=u},{"./nodes":275,"substance-chronicle":19,"substance-composer":33,"substance-document":132,"substance-util":264}],272:[function(t,e){"use strict";var n=t("./archivist_backend"),i=t("substance-composer"),o=i.WebShell,r=function(){o.call(this,new n(this))};r.Prototype=function(){},r.Prototype.prototype=o.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"./archivist_backend":270,"substance-composer":33}],273:[function(t,e){var n=(t("substance-util"),t("path"),t("underscore")),i=function(){};i.Prototype=function(){this.load=function(t){var e=this;$.getJSON("/api/metadata",function(n){console.log("subjectDBVersion",n.subjectDBVersion),e.subjectDBVersion=n.subjectDBVersion,e.importSubjects(n.subjects),t(null)})},this.importSubjects=function(t){this.subjects={},n.each(t,function(t){this.subjects[t.id]=t},this)},this.getSubjects=function(){return this.subjects}},i.prototype=new i.Prototype;var o=null;i.instance=function(){return o||(o=new i),o},e.exports=i},{path:305,"substance-util":264,underscore:269}],274:[function(t,e){var n=(t("substance-util"),t("path"),t("fs"),t("underscore")),i=function(){this.locations=t("../data/locations"),this.persons=t("../data/persons"),this.definitions=t("../data/definitions"),this.importSubjects()};i.Prototype=function(){this.importSubjects=function(){var e=t("../data/subjects");this.subjects={},n.each(e,function(t){this.subjects[t.id]=t},this)},this.getLocations=function(){return this.locations},this.getPersons=function(){return this.persons},this.getDefinitions=function(){return this.definitions},this.getSubjects=function(){return this.subjects}},i.prototype=new i.Prototype;var o=null;i.instance=function(){return o||(o=new i),o},e.exports=i},{"../data/definitions":2,"../data/locations":3,"../data/persons":4,"../data/subjects":5,fs:304,path:305,"substance-util":264,underscore:269}],275:[function(t,e){e.exports={}},{}],276:[function(t,e){"use strict";var n=t("../entity_panel_controller"),i=t("./definitions_view"),o=(t("underscore"),t("substance-util"),function(t,e){n.call(this,t,e)});o.Prototype=function(){this.createView=function(){return this.view||(this.view=new i(this)),this.view},this.getEntities=function(){return this.metadataService.getDefinitions()}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../entity_panel_controller":280,"./definitions_view":278,"substance-util":264,underscore:269}],277:[function(t,e){"use strict";var n=(t("underscore"),t("substance-composer").Panel),i=t("./definitions_controller"),o=function(){n.call(this,"definitions")};o.Prototype=function(){this.createController=function(t,e){return new i(t,e)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"./definitions_controller":276,"substance-composer":33,underscore:269}],278:[function(t,e){var n=t("../entity_panel_view"),i=function(t){n.call(this,t,{entityType:"definition",name:"definitions",label:"Definitions",title:"Definitions",type:"resource",icon:"icon-book"})};i.Prototype=function(){this.renderEntity=function(t){var e=$("<div>").addClass("definition entity").attr("data-id",t.id);return e.append($("<div>").addClass("definition-title").html(t.title)),e.append($("<div>").addClass("definition-description").html(t.description)),e}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../entity_panel_view":281}],279:[function(t,e){e.exports=t("./definitions_panel")},{"./definitions_panel":277}],280:[function(t,e){"use strict";var n=t("substance-composer").PanelController,i=t("../metadata_service"),o=(t("underscore"),t("substance-util"),function(t,e){n.call(this,t,e),this.state={id:"initialized"},this.metadataService=i.instance()});o.Prototype=function(){this.createView=function(){},this.initialize=function(t,e){e(null)},this.getEntities=function(){throw new Error("this method is abstract")},this.transition=function(t,e){e(null)},this.afterTransition=function(t){this.view.transition(t)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"../metadata_service":274,"substance-composer":33,"substance-util":264,underscore:269}],281:[function(t,e){var n=t("substance-composer").PanelView,i=t("underscore"),o=function(t,e){n.call(this,t,{name:e.name,label:e.label,title:e.title,type:e.type,icon:e.icon}),this.entityType=e.entityType,this.writerCtrl=this.controller.writerCtrl,this.$el.addClass("entities"),this.$el.on("click",".select-entity",i.bind(this.selectEntity,this))};o.Prototype=function(){this.selectEntity=function(t){var e=$(t.currentTarget).attr("data-id"),n=this.writerCtrl.workflows.tag_entity;n.endWorkflow(e,this.entityType),t.preventDefault()},this.render=function(){return this.renderEntities(),this},this.renderEntity=function(){throw new Error("this method is abstract")},this.renderEntities=function(){this.$entities=$("<div>").addClass("entities"),i.each(this.controller.getEntities(),function(t){var e=this.renderEntity(t),n=$("<a>").addClass("select-entity").attr({"data-id":t.id}).html("Select");e.append(n),this.$entities.append(e)},this),this.$el.append(this.$entities),this.updateView({mode:"list"})},this.updateView=function(t){var e=this;this.$el.removeClass("select-mode").removeClass("list-mode"),this.$el.addClass(t.mode+"-mode");var n=this.$(".entity");n.each(function(){var n=this.getAttribute("data-id"),i=e.writerCtrl.referenceIndex.get(n);0===Object.keys(i).length?$(this).addClass("unreferenced"):$(this).removeClass("unreferenced"),n===t.selectedResource&&$(this).addClass("active")})},this.focusResource=function(t){this.$(".entity.active").removeClass("active");var e=this.$(".entity[data-id="+t+"]");e.addClass("active")}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"substance-composer":33,underscore:269}],282:[function(t,e){e.exports=t("./locations_panel")},{"./locations_panel":284}],283:[function(t,e){"use strict";var n=t("../entity_panel_controller"),i=t("./locations_view"),o=(t("underscore"),t("substance-util"),function(t,e){n.call(this,t,e)});o.Prototype=function(){this.createView=function(){return this.view||(this.view=new i(this)),this.view},this.getEntities=function(){return this.metadataService.getLocations()}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../entity_panel_controller":280,"./locations_view":285,"substance-util":264,underscore:269}],284:[function(t,e){"use strict";var n=(t("underscore"),t("substance-composer").Panel),i=t("./locations_controller"),o=function(){n.call(this,"locations")};o.Prototype=function(){this.createController=function(t,e){return new i(t,e)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"./locations_controller":283,"substance-composer":33,underscore:269}],285:[function(t,e){var n=t("../entity_panel_view"),i=function(t){n.call(this,t,{entityType:"location",name:"locations",label:"Locations",title:"Locations",type:"resource",icon:"icon-location-arrow"})};i.Prototype=function(){this.renderEntity=function(t){var e=$("<div>").addClass("location entity").attr("data-id",t.id);return e.append($("<div>").addClass("location-type").addClass(t.location_type).html(t.location_type)),e.append($("<div>").addClass("location-name").html([t.name,t.country].join(", "))),e.append($("<div>").addClass("location-synonyms").html(t.synonyms.join(", "))),"prison"===t.location_type?(e.append($("<div>").addClass("prison-type").html(t.prison_type.join(", "))),e.append($("<div>").addClass("nearest-locality").html("Nearest locality: "+t.nearest_locality))):e.append($("<div>").addClass("current-name").html("Current name: "+t.current_name)),e}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../entity_panel_view":281}],286:[function(t,e){e.exports=t("./metadata_panel")},{"./metadata_panel":288}],287:[function(t,e){"use strict";var n=t("substance-composer").NodesPanelController,i=t("underscore"),o=(t("substance-util"),t("./metadata_view")),r=function(t,e){n.call(this,t,e),this.state={id:"initialized"}};r.Prototype=function(){this.getNodes=function(){var t=[],e=this.document.get("info");return i.each(e.nodes,function(e){t.push(this.document.get(e))},this),t},this.createView=function(){return this.view||(this.view=new o(this,this.createViewFactory())),this.view},this.initialize=function(t,e){e(null)},this.transition=function(t,e){e(null)},this.afterTransition=function(t){this.view.transition(t)}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"./metadata_view":289,"substance-composer":33,"substance-util":264,underscore:269}],288:[function(t,e){"use strict";var n=(t("underscore"),t("substance-composer").Panel),i=t("./metadata_controller"),o=function(){n.call(this,"metadata")};o.Prototype=function(){this.createController=function(t,e){return new i(t,e)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"./metadata_controller":287,"substance-composer":33,underscore:269}],289:[function(t,e){var n=t("substance-composer").NodesPanelView,i=(t("underscore"),function(t,e){n.call(this,t,e,{name:"metadata",label:"Info",title:"Info",type:"resource",icon:"icon-info"}),this.writerCtrl=this.controller.writerCtrl,this.$el.addClass("metadata-panel")});i.Prototype=function(){this.focusResource=function(){}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"substance-composer":33,underscore:269}],290:[function(t,e){e.exports=t("./persons_panel")},{"./persons_panel":292}],291:[function(t,e){"use strict";var n=t("../entity_panel_controller"),i=t("./persons_view"),o=(t("underscore"),t("substance-util"),function(t,e){n.call(this,t,e)});o.Prototype=function(){this.createView=function(){return this.view||(this.view=new i(this)),this.view},this.getEntities=function(){return this.metadataService.getPersons()}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../entity_panel_controller":280,"./persons_view":293,"substance-util":264,underscore:269}],292:[function(t,e){"use strict";var n=(t("underscore"),t("substance-composer").Panel),i=t("./persons_controller"),o=function(){n.call(this,"persons")};o.Prototype=function(){this.createController=function(t,e){return new i(t,e)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"./persons_controller":291,"substance-composer":33,underscore:269}],293:[function(t,e){var n=t("../entity_panel_view"),i=function(t){n.call(this,t,{entityType:"person",name:"persons",label:"Persons",title:"Persons",type:"resource",icon:"icon-user"})};i.Prototype=function(){this.renderEntity=function(t){var e=$("<div>").addClass("person entity").attr("data-id",t.id);return e.append($("<div>").addClass("person-name").html(t.name)),e.append($("<div>").addClass("person-bio").html(t.bio)),e}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../entity_panel_view":281}],294:[function(t,e){e.exports=t("./subjects_panel")},{"./subjects_panel":296}],295:[function(t,e){"use strict";var n=t("substance-composer").PanelController,i=t("./subjects_view"),o=t("underscore"),r=function(t){this.nodes=t,this.buildIndexes()};r.Prototype=function(){this.buildIndexes=function(){this.parentIndex={},o.each(this.nodes,function(t){var e=t.parent||"root";this.parentIndex[e]?this.parentIndex[e].push(t):this.parentIndex[e]=[t]},this)},this.get=function(t){return this.nodes[t]},this.getChildren=function(t){return this.parentIndex[t]||[]},this.getParent=function(t){var e=this.nodes[t];return this.nodes[e.parent]},this.walkTree=function(t,e){function n(t,e,r){"root"!==t&&e.call(r,t),o.each(i.getChildren(t.id),function(t){n(t,e,r)})}var i=this;return e||(e=this),n("root",t,e)}},r.prototype=new r.Prototype;var s=function(t,e){n.call(this,t,e),this.updateSubjects(),this.writerCtrl.document.on("metadata:updated",o.bind(this.updateSubjects,this))};s.Prototype=function(){this.updateSubjects=function(){var t=this.writerCtrl.document.metadata.getSubjects();this.tree=new r(t),this.view&&this.view.updateView()},this.createView=function(){return this.view||(this.view=new i(this)),this.view},this.getAllReferencedSubjects=function(){var t=this.document,e=t.getIndex("multi_annotations").get("content"),n=this.getSubjects(),i=[];return o.each(e,function(t){o.each(t.target,function(t){n[t]&&i.push(n[t])},this)},this),i},this.getReferencedSubjects=function(t){var e=this.document.get(t);if(!e)return[];var n=this.getSubjects(),i=[];return o.each(e.target,function(t){n[t]&&i.push(n[t])}),i},this.getSubjects=function(){var t=this.document,e=t.metadata.getSubjects();return e},this.getSubjectsTree=function(){function t(n){var i=[],r=e.getChildren(n);return 0===r.length?i:(o.each(r,function(e){var n={id:e.id,text:e.name,children:t(e.id)};i.push(n)}),i)}var e=this.tree;return t("root")},this.getFullPathForSubject=function(t){function e(t){var o=n.get(t),r=n.getParent(t);return r&&e(r.id),i.push(o.name),i}var n=this.tree,i=[];return e(t)}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"./subjects_view":297,"substance-composer":33,underscore:269}],296:[function(t,e){"use strict";var n=(t("underscore"),t("substance-composer").Panel),i=t("./subjects_controller"),o=function(){n.call(this,"subjects")};o.Prototype=function(){this.createController=function(t,e){return new i(t,e)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"./subjects_controller":295,"substance-composer":33,underscore:269}],297:[function(t,e){var n=t("substance-composer").PanelView,i=t("substance-application").$$,o=t("underscore"),r=function(t){n.call(this,t,{name:"subjects",label:"Subjects",title:"Subjects",type:"resource",icon:"icon-tag"}),this.writerCtrl=this.controller.writerCtrl,this.$el.addClass("entities subjects"),this.$el.on("click",".confirm-selection",o.bind(this.confirmSelection,this)),this.$el.on("click",".edit-subject-reference",o.bind(this.enableSelection,this)),this.$el.on("click",".delete-subject-reference",o.bind(this.deleteSubjectReference,this)),this.$el.on("click",".cancel-edit",o.bind(this.cancelEdit,this))};r.Prototype=function(){this.cancelEdit=function(){var t=this.writerCtrl.state;this.writerCtrl.switchState({id:"main",contextId:"subjects",subjectReferenceId:t.subjectReferenceId},{"no-scroll":!0})},this.deleteSubjectReference=function(t){t&&t.preventDefault();var e=this.writerCtrl.state,n=this.writerCtrl.document,i=e.subjectReferenceId,r=n.getAnnotationFragments(i);o.each(r,function(t){n["delete"](t.id)},this),n["delete"](i),this.writerCtrl.switchState({id:"main",contextId:"subjects"},{"no-scroll":!0})},this.enableSelection=function(t){t.preventDefault();var e=this.writerCtrl.state;this.writerCtrl.switchState({id:"main",contextId:"subjects",subjectReferenceId:e.subjectReferenceId,mode:"select"},{"no-scroll":!0})},this.confirmSelection=function(t){t.preventDefault();var e=$(this.treeView).jstree().get_selected(),n=this.writerCtrl.state,i=this.writerCtrl.document,o=n.subjectReferenceId;i.set([o,"target"],e),this.writerCtrl.contentCtrl._afterEdit(),this.writerCtrl.switchState({id:"main",contextId:"subjects",subjectReferenceId:o,mode:"show"},{updateRoute:!0,replace:!0})},this.updateView=function(t){t&&(this.viewState=t),this.el.innerHTML="","select"===this.viewState.mode?this.renderSelectMode():"show"===this.viewState.mode?this.renderShowMode():this.renderListMode()},this.renderShowMode=function(){this.el.innerHTML="";var t=this.controller.getReferencedSubjects(this.viewState.subjectReferenceId);this.headerEl=i(".header",{text:"Annotated text"}),this.actionsEl=i(".actions"),this.actionsEl.appendChild(i("a.action.edit-subject-reference",{href:"#",text:"Edit"})),this.actionsEl.appendChild(i("a.action.delete-subject-reference",{href:"#",text:"Delete"})),this.headerEl.appendChild(this.actionsEl),this.el.appendChild(this.headerEl),this.renderSubjectsList(t)},this.renderSubjectsList=function(t){this.subjectsEl=i(".subjects.entities"),o.each(t,function(t){var e=this.controller.getFullPathForSubject(t.id),n=i(".subject.entity",{children:[i(".subject-name",{text:e.join(" > ")})]});this.subjectsEl.appendChild(n)},this),this.el.appendChild(this.subjectsEl)},this.renderListMode=function(){this.el.innerHTML="";var t=this.controller.getAllReferencedSubjects();this.headerEl=i(".header",{text:t.length+" subjects annotated in this interview"}),this.el.appendChild(this.headerEl),this.renderSubjectsList(t)},this.renderSelectMode=function(){var t=this.writerCtrl.state,e=this.writerCtrl.document,n=e.get(t.subjectReferenceId);this.headerEl=i(".header",{text:"Please choose relevant subjects"}),this.el.appendChild(this.headerEl),this.actionsEl=i(".actions"),this.actionsEl.appendChild(i("a.action.confirm-selection",{href:"#",text:"Save"})),n.target&&0!==n.target.length||this.actionsEl.appendChild(i("a.action.delete-subject-reference",{href:"#",text:"Cancel"})),this.headerEl.appendChild(this.actionsEl),this.availableSubjects=i(".available-subjects");this.treeView=i(".tree-view");this.availableSubjects.appendChild(this.treeView);var r=this.controller.getSubjectsTree();$(this.treeView).jstree({checkbox:{three_state:!1},plugins:["checkbox"],core:{data:r}}),t.subjectReferenceId&&o.delay(function(){o.each(n.target,function(t){$(".jstree").jstree("select_node",t)},this)},200,this),this.el.appendChild(this.availableSubjects)},this.render=function(){return this.renderListMode(),this}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"substance-application":6,"substance-composer":33,underscore:269}],298:[function(t,e){var n=function(){this.name="definition",this.title="Definition",this.icon="icon-book",this.action="select-definition"};n.Prototype=function(){this.isActive=function(t){return!!t.getActiveAnnotationByType("definition_reference")},this.isEnabled=function(t){var e=t.getCurrentEditor();if(!e)return!1;if("content"!==e.view)return!1;var n=e.selection;return!n.isCollapsed()},this.handleToggle=function(t){var e=t.getActiveAnnotationByType("definition_reference");e?t.deleteAnnotation(e):t.workflows.tag_entity.beginWorkflow("definition")}},n.Prototype.prototype=n.prototype,n.prototype=new n.Prototype,n.prototype.constructor=n,e.exports=n},{}],299:[function(t,e){var n=function(){this.name="location",this.title="Location",this.icon="icon-location-arrow",this.action="select-location"};n.Prototype=function(){this.isActive=function(t){return!!t.getActiveAnnotationByType("location_reference")},this.isEnabled=function(t){var e=t.getCurrentEditor();if(!e)return!1;if("content"!==e.view)return!1;var n=e.selection;return!n.isCollapsed()},this.handleToggle=function(t){var e=t.getActiveAnnotationByType("location_reference");e?t.deleteAnnotation(e):(console.log("TODO Begin tag location workflow"),t.workflows.tag_entity.beginWorkflow("location"))}},n.Prototype.prototype=n.prototype,n.prototype=new n.Prototype,n.prototype.constructor=n,e.exports=n},{}],300:[function(t,e){var n=function(){this.name="person",this.title="Person",this.icon="icon-user",this.action="select-person"};n.Prototype=function(){this.isActive=function(t){return!!t.getActiveAnnotationByType("person_reference")},this.isEnabled=function(t){var e=t.getCurrentEditor();if(!e)return!1;if("content"!==e.view)return!1;var n=e.selection;return!n.isCollapsed()},this.handleToggle=function(t){var e=t.getActiveAnnotationByType("person_reference");e?t.deleteAnnotation(e):t.workflows.tag_entity.beginWorkflow("person")}},n.Prototype.prototype=n.prototype,n.prototype=new n.Prototype,n.prototype.constructor=n,e.exports=n},{}],301:[function(t,e){var n=function(){this.name="subject",this.title="Subject",this.icon="icon-tag",this.action="select-subject"};n.Prototype=function(){this.isActive=function(t){return!!t.getActiveAnnotationByType("subject_reference")},this.isEnabled=function(t){var e=t.getCurrentEditor();if(!e)return!1;if("content"!==e.view)return!1;var n=e.selection;return!n.isCollapsed()},this.handleToggle=function(t){var e=t.getActiveAnnotationByType("subject_reference");e?t.deleteAnnotation(e):t.workflows.tag_subject.beginWorkflow()}},n.Prototype.prototype=n.prototype,n.prototype=new n.Prototype,n.prototype.constructor=n,e.exports=n},{}],302:[function(t,e){"use strict";var n=(t("underscore"),t("substance-composer").Workflow),i=function(){n.apply(this,arguments),this.handlers=[]};i.Prototype=function(){this.registerHandlers=function(){},this.unRegisterHandlers=function(){},this.handlesStateUpdate=!0,this.handleStateUpdate=function(t,e){var n=t.contextId,i=this.writerView.panelViews[n];return"tagentity"===t.id?(i.updateView({mode:"select"}),!0):"tagentity"===e.id?(i.updateView({mode:"list"}),this.writerView.focusResource(),!0):!1},this.beginWorkflow=function(t){var e=this.writerCtrl.document,n=this.writerCtrl.currentSession,i=e.state;if(!n)return console.error("Workflow 'beginAddLocation': nothing selected."),!1;var o=n.container,r=n.selection;if(r.isNull())throw new Error("Selection is null.");var s=n.container.id,a=r.getCursor(),c=o.getRootNodeFromPos(a.pos),h=a.charPos;this.writerCtrl.switchState({id:"tagentity",contextId:t+"s",containerId:s,nodeId:c.id,recover:i,charPos:""+h},{"no-scroll":!0})},this.endWorkflow=function(t,e){var n=this.writerCtrl.contentCtrl;n.addReference(e+"_reference",{target:t}),n.focus()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"substance-composer":33,underscore:269}],303:[function(t,e){"use strict";var n=t("substance-composer").Workflow,i=function(){n.apply(this,arguments),this.handlers=[]};i.Prototype=function(){this.registerHandlers=function(){},this.unRegisterHandlers=function(){},this.handlesStateUpdate=!0,this.handleStateUpdate=function(t,e){var n=this.writerView.panelViews.subjects;if(console.log("handling state update..."),"main"===t.id&&t.subjectReferenceId){var i=t.mode||"show";return n.updateView({mode:i,subjectReferenceId:t.subjectReferenceId}),this.writerView.contentView.annotationBar.update(),!0}return e.subjectReferenceId&&!t.subjectReferenceId&&this.writerView.contentView.annotationBar.update(),n.updateView({mode:"list"}),!1},this.beginWorkflow=function(){{var t=this.writerCtrl.document,e=this.writerCtrl.currentSession;t.state}if(!e)return!1;var n=e.container,i=e.selection;if(i.isNull())throw new Error("Selection is null.");var o=(e.container.id,i.getCursor()),r=(n.getRootNodeFromPos(o.pos),o.charPos,this.writerCtrl.contentCtrl),s=(this.writerCtrl.state,r.addMultiAnnotation("subject_reference",{target:[],container:"content"}));this.writerCtrl.switchState({id:"main",contextId:"subjects",subjectReferenceId:s,mode:"select"},{updateRoute:!0,replace:!0}),this.endWorkflow()},this.endWorkflow=function(){}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"substance-composer":33}],304:[function(){},{}],305:[function(t,e,n){(function(t){function e(t,e){for(var n=0,i=t.length-1;i>=0;i--){var o=t[i];"."===o?t.splice(i,1):".."===o?(t.splice(i,1),n++):n&&(t.splice(i,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}function i(t,e){if(t.filter)return t.filter(e);for(var n=[],i=0;i<t.length;i++)e(t[i],i,t)&&n.push(t[i]);return n}var o=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,r=function(t){return o.exec(t).slice(1)};n.resolve=function(){for(var n="",o=!1,r=arguments.length-1;r>=-1&&!o;r--){var s=r>=0?arguments[r]:t.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");s&&(n=s+"/"+n,o="/"===s.charAt(0))}return n=e(i(n.split("/"),function(t){return!!t}),!o).join("/"),(o?"/":"")+n||"."},n.normalize=function(t){var o=n.isAbsolute(t),r="/"===s(t,-1);return t=e(i(t.split("/"),function(t){return!!t}),!o).join("/"),t||o||(t="."),t&&r&&(t+="/"),(o?"/":"")+t},n.isAbsolute=function(t){return"/"===t.charAt(0)},n.join=function(){var t=Array.prototype.slice.call(arguments,0);return n.normalize(i(t,function(t){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))},n.relative=function(t,e){function i(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=n.resolve(t).substr(1),e=n.resolve(e).substr(1);for(var o=i(t.split("/")),r=i(e.split("/")),s=Math.min(o.length,r.length),a=s,c=0;s>c;c++)if(o[c]!==r[c]){a=c;break}for(var h=[],c=a;c<o.length;c++)h.push("..");return h=h.concat(r.slice(a)),h.join("/")},n.sep="/",n.delimiter=":",n.dirname=function(t){var e=r(t),n=e[0],i=e[1];return n||i?(i&&(i=i.substr(0,i.length-1)),n+i):"."},n.basename=function(t,e){var n=r(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},n.extname=function(t){return r(t)[3]};var s="b"==="ab".substr(-1)?function(t,e,n){return t.substr(e,n)}:function(t,e,n){return 0>e&&(e=t.length+e),t.substr(e,n)}}).call(this,t("_process"))},{_process:306}],306:[function(t,e){function n(){}var i=e.exports={};i.nextTick=function(){var t="undefined"!=typeof window&&window.setImmediate,e="undefined"!=typeof window&&window.MutationObserver,n="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(t)return function(t){return window.setImmediate(t)};var i=[];if(e){var o=document.createElement("div"),r=new MutationObserver(function(){var t=i.slice();i.length=0,t.forEach(function(t){t()})});return r.observe(o,{attributes:!0}),function(t){i.length||o.setAttribute("yes","no"),i.push(t)}}return n?(window.addEventListener("message",function(t){var e=t.source;if((e===window||null===e)&&"process-tick"===t.data&&(t.stopPropagation(),i.length>0)){var n=i.shift();n()}},!0),function(t){i.push(t),window.postMessage("process-tick","*")}):function(t){setTimeout(t,0)}}(),i.title="browser",i.browser=!0,i.env={},i.argv=[],i.on=n,i.addListener=n,i.once=n,i.off=n,i.removeListener=n,i.removeAllListeners=n,i.emit=n,i.binding=function(){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(){throw new Error("process.chdir is not supported")}},{}]},{},[1]);